events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # =====================================
    # ✅ Unity WebGL MIME Types
    # =====================================
    types {
        application/wasm                     wasm;
        application/javascript               js;
        application/octet-stream             data unityweb;
        application/json                     json;
    }
    
    # =====================================
    # ✅ FILE UPLOAD LIMITS - 1.5 GB (Safe Buffer)
    # =====================================
    client_max_body_size 1536M;          # 1.5 GB (1 GB + buffer)
    client_body_timeout 600s;            # 10 minutes
    client_body_buffer_size 16M;
    client_header_timeout 600s;
    
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # =====================================
    # ✅ Gzip Compression
    # =====================================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types 
        text/plain 
        text/css 
        application/json 
        application/javascript 
        text/xml 
        application/xml 
        application/xml+rss 
        text/javascript
        application/wasm;
    gzip_disable "msie6";

    # =====================================
    # ✅ Proxy Buffers for Large Files
    # =====================================
    proxy_buffering on;
    proxy_buffer_size 128k;
    proxy_buffers 256 16k;
    proxy_busy_buffers_size 256k;
    proxy_temp_file_write_size 256k;
    proxy_max_temp_file_size 2048m;

    upstream django {
        server web:8000;
    }

    server {
        listen 80;
        server_name 35.154.90.26;

        # =====================================
        # ✅ Static Files
        # =====================================
        location /static/ {
            alias /app/staticfiles/;
            expires 30d;
            add_header Cache-Control "public, immutable";
            add_header Access-Control-Allow-Origin "*";
        }

        # =====================================
        # ✅ WebGL Brotli Files (.br extension)
        # =====================================
        location ~* ^/demo/webgl/.*\.(wasm|js|data|json|symbols)\.br$ {
            proxy_pass http://django;
            proxy_http_version 1.1;
            
            # ✅ CRITICAL: Brotli Content-Encoding
            add_header Content-Encoding "br" always;
            add_header Cache-Control "public, max-age=31536000, immutable" always;
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
            
            # ✅ Set correct MIME type using map (better than if)
            set $mime_type "application/octet-stream";
            
            if ($uri ~* \.wasm\.br$) {
                set $mime_type "application/wasm";
            }
            if ($uri ~* \.js\.br$) {
                set $mime_type "application/javascript";
            }
            if ($uri ~* \.data\.br$) {
                set $mime_type "application/octet-stream";
            }
            if ($uri ~* \.json\.br$) {
                set $mime_type "application/json";
            }
            
            add_header Content-Type $mime_type always;
            
            # Proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Buffering OFF for streaming
            proxy_buffering off;
            proxy_redirect off;
            
            # Extended timeouts
            proxy_read_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
        }
        
        # =====================================
        # ✅ WebGL Regular Files (non-Brotli)
        # =====================================
        location ~* ^/demo/webgl/.*\.(wasm|js|data|json|unityweb|html)$ {
            proxy_pass http://django;
            proxy_http_version 1.1;
            
            add_header Cache-Control "public, max-age=31536000, immutable" always;
            add_header Access-Control-Allow-Origin "*" always;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_buffering off;
            proxy_redirect off;
            
            proxy_read_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
        }

        # =====================================
        # ✅ WebGL Index Pages and Other Files
        # =====================================
        location /demo/webgl/ {
            proxy_pass http://django;
            proxy_http_version 1.1;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_buffering off;
            proxy_redirect off;
            
            proxy_read_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
        }

        # =====================================
        # ✅ Media Files (Videos, Images, etc.)
        # =====================================
        location /media/ {
            alias /app/media/;
            expires 1y;
            add_header Cache-Control "public, max-age=31536000";
            add_header Access-Control-Allow-Origin "*";
            
            # Allow large file serving
            sendfile on;
            sendfile_max_chunk 1m;
            tcp_nopush on;
        }

        # =====================================
        # ✅ All Other Django Requests
        # =====================================
        location / {
            proxy_pass http://django;
            proxy_http_version 1.1;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "";
            
            # ✅ Large file upload support
            client_max_body_size 1536M;
            
            # Extended timeouts for uploads
            proxy_read_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            
            # Request body timeouts
            client_body_timeout 600;
        }
    }
}