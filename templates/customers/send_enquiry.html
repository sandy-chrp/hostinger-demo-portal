<!-- templates/customers/send_enquiry.html - Compact Single Screen Version -->
{% extends 'customers/base.html' %}
{% load static %}

{% block customer_title %}Send Business Enquiry - Customer Portal{% endblock %}
{% block page_title %}Send Business Enquiry{% endblock %}

{% block customer_content %}
<style>
    /* Container */
    .enquiry-form-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Compact Page Header */
    .page-header-compact {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
        padding: var(--spacing-md) var(--spacing-lg);
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-200);
        flex-wrap: wrap;
        gap: var(--spacing-sm);
    }

    .page-header-compact h4 {
        margin: 0;
        color: var(--dark-color);
        font-size: var(--font-xl);
        font-weight: 600;
        font-family: var(--heading-font);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .page-header-compact .header-actions {
        display: flex;
        gap: var(--spacing-xs);
    }

    /* Compact Form Card */
    .form-card-compact {
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
        overflow: hidden;
    }

    /* Form Header - Slim */
    .form-header-slim {
        background: var(--gradient-primary);
        color: white;
        padding: var(--spacing-md) var(--spacing-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .form-header-slim h5 {
        margin: 0;
        font-size: var(--font-lg);
        font-weight: 600;
        font-family: var(--heading-font);
    }

    .form-header-slim .header-info {
        font-size: var(--font-xs);
        opacity: 0.9;
    }

    /* Compact Form Body */
    .form-body-compact {
        padding: var(--spacing-lg);
    }

    /* Three Column Grid Layout */
    .form-grid-3col {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }

    /* Two Column Grid */
    .form-grid-2col {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }

    /* Full Width Grid Item */
    .grid-full {
        grid-column: span 3;
    }

    .grid-span-2 {
        grid-column: span 2;
    }

    /* Compact Form Group */
    .form-group-compact {
        margin-bottom: 0;
    }

    .form-label-compact {
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.25rem;
        display: block;
        font-size: var(--font-xs);
        font-family: var(--primary-font);
    }

    .required::after {
        content: " *";
        color: var(--danger-color);
    }

    /* Smaller Form Controls */
    .form-control-sm,
    .form-select-sm {
        width: 100%;
        padding: 0.375rem 0.75rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-md);
        font-size: var(--font-sm);
        font-family: var(--primary-font);
        transition: all 0.2s ease;
        background: white;
    }

    .form-control-sm:focus,
    .form-select-sm:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(8, 127, 194, 0.1);
        outline: none;
    }

    /* Compact Textarea */
    textarea.form-control-sm {
        min-height: 80px;
        resize: vertical;
    }

    /* Compact Priority Pills */
    .priority-group-compact {
        display: flex;
        gap: var(--spacing-xs);
        margin-top: 0.25rem;
    }

    .priority-badge {
        position: relative;
    }

    .priority-badge input {
        position: absolute;
        opacity: 0;
    }

    .priority-badge label {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.625rem;
        border: 1px solid var(--gray-300);
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: var(--font-xs);
        font-weight: 500;
        font-family: var(--primary-font);
        background: white;
    }

    .priority-badge label:hover {
        border-color: var(--primary-color);
        background: var(--gray-50);
    }

    .priority-badge input:checked + label {
        color: white;
    }

    .priority-badge.low input:checked + label {
        background: var(--success-color);
        border-color: var(--success-color);
    }

    .priority-badge.medium input:checked + label {
        background: var(--warning-color);
        border-color: var(--warning-color);
    }

    .priority-badge.high input:checked + label {
        background: var(--danger-color);
        border-color: var(--danger-color);
    }

    /* Inline File Upload */
    .file-upload-compact {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: 0.375rem 0.75rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-md);
        background: white;
        min-height: 38px;
    }

    .file-upload-compact input[type="file"] {
        display: none;
    }

    .file-upload-label-compact {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        cursor: pointer;
        font-size: var(--font-sm);
        color: var(--primary-color);
        font-family: var(--primary-font);
    }

    .file-upload-label-compact:hover {
        text-decoration: underline;
    }

    .file-info {
        flex: 1;
        font-size: var(--font-xs);
        color: var(--gray-600);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .file-remove {
        color: var(--danger-color);
        cursor: pointer;
        font-size: var(--font-sm);
    }

    /* Message Counter */
    .input-with-counter {
        position: relative;
    }

    .char-counter {
        position: absolute;
        bottom: 0.25rem;
        right: 0.5rem;
        font-size: 10px;
        color: var(--gray-400);
        background: white;
        padding: 0 0.25rem;
        font-family: var(--primary-font);
    }

    /* Submit Section */
    .form-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--gray-200);
        margin-top: var(--spacing-lg);
    }

    .form-footer-info {
        font-size: var(--font-xs);
        color: var(--gray-600);
        font-family: var(--primary-font);
    }

    .form-footer-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    .btn-submit-compact {
        padding: 0.5rem 1.5rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-size: var(--font-sm);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-family: var(--primary-font);
    }

    .btn-submit-compact:hover {
        background: var(--secondary-color);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    /* Help Strip */
    .help-strip {
        display: flex;
        justify-content: space-around;
        padding: var(--spacing-md);
        background: var(--gray-100);
        border-radius: var(--radius-lg);
        margin-top: var(--spacing-md);
        gap: var(--spacing-lg);
    }

    .help-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: var(--font-sm);
        font-family: var(--primary-font);
    }

    .help-item i {
        color: var(--primary-color);
        font-size: var(--font-md);
    }

    /* Section Headers */
    .section-divider {
        display: flex;
        align-items: center;
        margin: var(--spacing-md) 0 var(--spacing-sm) 0;
        font-size: var(--font-sm);
        font-weight: 600;
        color: var(--primary-color);
        font-family: var(--primary-font);
    }

    .section-divider::before,
    .section-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: var(--gray-200);
    }

    .section-divider span {
        padding: 0 var(--spacing-sm);
    }

    /* Alert Compact */
    .alert-compact {
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: var(--font-sm);
    }

    /* Mobile Responsive */
    @media (max-width: 992px) {
        .form-grid-3col {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-full {
            grid-column: span 2;
        }

        .grid-span-2 {
            grid-column: span 2;
        }
    }

    @media (max-width: 768px) {
        .page-header-compact {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-sm);
        }

        .page-header-compact .header-actions {
            width: 100%;
        }

        .page-header-compact .btn {
            flex: 1;
            font-size: var(--font-xs);
        }

        .form-grid-3col,
        .form-grid-2col {
            grid-template-columns: 1fr;
            gap: var(--spacing-sm);
        }

        .grid-full,
        .grid-span-2 {
            grid-column: span 1;
        }

        .form-body-compact {
            padding: var(--spacing-md);
        }

        .priority-group-compact {
            flex-direction: column;
        }

        .priority-badge label {
            width: 100%;
            justify-content: center;
        }

        .help-strip {
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .form-footer {
            flex-direction: column;
            gap: var(--spacing-md);
            align-items: stretch;
        }

        .form-footer-actions {
            width: 100%;
        }

        .btn-submit-compact {
            width: 100%;
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .form-header-slim {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-xs);
        }

        .form-label-compact {
            font-size: 11px;
        }

        .form-control-sm,
        .form-select-sm {
            font-size: var(--font-xs);
            padding: 0.3rem 0.5rem;
        }
    }

    /* For larger screens - 4 column option */
    @media (min-width: 1400px) {
        .form-grid-3col {
            grid-template-columns: repeat(4, 1fr);
        }

        .grid-full {
            grid-column: span 4;
        }

        .grid-span-2 {
            grid-column: span 2;
        }

        .grid-span-3 {
            grid-column: span 3;
        }
    }
</style>

<div class="enquiry-form-container">
    <!-- Compact Header -->
    <div class="page-header-compact">
        <h4>
            <i class="fas fa-paper-plane" style="color: var(--primary-color);"></i>
            Send Business Enquiry
        </h4>
        <div class="header-actions">
            <a href="{% url 'customers:enquiries' %}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-list me-1"></i>My Enquiries
            </a>
            <a href="{% url 'customers:dashboard' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-home me-1"></i>Dashboard
            </a>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-compact">
                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Compact Form Card -->
    <div class="form-card-compact">
        <div class="form-header-slim">
            <h5><i class="fas fa-envelope me-2"></i>Business Enquiry Form</h5>
            <span class="header-info"><i class="fas fa-clock"></i> 24hr Response Time</span>
        </div>
        
        <div class="form-body-compact">
            <form method="post" id="enquiryForm" enctype="multipart/form-data" novalidate>
                {% csrf_token %}
                
                <!-- Contact Information - 3 Column Grid -->
                <div class="section-divider">
                    <span><i class="fas fa-user me-1"></i> Contact Details</span>
                </div>
                
                <div class="form-grid-3col">
                    <div class="form-group-compact">
                        <label for="name" class="form-label-compact required">Name</label>
                        <input type="text" class="form-control-sm" id="name" name="name" 
                               value="{{ user.first_name }} {{ user.last_name }}" required readonly>
                    </div>
                    
                    <div class="form-group-compact">
                        <label for="email" class="form-label-compact required">Email</label>
                        <input type="email" class="form-control-sm" id="email" name="email" 
                               value="{{ user.email }}" required readonly>
                    </div>
                    
                    <div class="form-group-compact">
                        <label for="mobile" class="form-label-compact">Mobile</label>
                        <input type="tel" class="form-control-sm" id="mobile" name="mobile" 
                               value="{{ user.mobile }}" readonly>
                    </div>
                </div>

                <!-- Business Category - 2 Column Grid -->
                <div class="form-grid-2col">
                    <div class="form-group-compact">
                        <label for="business_category" class="form-label-compact required">Business Category</label>
                        <select class="form-select-sm" id="business_category" name="business_category" required>
                            <option value="">Select Category</option>
                            {% for category in business_categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group-compact" id="subcategoryWrapper" style="display: none;">
                        <label for="business_subcategory" class="form-label-compact">Subcategory</label>
                        <select class="form-select-sm" id="business_subcategory" name="business_subcategory">
                            <option value="">Select Subcategory</option>
                        </select>
                    </div>
                </div>

                <!-- Enquiry Details Section -->
                <div class="section-divider">
                    <span><i class="fas fa-message me-1"></i> Enquiry Details</span>
                </div>

                <div class="form-grid-2col">
                    <div class="form-group-compact grid-span-2">
                        <label for="subject" class="form-label-compact">Subject (Optional)</label>
                        <input type="text" class="form-control-sm" id="subject" name="subject">
                        <small style="font-size: 11px; color: var(--gray-500);">Leave blank to auto-generate based on category</small>
                    </div>
                </div>

                <!-- Message -->
                <div class="form-grid-2col">
                    <div class="form-group-compact grid-span-2">
                        <label for="message" class="form-label-compact required">Message (Min. 10 characters)</label>
                        <div class="input-with-counter">
                            <textarea class="form-control-sm" id="message" name="message" 
                                      rows="4" maxlength="2000" minlength="10" required></textarea>
                            <span class="char-counter" id="messageCounter">0/2000</span>
                        </div>
                    </div>
                </div>

                <!-- Priority and Attachment in same row -->
                <div class="form-grid-2col">
                    <div class="form-group-compact">
                        <label class="form-label-compact">Priority</label>
                        <div class="priority-group-compact">
                            <div class="priority-badge low">
                                <input type="radio" id="priority_low" name="priority" value="low" checked>
                                <label for="priority_low">Low</label>
                            </div>
                            <div class="priority-badge medium">
                                <input type="radio" id="priority_medium" name="priority" value="medium">
                                <label for="priority_medium">Medium</label>
                            </div>
                            <div class="priority-badge high">
                                <input type="radio" id="priority_high" name="priority" value="high">
                                <label for="priority_high">High</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group-compact">
                        <label class="form-label-compact">Attachment</label>
                        <div class="file-upload-compact">
                            <input type="file" id="attachment" name="attachment" 
                                   accept=".png,.jpg,.jpeg,.pdf,.doc,.docx,.xls,.xlsx">
                            <label for="attachment" class="file-upload-label-compact">
                                <i class="fas fa-paperclip"></i>
                                <span id="fileText">Choose file (Max 10MB)</span>
                            </label>
                            <span class="file-info" id="fileInfo"></span>
                            <span class="file-remove" id="removeFile" style="display:none;">
                                <i class="fas fa-times"></i>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Submit Footer -->
                <div class="form-footer">
                    <div class="form-footer-info">
                        <i class="fas fa-lock me-1"></i> Your information is secure and confidential
                    </div>
                    <div class="form-footer-actions">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="this.form.reset();">
                            <i class="fas fa-redo me-1"></i>Reset
                        </button>
                        <button type="submit" class="btn-submit-compact" id="submitBtn">
                            <i class="fas fa-paper-plane"></i>
                            Send Enquiry
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Help Strip -->
    <div class="help-strip">
        <div class="help-item">
            <i class="fas fa-phone"></i>
            <div>
                <strong>Call Us</strong><br>
                <small>+91-1234567890</small>
            </div>
        </div>
        <div class="help-item">
            <i class="fas fa-envelope"></i>
            <div>
                <strong>Email</strong><br>
                <small>support@chrp-india.com</small>
            </div>
        </div>
        <div class="help-item">
            <i class="fas fa-clock"></i>
            <div>
                <strong>Business Hours</strong><br>
                <small>Mon-Sat: 9AM-6PM IST</small>
            </div>
        </div>
        <div class="help-item">
            <i class="fas fa-bolt"></i>
            <div>
                <strong>Response Time</strong><br>
                <small>Within 24 hours</small>
            </div>
        </div>
    </div>
</div>
{% endblock customer_content %}

{% block customer_extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const BASE_URL = window.location.pathname.includes('/customer/') ? '/customer/' : '/customers/';
    const form = document.getElementById('enquiryForm');
    const categorySelect = document.getElementById('business_category');
    const subcategorySelect = document.getElementById('business_subcategory');
    const subcategoryWrapper = document.getElementById('subcategoryWrapper');
    const messageTextarea = document.getElementById('message');
    const messageCounter = document.getElementById('messageCounter');
    const submitBtn = document.getElementById('submitBtn');
    
    // File upload elements
    const fileInput = document.getElementById('attachment');
    const fileText = document.getElementById('fileText');
    const fileInfo = document.getElementById('fileInfo');
    const removeFile = document.getElementById('removeFile');
    
    // Category change handler
    categorySelect.addEventListener('change', function() {
        const categoryId = this.value;
        
        if (categoryId) {
            fetch(`${BASE_URL}api/business-subcategories/${categoryId}/`)
                .then(response => response.json())
                .then(data => {
                    subcategorySelect.innerHTML = '<option value="">Select</option>';
                    
                    if (data.subcategories && data.subcategories.length > 0) {
                        data.subcategories.forEach(sub => {
                            const option = document.createElement('option');
                            option.value = sub.id;
                            option.textContent = sub.name;
                            subcategorySelect.appendChild(option);
                        });
                        subcategoryWrapper.style.display = 'block';
                    } else {
                        subcategoryWrapper.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error fetching subcategories:', error);
                    subcategoryWrapper.style.display = 'none';
                });
        } else {
            subcategoryWrapper.style.display = 'none';
            subcategorySelect.innerHTML = '<option value="">Select</option>';
        }
    });
    
    // Message counter
    messageTextarea.addEventListener('input', function() {
        const length = this.value.length;
        messageCounter.textContent = `${length}/2000`;
        
        if (length > 1800) {
            messageCounter.style.color = 'var(--danger-color)';
        } else if (length > 1500) {
            messageCounter.style.color = 'var(--warning-color)';
        } else {
            messageCounter.style.color = 'var(--gray-400)';
        }
    });
    
    // File upload handling
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        
        if (file) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert('File size must be less than 10MB');
                fileInput.value = '';
                return;
            }
            
            // Show file info
            const fileName = file.name.length > 20 ? 
                file.name.substring(0, 20) + '...' : file.name;
            fileText.textContent = fileName;
            fileInfo.textContent = `(${(file.size / 1024 / 1024).toFixed(1)}MB)`;
            removeFile.style.display = 'inline';
        }
    });
    
    // Remove file
    removeFile.addEventListener('click', function() {
        fileInput.value = '';
        fileText.textContent = 'Choose file (Max 10MB)';
        fileInfo.textContent = '';
        removeFile.style.display = 'none';
    });
    
    // Form validation
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        let isValid = true;
        let errorMessages = [];
        
        // Validate business category
        if (!categorySelect.value) {
            categorySelect.style.borderColor = 'var(--danger-color)';
            errorMessages.push('Please select a business category');
            isValid = false;
        } else {
            categorySelect.style.borderColor = '';
        }
        
        // Validate message (minimum 10 characters)
        if (!messageTextarea.value.trim() || messageTextarea.value.trim().length < 10) {
            messageTextarea.style.borderColor = 'var(--danger-color)';
            errorMessages.push('Message must be at least 10 characters long');
            isValid = false;
        } else {
            messageTextarea.style.borderColor = '';
        }
        
        if (!isValid) {
            // Show first error message
            if (errorMessages.length > 0) {
                alert(errorMessages[0]);
            }
            // Focus on first invalid field
            const firstInvalid = form.querySelector('[style*="danger-color"]');
            if (firstInvalid) {
                firstInvalid.focus();
            }
        } else {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            form.submit();
        }
    });
    
    // Reset form borders on input
    form.querySelectorAll('input, select, textarea').forEach(field => {
        field.addEventListener('input', function() {
            this.style.borderColor = '';
        });
    });
});
</script>
{% endblock customer_extra_js %}