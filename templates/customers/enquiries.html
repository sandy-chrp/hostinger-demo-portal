<!-- templates/customers/enquiries.html -->
{% extends 'customers/base.html' %}
{% load static %}

{% block customer_title %}My Enquiries - Customer Portal{% endblock %}
{% block page_title %}My Business Enquiries{% endblock %}

{% block customer_content %}
<style>
    /* Header Section with Actions and Filter */
    .page-header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        padding: var(--spacing-lg);
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-200);
        flex-wrap: wrap;
        gap: var(--spacing-md);
    }

    .page-header-title {
        flex: 1;
        min-width: 250px;
    }

    .page-header-actions {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
        flex-wrap: wrap;
    }

    /* Dropdown Customization */
    .dropdown-menu {
        min-width: 200px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--gray-200);
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: var(--font-sm);
        font-family: var(--primary-font);
    }

    .dropdown-item:hover {
        background: var(--gray-100);
        color: var(--primary-color);
    }

    .dropdown-item.active {
        background: var(--primary-color);
        color: white;
    }

    .dropdown-item.active i {
        color: white !important;
    }

    .dropdown-divider {
        margin: var(--spacing-xs) 0;
    }

    /* Statistics Cards */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
    }

    .stat-card {
        background: white;
        padding: var(--spacing-lg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-200);
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .stat-card-body {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .stat-info {
        flex: 1;
    }

    .stat-value {
        font-size: var(--font-4xl);
        font-weight: 700;
        color: var(--dark-color);
        font-family: var(--primary-font);
        line-height: 1;
    }

    .stat-label {
        font-size: var(--font-sm);
        color: var(--gray-600);
        margin-top: var(--spacing-xs);
        font-family: var(--primary-font);
    }

    .stat-icon-wrapper {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-md);
        font-size: var(--font-xl);
        color: white;
    }

    /* Enquiry Cards - Using customer-card pattern */
    .enquiry-item {
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
        margin-bottom: var(--spacing-lg);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .enquiry-item:hover {
        box-shadow: var(--shadow-lg);
    }

    .enquiry-item-header {
        padding: var(--spacing-lg);
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 1px solid var(--gray-200);
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .enquiry-item-header:hover {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    }

    .enquiry-header-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: var(--spacing-md);
    }

    .enquiry-title-section {
        flex: 1;
        min-width: 200px;
    }

    .enquiry-subject {
        font-size: var(--font-xl);
        font-weight: 700;
        color: var(--dark-color);
        margin: 0 0 var(--spacing-xs) 0;
        font-family: var(--heading-font);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .collapse-icon {
        font-size: var(--font-md);
        color: var(--primary-color);
        transition: transform 0.3s ease;
    }

    .collapse-icon.collapsed {
        transform: rotate(-90deg);
    }

    .enquiry-ref {
        font-size: var(--font-sm);
        color: var(--gray-500);
        font-family: var(--primary-font);
    }

    .enquiry-status-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: var(--font-xs);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        font-family: var(--primary-font);
    }

    .status-open {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }

    .status-in_progress {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
    }

    .status-answered {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #bfdbfe;
    }

    .status-closed {
        background: var(--gray-100);
        color: var(--gray-600);
        border: 1px solid var(--gray-300);
    }

    .enquiry-item-body {
        padding: var(--spacing-lg);
        display: none;
    }

    .enquiry-item-body.show {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Meta Information */
    .enquiry-meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-md);
        padding-bottom: var(--spacing-md);
        border-bottom: 1px solid var(--gray-200);
        margin-bottom: var(--spacing-md);
    }

    .meta-field {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: var(--font-sm);
        font-family: var(--primary-font);
    }

    .meta-field i {
        color: var(--primary-color);
        width: 16px;
        flex-shrink: 0;
    }

    .meta-field-label {
        font-weight: 600;
        color: var(--gray-700);
        margin-right: var(--spacing-xs);
    }

    .meta-field-value {
        color: var(--gray-600);
    }

    /* Message Box */
    .enquiry-message-box {
        background: var(--gray-100);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        border-left: 4px solid var(--primary-color);
        margin-bottom: var(--spacing-md);
    }

    .message-box-title {
        font-size: var(--font-md);
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: var(--spacing-sm);
        font-family: var(--primary-font);
    }

    .message-box-content {
        font-size: var(--font-sm);
        color: var(--gray-700);
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-word;
        font-family: var(--primary-font);
    }

    /* Attachment Section */
    .attachment-container {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        border: 1px solid #bae6fd;
        margin-bottom: var(--spacing-md);
    }

    .attachment-title {
        font-size: var(--font-sm);
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: var(--spacing-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-family: var(--primary-font);
    }

    .attachment-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: white;
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        border: 1px solid var(--gray-200);
        transition: all 0.3s ease;
    }

    .attachment-card:hover {
        border-color: var(--primary-color);
        box-shadow: var(--shadow-sm);
    }

    .attachment-info-wrapper {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        flex: 1;
    }

    .attachment-icon-box {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-md);
        color: white;
        font-size: var(--font-lg);
        flex-shrink: 0;
    }

    .file-icon-pdf { background: var(--gradient-primary); }
    .file-icon-doc { background: var(--gradient-success); }
    .file-icon-image { background: var(--gradient-warning); }
    .file-icon-default { background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%); }

    .attachment-details {
        flex: 1;
        min-width: 0;
    }

    .attachment-filename {
        font-size: var(--font-sm);
        font-weight: 600;
        color: var(--dark-color);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-family: var(--primary-font);
    }

    .attachment-size {
        font-size: var(--font-xs);
        color: var(--gray-500);
        font-family: var(--primary-font);
    }

    .attachment-actions {
        display: flex;
        gap: var(--spacing-xs);
    }

    .btn-attachment {
        padding: 0.375rem 0.75rem;
        border-radius: var(--radius-md);
        font-size: var(--font-sm);
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        transition: all 0.3s ease;
        font-family: var(--primary-font);
    }

    .btn-attachment-view {
        background: var(--primary-color);
        color: white;
        border: 1px solid var(--primary-color);
    }

    .btn-attachment-view:hover {
        background: var(--secondary-color);
        border-color: var(--secondary-color);
        transform: translateY(-1px);
    }

    .btn-attachment-download {
        background: white;
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
    }

    .btn-attachment-download:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
    }

    /* Response Section */
    .response-container {
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--gray-200);
    }

    .response-title {
        font-size: var(--font-md);
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: var(--spacing-md);
        font-family: var(--primary-font);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .response-card {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-sm);
        border: 1px solid #bbf7d0;
        border-left: 4px solid #16a34a;
    }

    .response-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-sm);
        flex-wrap: wrap;
        gap: var(--spacing-xs);
    }

    .response-author {
        font-size: var(--font-sm);
        font-weight: 600;
        color: #15803d;
        font-family: var(--primary-font);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .response-date {
        font-size: var(--font-xs);
        color: #166534;
        font-family: var(--primary-font);
    }

    .response-content {
        font-size: var(--font-sm);
        color: #14532d;
        line-height: 1.6;
        font-family: var(--primary-font);
        white-space: pre-wrap;
        word-break: break-word;
    }

    .no-responses-message {
        background: #fef3c7;
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        border-left: 4px solid #f59e0b;
        margin-top: var(--spacing-md);
    }

    .no-responses-message p {
        margin: 0;
        font-size: var(--font-sm);
        color: #92400e;
        font-family: var(--primary-font);
    }

    /* Action Buttons */
    .enquiry-actions {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--gray-200);
        flex-wrap: wrap;
    }

    /* Empty State */
    .empty-container {
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: 3rem var(--spacing-xl);
        text-align: center;
        border: 1px solid var(--gray-200);
    }

    .empty-icon {
        font-size: 4rem;
        color: var(--gray-300);
        margin-bottom: var(--spacing-lg);
    }

    .empty-title {
        font-size: var(--font-2xl);
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: var(--spacing-sm);
        font-family: var(--heading-font);
    }

    .empty-text {
        font-size: var(--font-md);
        color: var(--gray-600);
        margin-bottom: var(--spacing-lg);
        font-family: var(--primary-font);
    }

    /* Pagination */
    .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: var(--spacing-xl);
        gap: var(--spacing-md);
    }

    .pagination {
        display: flex;
        gap: var(--spacing-xs);
        list-style: none;
        padding: 0;
        margin: 0;
        flex-wrap: wrap;
        justify-content: center;
    }

    .page-item {
        display: inline-block;
    }

    .page-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-sm) 0.75rem;
        border: 1px solid var(--gray-300);
        background: white;
        color: var(--gray-700);
        border-radius: var(--radius-md);
        font-size: var(--font-sm);
        min-width: 40px;
        height: 40px;
        text-decoration: none;
        transition: all 0.3s ease;
        font-family: var(--primary-font);
        font-weight: 500;
    }

    .page-link:hover {
        background: var(--gray-100);
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }

    .page-item.active .page-link {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        font-weight: 600;
        box-shadow: var(--shadow-md);
    }

    .page-item.disabled .page-link {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
        background: var(--gray-100);
    }

    .page-info {
        font-size: var(--font-sm);
        color: var(--gray-600);
        font-family: var(--primary-font);
        padding: var(--spacing-sm) var(--spacing-md);
        background: white;
        border-radius: var(--radius-md);
        border: 1px solid var(--gray-200);
    }

    /* File Preview Modal */
    .file-modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        padding: var(--spacing-lg);
    }

    .file-modal-content {
        position: relative;
        max-width: 90%;
        max-height: 90vh;
        margin: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
    }

    .file-modal-close {
        position: absolute;
        top: var(--spacing-lg);
        right: var(--spacing-xl);
        color: white;
        font-size: 2rem;
        cursor: pointer;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        z-index: 10000;
        transition: all 0.3s ease;
    }

    .file-modal-close:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: scale(1.1);
    }

    .file-preview-img {
        max-width: 100%;
        max-height: 85vh;
        object-fit: contain;
        border-radius: var(--radius-md);
    }

    .file-preview-frame {
        width: 100%;
        height: 85vh;
        border: none;
        border-radius: var(--radius-md);
        background: white;
    }

    /* Floating Action Button (Mobile) */
    .fab-container {
        display: none;
        position: fixed;
        bottom: var(--spacing-xl);
        right: var(--spacing-xl);
        z-index: 1000;
    }

    .fab-button {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        border: none;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-xl);
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .fab-button:hover {
        background: var(--secondary-color);
        transform: scale(1.1);
        box-shadow: var(--shadow-xl);
        color: white;
    }

    /* Response Count Badge */
    .response-count-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: 0.25rem 0.5rem;
        background: #16a34a;
        color: white;
        border-radius: 12px;
        font-size: var(--font-xs);
        font-weight: 600;
        margin-left: var(--spacing-sm);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .page-header-section {
            padding: var(--spacing-md);
        }

        .page-header-title {
            width: 100%;
            margin-bottom: var(--spacing-md);
        }

        .page-header-title h4 {
            font-size: var(--font-xl);
        }

        .page-header-title p {
            font-size: var(--font-xs);
        }

        .page-header-actions {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-xs);
        }

        .page-header-actions .dropdown {
            grid-column: span 2;
        }

        .page-header-actions .dropdown button {
            width: 100%;
        }

        .page-header-actions .btn {
            width: 100%;
            justify-content: center;
            font-size: var(--font-sm);
            padding: var(--spacing-sm);
        }

        .page-header-actions .btn i {
            font-size: var(--font-sm);
        }

        .fab-container {
            display: block;
            bottom: var(--spacing-lg);
            right: var(--spacing-lg);
        }

        .stats-row {
            grid-template-columns: 1fr 1fr;
        }

        .stat-value {
            font-size: var(--font-3xl);
        }

        .enquiry-header-content {
            flex-direction: column;
        }

        .enquiry-subject {
            font-size: var(--font-lg);
        }

        .enquiry-meta-grid {
            grid-template-columns: 1fr;
        }

        .attachment-card {
            flex-direction: column;
            align-items: stretch;
        }

        .attachment-info-wrapper {
            margin-bottom: var(--spacing-sm);
        }

        .attachment-actions {
            width: 100%;
            justify-content: stretch;
        }

        .btn-attachment {
            flex: 1;
            justify-content: center;
        }

        .response-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .enquiry-actions {
            flex-direction: column;
        }

        .enquiry-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .pagination {
            gap: 4px;
        }

        .page-link {
            padding: var(--spacing-xs) 0.5rem;
            min-width: 36px;
            height: 36px;
            font-size: var(--font-xs);
        }

        .page-info {
            font-size: var(--font-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
        }
    }

    @media (max-width: 480px) {
        .stats-row {
            grid-template-columns: 1fr;
        }

        .enquiry-subject {
            font-size: var(--font-md);
        }

        .filter-btn {
            font-size: var(--font-xs);
            padding: 0.375rem 0.75rem;
        }
    }
</style>

<!-- Page Header with Actions and Filter -->
<div class="page-header-section">
    <div class="page-header-title">
        <h4 style="margin: 0; color: var(--dark-color); font-size: var(--font-2xl); font-weight: 600; font-family: var(--heading-font);">
            <i class="fas fa-envelope" style="color: var(--primary-color); margin-right: var(--spacing-xs);"></i>
            Business Enquiries Management
        </h4>
        <p style="margin: var(--spacing-xs) 0 0 0; color: var(--gray-600); font-size: var(--font-sm);">
            Track and manage all your business enquiries
        </p>
    </div>
    <div class="page-header-actions">
        <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-filter me-2"></i>
                {% if request.GET.status == 'open' %}
                    Open Enquiries
                {% elif request.GET.status == 'in_progress' %}
                    In Progress
                {% elif request.GET.status == 'answered' %}
                    Answered
                {% elif request.GET.status == 'closed' %}
                    Closed
                {% else %}
                    All Enquiries
                {% endif %}
                {% if page_obj %}
                    <span class="badge bg-primary ms-2">{{ page_obj.paginator.count }}</span>
                {% endif %}
            </button>
            <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                <li>
                    <a class="dropdown-item {% if not request.GET.status %}active{% endif %}" href="{% url 'customers:enquiries' %}">
                        <i class="fas fa-list me-2"></i>All Enquiries
                        {% if status_counts.total %}
                            <span class="badge bg-secondary float-end">{{ status_counts.total }}</span>
                        {% endif %}
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item {% if request.GET.status == 'open' %}active{% endif %}" href="?status=open">
                        <i class="fas fa-circle text-success me-2" style="font-size: 0.5rem;"></i>Open
                        {% if status_counts.open %}
                            <span class="badge bg-success float-end">{{ status_counts.open }}</span>
                        {% endif %}
                    </a>
                </li>
                <li>
                    <a class="dropdown-item {% if request.GET.status == 'in_progress' %}active{% endif %}" href="?status=in_progress">
                        <i class="fas fa-clock text-warning me-2"></i>In Progress
                        {% if status_counts.in_progress %}
                            <span class="badge bg-warning float-end">{{ status_counts.in_progress }}</span>
                        {% endif %}
                    </a>
                </li>
                <li>
                    <a class="dropdown-item {% if request.GET.status == 'answered' %}active{% endif %}" href="?status=answered">
                        <i class="fas fa-check-circle text-info me-2"></i>Answered
                        {% if status_counts.answered %}
                            <span class="badge bg-info float-end">{{ status_counts.answered }}</span>
                        {% endif %}
                    </a>
                </li>
                <li>
                    <a class="dropdown-item {% if request.GET.status == 'closed' %}active{% endif %}" href="?status=closed">
                        <i class="fas fa-times-circle text-secondary me-2"></i>Closed
                        {% if status_counts.closed %}
                            <span class="badge bg-secondary float-end">{{ status_counts.closed }}</span>
                        {% endif %}
                    </a>
                </li>
            </ul>
        </div>
        <a href="{% url 'customers:send_enquiry' %}" class="btn btn-primary">
            <i class="fas fa-plus-circle me-2"></i>
            Send New Enquiry
        </a>
        <a href="{% url 'customers:contact_sales' %}" class="btn btn-outline-secondary">
            <i class="fas fa-headset me-2"></i>
            Contact Sales
        </a>
    </div>
</div>

{% if page_obj.object_list %}
<!-- Enquiries List -->
{% for enquiry in page_obj.object_list %}
<div class="enquiry-item fade-in">
    <div class="enquiry-item-header" onclick="toggleEnquiry('enquiry-{{ enquiry.id }}')">
        <div class="enquiry-header-content">
            <div class="enquiry-title-section">
                <h5 class="enquiry-subject">
                    <i class="fas fa-chevron-down collapse-icon" id="icon-enquiry-{{ enquiry.id }}"></i>
                    {{ enquiry.subject }}
                    {% with response_count=enquiry.responses.all|length %}
                        {% if response_count > 0 %}
                            <span class="response-count-badge">
                                <i class="fas fa-reply"></i>
                                {{ response_count }}
                            </span>
                        {% endif %}
                    {% endwith %}
                </h5>
                <div class="enquiry-ref">
                    <i class="fas fa-hashtag"></i>
                    {{ enquiry.enquiry_id }}
                    <span style="margin: 0 var(--spacing-xs); color: var(--gray-400);">•</span>
                    <i class="fas fa-calendar"></i>
                    {{ enquiry.created_at|date:"M d, Y" }}
                </div>
            </div>
            <span class="enquiry-status-badge status-{{ enquiry.status }}">
                {% if enquiry.status == 'open' %}
                    <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                {% elif enquiry.status == 'in_progress' %}
                    <i class="fas fa-clock"></i>
                {% elif enquiry.status == 'answered' %}
                    <i class="fas fa-check-circle"></i>
                {% else %}
                    <i class="fas fa-times-circle"></i>
                {% endif %}
                {{ enquiry.get_status_display }}
            </span>
        </div>
    </div>
    
    <div class="enquiry-item-body" id="enquiry-{{ enquiry.id }}">
        <div class="enquiry-meta-grid">
            <div class="meta-field">
                <i class="fas fa-clock"></i>
                <span class="meta-field-label">Time:</span>
                <span class="meta-field-value">{{ enquiry.created_at|date:"g:i A" }}</span>
            </div>
            <div class="meta-field">
                <i class="fas fa-tag"></i>
                <span class="meta-field-label">Type:</span>
                <span class="meta-field-value">{{ enquiry.enquiry_type|title }}</span>
            </div>
            {% if enquiry.priority %}
            <div class="meta-field">
                <i class="fas fa-flag"></i>
                <span class="meta-field-label">Priority:</span>
                <span class="meta-field-value">{{ enquiry.priority|title }}</span>
            </div>
            {% endif %}
            {% if enquiry.assigned_to %}
            <div class="meta-field">
                <i class="fas fa-user-tie"></i>
                <span class="meta-field-label">Assigned To:</span>
                <span class="meta-field-value">{{ enquiry.assigned_to.get_full_name }}</span>
            </div>
            {% endif %}
        </div>
        
        <div class="enquiry-message-box">
            <div class="message-box-title">
                <i class="fas fa-comment-dots"></i> Your Message:
            </div>
            <div class="message-box-content">{{ enquiry.message }}</div>
        </div>
        
        {% if enquiry.attachment %}
        <div class="attachment-container">
            <div class="attachment-title">
                <i class="fas fa-paperclip"></i>
                Attachment
            </div>
            <div class="attachment-card">
                <div class="attachment-info-wrapper">
                    <div class="attachment-icon-box 
                        {% if enquiry.attachment.name|lower|slice:'-4:' == '.pdf' %}file-icon-pdf
                        {% elif enquiry.attachment.name|lower|slice:'-4:' == '.doc' or enquiry.attachment.name|lower|slice:'-5:' == '.docx' %}file-icon-doc
                        {% elif enquiry.attachment.name|lower|slice:'-4:' == '.png' or enquiry.attachment.name|lower|slice:'-4:' == '.jpg' or enquiry.attachment.name|lower|slice:'-5:' == '.jpeg' %}file-icon-image
                        {% else %}file-icon-default{% endif %}">
                        <i class="fas fa-file{% if enquiry.attachment.name|lower|slice:'-4:' == '.pdf' %}-pdf{% elif enquiry.attachment.name|lower|slice:'-4:' == '.doc' or enquiry.attachment.name|lower|slice:'-5:' == '.docx' %}-word{% elif enquiry.attachment.name|lower|slice:'-4:' == '.png' or enquiry.attachment.name|lower|slice:'-4:' == '.jpg' or enquiry.attachment.name|lower|slice:'-5:' == '.jpeg' %}-image{% endif %}"></i>
                    </div>
                    <div class="attachment-details">
                        <div class="attachment-filename">{{ enquiry.attachment_filename }}</div>
                        <div class="attachment-size">
                            {% if enquiry.attachment_size_mb %}{{ enquiry.attachment_size_mb }} MB • {% endif %}
                            {{ enquiry.created_at|date:"M d, Y" }}
                        </div>
                    </div>
                </div>
                <div class="attachment-actions">
                    {% if enquiry.attachment.name|lower|slice:'-4:' == '.png' or enquiry.attachment.name|lower|slice:'-4:' == '.jpg' or enquiry.attachment.name|lower|slice:'-5:' == '.jpeg' or enquiry.attachment.name|lower|slice:'-4:' == '.pdf' %}
                    <a href="javascript:void(0);" class="btn-attachment btn-attachment-view" 
                       onclick="event.stopPropagation(); viewFile('{{ enquiry.attachment.url }}', '{{ enquiry.attachment.name }}'); return false;">
                        <i class="fas fa-eye"></i> View
                    </a>
                    {% endif %}
                    <a href="{{ enquiry.attachment.url }}" class="btn-attachment btn-attachment-download" download onclick="event.stopPropagation();">
                        <i class="fas fa-download"></i> Download
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if enquiry.admin_notes %}
        <div class="enquiry-message-box" style="border-left-color: var(--warning-color); background: #fef3c7;">
            <div class="message-box-title" style="color: #92400e;">
                <i class="fas fa-sticky-note"></i> Admin Notes:
            </div>
            <div class="message-box-content" style="color: #78350f;">{{ enquiry.admin_notes }}</div>
        </div>
        {% endif %}
        
        {# Response Section - Fixed to show responses properly #}
        {% with visible_responses=enquiry.responses.all %}
            {% if visible_responses %}
                {% for response in visible_responses %}
                    {% if not response.is_internal_note %}
                        {% if forloop.first %}
                        <div class="response-container">
                            <div class="response-title">
                                <i class="fas fa-reply"></i> 
                                Responses from our team
                            </div>
                        {% endif %}
                        
                        <div class="response-card">
                            <div class="response-header">
                                <span class="response-author">
                                    <i class="fas fa-user-tie"></i>
                                    {% if response.responded_by %}
                                        {{ response.responded_by.get_full_name|default:response.responded_by.username }}
                                    {% else %}
                                        Support Team
                                    {% endif %}
                                </span>
                                <span class="response-date">
                                    <i class="fas fa-clock me-1"></i>
                                    {{ response.created_at|date:"M d, Y - g:i A" }}
                                </span>
                            </div>
                            <div class="response-content">{{ response.response_text }}</div>
                        </div>
                        
                        {% if forloop.last %}
                        </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="enquiry-actions">
            {% if enquiry.status == 'open' or enquiry.status == 'in_progress' %}
            <a href="{% url 'customers:contact_sales' %}" class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation();">
                <i class="fas fa-headset me-2"></i>Follow Up
            </a>
            {% endif %}
            
            {% if enquiry.status == 'answered' %}
            <span class="badge bg-success">
                <i class="fas fa-check me-1"></i>Response Received
            </span>
            {% endif %}
            
            {% if enquiry.status == 'closed' %}
            <span class="badge bg-secondary">
                <i class="fas fa-check-double me-1"></i>Resolved
            </span>
            {% endif %}
        </div>
    </div>
</div>
{% endfor %}

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<div class="pagination-container">
    <div class="page-info">
        Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} enquiries
    </div>
    
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" title="First Page">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" title="Previous Page">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">
                    <i class="fas fa-angle-double-left"></i>
                </span>
            </li>
            <li class="page-item disabled">
                <span class="page-link">
                    <i class="fas fa-angle-left"></i>
                </span>
            </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" title="Next Page">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" title="Last Page">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">
                    <i class="fas fa-angle-right"></i>
                </span>
            </li>
            <li class="page-item disabled">
                <span class="page-link">
                    <i class="fas fa-angle-double-right"></i>
                </span>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="empty-container">
    <div class="empty-icon">
        <i class="fas fa-envelope-open-text"></i>
    </div>
    <h3 class="empty-title">No Enquiries Found</h3>
    {% if request.GET.status %}
    <p class="empty-text">No enquiries found with status "{{ request.GET.status|title }}".</p>
    <div style="display: flex; gap: var(--spacing-sm); justify-content: center; flex-wrap: wrap;">
        <a href="{% url 'customers:enquiries' %}" class="btn btn-outline-primary">
            <i class="fas fa-list me-2"></i>View All Enquiries
        </a>
        <a href="{% url 'customers:send_enquiry' %}" class="btn btn-primary">
            <i class="fas fa-plus-circle me-2"></i>Send New Enquiry
        </a>
    </div>
    {% else %}
    <p class="empty-text">You haven't sent any business enquiries yet. Start by creating your first enquiry.</p>
    <div style="display: flex; gap: var(--spacing-sm); justify-content: center; flex-wrap: wrap; margin-top: var(--spacing-lg);">
        <a href="{% url 'customers:send_enquiry' %}" class="btn btn-primary btn-lg">
            <i class="fas fa-plus-circle me-2"></i>Send Your First Enquiry
        </a>
        <a href="{% url 'customers:contact_sales' %}" class="btn btn-outline-primary btn-lg">
            <i class="fas fa-headset me-2"></i>Contact Sales Team
        </a>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- File Preview Modal -->
<div id="filePreviewModal" class="file-modal">
    <span class="file-modal-close" onclick="closeFilePreview()">&times;</span>
    <div class="file-modal-content" id="filePreviewContent"></div>
</div>

<!-- Floating Action Button (Mobile) -->
<div class="fab-container">
    <a href="{% url 'customers:send_enquiry' %}" class="fab-button" title="Send New Enquiry">
        <i class="fas fa-plus"></i>
    </a>
</div>
{% endblock %}

{% block customer_extra_js %}
<script>
// Toggle enquiry collapse
function toggleEnquiry(enquiryId) {
    const body = document.getElementById(enquiryId);
    const icon = document.getElementById('icon-' + enquiryId);
    
    if (body.classList.contains('show')) {
        body.classList.remove('show');
        icon.classList.add('collapsed');
    } else {
        body.classList.add('show');
        icon.classList.remove('collapsed');
    }
}

// File preview functionality
function viewFile(fileUrl, fileName) {
    const modal = document.getElementById('filePreviewModal');
    const content = document.getElementById('filePreviewContent');
    const fileExtension = fileName.toLowerCase().split('.').pop();
    
    content.innerHTML = '';
    
    if (['png', 'jpg', 'jpeg', 'webp', 'gif'].includes(fileExtension)) {
        const img = document.createElement('img');
        img.src = fileUrl;
        img.className = 'file-preview-img';
        img.alt = fileName;
        content.appendChild(img);
    } else if (fileExtension === 'pdf') {
        const iframe = document.createElement('iframe');
        iframe.src = fileUrl;
        iframe.className = 'file-preview-frame';
        content.appendChild(iframe);
    } else {
        const message = document.createElement('div');
        message.style.cssText = 'color: white; text-align: center; padding: 50px;';
        message.innerHTML = `
            <i class="fas fa-file fa-3x mb-3"></i>
            <p>Preview not available for this file type.</p>
            <a href="${fileUrl}" download class="btn btn-primary mt-3">
                <i class="fas fa-download me-2"></i>Download File
            </a>
        `;
        content.appendChild(message);
    }
    
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeFilePreview() {
    const modal = document.getElementById('filePreviewModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

window.onclick = function(event) {
    const modal = document.getElementById('filePreviewModal');
    if (event.target === modal) {
        closeFilePreview();
    }
}

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeFilePreview();
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Fade in animation
    const cards = document.querySelectorAll('.enquiry-item');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Open first enquiry by default if there's only one
    const enquiries = document.querySelectorAll('.enquiry-item');
    if (enquiries.length === 1) {
        const firstEnquiryId = enquiries[0].querySelector('.enquiry-item-body').id;
        toggleEnquiry(firstEnquiryId);
    }
});
</script>
{% endblock %}