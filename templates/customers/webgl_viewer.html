{% extends 'customers/base.html' %}
{% load static %}

{% block title %}{{ demo.title }} | WebGL Viewer{% endblock %}

{% block customer_content %}
<style>
    /* Main container with responsive sizing */
    .webgl-container {
        width: 100%;
        height: calc(100vh - 120px);
        position: relative;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }
    
    /* Header with controls */
    .webgl-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background-color: white;
        border-bottom: 1px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        position: relative;
        z-index: 10;
    }
    
    .webgl-title {
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #1f2937;
        flex: 1;
        min-width: 0;
    }
    
    .webgl-title span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Content area for iframe */
    .webgl-content {
        width: 100%;
        height: calc(100% - 56px);
        position: relative;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Responsive iframe */
    .webgl-iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
        background: white;
    }
    
    /* Screen size options panel */
    .screen-options {
        position: absolute;
        top: 65px;
        right: 10px;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 0.5rem;
        z-index: 100;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        display: none;
        min-width: 200px;
    }
    
    .screen-options.show {
        display: block;
        animation: dropdownFadeIn 0.2s ease;
    }
    
    @keyframes dropdownFadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .screen-option {
        margin-bottom: 0.25rem;
        cursor: pointer;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: #4b5563;
    }
    
    .screen-option:last-child {
        margin-bottom: 0;
    }
    
    .screen-option:hover {
        background: #f3f4f6;
        color: #087fc2;
        transform: translateX(2px);
    }
    
    .screen-option:active {
        background: #e5e7eb;
    }
    
    .screen-option.active {
        background: #087fc2;
        color: white;
        font-weight: 600;
    }
    
    .screen-option.active:hover {
        background: #0669a0;
    }
    
    .screen-option i {
        width: 20px;
        text-align: center;
    }
    
    /* Responsive sizing for different devices */
    .size-desktop {
        /* Default size - full width */
    }
    
    .size-laptop {
        width: 85%;
        height: 85%;
        margin: 0 auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .size-tablet {
        width: 768px;
        max-width: 90%;
        height: 80%;
        margin: 0 auto;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .size-mobile {
        width: 375px;
        max-width: 85%;
        height: 75%;
        margin: 0 auto;
        border: 1px solid #dee2e6;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    /* Toolbar for additional controls */
    .webgl-toolbar {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    /* Button styling */
    .webgl-toolbar .btn {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.5rem 0.875rem;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 6px;
        transition: all 0.2s ease;
        white-space: nowrap;
        position: relative;
    }
    
    .webgl-toolbar .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .webgl-toolbar .btn:active {
        transform: translateY(0);
    }
    
    .webgl-toolbar .btn i {
        font-size: 0.875rem;
    }
    
    /* Screen size button */
    .screen-size-btn {
        position: relative;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
        .webgl-header {
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .webgl-title {
            font-size: 1rem;
        }
        
        .webgl-toolbar {
            width: 100%;
            justify-content: space-between;
        }
        
        .webgl-toolbar .btn span {
            display: none;
        }
        
        .webgl-toolbar .btn {
            padding: 0.5rem;
            min-width: 40px;
            justify-content: center;
        }
        
        .size-laptop,
        .size-tablet,
        .size-mobile {
            width: 100% !important;
        }
        
        .screen-options {
            right: 5px;
            top: 110px;
        }
    }
    
    @media (max-width: 480px) {
        .webgl-container {
            height: calc(100vh - 140px);
        }
    }
    
    /* Loading indicator */
    .loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 5;
    }
    
    .loading-indicator .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f4f6;
        border-top: 4px solid #087fc2;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .loading-indicator p {
        margin-top: 1rem;
        color: #6b7280;
        font-size: 0.875rem;
    }
    
    /* Hide loading when iframe loads */
    .webgl-content.loaded .loading-indicator {
        display: none;
    }
</style>

<div class="webgl-container" id="webglContainer">
    <!-- Header with title and controls -->
    <div class="webgl-header">
        <div class="webgl-title">
            <i class="fas fa-cube text-primary"></i>
            <span>{{ demo.title }}</span>
        </div>
        
        <div class="webgl-toolbar">
            <!-- Screen size options button -->
            <button class="btn btn-outline-secondary btn-sm screen-size-btn" id="screenSizeBtn" type="button">
                <i class="fas fa-desktop"></i>
                <span>Screen Size</span>
            </button>
            
            <!-- Fullscreen button -->
            <button class="btn btn-outline-primary btn-sm" id="fullscreenBtn" type="button">
                <i class="fas fa-expand"></i>
                <span>Fullscreen</span>
            </button>
            
            <!-- Like button -->
            <button class="btn {% if user_liked %}btn-danger{% else %}btn-outline-danger{% endif %} btn-sm" id="likeBtn" type="button">
                <i class="{% if user_liked %}fas{% else %}far{% endif %} fa-thumbs-up"></i>
                <span>{% if user_liked %}Liked{% else %}Like{% endif %}</span>
            </button>
            
            <!-- Back to demos button -->
            <a href="{% url 'customers:browse_demos' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left"></i>
                <span>Back</span>
            </a>
        </div>
    </div>
    
    <!-- Screen size options panel -->
    <div class="screen-options" id="screenOptions">
        <div class="screen-option active" data-size="desktop">
            <i class="fas fa-desktop"></i>Desktop (Full Width)
        </div>
        <div class="screen-option" data-size="laptop">
            <i class="fas fa-laptop"></i>Laptop (85%)
        </div>
        <div class="screen-option" data-size="tablet">
            <i class="fas fa-tablet-alt"></i>Tablet (768px)
        </div>
        <div class="screen-option" data-size="mobile">
            <i class="fas fa-mobile-alt"></i>Mobile (375px)
        </div>
    </div>
    
    <!-- WebGL Content Area -->
    <div class="webgl-content" id="webglContent">
        <!-- Loading indicator -->
        <div class="loading-indicator" id="loadingIndicator">
            <div class="spinner"></div>
            <p>Loading 3D content...</p>
        </div>
        
        <iframe 
            id="webglFrame"
            class="webgl-iframe" 
            src="{{ content_url }}"
            allowfullscreen
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-modals allow-downloads">
        </iframe>
    </div>
</div>
{% endblock %}

{% block customer_extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéÆ WebGL Viewer Initializing...');
    
    // Get UI elements
    const container = document.getElementById('webglContainer');
    const content = document.getElementById('webglContent');
    const iframe = document.getElementById('webglFrame');
    const screenSizeBtn = document.getElementById('screenSizeBtn');
    const screenOptions = document.getElementById('screenOptions');
    const sizeOptions = document.querySelectorAll('.screen-option');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const likeBtn = document.getElementById('likeBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    // Hide loading indicator when iframe loads
    if (iframe && loadingIndicator) {
        iframe.addEventListener('load', function() {
            console.log('‚úÖ WebGL content loaded');
            content.classList.add('loaded');
        });
        
        // Also handle errors
        iframe.addEventListener('error', function() {
            console.error('‚ùå WebGL content failed to load');
            loadingIndicator.innerHTML = '<p style="color: #ef4444;">Failed to load 3D content. Please refresh the page.</p>';
        });
    }
    
    // Screen size button toggle
    if (screenSizeBtn && screenOptions) {
        screenSizeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('üìê Screen size button clicked');
            
            const isShown = screenOptions.classList.contains('show');
            screenOptions.classList.toggle('show');
            
            console.log(`Screen options ${isShown ? 'hidden' : 'shown'}`);
        });
        
        // Close when clicking outside
        document.addEventListener('click', function(e) {
            if (!screenOptions.contains(e.target) && e.target !== screenSizeBtn && !screenSizeBtn.contains(e.target)) {
                screenOptions.classList.remove('show');
            }
        });
    }
    
    // Screen size options
    if (sizeOptions.length) {
        sizeOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.stopPropagation();
                console.log('üìè Screen size option clicked');
                
                // Remove active class from all options
                sizeOptions.forEach(opt => opt.classList.remove('active'));
                
                // Add active class to clicked option
                this.classList.add('active');
                
                // Get selected size
                const size = this.getAttribute('data-size');
                console.log(`Changing size to: ${size}`);
                
                // Remove all size classes from container
                container.classList.remove('size-desktop', 'size-laptop', 'size-tablet', 'size-mobile');
                
                // Add selected size class
                if (size !== 'desktop') {
                    container.classList.add(`size-${size}`);
                }
                
                // Update button icon
                const iconMap = {
                    desktop: 'fa-desktop',
                    laptop: 'fa-laptop',
                    tablet: 'fa-tablet-alt',
                    mobile: 'fa-mobile-alt'
                };
                
                const btnIcon = screenSizeBtn.querySelector('i');
                if (btnIcon) {
                    btnIcon.className = `fas ${iconMap[size]}`;
                }
                
                // Hide options panel
                screenOptions.classList.remove('show');
                
                // Trigger resize event for iframe
                window.dispatchEvent(new Event('resize'));
                
                console.log(`‚úÖ Screen size changed to: ${size}`);
            });
        });
    }
    
    // Fullscreen button
    if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('üñ•Ô∏è Fullscreen button clicked');
            
            // Element to make fullscreen
            const element = content || container;
            
            if (!document.fullscreenElement) {
                console.log('‚û°Ô∏è Entering fullscreen');
                
                // Request fullscreen with different browser prefixes
                const requestFullscreen = element.requestFullscreen || 
                                        element.mozRequestFullScreen || 
                                        element.webkitRequestFullscreen || 
                                        element.msRequestFullscreen;
                
                if (requestFullscreen) {
                    requestFullscreen.call(element).catch(err => {
                        console.error('‚ùå Fullscreen error:', err);
                        alert('Fullscreen not supported or blocked by browser');
                    });
                }
            } else {
                console.log('‚¨ÖÔ∏è Exiting fullscreen');
                
                // Exit fullscreen
                const exitFullscreen = document.exitFullscreen || 
                                      document.mozCancelFullScreen || 
                                      document.webkitExitFullscreen || 
                                      document.msExitFullscreen;
                
                if (exitFullscreen) {
                    exitFullscreen.call(document);
                }
            }
        });
    }
    
    // Like button
    if (likeBtn) {
        likeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('‚ù§Ô∏è Like button clicked');
            
            likeBtn.disabled = true;
            
            // Get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            const csrfToken = getCookie('csrftoken');
            
            // Make AJAX request
            fetch("{% url 'customers:toggle_demo_like' demo.id %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Like response:', data);
                
                const icon = likeBtn.querySelector('i');
                const span = likeBtn.querySelector('span');
                
                if (data.liked) {
                    icon.className = 'fas fa-thumbs-up';
                    if (span) span.textContent = 'Liked';
                    likeBtn.classList.remove('btn-outline-danger');
                    likeBtn.classList.add('btn-danger');
                } else {
                    icon.className = 'far fa-thumbs-up';
                    if (span) span.textContent = 'Like';
                    likeBtn.classList.remove('btn-danger');
                    likeBtn.classList.add('btn-outline-danger');
                }
                
                likeBtn.disabled = false;
            })
            .catch(error => {
                console.error('‚ùå Like error:', error);
                alert('Failed to update like status. Please try again.');
                likeBtn.disabled = false;
            });
        });
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Don't trigger if user is typing in an input
        if (document.activeElement.tagName.match(/input|textarea/i)) {
            return;
        }
        
        // F key for fullscreen
        if (e.key === 'f' || e.key === 'F') {
            e.preventDefault();
            fullscreenBtn.click();
        }
        
        // 1-4 keys for screen sizes
        if (e.key >= '1' && e.key <= '4') {
            e.preventDefault();
            const index = parseInt(e.key) - 1;
            if (sizeOptions[index]) {
                sizeOptions[index].click();
            }
        }
        
        // ESC key to close screen options
        if (e.key === 'Escape' && screenOptions.classList.contains('show')) {
            screenOptions.classList.remove('show');
        }
    });
    
    // Handle fullscreen change
    function updateFullscreenButton() {
        if (!fullscreenBtn) return;
        
        const icon = fullscreenBtn.querySelector('i');
        const span = fullscreenBtn.querySelector('span');
        
        if (document.fullscreenElement || 
            document.webkitFullscreenElement || 
            document.mozFullScreenElement || 
            document.msFullscreenElement) {
            
            console.log('‚úÖ Fullscreen active');
            if (icon) icon.className = 'fas fa-compress';
            if (span) span.textContent = 'Exit Fullscreen';
        } else {
            console.log('‚Ü©Ô∏è Fullscreen exited');
            if (icon) icon.className = 'fas fa-expand';
            if (span) span.textContent = 'Fullscreen';
        }
    }
    
    document.addEventListener('fullscreenchange', updateFullscreenButton);
    document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
    document.addEventListener('mozfullscreenchange', updateFullscreenButton);
    document.addEventListener('MSFullscreenChange', updateFullscreenButton);
    
    // Make iframe responsive to window resizing
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            console.log('üìê Window resized');
            if (iframe) {
                iframe.style.width = '100%';
                iframe.style.height = '100%';
            }
        }, 250);
    });
    
    // Double click content for fullscreen
    if (content) {
        content.addEventListener('dblclick', function(e) {
            // Don't trigger if double-clicking the iframe itself
            if (e.target === content) {
                fullscreenBtn.click();
            }
        });
    }
    
    console.log('‚úÖ WebGL Viewer Initialized');
});
</script>
{% endblock %}