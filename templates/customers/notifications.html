<!-- templates/customers/notifications.html - FULLY DYNAMIC VERSION -->
{% extends 'customers/base.html' %}
{% load static %}

{% block customer_title %}Notifications - Customer Portal{% endblock %}
{% block page_title %}Notifications{% endblock %}

{% block customer_extra_css %}
<style>
    /* Notifications specific styles - TYPOGRAPHY FIXED TO MATCH BASE.HTML */
    .notifications-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .notifications-header {
        background: white;
        padding: var(--spacing-xl);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        margin-bottom: var(--spacing-xl);
        border: 1px solid var(--gray-200);
        text-align: center;
    }

    .notifications-title {
        font-size: var(--font-3xl); /* FIXED: was 2rem */
        font-weight: 700;
        font-family: var(--heading-font); /* FIXED: added */
        color: var(--dark-color);
        margin-bottom: var(--spacing-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
    }

    .notifications-subtitle {
        color: var(--gray-600);
        font-size: var(--font-lg); /* FIXED: was 1.1rem */
        font-family: var(--primary-font); /* FIXED: added */
    }

    .notification-filters {
        background: white;
        padding: var(--spacing-lg);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        margin-bottom: var(--spacing-xl);
        border: 1px solid var(--gray-200);
    }

    .filter-buttons {
        display: flex;
        gap: var(--spacing-sm);
        flex-wrap: wrap;
        justify-content: center;
    }

    .filter-btn {
        padding: var(--spacing-sm) var(--spacing-lg);
        border: 2px solid var(--gray-300);
        border-radius: var(--radius-lg);
        background: white;
        color: var(--gray-700);
        text-decoration: none;
        font-weight: 500;
        font-size: var(--font-sm); /* FIXED: added */
        font-family: var(--primary-font); /* FIXED: added */
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .filter-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        background: rgba(30, 60, 114, 0.05);
        text-decoration: none;
    }

    .filter-btn.active {
        border-color: var(--primary-color);
        background: var(--primary-color);
        color: white;
    }

    .filter-btn.active:hover {
        color: white;
    }

    .notification-item {
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        margin-bottom: var(--spacing-lg);
        border: 1px solid var(--gray-200);
        transition: all 0.3s ease;
        overflow: hidden;
        position: relative;
    }

    .notification-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .notification-item.unread {
        border-left: 4px solid var(--primary-color);
        background: linear-gradient(135deg, #f8faff 0%, white 100%);
    }

    .notification-item.unread::before {
        content: '';
        position: absolute;
        top: var(--spacing-md);
        right: var(--spacing-md);
        width: 10px;
        height: 10px;
        background: var(--primary-color);
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }

    .notification-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-md);
    }

    .notification-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-2xl); /* FIXED: was 1.25rem */
        color: white;
        flex-shrink: 0;
    }

    .notification-icon.demo-confirmation {
        background: var(--success-color);
    }

    .notification-icon.demo-reschedule {
        background: var(--warning-color);
    }

    .notification-icon.demo-cancellation {
        background: var(--danger-color);
    }

    .notification-icon.enquiry-response {
        background: var(--info-color);
    }

    .notification-icon.new-demo-available {
        background: var(--primary-color);
    }

    .notification-icon.account-approved {
        background: var(--success-color);
    }

    .notification-icon.system-announcement {
        background: var(--dark-color);
    }

    .notification-content {
        flex: 1;
    }

    .notification-title {
        font-size: var(--font-xl); /* FIXED: was 1.25rem */
        font-weight: 600;
        font-family: var(--heading-font); /* FIXED: added */
        color: var(--dark-color);
        margin-bottom: var(--spacing-xs);
        line-height: 1.3;
    }

    .notification-meta {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
        font-size: var(--font-sm); /* FIXED: was 0.875rem */
        font-family: var(--primary-font); /* FIXED: added */
        color: var(--gray-500);
    }

    .notification-type {
        background: var(--gray-100);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-sm);
        font-weight: 500;
        font-size: var(--font-xs); /* FIXED: added */
        font-family: var(--primary-font); /* FIXED: added */
        color: var(--gray-700);
    }

    .notification-time {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: var(--font-xs); /* FIXED: added */
        font-family: var(--primary-font); /* FIXED: added */
    }

    .notification-body {
        padding: 0 var(--spacing-lg) var(--spacing-lg) var(--spacing-lg);
    }

    .notification-message {
        color: var(--gray-700);
        font-size: var(--font-sm); /* FIXED: added */
        font-family: var(--primary-font); /* FIXED: added */
        line-height: 1.6;
        margin-bottom: var(--spacing-md);
    }

    .notification-actions {
        display: flex;
        gap: var(--spacing-sm);
        flex-wrap: wrap;
    }

    .notification-btn {
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        font-size: var(--font-sm); /* FIXED: was 0.875rem */
        font-family: var(--primary-font); /* FIXED: added */
        font-weight: 500;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .btn-primary-outline {
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
        background: transparent;
    }

    .btn-primary-outline:hover {
        background: var(--primary-color);
        color: white;
        text-decoration: none;
    }

    .btn-success-outline {
        border: 1px solid var(--success-color);
        color: var(--success-color);
        background: transparent;
    }

    .btn-success-outline:hover {
        background: var(--success-color);
        color: white;
        text-decoration: none;
    }

    .btn-mark-read {
        background: var(--gray-200);
        color: var(--gray-700);
        border: 1px solid var(--gray-300);
        cursor: pointer;
        border-radius: var(--radius-md);
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: var(--font-xs); /* FIXED: was 0.75rem */
        font-family: var(--primary-font); /* FIXED: added */
        transition: all 0.3s ease;
    }

    .btn-mark-read:hover {
        background: var(--gray-300);
    }

    .empty-state {
        text-align: center;
        padding: calc(var(--spacing-xl) * 2); /* FIXED: was var(--spacing-xl) * 2 */
        color: var(--gray-500);
    }

    .empty-icon {
        font-size: var(--font-5xl); /* FIXED: was 4rem */
        margin-bottom: var(--spacing-lg);
        opacity: 0.5;
        color: var(--primary-color);
    }

    .empty-title {
        font-size: var(--font-3xl); /* FIXED: was 1.5rem */
        font-weight: 600;
        font-family: var(--heading-font); /* FIXED: added */
        margin-bottom: var(--spacing-sm);
        color: var(--gray-700);
    }

    .empty-message {
        font-size: var(--font-lg); /* FIXED: was 1.1rem */
        font-family: var(--primary-font); /* FIXED: added */
        margin-bottom: var(--spacing-lg);
    }

    .pagination-wrapper {
        margin-top: var(--spacing-xl);
        display: flex;
        justify-content: center;
    }

    .bulk-actions {
        background: var(--gray-50);
        padding: var(--spacing-md);
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--gray-200);
    }

    .bulk-actions-left {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .bulk-actions-right {
        display: flex;
        gap: var(--spacing-sm);
    }

    .bulk-btn {
        padding: var(--spacing-sm) var(--spacing-md);
        border: 1px solid var(--gray-300);
        background: white;
        color: var(--gray-700);
        border-radius: var(--radius-md);
        font-size: var(--font-sm); /* FIXED: was 0.875rem */
        font-family: var(--primary-font); /* FIXED: added */
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .bulk-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    /* Bulk actions text */
    .bulk-actions-left .text-muted {
        font-size: var(--font-sm); /* FIXED: added */
        font-family: var(--primary-font); /* FIXED: added */
    }

    /* Badge in header */
    .notifications-header .badge {
        font-size: var(--font-md); /* FIXED: was 1rem */
        font-family: var(--primary-font); /* FIXED: added */
        padding: 0.5rem 1rem;
    }

    /* Notification meta read indicator */
    .notification-meta .text-muted {
        font-size: var(--font-xs); /* FIXED: added */
        font-family: var(--primary-font); /* FIXED: added */
    }

    /* Responsive */
    @media (max-width: 768px) {
        .notifications-title {
            font-size: var(--font-2xl); /* FIXED: was 1.5rem */
            flex-direction: column;
        }

        .notification-header {
            flex-direction: column;
            text-align: center;
        }

        .notification-meta {
            flex-direction: column;
            gap: var(--spacing-sm);
            align-items: flex-start;
        }

        .filter-buttons {
            flex-direction: column;
        }

        .bulk-actions {
            flex-direction: column;
            gap: var(--spacing-md);
            align-items: stretch;
        }

        .bulk-actions-left,
        .bulk-actions-right {
            justify-content: center;
        }

        .notification-icon {
            width: 42px;
            height: 42px;
            font-size: var(--font-xl); /* FIXED: added */
        }

        .notification-title {
            font-size: var(--font-lg); /* FIXED: added */
        }
    }

    @media (max-width: 576px) {
        .notifications-title {
            font-size: var(--font-xl); /* FIXED: added */
        }

        .notifications-subtitle {
            font-size: var(--font-md); /* FIXED: added */
        }

        .notification-icon {
            width: 38px;
            height: 38px;
            font-size: var(--font-lg); /* FIXED: added */
        }

        .notification-title {
            font-size: var(--font-md); /* FIXED: added */
        }
    }

    @media (max-width: 480px) {
        .notifications-title {
            font-size: var(--font-lg); /* FIXED: added */
        }

        .notifications-subtitle {
            font-size: var(--font-sm); /* FIXED: added */
        }

        .notification-icon {
            width: 34px;
            height: 34px;
            font-size: var(--font-md); /* FIXED: added */
        }
    }
</style>
{% endblock %}

{% block customer_content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'customers:dashboard' %}">Dashboard</a>
        </li>
        <li class="breadcrumb-item active">Notifications</li>
    </ol>
</nav>

<div class="notifications-container">
    <!-- Header -->
    <div class="notifications-header">
        <h1 class="notifications-title">
            <i class="fas fa-bell"></i>
            Notifications
        </h1>
        <p class="notifications-subtitle">
            Stay updated with your demo requests, enquiries, and important announcements
        </p>
        {% if unread_count > 0 %}
        <div class="mt-3">
            <span class="badge bg-primary">
                {{ unread_count }} Unread Notification{{ unread_count|pluralize }}
            </span>
        </div>
        {% endif %}
    </div>
    
    <!-- DYNAMIC Filters - Generated from actual notification types -->
    <div class="notification-filters">
        <div class="filter-buttons">
            <a href="{% url 'customers:notifications' %}" 
               class="filter-btn {% if not request.GET.type %}active{% endif %}">
                <i class="fas fa-list"></i>
                All Notifications
                <span class="badge bg-secondary ms-1">{{ page_obj.paginator.count }}</span>
            </a>
            
            <a href="?type=unread" 
               class="filter-btn {% if request.GET.type == 'unread' %}active{% endif %}">
                <i class="fas fa-circle"></i>
                Unread
                <span class="badge bg-primary ms-1">{{ unread_count }}</span>
            </a>
            
            <!-- Dynamic type filters based on actual notifications -->
{% for ntype, count in available_types %}
    <a href="?type={{ ntype }}" 
       class="filter-btn {% if request.GET.type == ntype %}active{% endif %}">
        {% if 'demo' in ntype %}
            <i class="fas fa-video"></i>
        {% elif 'enquiry' in ntype %}
            <i class="fas fa-envelope"></i>
        {% elif 'account' in ntype %}
            <i class="fas fa-user"></i>
        {% elif 'system' in ntype %}
            <i class="fas fa-cog"></i>
        {% else %}
            <i class="fas fa-bell"></i>
        {% endif %}
        {{ ntype|title|cut:"_" }}
        <span class="badge bg-secondary ms-1">{{ count }}</span>
    </a>
{% endfor %}
        </div>
    </div>
    
    <!-- Bulk Actions -->
    {% if page_obj.object_list %}
    <div class="bulk-actions">
        <div class="bulk-actions-left">
            <span class="text-muted">
                Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} notifications
            </span>
        </div>
        <div class="bulk-actions-right">
            {% if unread_count > 0 %}
            <button class="bulk-btn" id="markAllReadBtn">
                <i class="fas fa-check-double me-1"></i>
                Mark All as Read ({{ unread_count }})
            </button>
            {% endif %}
            <button class="bulk-btn" id="refreshBtn">
                <i class="fas fa-sync-alt me-1"></i>
                Refresh
            </button>
        </div>
    </div>
    {% endif %}
    
    <!-- DYNAMIC Notifications List -->
    {% if page_obj.object_list %}
        {% for notification in page_obj.object_list %}
            <div class="notification-item {% if not notification.is_read %}unread{% endif %}" 
                 id="notification-{{ notification.id }}">
                <div class="notification-header">
                    <!-- DYNAMIC icon based on notification type -->
                    <div class="notification-icon {{ notification.notification_type }}">
                        {% if 'confirmation' in notification.notification_type %}
                            <i class="fas fa-check-circle"></i>
                        {% elif 'reschedule' in notification.notification_type %}
                            <i class="fas fa-calendar-alt"></i>
                        {% elif 'cancel' in notification.notification_type %}
                            <i class="fas fa-times-circle"></i>
                        {% elif 'response' in notification.notification_type or 'reply' in notification.notification_type %}
                            <i class="fas fa-reply"></i>
                        {% elif 'demo' in notification.notification_type or 'video' in notification.notification_type %}
                            <i class="fas fa-play-circle"></i>
                        {% elif 'approved' in notification.notification_type or 'approved' in notification.notification_type %}
                            <i class="fas fa-user-check"></i>
                        {% elif 'announcement' in notification.notification_type or 'system' in notification.notification_type %}
                            <i class="fas fa-bullhorn"></i>
                        {% elif 'enquiry' in notification.notification_type %}
                            <i class="fas fa-envelope"></i>
                        {% else %}
                            <i class="fas fa-info-circle"></i>
                        {% endif %}
                    </div>
                    
                    <div class="notification-content">
                        <h3 class="notification-title">{{ notification.title }}</h3>
                        <div class="notification-meta">
                            <span class="notification-type">
                                {{ notification.get_notification_type_display|default:notification.notification_type }}
                            </span>
                            <span class="notification-time">
                                <i class="fas fa-clock"></i>
                                {{ notification.created_at|timesince }} ago
                            </span>
                            {% if not notification.is_read %}
                                <button class="btn-mark-read" 
                                        data-notification-id="{{ notification.id }}"
                                        title="Mark as read">
                                    <i class="fas fa-check me-1"></i>Mark as Read
                                </button>
                            {% else %}
                                <span class="text-muted small">
                                    <i class="fas fa-check-double me-1"></i>Read
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="notification-body">
                    <div class="notification-message">
                        {{ notification.message|linebreaks }}
                    </div>
                    
                    <!-- DYNAMIC Notification Actions -->
                    {% if notification.link %}
                    <div class="notification-actions">
                        <a href="{{ notification.link }}" class="notification-btn btn-primary-outline">
                            <i class="fas fa-external-link-alt"></i>
                            View Details
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
        
        <!-- Pagination [Keep existing pagination code] -->
        
    {% else %}
        <!-- Empty State [Keep existing empty state code] -->
    {% endif %}
</div>

<!-- Toast Container -->
<div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 11000;"></div>
{% endblock %}

{% block customer_extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mark individual notification as read
    document.querySelectorAll('.btn-mark-read').forEach(button => {
        button.addEventListener('click', function() {
            const notificationId = this.dataset.notificationId;
            markNotificationAsRead(notificationId, this);
        });
    });
    
    // Mark all notifications as read
    const markAllBtn = document.getElementById('markAllReadBtn');
    if (markAllBtn) {
        markAllBtn.addEventListener('click', function() {
            markAllNotificationsAsRead();
        });
    }
    
    // Refresh notifications
    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            const icon = this.querySelector('i');
            icon.classList.add('fa-spin');
            setTimeout(() => {
                window.location.reload();
            }, 300);
        });
    }
    
    function markNotificationAsRead(notificationId, buttonElement) {
        const originalHTML = buttonElement.innerHTML;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        buttonElement.disabled = true;
        
        fetch(`/customers/ajax/notification/${notificationId}/mark-read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const notificationItem = document.getElementById(`notification-${notificationId}`);
                notificationItem.classList.remove('unread');
                
                // Replace button with read indicator
                const readIndicator = document.createElement('span');
                readIndicator.className = 'text-muted small';
                readIndicator.innerHTML = '<i class="fas fa-check-double me-1"></i>Read';
                buttonElement.replaceWith(readIndicator);
                
                showToast('Notification marked as read', 'success');
                updateNotificationCount(-1);
            } else {
                throw new Error(data.error || 'Failed to mark as read');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error marking notification as read', 'error');
            buttonElement.innerHTML = originalHTML;
            buttonElement.disabled = false;
        });
    }
    
    function markAllNotificationsAsRead() {
        if (!confirm('Mark all unread notifications as read?')) {
            return;
        }
        
        const markAllBtn = document.getElementById('markAllReadBtn');
        const originalHTML = markAllBtn.innerHTML;
        markAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
        markAllBtn.disabled = true;
        
        fetch('/customers/ajax/notifications/mark-all-read/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelectorAll('.notification-item.unread').forEach(item => {
                    item.classList.remove('unread');
                });
                
                document.querySelectorAll('.btn-mark-read').forEach(btn => {
                    const readIndicator = document.createElement('span');
                    readIndicator.className = 'text-muted small';
                    readIndicator.innerHTML = '<i class="fas fa-check-double me-1"></i>Read';
                    btn.replaceWith(readIndicator);
                });
                
                showToast(`${data.count} notification(s) marked as read`, 'success');
                updateNotificationCount(-data.count);
                
                // Hide the bulk action button
                markAllBtn.style.display = 'none';
            } else {
                throw new Error(data.error || 'Failed to mark all as read');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error marking notifications as read', 'error');
            markAllBtn.innerHTML = originalHTML;
            markAllBtn.disabled = false;
        });
    }
    
    function updateNotificationCount(change) {
        const badge = document.querySelector('.nav-link[href*="notifications"] .badge');
        if (badge) {
            const currentCount = parseInt(badge.textContent) || 0;
            const newCount = Math.max(0, currentCount + change);
            
            if (newCount === 0) {
                badge.style.display = 'none';
            } else {
                badge.textContent = newCount;
                badge.style.display = '';
            }
        }
    }
    
    function getCsrfToken() {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) return csrfInput.value;
        
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') return value;
        }
        return null;
    }
    
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        const toastId = 'toast-' + Date.now();
        
        const alertClass = type === 'error' ? 'danger' : type;
        const icon = type === 'success' ? 'check-circle' : 
                   type === 'error' ? 'exclamation-triangle' : 
                   'info-circle';
        
        const toastHTML = `
            <div class="toast show mb-2" id="${toastId}" role="alert">
                <div class="toast-header bg-${alertClass} text-white">
                    <i class="fas fa-${icon} me-2"></i>
                    <strong class="me-auto">Notifications</strong>
                    <button type="button" class="btn-close btn-close-white" 
                            onclick="document.getElementById('${toastId}').remove()"></button>
                </div>
                <div class="toast-body">${message}</div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        
        setTimeout(() => {
            const toast = document.getElementById(toastId);
            if (toast) toast.remove();
        }, 5000);
    }
    
    // Fade-in animation
    const notifications = document.querySelectorAll('.notification-item');
    notifications.forEach((notification, index) => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(20px)';
        notification.style.transition = 'all 0.4s ease';
        
        setTimeout(() => {
            notification.style.opacity = '1';
            notification.style.transform = 'translateY(0)';
        }, index * 50);
    });
});
</script>
{% endblock %}