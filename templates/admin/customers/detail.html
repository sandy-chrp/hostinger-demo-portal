<!-- templates/admin/customers/detail.html - FIXED AJAX VERSION -->
{% extends 'admin/base.html' %}
{% load static %}

{% block admin_title %}Customer Details{% endblock %}
{% block page_title %}{{ customer.full_name }} - Customer Details{% endblock %}

{% block breadcrumb %}
<div class="admin-breadcrumb">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a href="{% url 'core:admin_dashboard' %}">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'core:admin_users' %}">
                    <i class="fas fa-users me-1"></i>Customers
                </a>
            </li>
            <li class="breadcrumb-item active">{{ customer.first_name }}</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block admin_extra_css %}
<style>
    /* ========================================
       PROFESSIONAL TYPOGRAPHY SYSTEM 
       Matching Admin Base Template
       ======================================== */
    
    /* Customer Header with Professional Font Sizes */
    .customer-header {
        background: linear-gradient(135deg, #087fc2 0%, #0669a0 100%);
        color: white;
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .customer-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }

    /* Avatar with Responsive Sizing */
    .customer-avatar {
        width: 80px;
        height: 80px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: var(--font-4xl);
        margin-bottom: 0.75rem;
        border: 3px solid rgba(255, 255, 255, 0.3);
        position: relative;
        z-index: 1;
    }

    /* Customer Name - Professional Size */
    .customer-info h1 {
        font-size: var(--font-3xl);
        font-weight: 600;
        margin-bottom: 0.5rem;
        line-height: 1.2;
        font-family: var(--heading-font);
    }

    .customer-info p {
        font-size: var(--font-base);
        opacity: 0.95;
        margin-bottom: 0;
    }

    .customer-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
        opacity: 0.95;
        font-size: var(--font-sm);
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: var(--font-sm);
    }

    .meta-item i {
        font-size: var(--font-sm);
    }

    /* Professional Status Badge */
    .status-badge {
        padding: 0.35rem 0.7rem;
        border-radius: var(--radius-md);
        font-size: var(--font-xs);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
    }

    .status-approved {
        background: rgba(16, 185, 129, 0.2);
        color: white;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-pending {
        background: rgba(245, 158, 11, 0.2);
        color: white;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .status-blocked {
        background: rgba(239, 68, 68, 0.2);
        color: white;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    /* Collapsible Section with Professional Typography */
    .info-section {
        background: white;
        border-radius: var(--radius-lg);
        margin-bottom: 1.25rem;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem 1.5rem;
        cursor: pointer;
        user-select: none;
        background: linear-gradient(to right, var(--gray-100), #ffffff);
        border-bottom: 1px solid var(--gray-200);
        transition: all 0.3s ease;
    }

    .section-header:hover {
        background: linear-gradient(to right, var(--gray-200), var(--gray-100));
    }

    /* Section Title - Professional Size */
    .section-title {
        color: var(--primary-color);
        font-size: var(--font-lg);
        font-weight: 600;
        display: flex;
        align-items: center;
        margin: 0;
        font-family: var(--heading-font);
    }

    .section-title i {
        background: linear-gradient(135deg, #087fc2 0%, #0669a0 100%);
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        font-size: var(--font-sm);
    }

    .collapse-icon {
        color: var(--gray-500);
        font-size: var(--font-lg);
        transition: transform 0.3s ease;
    }

    .collapse-icon.collapsed {
        transform: rotate(-180deg);
    }

    .section-content {
        padding: 1.5rem;
        display: block;
        transition: all 0.3s ease;
    }

    .section-content.collapsed {
        display: none;
    }

    /* Info Grid - Responsive */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.25rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
    }

    /* Info Label - Professional Size */
    .info-label {
        color: var(--gray-500);
        font-size: var(--font-xs);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    /* Info Value - Professional Size */
    .info-value {
        color: var(--gray-800);
        font-weight: 500;
        font-size: var(--font-md);
        word-break: break-word;
    }

    /* Stats Grid - Fully Responsive */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
    }

    .stat-card {
        background: var(--gray-100);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--gradient-primary);
    }

    /* Stat Number - Professional Size */
    .stat-number {
        font-size: var(--font-4xl);
        font-weight: 700;
        color: var(--primary-color);
        line-height: 1;
        margin-bottom: 0.5rem;
        font-family: var(--heading-font);
    }

    /* Stat Icon */
    .stat-icon {
        font-size: var(--font-2xl);
        color: var(--primary-color);
        margin-bottom: 0.5rem;
        opacity: 0.8;
    }

    /* Stat Label - Professional Size */
    .stat-label {
        color: var(--gray-600);
        font-size: var(--font-sm);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    /* Professional Buttons */
    .action-buttons {
        margin-top: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
    }

    .btn-group-actions {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }

    /* Button Action - Professional Typography */
    .btn-action {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: var(--radius-md);
        border: 2px solid transparent;
        font-size: var(--font-sm);
        font-weight: 500;
        text-decoration: none;
        transition: all 0.3s ease;
        cursor: pointer;
        white-space: nowrap;
        font-family: var(--primary-font);
    }

    .btn-action i {
        font-size: var(--font-sm);
    }

    .btn-primary-action {
        background: var(--gradient-primary);
        color: white;
        border-color: var(--primary-color);
    }

    .btn-primary-action:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        color: white;
    }

    .btn-success-action {
        background: var(--gradient-success);
        color: white;
        border-color: var(--success-color);
    }

    .btn-success-action:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        color: white;
    }

    .btn-warning-action {
        background: var(--gradient-warning);
        color: white;
        border-color: var(--warning-color);
    }

    .btn-warning-action:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        color: white;
    }

    .btn-outline-action {
        background: white;
        color: var(--gray-700);
        border-color: var(--gray-300);
    }

    .btn-outline-action:hover {
        background: var(--gray-100);
        border-color: var(--gray-400);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    /* Timeline Styles */
    .activity-timeline {
        position: relative;
        padding-left: 2rem;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
        border-left: 2px solid var(--gray-200);
        padding-left: 1.5rem;
    }

    .timeline-item:last-child {
        border-left: 2px solid transparent;
        padding-bottom: 0;
    }

    .timeline-dot {
        position: absolute;
        left: -6px;
        top: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--primary-color);
        border: 2px solid white;
        box-shadow: 0 0 0 2px var(--primary-color);
    }

    .timeline-content {
        background: var(--gray-100);
        padding: 1rem;
        border-radius: var(--radius-md);
        border: 1px solid var(--gray-200);
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .timeline-title {
        font-size: var(--font-md);
        font-weight: 600;
        color: var(--gray-800);
    }

    .timeline-date {
        font-size: var(--font-xs);
        color: var(--gray-500);
    }

    .timeline-description {
        font-size: var(--font-sm);
        color: var(--gray-600);
        margin: 0;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--gray-500);
    }

    .empty-state i {
        font-size: var(--font-5xl);
        color: var(--gray-300);
        margin-bottom: 1rem;
    }

    .empty-state h5 {
        font-size: var(--font-xl);
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        font-size: var(--font-base);
        color: var(--gray-500);
        margin: 0;
    }

    /* Top Actions Bar */
    .top-actions {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 1.5rem;
        gap: 0.75rem;
    }

    .btn-expand-all {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: white;
        border: 2px solid var(--gray-300);
        border-radius: var(--radius-md);
        color: var(--gray-700);
        font-size: var(--font-sm);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-expand-all:hover {
        background: var(--gray-100);
        border-color: var(--gray-400);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }

    .btn-expand-all i {
        font-size: var(--font-md);
        transition: transform 0.3s ease;
    }

    /* ========================================
       RESPONSIVE DESIGN
       ======================================== */

    /* Tablets and Small Laptops (768px - 1024px) */
    @media (max-width: 1024px) {
        .customer-header {
            padding: 1.25rem;
        }

        .customer-avatar {
            width: 70px;
            height: 70px;
            font-size: var(--font-3xl);
        }

        .customer-info h1 {
            font-size: var(--font-2xl);
        }

        .section-title {
            font-size: var(--font-md);
        }

        .stat-number {
            font-size: var(--font-3xl);
        }

        .info-grid {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        }

        .btn-group-actions {
            gap: 1rem;
        }
    }

    /* Mobile Devices (max 768px) */
    @media (max-width: 768px) {
        .customer-header {
            padding: 1rem;
            border-radius: var(--radius-md);
        }

        .customer-avatar {
            width: 60px;
            height: 60px;
            font-size: var(--font-2xl);
            margin-bottom: 0.5rem;
        }

        .customer-info h1 {
            font-size: var(--font-xl);
        }

        .customer-info p {
            font-size: var(--font-sm);
        }

        .customer-meta {
            gap: 0.75rem;
            font-size: var(--font-xs);
        }

        .status-badge {
            padding: 0.3rem 0.6rem;
            font-size: 0.625rem;
        }

        .section-header {
            padding: 1rem 1.25rem;
        }

        .section-title {
            font-size: var(--font-base);
        }

        .section-title i {
            width: 26px;
            height: 26px;
            font-size: var(--font-xs);
            margin-right: 0.6rem;
        }

        .section-content {
            padding: 1.25rem;
        }

        .info-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .stat-card {
            padding: 1rem;
        }

        .stat-number {
            font-size: var(--font-2xl);
        }

        .stat-label {
            font-size: var(--font-xs);
        }

        .info-label {
            font-size: 0.65rem;
        }

        .info-value {
            font-size: var(--font-sm);
        }

        .action-buttons {
            padding: 1rem;
        }

        .btn-group-actions {
            gap: 0.75rem;
        }

        .btn-group-actions > div {
            flex-direction: column;
        }

        .btn-group-actions > div > div {
            width: 100%;
        }

        .btn-action {
            width: 100%;
            justify-content: center;
            padding: 0.55rem 0.875rem;
            font-size: var(--font-xs);
        }

        .top-actions {
            justify-content: center;
        }

        .activity-timeline {
            padding-left: 1.5rem;
        }

        .timeline-item {
            padding-left: 1.25rem;
        }

        .timeline-content {
            padding: 0.875rem;
        }

        .timeline-title {
            font-size: var(--font-sm);
        }
    }

    /* Small Mobile (max 480px) */
    @media (max-width: 480px) {
        .customer-avatar {
            width: 50px;
            height: 50px;
            font-size: var(--font-xl);
        }

        .customer-info h1 {
            font-size: var(--font-lg);
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .stat-number {
            font-size: var(--font-xl);
        }

        .section-title {
            font-size: var(--font-sm);
        }

        .btn-action {
            font-size: 0.65rem;
            padding: 0.5rem 0.75rem;
        }
    }

    /* Auto Width Management for Collapsed Sidebar */
    @media (min-width: 1025px) {
        .admin-main-content {
            transition: margin-left 0.3s ease, width 0.3s ease;
        }

        .admin-sidebar.collapsed ~ .admin-main-content {
            margin-left: var(--admin-sidebar-collapsed);
            width: calc(100% - var(--admin-sidebar-collapsed));
        }
    }

    /* Print Styles */
    @media print {
        .admin-sidebar,
        .admin-header,
        .action-buttons,
        .top-actions,
        .sidebar-toggle,
        .btn-expand-all {
            display: none !important;
        }

        .customer-header {
            background: #087fc2 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .section-content {
            display: block !important;
        }
    }
</style>
{% endblock %}

{% block admin_content %}
<!-- Top Actions -->
<div class="top-actions">
    <button type="button" class="btn-expand-all" onclick="toggleAllSections()">
        <i class="fas fa-chevron-up" id="expandCollapseIcon"></i>
        <span>Expand/Collapse All</span>
    </button>
</div>

<!-- Customer Header -->
<div class="customer-header">
    <div class="d-flex align-items-center">
        <div class="customer-avatar">
            {{ customer.first_name.0|upper }}{{ customer.last_name.0|upper }}
        </div>
        <div class="customer-info flex-grow-1">
            <h1>{{ customer.full_name }}</h1>
            <p class="mb-0">{{ customer.job_title|default:"Customer" }} 
                {% if customer.organization %}at {{ customer.organization }}{% endif %}
            </p>
            <div class="customer-meta">
                <div class="meta-item">
                    <i class="fas fa-envelope"></i>
                    <span>{{ customer.email }}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-phone"></i>
                    <span>{{ customer.full_mobile }}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-calendar"></i>
                    <span>Joined {{ customer.created_at|date:"d M Y" }}</span>
                </div>
                <div class="meta-item">
                    {% if customer.is_approved %}
                        {% if customer.is_active %}
                            <span class="status-badge status-approved">
                                <i class="fas fa-check-circle"></i>Active
                            </span>
                        {% else %}
                            <span class="status-badge status-blocked">
                                <i class="fas fa-ban"></i>Blocked
                            </span>
                        {% endif %}
                    {% else %}
                        <span class="status-badge status-pending">
                            <i class="fas fa-clock"></i>Pending
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Section -->
<div class="info-section">
    <div class="section-header" onclick="toggleSection('statistics')">
        <h3 class="section-title">
            <i class="fas fa-chart-bar"></i>
            Statistics Overview
        </h3>
        <i class="fas fa-chevron-up collapse-icon" id="icon-statistics"></i>
    </div>
    <div class="section-content" id="content-statistics">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-eye"></i></div>
                <div class="stat-number">{{ customer_stats.demo_views|default:0 }}</div>
                <div class="stat-label">Demo Views</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                <div class="stat-number">{{ customer_stats.demo_requests|default:0 }}</div>
                <div class="stat-label">Demo Requests</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-envelope-open-text"></i></div>
                <div class="stat-number">{{ customer_stats.enquiries|default:0 }}</div>
                <div class="stat-label">Enquiries</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                <div class="stat-number">{{ customer_stats.engagement_score|default:0 }}%</div>
                <div class="stat-label">Engagement</div>
            </div>
        </div>
    </div>
</div>

<!-- Personal Information -->
<div class="info-section">
    <div class="section-header" onclick="toggleSection('personal')">
        <h3 class="section-title">
            <i class="fas fa-user"></i>
            Personal Information
        </h3>
        <i class="fas fa-chevron-up collapse-icon" id="icon-personal"></i>
    </div>
    <div class="section-content" id="content-personal">
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Full Name</div>
                <div class="info-value">{{ customer.full_name }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Email Address</div>
                <div class="info-value">{{ customer.email }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Mobile Number</div>
                <div class="info-value">{{ customer.full_mobile }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Country</div>
                <div class="info-value">{{ customer.get_country_code_display|default:"Not specified" }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Business Information -->
<div class="info-section">
    <div class="section-header" onclick="toggleSection('business')">
        <h3 class="section-title">
            <i class="fas fa-briefcase"></i>
            Business Information
        </h3>
        <i class="fas fa-chevron-up collapse-icon" id="icon-business"></i>
    </div>
    <div class="section-content" id="content-business">
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Organization</div>
                <div class="info-value">{{ customer.organization|default:"Not specified" }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Job Title</div>
                <div class="info-value">{{ customer.job_title|default:"Not specified" }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Industry</div>
                <div class="info-value">{{ customer.industry|default:"Not specified" }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Company Size</div>
                <div class="info-value">{{ customer.company_size|default:"Not specified" }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Account Information -->
<div class="info-section">
    <div class="section-header" onclick="toggleSection('account')">
        <h3 class="section-title">
            <i class="fas fa-shield-alt"></i>
            Account Information
        </h3>
        <i class="fas fa-chevron-up collapse-icon" id="icon-account"></i>
    </div>
    <div class="section-content" id="content-account">
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Account Status</div>
                <div class="info-value">
                    {% if customer.is_approved %}
                        {% if customer.is_active %}
                            <span class="text-success"><i class="fas fa-check-circle me-1"></i>Active</span>
                        {% else %}
                            <span class="text-danger"><i class="fas fa-ban me-1"></i>Blocked</span>
                        {% endif %}
                    {% else %}
                        <span class="text-warning"><i class="fas fa-clock me-1"></i>Pending Approval</span>
                    {% endif %}
                </div>
            </div>
            <div class="info-item">
                <div class="info-label">Email Verified</div>
                <div class="info-value">
                    {% if customer.is_email_verified %}
                        <span class="text-success"><i class="fas fa-check-circle me-1"></i>Verified</span>
                    {% else %}
                        <span class="text-warning"><i class="fas fa-exclamation-circle me-1"></i>Not Verified</span>
                    {% endif %}
                </div>
            </div>
            <div class="info-item">
                <div class="info-label">Registration Date</div>
                <div class="info-value">{{ customer.created_at|date:"d M Y, h:i A" }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Last Login</div>
                <div class="info-value">
                    {% if customer.last_login %}
                        {{ customer.last_login|date:"d M Y, h:i A" }}
                    {% else %}
                        <span class="text-muted">Never</span>
                    {% endif %}
                </div>
            </div>
            <div class="info-item">
                <div class="info-label">Last Updated</div>
                <div class="info-value">{{ customer.updated_at|date:"d M Y, h:i A" }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Customer ID</div>
                <div class="info-value">#{{ customer.id|stringformat:"05d" }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Activity Timeline -->
<div class="info-section">
    <div class="section-header" onclick="toggleSection('activity')">
        <h3 class="section-title">
            <i class="fas fa-history"></i>
            Recent Activity
        </h3>
        <i class="fas fa-chevron-up collapse-icon" id="icon-activity"></i>
    </div>
    <div class="section-content" id="content-activity">
        {% if customer.recent_activities %}
        <div class="activity-timeline">
            {% for activity in customer.recent_activities %}
            <div class="timeline-item">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                    <div class="timeline-header">
                        <div class="timeline-title">{{ activity.title }}</div>
                        <div class="timeline-date">{{ activity.created_at|date:"d M Y" }}</div>
                    </div>
                    <p class="timeline-description">{{ activity.description }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="mt-3">
            <div class="info-label mb-2">Engagement Level</div>
            <div class="info-value">
                {% if customer_stats.engagement_score >= 70 %}
                    <span class="text-success">
                        <i class="fas fa-chart-line me-1"></i>High Activity
                    </span>
                {% elif customer_stats.engagement_score >= 40 %}
                    <span class="text-warning">
                        <i class="fas fa-chart-bar me-1"></i>Moderate Activity
                    </span>
                {% else %}
                    <span class="text-muted">
                        <i class="fas fa-battery-empty me-1"></i>Low Activity
                    </span>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-chart-line"></i>
            <h5>No Recent Activity</h5>
            <p>This customer hasn't performed any activities yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Actions -->
<div class="action-buttons">
    <div class="btn-group-actions">
        <div class="d-flex justify-content-between align-items-center gap-3 flex-wrap">
            <div class="d-flex gap-3 flex-wrap">
                <a href="{% url 'core:admin_edit_customer' customer.id %}" class="btn-action btn-primary-action">
                    <i class="fas fa-edit"></i>
                    <span>Edit Customer</span>
                </a>
                
                {% if not customer.is_approved %}
                    <button type="button" class="btn-action btn-success-action" onclick="approveCustomer()">
                        <i class="fas fa-check"></i>
                        <span>Approve Customer</span>
                    </button>
                {% endif %}
                
                {% if customer.is_active %}
                    <button type="button" class="btn-action btn-warning-action" onclick="blockCustomer()">
                        <i class="fas fa-ban"></i>
                        <span>Block Customer</span>
                    </button>
                {% else %}
                    <button type="button" class="btn-action btn-success-action" onclick="unblockCustomer()">
                        <i class="fas fa-unlock"></i>
                        <span>Unblock Customer</span>
                    </button>
                {% endif %}
                
                <a href="mailto:{{ customer.email }}" class="btn-action btn-outline-action">
                    <i class="fas fa-envelope"></i>
                    <span>Send Email</span>
                </a>
            </div>
            
            <a href="{% url 'core:admin_users' %}" class="btn-action btn-outline-action">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Customers</span>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_extra_js %}
<script>
    const csrfToken = '{{ csrf_token }}';
    const customerId = {{ customer.id }};
    const customerName = '{{ customer.full_name|escapejs }}';

    // Toggle individual section
    function toggleSection(sectionId) {
        const content = document.getElementById('content-' + sectionId);
        const icon = document.getElementById('icon-' + sectionId);
        
        if (!content || !icon) {
            console.error('Section not found:', sectionId);
            return;
        }
        
        const isCollapsed = content.classList.contains('collapsed');
        
        if (isCollapsed) {
            content.classList.remove('collapsed');
            icon.classList.remove('collapsed');
        } else {
            content.classList.add('collapsed');
            icon.classList.add('collapsed');
        }
    }

    // Toggle all sections
    function toggleAllSections() {
        const sections = ['statistics', 'personal', 'business', 'account', 'activity'];
        const btn = document.getElementById('expandCollapseIcon');
        
        if (!btn) return;
        
        // Check if all are collapsed
        let allCollapsed = true;
        sections.forEach(sectionId => {
            const content = document.getElementById('content-' + sectionId);
            if (content && !content.classList.contains('collapsed')) {
                allCollapsed = false;
            }
        });
        
        // Toggle all
        sections.forEach(sectionId => {
            const content = document.getElementById('content-' + sectionId);
            const icon = document.getElementById('icon-' + sectionId);
            
            if (!content || !icon) return;
            
            if (allCollapsed) {
                // Expand all
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            } else {
                // Collapse all
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            }
        });
        
        // Update button icon
        if (allCollapsed) {
            btn.classList.remove('fa-chevron-down');
            btn.classList.add('fa-chevron-up');
        } else {
            btn.classList.remove('fa-chevron-up');
            btn.classList.add('fa-chevron-down');
        }
    }

    // ✅ FIXED: Approve Customer with AJAX
    function approveCustomer() {
        if (!confirm(`Approve ${customerName}? They will gain full access to the portal.`)) {
            return;
        }

        fetch(`/admin/customers/${customerId}/approve/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                throw new Error(data.message || 'Error approving customer');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error approving customer. Please try again.', 'error');
        });
    }

    // ✅ FIXED: Block Customer with AJAX
    function blockCustomer() {
        if (!confirm(`Block ${customerName}? They will lose access to the portal.`)) {
            return;
        }

        fetch(`/admin/customers/${customerId}/block/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                throw new Error(data.message || 'Error blocking customer');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error blocking customer. Please try again.', 'error');
        });
    }

    // ✅ FIXED: Unblock Customer with AJAX
    function unblockCustomer() {
        if (!confirm(`Unblock ${customerName}? They will regain access to the portal.`)) {
            return;
        }

        fetch(`/admin/customers/${customerId}/unblock/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                throw new Error(data.message || 'Error unblocking customer');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error unblocking customer. Please try again.', 'error');
        });
    }

    // ✅ Professional Notification System
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 450px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        `;
        
        const iconClass = type === 'success' ? 'check-circle' : 
                         type === 'warning' ? 'exclamation-triangle' : 
                         type === 'error' ? 'exclamation-circle' : 'info-circle';
        
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${iconClass} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
</script>
{% endblock %}