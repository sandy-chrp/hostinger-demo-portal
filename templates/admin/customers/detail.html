<!-- templates/admin/customers/detail.html - FRESH COMPLETE VERSION -->
{% extends 'admin/base.html' %}
{% load static %}

{% block admin_title %}Customer Details{% endblock %}
{% block page_title %}{{ customer.full_name }} - Customer Details{% endblock %}

{% block breadcrumb %}
<div class="admin-breadcrumb">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a href="{% url 'core:admin_dashboard' %}">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'core:admin_users' %}">
                    <i class="fas fa-users me-1"></i>Customers
                </a>
            </li>
            <li class="breadcrumb-item active">{{ customer.first_name }}</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block admin_extra_css %}
<style>
    .customer-header {
        background: linear-gradient(135deg, #087fc2 0%, #0669a0 100%);
        color: white;
        border-radius: 0.75rem;
        padding: 2rem;
        margin-bottom: 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .customer-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }

    .customer-avatar {
        width: 100px;
        height: 100px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 2.5rem;
        margin-bottom: 1rem;
        border: 4px solid rgba(255, 255, 255, 0.3);
        position: relative;
        z-index: 1;
    }

    .customer-info h1 {
        margin-bottom: 0.5rem;
    }

    .customer-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin-top: 1rem;
        opacity: 0.95;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-approved {
        background: rgba(16, 185, 129, 0.2);
        color: white;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-pending {
        background: rgba(245, 158, 11, 0.2);
        color: white;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .status-blocked {
        background: rgba(239, 68, 68, 0.2);
        color: white;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    /* Collapsible Section Styles */
    .info-section {
        background: white;
        border-radius: 0.75rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid #e5e7eb;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        cursor: pointer;
        user-select: none;
        background: linear-gradient(to right, #f9fafb, #ffffff);
        border-bottom: 1px solid #e5e7eb;
        transition: all 0.3s ease;
    }

    .section-header:hover {
        background: linear-gradient(to right, #f3f4f6, #f9fafb);
    }

    .section-title {
        color: #087fc2;
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        margin: 0;
    }

    .section-title i {
        background: linear-gradient(135deg, #087fc2 0%, #0669a0 100%);
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 0.9rem;
    }

    .collapse-icon {
        color: #6b7280;
        font-size: 1.2rem;
        transition: transform 0.3s ease;
    }

    .collapse-icon.collapsed {
        transform: rotate(-180deg);
    }

    .section-content {
        padding: 1.5rem;
        display: block;
        transition: all 0.3s ease;
    }

    .section-content.collapsed {
        display: none;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .info-label {
        color: #6b7280;
        font-size: 0.85rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .info-value {
        color: #1f2937;
        font-weight: 600;
        font-size: 1rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .stat-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1.5rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, #087fc2 0%, #0669a0 100%);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #087fc2;
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: #6b7280;
        font-size: 0.85rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .stat-sublabel {
        color: #9ca3af;
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }

    .action-buttons {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid #e5e7eb;
        position: sticky;
        bottom: 1.5rem;
        z-index: 10;
    }

    .btn-group-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
    }

    .btn-action {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 0.5rem;
        border: 2px solid;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .btn-primary-action {
        background: linear-gradient(135deg, #087fc2 0%, #0669a0 100%);
        border-color: #087fc2;
        color: white !important;
    }

    .btn-primary-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        text-decoration: none;
    }

    .btn-success-action {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-color: #10b981;
        color: white !important;
    }

    .btn-success-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        text-decoration: none;
    }

    .btn-warning-action {
        background: #f59e0b;
        border-color: #f59e0b;
        color: white !important;
    }

    .btn-warning-action:hover {
        background: #d97706;
        transform: translateY(-2px);
        text-decoration: none;
    }

    .btn-outline-action {
        background: transparent;
        border-color: #9ca3af;
        color: #374151 !important;
    }

    .btn-outline-action:hover {
        background: #f3f4f6;
        text-decoration: none;
    }

    .expand-collapse-all {
        position: fixed;
        bottom: 100px;
        right: 30px;
        z-index: 999;
        background: linear-gradient(135deg, #087fc2 0%, #0669a0 100%);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .expand-collapse-all:hover {
        transform: scale(1.1);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: #6b7280;
    }

    .empty-state i {
        font-size: 3rem;
        color: #9ca3af;
        margin-bottom: 1rem;
    }

    /* Text colors */
    .text-success {
        color: #10b981 !important;
    }

    .text-warning {
        color: #f59e0b !important;
    }

    .text-danger {
        color: #ef4444 !important;
    }

    .text-info {
        color: #087fc2 !important;
    }

    .text-muted {
        color: #6b7280 !important;
    }

    /* Links */
    a {
        color: #087fc2;
        text-decoration: none;
    }

    a:hover {
        color: #0669a0;
        text-decoration: none;
    }

    .breadcrumb-item a {
        color: #087fc2;
    }

    .breadcrumb-item a:hover {
        color: #0669a0;
    }

    .breadcrumb-item.active {
        color: #087fc2;
    }

    @media (max-width: 768px) {
        .customer-header {
            padding: 1.5rem;
        }
        
        .customer-meta {
            flex-direction: column;
            gap: 1rem;
        }
        
        .info-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .btn-group-actions {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .btn-action {
            width: 100%;
            justify-content: center;
        }

        .expand-collapse-all {
            bottom: 80px;
            right: 20px;
            width: 45px;
            height: 45px;
        }
    }
</style>
{% endblock %}

{% block admin_content %}
<!-- Customer Header -->
<div class="customer-header">
    <div class="customer-info">
        <div class="customer-avatar">
            {{ customer.first_name|first }}{{ customer.last_name|first }}
        </div>
        <h1>{{ customer.full_name }}</h1>
        <p class="mb-0 opacity-75">{{ customer.email }}</p>
        
        <div class="customer-meta">
            <div class="meta-item">
                {% if customer.is_approved %}
                    {% if customer.is_active %}
                        <span class="status-badge status-approved">
                            <i class="fas fa-check-circle"></i>Active Customer
                        </span>
                    {% else %}
                        <span class="status-badge status-blocked">
                            <i class="fas fa-ban"></i>Blocked Account
                        </span>
                    {% endif %}
                {% else %}
                    <span class="status-badge status-pending">
                        <i class="fas fa-clock"></i>Pending Approval
                    </span>
                {% endif %}
            </div>
            
            <div class="meta-item">
                {% if customer.is_email_verified %}
                    <i class="fas fa-envelope-check"></i>
                    <span>Email Verified</span>
                {% else %}
                    <i class="fas fa-envelope"></i>
                    <span>Email Not Verified</span>
                {% endif %}
            </div>
            
            <div class="meta-item">
                <i class="fas fa-calendar-alt"></i>
                <span>Member since {{ customer.created_at|date:"M Y" }}</span>
            </div>
            
            {% if customer.last_login %}
            <div class="meta-item">
                <i class="fas fa-sign-in-alt"></i>
                <span>Last login {{ customer.last_login|timesince }} ago</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Expand/Collapse All Button -->
<button class="expand-collapse-all" 
        onclick="toggleAllSections()"
        type="button"
        title="Expand/Collapse All Sections"
        aria-label="Expand or collapse all sections">
    <i class="fas fa-chevron-down" id="expandCollapseIcon"></i>
</button>

<!-- Customer Statistics -->
<div class="info-section">
    <div class="section-header" onclick="toggleSection('statistics')">
        <div class="section-title">
            <i class="fas fa-chart-bar"></i>
            Customer Statistics
        </div>
        <i class="fas fa-chevron-up collapse-icon collapsed" id="icon-statistics"></i>
    </div>
    
    <div class="section-content collapsed" id="content-statistics">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ customer_stats.demo_views|default:0 }}</div>
                <div class="stat-label">Demo Views</div>
                <div class="stat-sublabel">Total videos watched</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">{{ customer_stats.demo_requests|default:0 }}</div>
                <div class="stat-label">Demo Requests</div>
                <div class="stat-sublabel">Live sessions requested</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">{{ customer_stats.enquiries|default:0 }}</div>
                <div class="stat-label">Enquiries</div>
                <div class="stat-sublabel">Business questions asked</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">{{ customer_stats.notifications|default:0 }}</div>
                <div class="stat-label">Notifications</div>
                <div class="stat-sublabel">Messages received</div>
            </div>
        </div>
    </div>
</div>

<!-- Personal Information -->
<div class="info-section">
    <div class="section-header" onclick="toggleSection('personal')">
        <div class="section-title">
            <i class="fas fa-user"></i>
            Personal Information
        </div>
        <i class="fas fa-chevron-up collapse-icon collapsed" id="icon-personal"></i>
    </div>
    
    <div class="section-content collapsed" id="content-personal">
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Full Name</div>
                <div class="info-value">{{ customer.full_name }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">Email Address</div>
                <div class="info-value">{{ customer.email }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">Mobile Number</div>
                <div class="info-value">{{ customer.full_mobile|default:"Not provided" }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">Country</div>
                <div class="info-value">{{ customer.get_country_code_display }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Business Information -->
<div class="info-section">
    <div class="section-header" onclick="toggleSection('business')">
        <div class="section-title">
            <i class="fas fa-building"></i>
            Business Information
        </div>
        <i class="fas fa-chevron-up collapse-icon collapsed" id="icon-business"></i>
    </div>
    
    <div class="section-content collapsed" id="content-business">
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Job Title</div>
                <div class="info-value">{{ customer.job_title|default:"Not specified" }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">Organization</div>
                <div class="info-value">{{ customer.organization|default:"Not specified" }}</div>
            </div>

            <div class="info-item">
                <div class="info-label">Business Category</div>
                <div class="info-value">
                    {% if customer.business_category %}
                        {{ customer.business_category.name }}
                    {% else %}
                        Not specified
                    {% endif %}
                </div>
            </div>

            <div class="info-item">
                <div class="info-label">Business Subcategory</div>
                <div class="info-value">
                    {% if customer.business_subcategory %}
                        {{ customer.business_subcategory.name }}
                    {% else %}
                        Not specified
                    {% endif %}
                </div>
            </div>
            
            <div class="info-item">
                <div class="info-label">How They Found Us</div>
                <div class="info-value">{{ customer.get_referral_source_display|default:"Not specified" }}</div>
            </div>
            
            {% if customer.referral_message %}
            <div class="info-item">
                <div class="info-label">Referral Message</div>
                <div class="info-value">{{ customer.referral_message }}</div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Account Information -->
<div class="info-section">
    <div class="section-header" onclick="toggleSection('account')">
        <div class="section-title">
            <i class="fas fa-cog"></i>
            Account Information
        </div>
        <i class="fas fa-chevron-up collapse-icon collapsed" id="icon-account"></i>
    </div>
    
    <div class="section-content collapsed" id="content-account">
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Account Status</div>
                <div class="info-value">
                    {% if customer.is_approved %}
                        {% if customer.is_active %}
                            <span class="text-success">
                                <i class="fas fa-check-circle me-1"></i>Active & Approved
                            </span>
                        {% else %}
                            <span class="text-danger">
                                <i class="fas fa-ban me-1"></i>Blocked
                            </span>
                        {% endif %}
                    {% else %}
                        <span class="text-warning">
                            <i class="fas fa-clock me-1"></i>Pending Approval
                        </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="info-item">
                <div class="info-label">Email Verification</div>
                <div class="info-value">
                    {% if customer.is_email_verified %}
                        <span class="text-success">
                            <i class="fas fa-envelope-check me-1"></i>Verified
                        </span>
                    {% else %}
                        <span class="text-warning">
                            <i class="fas fa-envelope me-1"></i>Not Verified
                        </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="info-item">
                <div class="info-label">Registration Date</div>
                <div class="info-value">{{ customer.created_at|date:"F d, Y \a\t g:i A" }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">Last Updated</div>
                <div class="info-value">{{ customer.updated_at|date:"F d, Y \a\t g:i A" }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">Last Login</div>
                <div class="info-value">
                    {% if customer.last_login %}
                        {{ customer.last_login|date:"F d, Y \a\t g:i A" }}
                        <small class="text-muted d-block">{{ customer.last_login|timesince }} ago</small>
                    {% else %}
                        <span class="text-muted">Never logged in</span>
                    {% endif %}
                </div>
            </div>
            
            {% if customer.last_login_ip %}
            <div class="info-item">
                <div class="info-label">Last Login IP</div>
                <div class="info-value">{{ customer.last_login_ip }}</div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="info-section">
    <div class="section-header" onclick="toggleSection('activity')">
        <div class="section-title">
            <i class="fas fa-history"></i>
            Recent Activity
        </div>
        <i class="fas fa-chevron-up collapse-icon collapsed" id="icon-activity"></i>
    </div>
    
    <div class="section-content collapsed" id="content-activity">
        {% if customer_stats.last_activity.0 %}
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Last Activity</div>
                <div class="info-value">
                    {{ customer_stats.last_activity.1 }}
                    <small class="text-muted d-block">{{ customer_stats.last_activity.0|timesince }} ago</small>
                </div>
            </div>
            
            <div class="info-item">
                <div class="info-label">Activity Level</div>
                <div class="info-value">
                    {% if customer_stats.engagement_score >= 70 %}
                        <span class="text-success">
                            <i class="fas fa-battery-full me-1"></i>Very Active
                        </span>
                    {% elif customer_stats.engagement_score >= 40 %}
                        <span class="text-warning">
                            <i class="fas fa-battery-half me-1"></i>Moderately Active
                        </span>
                    {% elif customer_stats.engagement_score >= 20 %}
                        <span class="text-info">
                            <i class="fas fa-battery-quarter me-1"></i>Somewhat Active
                        </span>
                    {% else %}
                        <span class="text-muted">
                            <i class="fas fa-battery-empty me-1"></i>Low Activity
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-chart-line"></i>
            <h5>No Recent Activity</h5>
            <p>This customer hasn't performed any activities yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Actions -->
<div class="action-buttons">
    <div class="btn-group-actions">
        <div class="d-flex gap-3 flex-wrap">
            <a href="{% url 'core:admin_edit_customer' customer.id %}" class="btn-action btn-primary-action">
                <i class="fas fa-edit"></i>
                <span>Edit Customer</span>
            </a>
            
            {% if not customer.is_approved %}
                <form method="post" action="{% url 'core:admin_approve_customer' customer.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn-action btn-success-action" onclick="return confirm('Approve {{ customer.full_name }}?')">
                        <i class="fas fa-check"></i>
                        <span>Approve Customer</span>
                    </button>
                </form>
            {% endif %}
            
            {% if customer.is_active %}
                <form method="post" action="{% url 'core:admin_block_customer' customer.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn-action btn-warning-action" onclick="return confirm('Block {{ customer.full_name }}?')">
                        <i class="fas fa-ban"></i>
                        <span>Block Customer</span>
                    </button>
                </form>
            {% else %}
                <button type="button" class="btn-action btn-success-action" onclick="unblockCustomer()">
                    <i class="fas fa-unlock"></i>
                    <span>Unblock Customer</span>
                </button>
            {% endif %}
            
            <a href="mailto:{{ customer.email }}" class="btn-action btn-outline-action">
                <i class="fas fa-envelope"></i>
                <span>Send Email</span>
            </a>
        </div>
        
        <div class="d-flex gap-3">
            <a href="{% url 'core:admin_users' %}" class="btn-action btn-outline-action">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Customers</span>
            </a>
            
            <button type="button" class="btn-action btn-outline-action" onclick="exportCustomerData()" style="border-color: #10b981; color: #10b981;">
                <i class="fas fa-download"></i>
                <span>Export Data</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_extra_js %}
<script>
    const csrfToken = '{{ csrf_token }}';

    // Toggle individual section
    function toggleSection(sectionId) {
        const content = document.getElementById('content-' + sectionId);
        const icon = document.getElementById('icon-' + sectionId);
        
        if (!content || !icon) {
            console.error('Section not found:', sectionId);
            return;
        }
        
        const isCollapsed = content.classList.contains('collapsed');
        
        if (isCollapsed) {
            content.classList.remove('collapsed');
            icon.classList.remove('collapsed');
        } else {
            content.classList.add('collapsed');
            icon.classList.add('collapsed');
        }
    }

    // Toggle all sections
    function toggleAllSections() {
        const sections = ['statistics', 'personal', 'business', 'account', 'activity'];
        const btn = document.getElementById('expandCollapseIcon');
        
        if (!btn) return;
        
        // Check if all are collapsed
        let allCollapsed = true;
        sections.forEach(sectionId => {
            const content = document.getElementById('content-' + sectionId);
            if (content && !content.classList.contains('collapsed')) {
                allCollapsed = false;
            }
        });
        
        // Toggle all
        sections.forEach(sectionId => {
            const content = document.getElementById('content-' + sectionId);
            const icon = document.getElementById('icon-' + sectionId);
            
            if (!content || !icon) return;
            
            if (allCollapsed) {
                // Expand all
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            } else {
                // Collapse all
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            }
        });
        
        // Update button icon
        if (allCollapsed) {
            btn.classList.remove('fa-chevron-down');
            btn.classList.add('fa-chevron-up');
        } else {
            btn.classList.remove('fa-chevron-up');
            btn.classList.add('fa-chevron-down');
        }
    }

    function unblockCustomer() {
        const customerName = '{{ customer.full_name|escapejs }}';
        
        if (confirm(`Unblock ${customerName}? They will regain access to the portal.`)) {
            fetch(`/admin/customers/{{ customer.id }}/unblock/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    throw new Error(data.message || 'Error unblocking customer');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error unblocking customer. Please try again.', 'error');
            });
        }
    }

    function exportCustomerData() {
        showNotification('Preparing customer data export...', 'info');
        
        const customerData = {
            personal_info: {
                name: '{{ customer.full_name|escapejs }}',
                email: '{{ customer.email|escapejs }}',
                mobile: '{{ customer.full_mobile|escapejs }}',
                job_title: '{{ customer.job_title|escapejs }}',
                organization: '{{ customer.organization|escapejs }}'
            },
            account_info: {
                status: '{% if customer.is_approved %}{% if customer.is_active %}Active{% else %}Blocked{% endif %}{% else %}Pending{% endif %}',
                email_verified: {{ customer.is_email_verified|yesno:"true,false" }},
                registration_date: '{{ customer.created_at|date:"Y-m-d H:i:s" }}',
                last_login: '{% if customer.last_login %}{{ customer.last_login|date:"Y-m-d H:i:s" }}{% else %}Never{% endif %}'
            },
            statistics: {
                demo_views: {{ customer_stats.demo_views|default:0 }},
                demo_requests: {{ customer_stats.demo_requests|default:0 }},
                enquiries: {{ customer_stats.enquiries|default:0 }},
                engagement_score: {{ customer_stats.engagement_score|default:0 }}
            }
        };

        const dataStr = JSON.stringify(customerData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `customer_${customerData.personal_info.name.replace(/\s+/g, '_').toLowerCase()}_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showNotification('Customer data exported successfully!', 'success');
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 350px;
            max-width: 500px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        `;
        
        const iconClass = type === 'success' ? 'check-circle' : 
                         type === 'warning' ? 'exclamation-triangle' : 
                         type === 'error' ? 'exclamation-circle' : 'info-circle';
        
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${iconClass} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
</script>
{% endblock %}