{% extends 'admin/base.html' %}
{% load static %}

{% block page_title %}Edit Customer{% endblock %}

{% block extra_css %}
<!-- jQuery (Required for Select2) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- Custom Select2 Styling - Matched to Create -->
<style>
.select2-container--default .select2-selection--single {
    border: 1.5px solid #e2e8f0 !important;
    border-radius: 0.5rem !important;
    height: 38px !important;
    padding: 0.6rem 0.8rem !important;
    font-size: 0.75rem !important;
    font-family: 'Poppins', 'Inter', sans-serif !important;
    transition: all 0.3s ease !important;
}

.select2-container--default .select2-selection--single:focus,
.select2-container--default.select2-container--focus .select2-selection--single {
    border-color: #087fc2 !important;
    box-shadow: 0 0 0 3px rgba(8, 127, 194, 0.1) !important;
    outline: none !important;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 24px !important;
    padding-left: 0 !important;
    color: #495057 !important;
    font-size: 0.75rem !important;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px !important;
    right: 8px !important;
}

.select2-dropdown {
    border: 1.5px solid #e2e8f0 !important;
    border-radius: 0.5rem !important;
    font-size: 0.75rem !important;
    font-family: 'Poppins', 'Inter', sans-serif !important;
    z-index: 9999 !important;
}

.select2-results__option {
    padding: 0.5rem 0.8rem !important;
    font-size: 0.75rem !important;
}

.select2-results__option--highlighted {
    background-color: #087fc2 !important;
    color: white !important;
}

.select2-search--dropdown .select2-search__field {
    border: 1.5px solid #e2e8f0 !important;
    border-radius: 0.5rem !important;
    padding: 0.5rem 0.8rem !important;
    font-size: 0.75rem !important;
    font-family: 'Poppins', 'Inter', sans-serif !important;
}

.select2-search--dropdown .select2-search__field:focus {
    border-color: #087fc2 !important;
    outline: none !important;
    box-shadow: 0 0 0 3px rgba(8, 127, 194, 0.1) !important;
}

.select2-container.is-invalid .select2-selection--single {
    border-color: #dc3545 !important;
}

.select2-container.is-valid .select2-selection--single {
    border-color: #198754 !important;
}

.select2-container {
    width: 100% !important;
}

/* Dropdown/Select specific styling - Matched to Create */
.form-control select,
.form-select,
select.form-control {
    font-size: 0.75rem !important;
    font-family: 'Poppins', 'Inter', sans-serif !important;
}

/* Dropdown options */
.form-control option,
.form-select option,
select.form-control option {
    font-size: 0.75rem !important;
    font-family: 'Poppins', 'Inter', sans-serif !important;
    padding: 0.5rem !important;
}

/* Input fields */
.form-control input,
input.form-control {
    font-size: 0.75rem !important;
    font-family: 'Poppins', 'Inter', sans-serif !important;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}

{% block admin_content %}
<style>
/* ============================================
   EDIT CUSTOMER PAGE STYLES - MATCHED TO CREATE.HTML
   ============================================ */

/* Admin Card Header - Compact like Create */
.admin-card-header {
    background: linear-gradient(135deg, #087fc2 0%, #0669a0 100%);
    color: white;
    padding: 0.75rem 1rem;
    border-radius: 8px 8px 0 0;
}

.admin-card-title {
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0;
    color: white !important;
    font-family: 'Poppins', 'Inter', sans-serif;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
}

.admin-card-title i {
    font-size: 0.875rem;
}

/* Admin Card Body - Matched to Create */
.admin-card-body {
    background: white;
    padding: 0.875rem;
    border-radius: 0 0 8px 8px;
    max-height: calc(100vh - 150px);
    overflow-y: auto;
}

/* Section Headers - Compact like Create */
.section-header {
    padding: 0.25rem 0;
    margin: 0.5rem 0 0.25rem 0;
    border-bottom: 1.5px solid #e9ecef;
}

.section-header h6 {
    font-size: 0.75rem;
    font-weight: 600;
    color: #087fc2;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-family: 'Poppins', 'Inter', sans-serif;
}

.section-header h6 i {
    font-size: 0.75rem;
}

/* Form Labels - Compact like Create */
.form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 0.25rem;
    font-size: 0.75rem;
    font-family: 'Poppins', 'Inter', sans-serif;
}

/* Form Controls - Matched to Create */
.form-control,
.form-select {
    border: 1.5px solid #e2e8f0;
    border-radius: 0.5rem;
    padding: 0.6rem 0.8rem;
    font-size: 0.75rem;
    transition: all 0.3s ease;
    font-family: 'Poppins', 'Inter', sans-serif;
}

.form-control:focus,
.form-select:focus {
    border-color: #087fc2;
    box-shadow: 0 0 0 3px rgba(8, 127, 194, 0.1);
}

/* Small Text - Compact like Create */
small.text-muted {
    font-size: 0.675rem;
    font-weight: 400;
    color: #6c757d;
    font-family: 'Poppins', 'Inter', sans-serif;
}

/* Required Asterisk */
.text-danger {
    color: #dc3545 !important;
    font-weight: 600;
}

/* Email Row - EXACTLY like Create */
.email-row-container {
    margin-bottom: 0.5rem;
}

/* Skip Verification Box - EXACTLY like Create (Admin Override Column) */
.skip-verification-box {
    background: #fff3cd;
    border: 1.5px solid #ffc107;
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    height: 38px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.skip-verification-box i {
    font-size: 0.75rem;
    color: #ffc107;
}

.skip-verification-box .form-check {
    margin: 0;
    display: flex;
    align-items: center;
}

.skip-verification-box .form-check-input {
    margin: 0;
}

.skip-verification-box .form-check-label {
    font-size: 0.675rem;
    font-weight: 500;
    color: #664d03;
    cursor: pointer;
    margin: 0;
    font-family: 'Poppins', 'Inter', sans-serif;
    white-space: nowrap;
}

/* Small helper text under skip box */
.skip-helper-text {
    font-size: 0.625rem;
    font-weight: 400;
    color: #6c757d;
    margin-top: 0.25rem;
    display: block;
}

/* Email Change Alert - Improved Design */
.email-change-alert {
    background: #d1ecf1;
    border: 1.5px solid #0dcaf0;
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.5rem;
    display: none;
    align-items: center;
    gap: 0.5rem;
}

.email-change-alert.show {
    display: flex !important;
}

.email-change-alert i {
    color: #0dcaf0;
    font-size: 0.875rem;
    flex-shrink: 0;
}

.email-change-alert .alert-text {
    flex: 1;
}

.email-change-alert .alert-text strong {
    display: block;
    color: #055160;
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 0.125rem;
}

.email-change-alert .alert-text small {
    color: #087990;
    font-size: 0.675rem;
}

/* Password Wrapper - Matched to Create */
.password-wrapper {
    position: relative;
}

.password-wrapper .form-control {
    padding-right: 2.5rem;
}

.password-toggle-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #6c757d;
    z-index: 10;
    font-size: 0.75rem;
    transition: color 0.3s ease;
}

.password-toggle-icon:hover {
    color: #087fc2;
}

/* Validation Messages - Matched to Create */
.validation-msg {
    font-size: 0.675rem;
    margin-top: 0.25rem;
    display: none;
    font-weight: 500;
    font-family: 'Poppins', 'Inter', sans-serif;
}

.validation-msg.show {
    display: block;
}

.validation-msg.success {
    color: #198754;
}

.validation-msg.error {
    color: #dc3545;
}

/* OTP Section - Matched to Create */
#otpSection {
    background: #f0f9ff;
    padding: 0.625rem;
    border-radius: 6px;
    border: 1.5px solid #087fc2;
    margin-bottom: 0.5rem;
}

#otpInput {
    font-size: 0.875rem;
    letter-spacing: 0.25rem;
    text-align: center;
    font-weight: 600;
    font-family: 'Poppins', 'Inter', sans-serif;
}

/* Buttons - Compact like Create */
.btn {
    padding: 0.35rem 0.75rem;
    font-weight: 500;
    border-radius: 6px;
    font-size: 0.75rem;
    border-width: 1.5px;
    transition: all 0.3s ease;
    font-family: 'Poppins', 'Inter', sans-serif;
}

.btn i {
    font-size: 0.675rem;
}

.btn:hover {
    transform: translateY(-1px);
}

.btn:active {
    transform: translateY(0);
}

.btn-primary {
    background-color: #087fc2;
    border-color: #087fc2;
}

.btn-primary:hover {
    background-color: #0669a0;
    border-color: #0669a0;
}

.btn-outline-primary {
    color: #087fc2;
    border-color: #087fc2;
}

.btn-outline-primary:hover {
    background-color: #087fc2;
    color: white;
}

.btn-success {
    background-color: #10b981;
    border-color: #10b981;
}

.btn-success:hover {
    background-color: #059669;
    border-color: #059669;
}

.btn-link {
    color: #087fc2;
    text-decoration: none;
    font-size: 0.75rem;
}

.btn-link:hover {
    color: #0669a0;
    text-decoration: underline;
}

/* Input Groups - Matched to Create */
.input-group .btn {
    border-radius: 0 6px 6px 0;
}

/* Form Check Switches - Matched to Create */
.form-check-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: #495057;
    font-family: 'Poppins', 'Inter', sans-serif;
}

/* Spinner - Matched to Create */
.spinner-border-sm {
    width: 0.75rem;
    height: 0.75rem;
    border-width: 0.125em;
}

/* Row spacing - Matched to Create */
.row.g-3 > * {
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
}

/* Card - Matched to Create */
.card {
    border: none;
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
}

/* Responsive Adjustments */
@media (max-width: 991.98px) {
    .admin-card-body {
        padding: 0.75rem;
    }
}

@media (max-width: 767.98px) {
    .admin-card-body {
        padding: 0.625rem;
    }

    .skip-verification-box .form-check-label {
        font-size: 0.625rem;
    }

    .btn {
        font-size: 0.675rem;
        padding: 0.3rem 0.65rem;
    }
}

@media (max-width: 575.98px) {
    .admin-card-body {
        padding: 0.5rem;
    }
}
</style>

<div class="container-fluid px-4 py-4">
    <div class="card border-0 shadow-sm">
        <div class="admin-card-header">
            <div class="d-flex justify-content-between align-items-center" style="width: 100%;">
                <h5 class="admin-card-title">
                    <i class="fas fa-user-edit me-2"></i>Edit Customer
                </h5>
                <a href="{% url 'core:admin_users' %}" class="btn btn-light btn-sm" style="padding: 0.35rem 0.75rem; font-size: 0.75rem; border-radius: 6px; font-weight: 500;">
                    <i class="fas fa-arrow-left me-1" style="font-size: 0.75rem;"></i>Back to List
                </a>
            </div>
        </div>
        
        <div class="admin-card-body">
            <form method="post" id="editCustomerForm" novalidate>
                {% csrf_token %}
                
                <!-- Personal Information -->
                <div class="section-header">
                    <h6><i class="fas fa-user"></i>Personal Information</h6>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-6 mb-2">
                        <label for="id_first_name" class="form-label">First Name <span class="text-danger">*</span></label>
                        {{ form.first_name }}
                        <div id="firstNameMsg" class="validation-msg"></div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label for="id_last_name" class="form-label">Last Name <span class="text-danger">*</span></label>
                        {{ form.last_name }}
                        <div id="lastNameMsg" class="validation-msg"></div>
                    </div>
                </div>
                
                <!-- Email Verification - EXACTLY like Create -->
                <div class="section-header">
                    <h6><i class="fas fa-envelope"></i>Email Verification</h6>
                </div>
                
                <!-- Email Change Alert -->
                <div class="email-change-alert" id="emailChangeAlert">
                    <i class="fas fa-info-circle"></i>
                    <div class="alert-text">
                        <strong>Email Address Changed!</strong>
                        <small>New email must be verified with OTP before saving (or enable Admin Override)</small>
                    </div>
                </div>
                
                <div class="row email-row-container">
                    <div class="col-md-8 mb-2">
                        <label for="id_email" class="form-label">Business Email <span class="text-danger">*</span></label>
                        <div class="input-group">
                            {{ form.email }}
                            <button class="btn btn-outline-primary btn-sm" type="button" id="sendOtpBtn" disabled style="padding: 0.35rem 0.75rem; font-weight: 500; border-radius: 0 6px 6px 0; font-size: 0.75rem; border-width: 1.5px; color: #087fc2; border-color: #087fc2;">
                                <i class="fas fa-paper-plane me-1" style="font-size: 0.675rem;"></i>Send OTP
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1" style="font-size: 0.675rem; font-weight: 400;">
                            <i class="fas fa-info-circle"></i> Business email required
                        </small>
                        <div id="emailMsg" class="validation-msg"></div>
                        <input type="hidden" id="originalEmail" value="{{ form.instance.email }}">
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">Admin Override</label>
                        <div class="skip-verification-box">
                            <i class="fas fa-shield-alt"></i>
                            <div class="form-check form-switch" style="margin: 0;">
                                {{ form.skip_email_validation }}
                                <label class="form-check-label" for="skipVerification" style="font-size: 0.675rem; font-weight: 500; color: #664d03; cursor: pointer; margin: 0; font-family: 'Poppins', 'Inter', sans-serif; white-space: nowrap;">
                                    Skip OTP
                                </label>
                            </div>
                        </div>
                        <small class="text-muted d-block mt-1" style="font-size: 0.625rem; font-weight: 400;">
                            <strong>ON</strong>=Bypass | <strong>OFF</strong>=Require
                        </small>
                    </div>
                </div>
                
                <!-- OTP Section - Matched to Create -->
                <div id="otpSection" style="display:none;">
                    <div class="row">
                        <div class="col-md-8 mb-2">
                            <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">Enter OTP <span style="color: #dc3545; font-weight: 600;">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="otpInput" maxlength="6" placeholder="000000" inputmode="numeric" style="font-size: 0.875rem; letter-spacing: 0.25rem; text-align: center; font-weight: 600;">
                                <button type="button" class="btn btn-success btn-sm" id="verifyOtpBtn" style="padding: 0.35rem 0.75rem; font-weight: 500; border-radius: 0 6px 6px 0; font-size: 0.75rem; background-color: #10b981; border-color: #10b981;">
                                    <i class="fas fa-check me-1" style="font-size: 0.675rem;"></i>Verify
                                </button>
                            </div>
                            <div id="otpMsg" style="font-size: 0.675rem; margin-top: 0.25rem; display: none; font-weight: 500;"></div>
                            <small class="text-muted" style="font-size: 0.675rem;">Check <strong id="otpEmailDisplay"></strong></small>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">Actions</label>
                            <div class="d-flex flex-column gap-1">
                                <button type="button" class="btn btn-link p-0 text-start" id="resendOtpBtn" style="color: #087fc2; text-decoration: none; font-size: 0.75rem; font-weight: 500;">
                                    <i class="fas fa-redo me-1"></i>Resend OTP
                                </button>
                                <small class="text-muted" id="otpTimerDisplay" style="font-size: 0.675rem;"></small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contact Information -->
                <div class="section-header">
                    <h6><i class="fas fa-phone"></i>Contact Information</h6>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-3 mb-2">
                        <label for="id_country_code" class="form-label">Country Code <span class="text-danger">*</span></label>
                        {{ form.country_code }}
                        <small class="text-muted d-block mt-1" style="font-size: 0.675rem; font-weight: 400;">
                            <i class="fas fa-globe"></i> Search or select
                        </small>
                        <div id="countryCodeMsg" class="validation-msg"></div>
                    </div>
                    <div class="col-md-9 mb-2">
                        <label for="id_mobile" class="form-label">Mobile Number <span class="text-danger">*</span></label>
                        {{ form.mobile }}
                        <small class="text-muted d-block mt-1" style="font-size: 0.675rem; font-weight: 400;" id="mobileHintText">
                            <i class="fas fa-info-circle"></i> Enter mobile number (without country code)
                        </small>
                        <div id="mobileMsg" class="validation-msg"></div>
                    </div>
                </div>
                
                <!-- Password Section -->
                <div class="section-header">
                    <h6><i class="fas fa-lock"></i>Change Password (Optional)</h6>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-6 mb-2">
                        <label for="id_new_password" class="form-label">New Password</label>
                        <div class="password-wrapper" style="position: relative;">
                            {{ form.new_password }}
                            <i class="fas fa-eye password-toggle-icon" id="togglePassword" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #6c757d; z-index: 10; font-size: 0.75rem;"></i>
                        </div>
                        <small class="text-muted d-block mt-1" style="font-size: 0.675rem; font-weight: 400;">Leave blank to keep current password</small>
                        <div id="pass1Msg" class="validation-msg"></div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label for="id_confirm_new_password" class="form-label">Confirm New Password</label>
                        <div class="password-wrapper" style="position: relative;">
                            {{ form.confirm_new_password }}
                            <i class="fas fa-eye password-toggle-icon" id="toggleConfirmPassword" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #6c757d; z-index: 10; font-size: 0.75rem;"></i>
                        </div>
                        <div id="pass2Msg" class="validation-msg"></div>
                    </div>
                </div>
                
                <!-- Business Information -->
                <div class="section-header">
                    <h6><i class="fas fa-briefcase"></i>Business Information</h6>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-4 mb-2">
                        <label for="id_organization" class="form-label">Organization</label>
                        {{ form.organization }}
                    </div>
                    <div class="col-md-4 mb-2">
                        <label for="id_job_title" class="form-label">Job Title</label>
                        {{ form.job_title }}
                    </div>
                    <div class="col-md-4 mb-2">
                        <label for="editCategorySelect" class="form-label">Business Category</label>
                        {{ form.business_category }}
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-md-12 mb-2">
                        <label for="editSubcategorySelect" class="form-label">Business Subcategory</label>
                        <div class="d-flex align-items-center gap-2">
                            {{ form.business_subcategory }}
                            <div class="spinner-border spinner-border-sm" id="subcategoryLoader" style="display:none; width: 0.75rem; height: 0.75rem; border-width: 0.125em;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Referral Information -->
                <div class="section-header">
                    <h6><i class="fas fa-share-alt"></i>Referral Information</h6>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-12 mb-2">
                        <label for="id_referral_source" class="form-label">Referral Source</label>
                        {{ form.referral_source }}
                    </div>
                    <div class="col-md-12 mb-2">
                        <label for="id_referral_message" class="form-label">Referral Message</label>
                        {{ form.referral_message }}
                    </div>
                </div>
                
                <!-- Account Status -->
                <div class="section-header">
                    <h6><i class="fas fa-cog"></i>Account Status</h6>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-4 mb-2">
                        <div class="form-check form-switch">
                            {{ form.is_approved }}
                            <label class="form-check-label" for="id_is_approved">Account Approved</label>
                        </div>
                    </div>
                    <div class="col-md-4 mb-2">
                        <div class="form-check form-switch">
                            {{ form.is_active }}
                            <label class="form-check-label" for="id_is_active">Account Active</label>
                        </div>
                    </div>
                    <div class="col-md-4 mb-2">
                        <div class="form-check form-switch">
                            {{ form.is_email_verified }}
                            <label class="form-check-label" for="id_is_email_verified">Email Verified</label>
                        </div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="mt-2">
                    <button type="submit" class="btn btn-primary btn-sm" id="submitBtn" style="padding: 0.35rem 0.75rem; font-weight: 500; border-radius: 6px; font-size: 0.75rem; background-color: #087fc2; border-color: #087fc2;">
                        <i class="fas fa-save me-1" style="font-size: 0.75rem;"></i>Update Customer
                    </button>
                    <a href="{% url 'core:admin_users' %}" class="btn btn-outline-secondary btn-sm" style="padding: 0.35rem 0.75rem; font-weight: 500; border-radius: 6px; font-size: 0.75rem;">
                        <i class="fas fa-times me-1" style="font-size: 0.75rem;"></i>Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form elements
    const form = document.getElementById('editCustomerForm');
    const email = document.getElementById('id_email');
    const originalEmail = document.getElementById('originalEmail');
    const firstName = document.getElementById('id_first_name');
    const lastName = document.getElementById('id_last_name');
    const mobile = document.getElementById('id_mobile');
    const countryCode = document.getElementById('id_country_code');
    const password1 = document.getElementById('id_new_password');
    const password2 = document.getElementById('id_confirm_new_password');
    const skipValidation = document.getElementById('skipVerification');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const otpSection = document.getElementById('otpSection');
    const otpInput = document.getElementById('otpInput');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const resendOtpBtn = document.getElementById('resendOtpBtn');
    const otpTimerDisplay = document.getElementById('otpTimerDisplay');
    const otpEmailDisplay = document.getElementById('otpEmailDisplay');
    const emailChangeAlert = document.getElementById('emailChangeAlert');
    const category = document.getElementById('editCategorySelect');
    const subcategory = document.getElementById('editSubcategorySelect');
    const submitBtn = document.getElementById('submitBtn');
    
    let emailChanged = false;
    let emailVerified = false;
    let otpTimer = null;
    let resendCooldown = 60;
    
    const commonPasswords = ['password', '12345678', 'qwerty', 'abc123', 'password123'];
    
    // ========================================
    // âœ… COUNTRY-SPECIFIC MOBILE FORMATS
    // ========================================
    const COUNTRY_MOBILE_FORMATS = {
        '+1': { min: 10, max: 10, name: 'USA/Canada' },
        '+44': { min: 10, max: 10, name: 'UK' },
        '+91': { min: 10, max: 10, name: 'India' },
        '+86': { min: 11, max: 11, name: 'China' },
        '+61': { min: 9, max: 9, name: 'Australia' },
        '+971': { min: 9, max: 9, name: 'UAE' },
        '+65': { min: 8, max: 8, name: 'Singapore' },
        '+81': { min: 10, max: 10, name: 'Japan' },
        '+49': { min: 10, max: 11, name: 'Germany' },
        '+33': { min: 9, max: 9, name: 'France' },
        '+92': { min: 10, max: 10, name: 'Pakistan' },
        '+880': { min: 10, max: 10, name: 'Bangladesh' },
        '+94': { min: 9, max: 9, name: 'Sri Lanka' },
        '+234': { min: 10, max: 10, name: 'Nigeria' },
        '+27': { min: 9, max: 9, name: 'South Africa' },
        '+20': { min: 10, max: 10, name: 'Egypt' },
        '+254': { min: 9, max: 10, name: 'Kenya' },
        '+55': { min: 10, max: 11, name: 'Brazil' },
        '+52': { min: 10, max: 10, name: 'Mexico' },
        '+54': { min: 10, max: 10, name: 'Argentina' },
        '+82': { min: 9, max: 10, name: 'South Korea' },
        '+66': { min: 9, max: 9, name: 'Thailand' },
        '+60': { min: 9, max: 10, name: 'Malaysia' },
        '+63': { min: 10, max: 10, name: 'Philippines' },
        '+62': { min: 10, max: 13, name: 'Indonesia' },
        '+84': { min: 9, max: 10, name: 'Vietnam' },
        '+90': { min: 10, max: 10, name: 'Turkey' },
        '+966': { min: 9, max: 9, name: 'Saudi Arabia' },
        '+98': { min: 10, max: 10, name: 'Iran' },
        '+964': { min: 10, max: 10, name: 'Iraq' },
        '+972': { min: 9, max: 9, name: 'Israel' },
        '+7': { min: 10, max: 10, name: 'Russia/Kazakhstan' }
    };
    
    function getMobileFormat(countryCodeValue) {
        return COUNTRY_MOBILE_FORMATS[countryCodeValue] || { min: 7, max: 15, name: 'International' };
    }
    
    // ========================================
    // INITIALIZE SELECT2 FOR COUNTRY CODE
    // ========================================
    if (countryCode && typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
        $(countryCode).select2({
            placeholder: 'Search country code...',
            allowClear: false,
            width: '100%',
            dropdownParent: $(countryCode).parent()
        });
        
        console.log('âœ… Select2 initialized for country code');
        
        $(countryCode).on('select2:select', function() {
            $(this).removeClass('is-invalid').addClass('is-valid');
            $(this).next('.select2-container').removeClass('is-invalid').addClass('is-valid');
            $('#countryCodeMsg').hide();
        });
    }
    
    // ========================================
    // PASSWORD TOGGLE
    // ========================================
    const togglePassword = document.getElementById('togglePassword');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    
    if (togglePassword && password1) {
        togglePassword.addEventListener('click', () => {
            const type = password1.type === 'password' ? 'text' : 'password';
            password1.type = type;
            togglePassword.classList.toggle('fa-eye');
            togglePassword.classList.toggle('fa-eye-slash');
        });
    }
    
    if (toggleConfirmPassword && password2) {
        toggleConfirmPassword.addEventListener('click', () => {
            const type = password2.type === 'password' ? 'text' : 'password';
            password2.type = type;
            toggleConfirmPassword.classList.toggle('fa-eye');
            toggleConfirmPassword.classList.toggle('fa-eye-slash');
        });
    }
    
    // ========================================
    // VALIDATION HELPER FUNCTIONS
    // ========================================
    function showValidation(field, msgId, isValid, message = '') {
        if (!field) return;
        const msg = document.getElementById(msgId);
        if (!msg) return;
        
        field.classList.remove('is-valid', 'is-invalid');
        msg.classList.remove('show', 'success', 'error');
        
        if (isValid) {
            field.classList.add('is-valid');
            msg.classList.add('show', 'success');
        } else {
            field.classList.add('is-invalid');
            msg.classList.add('show', 'error');
        }
        
        msg.textContent = message;
    }
    
    function clearValidation(field, msgId) {
        if (!field) return;
        field.classList.remove('is-valid', 'is-invalid');
        const msg = document.getElementById(msgId);
        if (msg) {
            msg.classList.remove('show', 'success', 'error');
            msg.textContent = '';
        }
    }
    
    // ========================================
    // EMAIL CHANGE DETECTION
    // ========================================
    if (email && originalEmail) {
        email.addEventListener('input', function() {
            const currentEmail = this.value.trim().toLowerCase();
            const origEmail = originalEmail.value.trim().toLowerCase();
            emailChanged = (currentEmail !== origEmail);
            
            if (emailChanged) {
                emailChangeAlert.classList.add('show');
                emailVerified = false;
                sendOtpBtn.disabled = false;
            } else {
                emailChangeAlert.classList.remove('show');
                emailVerified = false;
                sendOtpBtn.disabled = true;
            }
        });
    }
    
    // ========================================
    // SKIP VALIDATION TOGGLE
    // ========================================
    if (skipValidation) {
        skipValidation.addEventListener('change', function() {
            console.log('ðŸ”„ Skip Validation:', this.checked ? 'ON' : 'OFF');
            
            if (this.checked) {
                emailVerified = true;
                showValidation(email, 'emailMsg', true, 'âœ“ Email verification skipped by admin');
                if (otpSection) otpSection.style.display = 'none';
            } else {
                emailVerified = false;
                clearValidation(email, 'emailMsg');
            }
        });
    }
    
    // ========================================
    // SEND OTP
    // ========================================
    if (sendOtpBtn && email) {
        sendOtpBtn.addEventListener('click', function() {
            const emailValue = email.value.trim();
            
            if (!emailValue) {
                showValidation(email, 'emailMsg', false, 'Enter email first');
                return;
            }
            
            sendOtpBtn.disabled = true;
            sendOtpBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
            
            fetch('{% url "core:admin_send_otp" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ email: emailValue })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showValidation(email, 'emailMsg', true, 'âœ“ OTP sent to ' + emailValue);
                    if (otpSection) {
                        otpSection.style.display = 'block';
                        if (otpInput) otpInput.focus();
                    }
                    if (otpEmailDisplay) {
                        otpEmailDisplay.textContent = emailValue;
                    }
                    startResendTimer();
                    sendOtpBtn.innerHTML = '<i class="fas fa-check me-1"></i>OTP Sent';
                } else {
                    showValidation(email, 'emailMsg', false, data.message || 'Failed to send OTP');
                    sendOtpBtn.disabled = false;
                    sendOtpBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send OTP';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showValidation(email, 'emailMsg', false, 'Network error');
                sendOtpBtn.disabled = false;
                sendOtpBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send OTP';
            });
        });
    }
    
    // ========================================
    // VERIFY OTP
    // ========================================
    if (verifyOtpBtn && otpInput) {
        verifyOtpBtn.addEventListener('click', function() {
            const otp = otpInput.value.trim();
            const emailValue = email.value.trim();
            const otpMsg = document.getElementById('otpMsg');
            
            if (!otp || otp.length !== 6) {
                if (otpMsg) {
                    otpMsg.style.display = 'block';
                    otpMsg.className = 'show error';
                    otpMsg.textContent = 'Enter 6-digit OTP';
                }
                return;
            }
            
            verifyOtpBtn.disabled = true;
            verifyOtpBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Verifying...';
            
            fetch('{% url "core:admin_verify_otp" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ email: emailValue, otp: otp })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    emailVerified = true;
                    if (otpMsg) {
                        otpMsg.style.display = 'block';
                        otpMsg.className = 'show success';
                        otpMsg.textContent = 'âœ… Email verified successfully!';
                    }
                    showValidation(email, 'emailMsg', true, 'âœ“ Email verified');
                    setTimeout(() => {
                        if (otpSection) otpSection.style.display = 'none';
                    }, 2000);
                    verifyOtpBtn.innerHTML = '<i class="fas fa-check me-1"></i>Verified!';
                    emailChangeAlert.classList.remove('show');
                    clearInterval(otpTimer);
                } else {
                    if (otpMsg) {
                        otpMsg.style.display = 'block';
                        otpMsg.className = 'show error';
                        otpMsg.textContent = data.message || 'Invalid OTP';
                    }
                    verifyOtpBtn.disabled = false;
                    verifyOtpBtn.innerHTML = '<i class="fas fa-check me-1"></i>Verify';
                }
            });
        });
        
        otpInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                verifyOtpBtn.click();
            }
        });
    }
    
    // ========================================
    // RESEND OTP
    // ========================================
    if (resendOtpBtn) {
        resendOtpBtn.addEventListener('click', () => sendOtpBtn.click());
    }
    
    // ========================================
    // RESEND TIMER
    // ========================================
    function startResendTimer() {
        let timeLeft = resendCooldown;
        
        if (resendOtpBtn) resendOtpBtn.disabled = true;
        
        if (otpTimer) clearInterval(otpTimer);
        
        otpTimer = setInterval(() => {
            timeLeft--;
            
            if (otpTimerDisplay) {
                otpTimerDisplay.textContent = `Resend in ${timeLeft}s`;
            }
            
            if (timeLeft <= 0) {
                clearInterval(otpTimer);
                if (resendOtpBtn) resendOtpBtn.disabled = false;
                if (otpTimerDisplay) otpTimerDisplay.textContent = 'You can resend OTP now';
            }
        }, 1000);
    }
    
    // ========================================
    // âœ… MOBILE VALIDATION (COUNTRY-AWARE)
    // ========================================
    if (mobile && countryCode) {
        // âœ… Update hint text when country changes
        const updateMobileHint = function() {
            const selectedCountry = (typeof $ !== 'undefined' && $(countryCode).data('select2')) 
                ? $(countryCode).val() 
                : countryCode.value || '+91';
            
            const format = getMobileFormat(selectedCountry);
            const hintElement = document.getElementById('mobileHintText');
            
            if (hintElement) {
                if (format.min === format.max) {
                    hintElement.innerHTML = `<i class="fas fa-info-circle"></i> Enter ${format.min}-digit mobile number for ${format.name}`;
                } else {
                    hintElement.innerHTML = `<i class="fas fa-info-circle"></i> Enter ${format.min}-${format.max} digit mobile number for ${format.name}`;
                }
            }
        };
        
        // âœ… Input handler - Dynamic max length based on country
        mobile.addEventListener('input', function() {
            const selectedCountry = (typeof $ !== 'undefined' && $(countryCode).data('select2')) 
                ? $(countryCode).val() 
                : countryCode.value || '+91';
            
            const format = getMobileFormat(selectedCountry);
            
            // Only allow digits and limit to max length
            this.value = this.value.replace(/\D/g, '').slice(0, format.max);
        });
        
        // âœ… Blur validation - Dynamic validation based on country
        mobile.addEventListener('blur', function() {
            const selectedCountry = (typeof $ !== 'undefined' && $(countryCode).data('select2')) 
                ? $(countryCode).val() 
                : countryCode.value || '+91';
            
            const format = getMobileFormat(selectedCountry);
            const mobileValue = this.value.trim();
            
            if (!mobileValue) {
                clearValidation(this, 'mobileMsg');
                return;
            }
            
            const length = mobileValue.length;
            
            if (length < format.min || length > format.max) {
                if (format.min === format.max) {
                    showValidation(this, 'mobileMsg', false, 
                        `Mobile number for ${format.name} must be exactly ${format.min} digits`);
                } else {
                    showValidation(this, 'mobileMsg', false, 
                        `Mobile number for ${format.name} must be ${format.min}-${format.max} digits`);
                }
            } else {
                showValidation(this, 'mobileMsg', true, 'âœ“ Valid mobile number');
            }
        });
        
        // âœ… Update validation when country code changes
        if (typeof $ !== 'undefined') {
            $(countryCode).on('select2:select', function() {
                updateMobileHint();
                if (mobile.value.trim()) {
                    mobile.dispatchEvent(new Event('blur'));
                }
            });
        }
        
        countryCode.addEventListener('change', function() {
            updateMobileHint();
            if (mobile.value.trim()) {
                mobile.dispatchEvent(new Event('blur'));
            }
        });
        
        // Set initial hint
        updateMobileHint();
    }
    
    // ========================================
    // CATEGORY/SUBCATEGORY
    // ========================================
    if (category && subcategory) {
        category.addEventListener('change', function() {
            const categoryId = this.value;
            
            if (!categoryId) {
                subcategory.innerHTML = '<option value="">Select category first</option>';
                subcategory.disabled = true;
                return;
            }
            
            subcategory.disabled = true;
            subcategory.innerHTML = '<option value="">Loading...</option>';
            const loader = document.getElementById('subcategoryLoader');
            if (loader) loader.style.display = 'inline-block';
            
            fetch('{% url "core:get_subcategories" %}?category_id=' + categoryId)
                .then(res => res.json())
                .then(data => {
                    subcategory.innerHTML = '<option value="">Select subcategory</option>';
                    if (data.success && data.subcategories) {
                        data.subcategories.forEach(sub => {
                            subcategory.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                        });
                    }
                    subcategory.disabled = false;
                    if (loader) loader.style.display = 'none';
                });
        });
    }
    
    // ========================================
    // FORM SUBMISSION
    // ========================================
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            let isValid = true;
            
            // Validate first name
            if (firstName && !firstName.value.trim()) {
                showValidation(firstName, 'firstNameMsg', false, 'Required');
                isValid = false;
            }
            
            // Validate last name
            if (lastName && !lastName.value.trim()) {
                showValidation(lastName, 'lastNameMsg', false, 'Required');
                isValid = false;
            }
            
            // Country code validation
            if (countryCode) {
                const countryValue = (typeof $ !== 'undefined' && $(countryCode).data('select2')) 
                    ? $(countryCode).val() 
                    : countryCode.value;
                
                if (!countryValue) {
                    if (typeof $ !== 'undefined') {
                        $(countryCode).addClass('is-invalid');
                        $(countryCode).next('.select2-container').addClass('is-invalid');
                    }
                    showValidation(countryCode, 'countryCodeMsg', false, 'Required');
                    isValid = false;
                }
            }
            
            // Email verification check
            if (skipValidation && email && emailChanged && !skipValidation.checked && !emailVerified) {
                showValidation(email, 'emailMsg', false, 'âš  Verify new email or enable Admin Override');
                isValid = false;
            }
            
            // âœ… Validate mobile with country-aware logic
            if (mobile && countryCode) {
                const selectedCountry = (typeof $ !== 'undefined' && $(countryCode).data('select2')) 
                    ? $(countryCode).val() 
                    : countryCode.value || '+91';
                
                const format = getMobileFormat(selectedCountry);
                const mobileValue = mobile.value.trim();
                const length = mobileValue.length;
                
                if (!mobileValue) {
                    showValidation(mobile, 'mobileMsg', false, 'Mobile number is required');
                    isValid = false;
                } else if (length < format.min || length > format.max) {
                    if (format.min === format.max) {
                        showValidation(mobile, 'mobileMsg', false, 
                            `Mobile number for ${format.name} must be exactly ${format.min} digits`);
                    } else {
                        showValidation(mobile, 'mobileMsg', false, 
                            `Mobile number for ${format.name} must be ${format.min}-${format.max} digits`);
                    }
                    isValid = false;
                }
            }
            
            // Password validation (optional)
            if (password1 && password1.value) {
                if (password1.value.length < 8) {
                    showValidation(password1, 'pass1Msg', false, 'Min 8 characters');
                    isValid = false;
                }
                if (password2.value !== password1.value) {
                    showValidation(password2, 'pass2Msg', false, 'Passwords do not match');
                    isValid = false;
                }
            }
            
            // Scroll to first error
            if (!isValid) {
                const firstInvalid = form.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    if (typeof $ !== 'undefined' && $(firstInvalid).hasClass('select2-hidden-accessible')) {
                        $(firstInvalid).select2('open');
                    } else {
                        firstInvalid.focus();
                    }
                }
                return;
            }
            
            // Submit form
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Updating...';
            form.submit();
        });
    }
    
    console.log('âœ… Edit customer form JavaScript initialized with country-aware mobile validation');
});
</script>
{% endblock %}