{% extends 'admin/base.html' %}
{% load static %}

{% block page_title %}Edit Customer{% endblock %}

{% block admin_content %}
<style>
.password-wrapper {
    position: relative;
}
.password-wrapper .form-control {
    padding-right: 45px;
}
.password-toggle-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #6c757d;
    z-index: 10;
    transition: color 0.3s ease;
}
.password-toggle-icon:hover {
    color: #087fc2;
}
.validation-msg {
    font-size: 0.875rem;
    margin-top: 0.25rem;
    display: none;
    font-weight: 500;
}
.validation-msg.show {
    display: block;
}
.validation-msg.success {
    color: #198754;
}
.validation-msg.error {
    color: #dc3545;
}
.password-strength {
    margin-top: 0.5rem;
}
.password-strength .progress {
    height: 4px;
    border-radius: 2px;
}
.password-strength .progress-bar {
    transition: width 0.3s ease, background-color 0.3s ease;
}
.strength-weak { background-color: #dc3545 !important; }
.strength-medium { background-color: #ffc107 !important; }
.strength-strong { background-color: #198754 !important; }
#otpInput {
    font-size: 1.2rem;
    letter-spacing: 0.3rem;
    text-align: center;
    font-weight: 600;
}

.section-header {
    padding: var(--spacing-md) 0;
    margin: var(--spacing-lg) 0 var(--spacing-md) 0;
    border-bottom: 2px solid #e9ecef;
}

.section-header h5 {
    font-size: 1.125rem;
    font-weight: 700;
    color: #087fc2;
    margin: 0;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.section-header h5 i {
    font-size: 1.25rem;
}

.form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.form-control, .form-select {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 0.625rem 0.875rem;
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #087fc2;
    box-shadow: 0 0 0 3px rgba(8, 127, 194, 0.1);
}

.form-control.is-valid {
    border-color: #198754;
    background-image: none;
}

.form-control.is-invalid {
    border-color: #dc3545;
    background-image: none;
}

.btn {
    padding: 0.625rem 1.25rem;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

.btn:active {
    transform: translateY(0);
}

.btn-outline-primary {
    border-width: 2px;
    color: #087fc2;
    border-color: #087fc2;
}

.btn-outline-primary:hover {
    background-color: #087fc2;
    border-color: #087fc2;
    color: white;
}

.btn-primary {
    background-color: #087fc2;
    border-color: #087fc2;
}

.btn-primary:hover,
.btn-primary:focus,
.btn-primary:active {
    background-color: #0669a0;
    border-color: #0669a0;
}

#otpSection {
    background: #f8f9fa;
    padding: var(--spacing-lg);
    border-radius: 8px;
    border: 2px dashed #dee2e6;
    margin-bottom: var(--spacing-md);
}

.form-check-label {
    font-weight: 500;
    color: #495057;
}

.admin-card-header {
    background: linear-gradient(135deg, #087fc2 0%, #0669a0 100%);
    color: white;
    padding: var(--spacing-xl);
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.admin-card-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    color: white !important;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.admin-card-body {
    background: white;
    padding: var(--spacing-xl);
    border-radius: 0 0 12px 12px;
}

.text-danger {
    color: #dc3545 !important;
    font-weight: 700;
}

.input-group .btn {
    border-radius: 0 8px 8px 0;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
    border-width: 0.15em;
}

.btn-link {
    color: #087fc2;
    text-decoration: none;
}

.btn-link:hover {
    color: #0669a0;
    text-decoration: underline;
}

/* Alert customization */
.alert-danger {
    background-color: rgba(239, 68, 68, 0.1);
    border-color: #ef4444;
    color: #dc3545;
}

/* Form check customization */
.form-check-input:checked {
    background-color: #087fc2;
    border-color: #087fc2;
}

.form-check-input:focus {
    border-color: #087fc2;
    box-shadow: 0 0 0 0.25rem rgba(8, 127, 194, 0.25);
}

.form-switch .form-check-input:checked {
    background-color: #087fc2;
}

/* Button success */
.btn-success {
    background-color: #10b981;
    border-color: #10b981;
}

.btn-success:hover,
.btn-success:focus {
    background-color: #059669;
    border-color: #059669;
}

.btn-outline-success {
    color: #10b981;
    border-color: #10b981;
}

.btn-outline-success:hover {
    background-color: #10b981;
    border-color: #10b981;
    color: white;
}

/* Secondary button */
.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
}

.btn-secondary:hover,
.btn-secondary:focus {
    background-color: #5a6268;
    border-color: #5a6268;
}

@media (max-width: 768px) {
    .admin-card-header {
        flex-direction: column;
        gap: var(--spacing-md);
        align-items: flex-start;
    }
    
    .admin-card-body {
        padding: var(--spacing-md);
    }
    
    #otpSection {
        padding: var(--spacing-md);
    }
}
</style>

<div class="admin-card">
    <div class="admin-card-header">
        <h2 class="admin-card-title">
            <i class="fas fa-user-edit"></i>Edit Customer
        </h2>
        <a href="{% url 'core:admin_users' %}" class="btn btn-light">
            <i class="fas fa-arrow-left me-2"></i>Back
        </a>
    </div>
    
    <div class="admin-card-body">
        <form method="post" id="customerForm" novalidate>
            {% csrf_token %}
            
            {% if form.errors %}
                <div class="alert alert-danger alert-dismissible fade show">
                    <strong><i class="fas fa-exclamation-triangle me-2"></i>Please correct the following errors:</strong>
                    <ul class="mb-0 mt-2">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endif %}

            <!-- Personal Information -->
            <div class="section-header">
                <h5><i class="fas fa-user"></i>Personal Information</h5>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">First Name <span class="text-danger">*</span></label>
                    {{ form.first_name }}
                    <div class="validation-msg" id="firstNameMsg"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Last Name <span class="text-danger">*</span></label>
                    {{ form.last_name }}
                    <div class="validation-msg" id="lastNameMsg"></div>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="section-header">
                <h5><i class="fas fa-envelope"></i>Contact Information</h5>
            </div>
            <div class="row">
                <div class="col-md-8 mb-3">
                    <label class="form-label">Business Email <span class="text-danger">*</span></label>
                    <div class="input-group">
                        {{ form.email }}
                        <button type="button" class="btn btn-outline-primary" id="sendOtpBtn" disabled>
                            <i class="fas fa-paper-plane me-1"></i>Send OTP
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">Business email required for verification</small>
                    <div class="validation-msg" id="emailMsg"></div>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Options</label>
                    <div class="form-check form-switch">
                        {{ form.skip_email_validation }}
                        <label class="form-check-label">Skip email validation</label>
                    </div>
                    <small class="text-muted d-block">Bypass OTP verification</small>
                </div>
            </div>

            <!-- OTP Verification Section -->
            <div class="row" id="otpSection" style="display:none;">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Enter OTP Code <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="otpInput" maxlength="6" placeholder="000000">
                        <button type="button" class="btn btn-success" id="verifyOtpBtn">
                            <i class="fas fa-check me-1"></i>Verify
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">Check email for 6-digit verification code</small>
                    <div class="validation-msg" id="otpMsg"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Actions</label>
                    <div>
                        <button type="button" class="btn btn-link p-0" id="resendOtpBtn">
                            <i class="fas fa-redo me-1"></i>Resend OTP
                        </button>
                        <div class="mt-2">
                            <small class="text-muted fw-bold d-block" id="otpTimer"></small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Country Code <span class="text-danger">*</span></label>
                    {{ form.country_code }}
                </div>
                <div class="col-md-8 mb-3">
                    <label class="form-label">Mobile Number <span class="text-danger">*</span></label>
                    {{ form.mobile }}
                    <small class="text-muted d-block mt-1">10-digit mobile number</small>
                    <div class="validation-msg" id="mobileMsg"></div>
                </div>
            </div>

            <!-- Professional Information -->
            <div class="section-header">
                <h5><i class="fas fa-briefcase"></i>Professional Information</h5>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Job Title</label>
                    {{ form.job_title }}
                    <small class="text-muted d-block mt-1">e.g., Software Engineer, Manager</small>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Organization</label>
                    {{ form.organization }}
                    <small class="text-muted d-block mt-1">Company or organization name</small>
                </div>
            </div>

            <!-- Business Category -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Business Category</label>
                    {{ form.business_category }}
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Business Subcategory</label>
                    {{ form.business_subcategory }}
                    <div id="subcategoryLoader" style="display:none;">
                        <small class="text-muted">
                            <span class="spinner-border spinner-border-sm me-1"></span>Loading subcategories...
                        </small>
                    </div>
                </div>
            </div>

            <!-- Account Password -->
            <div class="section-header">
                <h5><i class="fas fa-key"></i>Account Password</h5>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Password <span class="text-danger">*</span></label>
                    <div class="password-wrapper">
                        {{ form.password }}
                        <i class="fas fa-eye password-toggle-icon" data-target="password"></i>
                    </div>
                    <small class="text-muted d-block mt-1">Minimum 8 characters with letters & numbers</small>
                    
                    <div class="password-strength" id="passwordStrength" style="display:none;">
                        <div class="progress">
                            <div class="progress-bar" id="strengthBar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted mt-1 d-block" id="strengthText"></small>
                    </div>
                    
                    <div class="validation-msg" id="pass1Msg"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Confirm Password <span class="text-danger">*</span></label>
                    <div class="password-wrapper">
                        {{ form.confirm_password }}
                        <i class="fas fa-eye password-toggle-icon" data-target="confirm_password"></i>
                    </div>
                    <small class="text-muted d-block mt-1">Re-enter password to confirm</small>
                    <div class="validation-msg" id="pass2Msg"></div>
                </div>
            </div>

            <!-- Additional Information -->
            <div class="section-header">
                <h5><i class="fas fa-info-circle"></i>Additional Information</h5>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Referral Source</label>
                    {{ form.referral_source }}
                    <small class="text-muted d-block mt-1">How did they hear about us?</small>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Notes</label>
                    {{ form.referral_message }}
                    <small class="text-muted d-block mt-1">Additional comments or context</small>
                </div>
            </div>

            <!-- Account Settings -->
            <div class="section-header">
                <h5><i class="fas fa-cog"></i>Account Settings</h5>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                        {{ form.is_approved }}
                        <label class="form-check-label fw-bold">Approve Account Immediately</label>
                    </div>
                    <small class="text-muted d-block mt-1">Customer can access portal immediately</small>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                        {{ form.send_welcome_email }}
                        <label class="form-check-label fw-bold">Send Welcome Email</label>
                    </div>
                    <small class="text-muted d-block mt-1">Email login credentials to customer</small>
                </div>
            </div>

            <hr class="my-4">

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                    <i class="fas fa-save me-2"></i>Update Customer
                </button>
                <a href="{% url 'core:admin_users' %}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times me-2"></i>Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block admin_extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('customerForm');
    const submitBtn = document.getElementById('submitBtn');
    
    const firstName = document.querySelector('[name="first_name"]');
    const lastName = document.querySelector('[name="last_name"]');
    const email = document.querySelector('[name="email"]');
    const skipValidation = document.querySelector('[name="skip_email_validation"]');
    const mobile = document.querySelector('[name="mobile"]');
    const password1 = document.querySelector('[name="password"]');
    const password2 = document.querySelector('[name="confirm_password"]');
    const category = document.querySelector('[name="business_category"]');
    const subcategory = document.querySelector('[name="business_subcategory"]');
    
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const resendOtpBtn = document.getElementById('resendOtpBtn');
    const otpSection = document.getElementById('otpSection');
    const otpInput = document.getElementById('otpInput');
    const otpTimerDisplay = document.getElementById('otpTimer');
    
    let emailVerified = false;
    let otpTimer = null;
    
    const blockedDomains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'ymail.com', 'aol.com', 'icloud.com', 'live.com'];
    const commonPasswords = ['12345678', '123456789', '1234567890', 'password', 'password1', 'password123', 'qwerty123', 'abc123456', '11111111', '00000000', '12341234', 'qwertyuiop', 'asdfghjkl', 'zxcvbnm123', 'admin123', 'welcome123', 'letmein123'];
    
    function showValidation(input, msgId, isValid, message) {
        const msg = document.getElementById(msgId);
        if (isValid) {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
            msg.className = 'validation-msg success show';
            msg.textContent = message || '✓ Valid';
        } else {
            input.classList.remove('is-valid');
            input.classList.add('is-invalid');
            msg.className = 'validation-msg error show';
            msg.textContent = message;
        }
    }
    
    function clearValidation(input, msgId) {
        input.classList.remove('is-valid', 'is-invalid');
        document.getElementById(msgId).className = 'validation-msg';
    }
    
    document.querySelectorAll('.password-toggle-icon').forEach(icon => {
        icon.addEventListener('click', function() {
            const target = this.dataset.target;
            const input = document.querySelector(`[name="${target}"]`);
            const type = input.type === 'password' ? 'text' : 'password';
            input.type = type;
            this.className = type === 'text' ? 'fas fa-eye-slash password-toggle-icon' : 'fas fa-eye password-toggle-icon';
        });
    });
    
    [firstName, lastName].forEach(field => {
        const msgId = field.name === 'first_name' ? 'firstNameMsg' : 'lastNameMsg';
        field.addEventListener('blur', () => {
            if (!field.value.trim()) showValidation(field, msgId, false, 'Required');
            else showValidation(field, msgId, true);
        });
        field.addEventListener('input', () => {
            if (field.classList.contains('is-invalid') && field.value.trim()) showValidation(field, msgId, true);
        });
    });
    
    email.addEventListener('blur', validateEmail);
    email.addEventListener('input', () => {
        if (email.classList.contains('is-invalid')) validateEmail();
        if (skipValidation.checked) {
            sendOtpBtn.disabled = true;
        } else {
            const value = email.value.trim();
            sendOtpBtn.disabled = !(value && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value));
        }
    });
    
    function validateEmail() {
        const value = email.value.trim();
        if (!value) {
            showValidation(email, 'emailMsg', false, 'Email is required');
            return false;
        }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
            showValidation(email, 'emailMsg', false, 'Invalid email format');
            return false;
        }
        if (!skipValidation.checked) {
            const domain = value.split('@')[1]?.toLowerCase();
            if (blockedDomains.includes(domain)) {
                showValidation(email, 'emailMsg', false, `Personal email (${domain}) not allowed. Check skip to override`);
                return false;
            }
        }
        return true;
    }
    
    skipValidation.addEventListener('change', function() {
        if (this.checked) {
            otpSection.style.display = 'none';
            sendOtpBtn.disabled = true;
            emailVerified = true;
            clearValidation(email, 'emailMsg');
        } else {
            emailVerified = false;
            if (email.value && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) {
                sendOtpBtn.disabled = false;
            }
        }
    });
    
    sendOtpBtn.addEventListener('click', function() {
        const emailValue = email.value.trim();
        if (!validateEmail()) return;
        
        sendOtpBtn.disabled = true;
        sendOtpBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
        
        fetch('{% url "core:admin_send_otp" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ email: emailValue })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showValidation(email, 'emailMsg', true, '✓ ' + data.message);
                otpSection.style.display = 'flex';
                otpInput.value = '';
                otpInput.disabled = false;
                otpInput.focus();
                verifyOtpBtn.disabled = false;
                verifyOtpBtn.innerHTML = '<i class="fas fa-check me-1"></i>Verify';
                verifyOtpBtn.classList.remove('btn-outline-success');
                verifyOtpBtn.classList.add('btn-success');
                resendOtpBtn.style.display = 'inline-block';
                startOtpTimer(600);
            } else {
                showValidation(email, 'emailMsg', false, data.message);
                sendOtpBtn.disabled = false;
            }
            sendOtpBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send OTP';
        })
        .catch(error => {
            console.error('Error:', error);
            showValidation(email, 'emailMsg', false, 'Failed to send OTP');
            sendOtpBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send OTP';
            sendOtpBtn.disabled = false;
        });
    });
    
    verifyOtpBtn.addEventListener('click', function() {
        const otpValue = otpInput.value.trim();
        const emailValue = email.value.trim();
        
        if (!otpValue || otpValue.length !== 6) {
            showValidation(otpInput, 'otpMsg', false, 'Enter 6-digit OTP');
            return;
        }
        
        verifyOtpBtn.disabled = true;
        verifyOtpBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Verifying...';
        
        fetch('{% url "core:admin_verify_otp" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ email: emailValue, otp: otpValue })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showValidation(otpInput, 'otpMsg', true, '✓ ' + data.message);
                emailVerified = true;
                verifyOtpBtn.innerHTML = '<i class="fas fa-check-circle me-1"></i>Verified';
                verifyOtpBtn.classList.remove('btn-success');
                verifyOtpBtn.classList.add('btn-outline-success');
                otpInput.disabled = true;
                resendOtpBtn.style.display = 'none';
                clearInterval(otpTimer);
                otpTimerDisplay.textContent = '';
            } else {
                showValidation(otpInput, 'otpMsg', false, data.message);
                verifyOtpBtn.disabled = false;
                verifyOtpBtn.innerHTML = '<i class="fas fa-check me-1"></i>Verify';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showValidation(otpInput, 'otpMsg', false, 'Verification failed');
            verifyOtpBtn.disabled = false;
            verifyOtpBtn.innerHTML = '<i class="fas fa-check me-1"></i>Verify';
        });
    });
    
    resendOtpBtn.addEventListener('click', () => sendOtpBtn.click());
    
    function startOtpTimer(seconds) {
        let remaining = seconds;
        clearInterval(otpTimer);
        otpTimer = setInterval(() => {
            const minutes = Math.floor(remaining / 60);
            const secs = remaining % 60;
            otpTimerDisplay.textContent = `⏱ Expires in ${minutes}:${secs.toString().padStart(2, '0')}`;
            if (remaining <= 0) {
                clearInterval(otpTimer);
                otpTimerDisplay.textContent = '⚠ OTP expired. Resend.';
            }
            remaining--;
        }, 1000);
    }
    
    mobile.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '').slice(0, 10);
    });
    
    mobile.addEventListener('blur', function() {
        if (!this.value) {
            clearValidation(this, 'mobileMsg');
        } else if (this.value.length === 10) {
            showValidation(this, 'mobileMsg', true, '✓ Valid');
        } else {
            showValidation(this, 'mobileMsg', false, 'Must be 10 digits');
        }
    });
    
    password1.addEventListener('input', function() {
        const value = this.value;
        const strengthDiv = document.getElementById('passwordStrength');
        const strengthBar = document.getElementById('strengthBar');
        const strengthText = document.getElementById('strengthText');
        
        if (!value) {
            strengthDiv.style.display = 'none';
            clearValidation(this, 'pass1Msg');
            return;
        }
        strengthDiv.style.display = 'block';
        let strength = 0;
        if (value.length >= 8) strength += 20;
        if (value.length >= 12) strength += 10;
        if (/[a-z]/.test(value)) strength += 20;
        if (/[A-Z]/.test(value)) strength += 20;
        if (/\d/.test(value)) strength += 20;
        if (/[^a-zA-Z\d]/.test(value)) strength += 10;
        strengthBar.style.width = strength + '%';
        if (strength < 50) {
            strengthBar.className = 'progress-bar strength-weak';
            strengthText.textContent = 'Weak password';
        } else if (strength < 75) {
            strengthBar.className = 'progress-bar strength-medium';
            strengthText.textContent = 'Medium strength';
        } else {
            strengthBar.className = 'progress-bar strength-strong';
            strengthText.textContent = 'Strong password';
        }
        if (this.classList.contains('is-invalid') || value.length >= 8) validatePass1();
        if (password2.value) validatePass2();
    });
    
    password1.addEventListener('blur', validatePass1);
    
    function validatePass1() {
        const value = password1.value;
        if (!value) {
            showValidation(password1, 'pass1Msg', false, 'Password is required');
            return false;
        }
        if (value.length < 8) {
            showValidation(password1, 'pass1Msg', false, 'Min 8 characters');
            return false;
        }
        if (/^\d+$/.test(value)) {
            showValidation(password1, 'pass1Msg', false, 'Cannot be all numeric');
            return false;
        }
        if (commonPasswords.includes(value.toLowerCase())) {
            showValidation(password1, 'pass1Msg', false, 'Too common');
            return false;
        }
        const hasLetters = /[a-zA-Z]/.test(value);
        const hasNumbers = /\d/.test(value);
        if (!hasLetters || !hasNumbers) {
            showValidation(password1, 'pass1Msg', false, 'Need letters and numbers');
            return false;
        }
        showValidation(password1, 'pass1Msg', true, '✓ Strong password');
        return true;
    }
    
    password2.addEventListener('input', validatePass2);
    password2.addEventListener('blur', validatePass2);
    
    function validatePass2() {
        if (!password2.value) {
            clearValidation(password2, 'pass2Msg');
            return false;
        }
        if (password1.value.length < 8) {
            showValidation(password2, 'pass2Msg', false, 'First password must be 8+ characters');
            return false;
        }
        if (password2.value !== password1.value) {
            showValidation(password2, 'pass2Msg', false, 'Passwords do not match');
            return false;
        }
        showValidation(password2, 'pass2Msg', true, '✓ Passwords match');
        return true;
    }
    
    if (category && subcategory) {
        category.addEventListener('change', function() {
            const categoryId = this.value;
            if (!categoryId) {
                subcategory.innerHTML = '<option value="">Select category first</option>';
                subcategory.disabled = true;
                return;
            }
            subcategory.disabled = true;
            subcategory.innerHTML = '<option value="">Loading...</option>';
            document.getElementById('subcategoryLoader').style.display = 'block';
            
            fetch(`/auth/ajax/get-subcategories/?category_id=${categoryId}`)
                .then(res => res.json())
                .then(data => {
                    subcategory.innerHTML = '<option value="">Select subcategory (optional)</option>';
                    if (data.success && data.subcategories) {
                        data.subcategories.forEach(sub => {
                            subcategory.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                        });
                    }
                    subcategory.disabled = false;
                    document.getElementById('subcategoryLoader').style.display = 'none';
                })
                .catch(() => {
                    subcategory.innerHTML = '<option value="">Error loading</option>';
                    subcategory.disabled = false;
                    document.getElementById('subcategoryLoader').style.display = 'none';
                });
        });
    }
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        let isValid = true;
        
        if (!firstName.value.trim()) {
            showValidation(firstName, 'firstNameMsg', false, 'Required');
            isValid = false;
        }
        if (!lastName.value.trim()) {
            showValidation(lastName, 'lastNameMsg', false, 'Required');
            isValid = false;
        }
        if (!validateEmail()) isValid = false;
        if (!skipValidation.checked && !emailVerified) {
            showValidation(email, 'emailMsg', false, '⚠ Verify email with OTP');
            isValid = false;
        }
        if (mobile.value.length !== 10) {
            showValidation(mobile, 'mobileMsg', false, '10 digits required');
            isValid = false;
        }
        if (!validatePass1()) isValid = false;
        if (!validatePass2()) isValid = false;
        
        if (!isValid) {
            form.querySelector('.is-invalid')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
        form.submit();
    });
});
</script>
{% endblock %}