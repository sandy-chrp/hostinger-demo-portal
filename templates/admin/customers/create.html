{% extends 'admin/base.html' %}
{% load static %}

{% block page_title %}Create Customer{% endblock %}

{% block extra_css %}
<!-- jQuery (Required for Select2) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- Custom Select2 Styling -->
<style>
/* Select2 container to match form-select */
.select2-container--default .select2-selection--single {
    border: 1.5px solid #e2e8f0 !important;
    border-radius: 0.5rem !important;
    height: 38px !important;
    padding: 0.6rem 0.8rem !important;
    font-size: 0.75rem !important;
    font-family: 'Poppins', 'Inter', sans-serif !important;
    transition: all 0.3s ease !important;
}

.select2-container--default .select2-selection--single:focus,
.select2-container--default.select2-container--focus .select2-selection--single {
    border-color: #087fc2 !important;
    box-shadow: 0 0 0 3px rgba(8, 127, 194, 0.1) !important;
    outline: none !important;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 24px !important;
    padding-left: 0 !important;
    color: #495057 !important;
    font-size: 0.75rem !important;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px !important;
    right: 8px !important;
}

.select2-dropdown {
    border: 1.5px solid #e2e8f0 !important;
    border-radius: 0.5rem !important;
    font-size: 0.75rem !important;
    font-family: 'Poppins', 'Inter', sans-serif !important;
}

.select2-results__option {
    padding: 0.5rem 0.8rem !important;
    font-size: 0.75rem !important;
}

.select2-results__option--highlighted {
    background-color: #087fc2 !important;
    color: white !important;
}

.select2-search--dropdown .select2-search__field {
    border: 1.5px solid #e2e8f0 !important;
    border-radius: 0.5rem !important;
    padding: 0.5rem 0.8rem !important;
    font-size: 0.75rem !important;
    font-family: 'Poppins', 'Inter', sans-serif !important;
}

.select2-search--dropdown .select2-search__field:focus {
    border-color: #087fc2 !important;
    outline: none !important;
    box-shadow: 0 0 0 3px rgba(8, 127, 194, 0.1) !important;
}

/* Validation states */
.select2-container--default.is-invalid .select2-selection--single {
    border-color: #dc3545 !important;
}

.select2-container--default.is-valid .select2-selection--single {
    border-color: #198754 !important;
}

/* Make Select2 full width */
.select2-container {
    width: 100% !important;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}

{% block admin_content %}
<div class="admin-card">
    <div class="admin-card-header" style="background: linear-gradient(135deg, #087fc2 0%, #0669a0 100%); color: white; padding: 0.75rem 1rem; border-radius: 8px 8px 0 0;">
        <div class="d-flex justify-content-between align-items-center" style="width: 100%;">
            <h5 style="font-size: 0.875rem; font-weight: 600; margin: 0; color: white; flex: 1; font-family: 'Poppins', 'Inter', sans-serif;">
                <i class="fas fa-user-plus me-2" style="font-size: 0.875rem;"></i>Create New Customer
            </h5>
            <a href="{% url 'core:admin_users' %}" class="btn btn-light btn-sm" style="padding: 0.35rem 0.75rem; font-size: 0.75rem; border-radius: 6px; font-weight: 500;">
                <i class="fas fa-arrow-left me-1" style="font-size: 0.75rem;"></i>Back to List
            </a>
        </div>
    </div>
    
    <div class="admin-card-body" style="background: white; padding: 0.875rem; border-radius: 0 0 8px 8px; max-height: calc(100vh - 150px); overflow-y: auto;">
        <form method="post" id="customerForm" novalidate>
            {% csrf_token %}
            
            {% if form.errors %}
                <div class="alert alert-danger alert-dismissible fade show" style="font-size: 0.75rem; padding: 0.5rem 0.75rem; margin-bottom: 0.75rem;">
                    <strong><i class="fas fa-exclamation-triangle me-2"></i>Please correct the following errors:</strong>
                    <ul class="mb-0 mt-1" style="font-size: 0.75rem;">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" style="font-size: 0.75rem;"></button>
                </div>
            {% endif %}

            <!-- Personal Information -->
            <div style="padding: 0.25rem 0; margin: 0.5rem 0 0.25rem 0; border-bottom: 1.5px solid #e9ecef;">
                <h6 style="font-size: 0.75rem; font-weight: 600; color: #087fc2; margin: 0; display: flex; align-items: center; gap: 0.375rem; font-family: 'Poppins', 'Inter', sans-serif;">
                    <i class="fas fa-user" style="font-size: 0.75rem;"></i>Personal Information
                </h6>
            </div>
            <div class="row">
                <div class="col-md-6 mb-2">
                    <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">First Name <span style="color: #dc3545; font-weight: 600;">*</span></label>
                    {{ form.first_name }}
                    <div id="firstNameMsg" style="font-size: 0.675rem; margin-top: 0.25rem; display: none; font-weight: 500;"></div>
                </div>
                <div class="col-md-6 mb-2">
                    <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">Last Name <span style="color: #dc3545; font-weight: 600;">*</span></label>
                    {{ form.last_name }}
                    <div id="lastNameMsg" style="font-size: 0.675rem; margin-top: 0.25rem; display: none; font-weight: 500;"></div>
                </div>
            </div>

            <!-- Email Verification -->
            <div style="padding: 0.25rem 0; margin: 0.5rem 0 0.25rem 0; border-bottom: 1.5px solid #e9ecef;">
                <h6 style="font-size: 0.75rem; font-weight: 600; color: #087fc2; margin: 0; display: flex; align-items: center; gap: 0.375rem; font-family: 'Poppins', 'Inter', sans-serif;">
                    <i class="fas fa-envelope" style="font-size: 0.75rem;"></i>Email Verification
                </h6>
            </div>
            
            <div class="row">
                <div class="col-md-8 mb-2">
                    <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">Business Email <span style="color: #dc3545; font-weight: 600;">*</span></label>
                    <div class="input-group">
                        {{ form.email }}
                        <button type="button" class="btn btn-outline-primary btn-sm" id="sendOtpBtn" disabled style="padding: 0.35rem 0.75rem; font-weight: 500; border-radius: 0 6px 6px 0; font-size: 0.75rem; border-width: 1.5px; color: #087fc2; border-color: #087fc2;">
                            <i class="fas fa-paper-plane me-1" style="font-size: 0.675rem;"></i>Send OTP
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1" style="font-size: 0.675rem; font-weight: 400;">
                        <i class="fas fa-info-circle"></i> Business email required
                    </small>
                    <div id="emailMsg" style="font-size: 0.675rem; margin-top: 0.25rem; display: none; font-weight: 500;"></div>
                </div>
                <div class="col-md-4 mb-2">
                    <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">Admin Override</label>
                    <div style="background: #fff3cd; border: 1.5px solid #ffc107; border-radius: 6px; padding: 0.5rem 0.75rem; height: 38px; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-shield-alt" style="font-size: 0.75rem; color: #ffc107;"></i>
                        <div class="form-check form-switch" style="margin: 0;">
                            {{ form.skip_email_validation }}
                            <label class="form-check-label" for="id_skip_email_validation" style="font-size: 0.675rem; font-weight: 500; color: #664d03; cursor: pointer; margin: 0; font-family: 'Poppins', 'Inter', sans-serif; white-space: nowrap;">
                                Skip OTP
                            </label>
                        </div>
                    </div>
                    <small class="text-muted d-block mt-1" style="font-size: 0.625rem; font-weight: 400;">
                        <strong>ON</strong>=Bypass | <strong>OFF</strong>=Require
                    </small>
                </div>
            </div>

            <!-- OTP Section -->
            <div id="otpSection" style="display:none; background: #f0f9ff; padding: 0.625rem; border-radius: 6px; border: 1.5px solid #087fc2; margin-bottom: 0.5rem;">
                <div class="row">
                    <div class="col-md-8 mb-2">
                        <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">Enter OTP <span style="color: #dc3545; font-weight: 600;">*</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="otpInput" maxlength="6" placeholder="000000" inputmode="numeric" style="font-size: 0.875rem; letter-spacing: 0.25rem; text-align: center; font-weight: 600;">
                            <button type="button" class="btn btn-success btn-sm" id="verifyOtpBtn" style="padding: 0.35rem 0.75rem; font-weight: 500; border-radius: 0 6px 6px 0; font-size: 0.75rem; background-color: #10b981; border-color: #10b981;">
                                <i class="fas fa-check me-1" style="font-size: 0.675rem;"></i>Verify
                            </button>
                        </div>
                        <div id="otpMsg" style="font-size: 0.675rem; margin-top: 0.25rem; display: none; font-weight: 500;"></div>
                        <small class="text-muted" style="font-size: 0.675rem;">Check <strong id="otpEmailDisplay"></strong></small>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">Actions</label>
                        <div class="d-flex flex-column gap-1">
                            <button type="button" class="btn btn-link p-0 text-start" id="resendOtpBtn" style="color: #087fc2; text-decoration: none; font-size: 0.75rem; font-weight: 500;">
                                <i class="fas fa-redo me-1"></i>Resend OTP
                            </button>
                            <small class="text-muted" id="otpTimerDisplay" style="font-size: 0.675rem;"></small>
                        </div>
                    </div>
                </div>
            </div>

<!-- Contact Information -->
<div style="padding: 0.25rem 0; margin: 0.5rem 0 0.25rem 0; border-bottom: 1.5px solid #e9ecef;">
    <h6 style="font-size: 0.75rem; font-weight: 600; color: #087fc2; margin: 0; display: flex; align-items: center; gap: 0.375rem; font-family: 'Poppins', 'Inter', sans-serif;">
        <i class="fas fa-phone" style="font-size: 0.75rem;"></i>Contact Information
    </h6>
</div>
<div class="row">
    <div class="col-md-3 mb-2">
        <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">
            Country Code <span style="color: #dc3545; font-weight: 600;">*</span>
        </label>
        {{ form.country_code }}
        <small class="text-muted d-block mt-1" style="font-size: 0.675rem; font-weight: 400;">
            <i class="fas fa-globe"></i> Search or select country code
        </small>
        <div id="countryCodeMsg" style="font-size: 0.675rem; margin-top: 0.25rem; display: none; font-weight: 500;"></div>
    </div>
    <div class="col-md-9 mb-2">
        <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">
            Mobile Number <span style="color: #dc3545; font-weight: 600;">*</span>
        </label>
        {{ form.mobile }}
        <small class="text-muted d-block mt-1" style="font-size: 0.675rem; font-weight: 400;" id="mobileHintText">
            <i class="fas fa-info-circle"></i> Enter mobile number (without country code)
        </small>
        <div id="mobileMsg" style="font-size: 0.675rem; margin-top: 0.25rem; display: none; font-weight: 500;"></div>
    </div>
</div>

            <!-- Password -->
            <div style="padding: 0.25rem 0; margin: 0.5rem 0 0.25rem 0; border-bottom: 1.5px solid #e9ecef;">
                <h6 style="font-size: 0.75rem; font-weight: 600; color: #087fc2; margin: 0; display: flex; align-items: center; gap: 0.375rem; font-family: 'Poppins', 'Inter', sans-serif;">
                    <i class="fas fa-lock" style="font-size: 0.75rem;"></i>Set Password
                </h6>
            </div>
            <div class="row">
                <div class="col-md-6 mb-2">
                    <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">Password <span style="color: #dc3545; font-weight: 600;">*</span></label>
                    <div style="position: relative;">
                        {{ form.password }}
                        <i class="fas fa-eye password-toggle-icon" id="togglePassword" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #6c757d; z-index: 10; font-size: 0.75rem;"></i>
                    </div>
                    <div id="passwordStrength" style="display:none; margin-top: 0.375rem;">
                        <div class="progress" style="height: 2.5px; border-radius: 2px;">
                            <div class="progress-bar" id="strengthBar" style="width:0%; transition: width 0.3s ease, background-color 0.3s ease;"></div>
                        </div>
                        <small id="strengthText" style="font-size: 0.675rem;"></small>
                    </div>
                    <div id="passwordMsg" style="font-size: 0.675rem; margin-top: 0.25rem; display: none; font-weight: 500;"></div>
                </div>
                <div class="col-md-6 mb-2">
                    <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">Confirm Password <span style="color: #dc3545; font-weight: 600;">*</span></label>
                    <div style="position: relative;">
                        {{ form.confirm_password }}
                        <i class="fas fa-eye password-toggle-icon" id="toggleConfirmPassword" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #6c757d; z-index: 10; font-size: 0.75rem;"></i>
                    </div>
                    <div id="confirmPasswordMsg" style="font-size: 0.675rem; margin-top: 0.25rem; display: none; font-weight: 500;"></div>
                </div>
            </div>

            <!-- Business Information -->
            <div style="padding: 0.25rem 0; margin: 0.5rem 0 0.25rem 0; border-bottom: 1.5px solid #e9ecef;">
                <h6 style="font-size: 0.75rem; font-weight: 600; color: #087fc2; margin: 0; display: flex; align-items: center; gap: 0.375rem; font-family: 'Poppins', 'Inter', sans-serif;">
                    <i class="fas fa-briefcase" style="font-size: 0.75rem;"></i>Business Information
                </h6>
            </div>
            <div class="row">
                <div class="col-md-4 mb-2">
                    <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">Organization</label>
                    {{ form.organization }}
                </div>
                <div class="col-md-4 mb-2">
                    <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">Job Title</label>
                    {{ form.job_title }}
                </div>
                <div class="col-md-4 mb-2">
                    <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">Business Category</label>
                    {{ form.business_category }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mb-2">
                    <label class="form-label" style="font-weight: 500; color: #495057; margin-bottom: 0.25rem; font-size: 0.75rem; font-family: 'Poppins', 'Inter', sans-serif;">Business Subcategory</label>
                    <div class="d-flex align-items-center gap-2">
                        {{ form.business_subcategory }}
                        <div class="spinner-border spinner-border-sm" id="subcategoryLoader" style="display:none; width: 0.75rem; height: 0.75rem; border-width: 0.125em;"></div>
                    </div>
                </div>
            </div>

            <!-- Email Notification Settings -->
            <div style="padding: 0.25rem 0; margin: 0.5rem 0 0.25rem 0; border-bottom: 1.5px solid #e9ecef;">
                <h6 style="font-size: 0.75rem; font-weight: 600; color: #087fc2; margin: 0; display: flex; align-items: center; gap: 0.375rem; font-family: 'Poppins', 'Inter', sans-serif;">
                    <i class="fas fa-envelope" style="font-size: 0.75rem;"></i>Email Notification
                </h6>
            </div>

            <div class="row mb-2">
                <div class="col-md-12">
                    <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 1.5px solid #10b981; border-radius: 6px; padding: 0.75rem;">
                        <div class="form-check form-switch" style="margin: 0;">
                            {{ form.send_welcome_email }}
                            <label class="form-check-label" for="id_send_welcome_email" style="font-size: 0.75rem; font-weight: 600; color: #065f46; cursor: pointer; font-family: 'Poppins', 'Inter', sans-serif;">
                                <i class="fas fa-paper-plane me-1"></i>Send Welcome Email with Login Credentials
                            </label>
                        </div>
                        <small class="text-muted d-block mt-2" style="font-size: 0.675rem; font-weight: 500; margin-left: 2rem; color: #047857 !important;">
                            <i class="fas fa-info-circle me-1"></i>When enabled, customer will receive an email containing:
                        </small>
                        <ul style="font-size: 0.675rem; margin: 0.5rem 0 0 3rem; padding: 0; color: #065f46;">
                            <li>‚úÖ Welcome message</li>
                            <li>‚úÖ Login credentials (username & password)</li>
                      
                        </ul>
                    </div>
                </div>
            </div>
            <!-- ‚≠ê‚≠ê‚≠ê EMAIL NOTIFICATION SECTION ENDS ‚≠ê‚≠ê‚≠ê -->

            <!-- Submit -->
            <div class="mt-2">
                <button type="submit" class="btn btn-primary btn-sm" id="submitBtn" style="padding: 0.35rem 0.75rem; font-weight: 500; border-radius: 6px; font-size: 0.75rem; background-color: #087fc2; border-color: #087fc2;">
                    <i class="fas fa-save me-1" style="font-size: 0.75rem;"></i>Create Customer
                </button>
            </div>
        </form>
    </div>
</div>

<style>
/* Minimal CSS - only for dynamic states */
.validation-msg.show { display: block !important; }
.validation-msg.success { color: #198754; }
.validation-msg.error { color: #dc3545; }
.form-control.is-valid { border-color: #198754; background-image: none; }
.form-control.is-invalid { border-color: #dc3545; background-image: none; }
.strength-weak { background-color: #dc3545 !important; }
.strength-medium { background-color: #ffc107 !important; }
.strength-strong { background-color: #198754 !important; }
.btn:hover { transform: translateY(-1px); }
.btn:active { transform: translateY(0); }
.btn-outline-primary:hover { background-color: #087fc2; color: white; }
.btn-primary:hover { background-color: #0669a0; border-color: #0669a0; }
.btn-success:hover { background-color: #059669; border-color: #059669; }
.password-toggle-icon:hover { color: #087fc2 !important; }
.btn-link:hover { color: #0669a0; text-decoration: underline; }

/* Form controls matching base.html */
.form-control {
    border: 1.5px solid #e2e8f0;
    border-radius: 0.5rem;
    padding: 0.6rem 0.8rem;
    font-size: 0.75rem;
    transition: all 0.3s ease;
    font-family: 'Poppins', 'Inter', sans-serif;
}

.form-control:focus {
    border-color: #087fc2;
    box-shadow: 0 0 0 3px rgba(8, 127, 194, 0.1);
}

/* Dropdown/Select specific styling */
.form-control select,
.form-select,
select.form-control {
    font-size: 0.75rem !important;
    font-family: 'Poppins', 'Inter', sans-serif !important;
}

/* Dropdown options */
.form-control option,
.form-select option,
select.form-control option {
    font-size: 0.75rem !important;
    font-family: 'Poppins', 'Inter', sans-serif !important;
    padding: 0.5rem !important;
}

/* Input fields */
.form-control input,
input.form-control {
    font-size: 0.75rem !important;
    font-family: 'Poppins', 'Inter', sans-serif !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('customerForm');
    const firstName = document.getElementById('id_first_name');
    const lastName = document.getElementById('id_last_name');
    const email = document.getElementById('id_email');
    const mobile = document.getElementById('id_mobile');
    const countryCode = document.getElementById('id_country_code');
    const password = document.getElementById('id_password');
    const confirmPassword = document.getElementById('id_confirm_password');
    const skipValidation = document.getElementById('id_skip_email_validation');
    const submitBtn = document.getElementById('submitBtn');
    const category = document.getElementById('id_business_category');
    const subcategory = document.getElementById('id_business_subcategory');
    
    if (!form || !email || !skipValidation) {
        console.error('‚ùå Critical form elements missing!');
        return;
    }
    
    // ‚úÖ SET DEFAULT COUNTRY CODE
    if (countryCode && !countryCode.value) {
        countryCode.value = '+91';
        console.log('‚úÖ Default country code set to +91');
    }
    
    // ========================================
    // ‚úÖ COUNTRY-SPECIFIC MOBILE FORMATS
    // ========================================
    const COUNTRY_MOBILE_FORMATS = {
        '+1': { min: 10, max: 10, name: 'USA/Canada' },
        '+44': { min: 10, max: 10, name: 'UK' },
        '+91': { min: 10, max: 10, name: 'India' },
        '+86': { min: 11, max: 11, name: 'China' },
        '+61': { min: 9, max: 9, name: 'Australia' },
        '+971': { min: 9, max: 9, name: 'UAE' },
        '+65': { min: 8, max: 8, name: 'Singapore' },
        '+81': { min: 10, max: 10, name: 'Japan' },
        '+49': { min: 10, max: 11, name: 'Germany' },
        '+33': { min: 9, max: 9, name: 'France' },
        '+92': { min: 10, max: 10, name: 'Pakistan' },
        '+880': { min: 10, max: 10, name: 'Bangladesh' },
        '+94': { min: 9, max: 9, name: 'Sri Lanka' },
        '+234': { min: 10, max: 10, name: 'Nigeria' },
        '+27': { min: 9, max: 9, name: 'South Africa' },
        '+20': { min: 10, max: 10, name: 'Egypt' },
        '+254': { min: 9, max: 10, name: 'Kenya' },
        '+55': { min: 10, max: 11, name: 'Brazil' },
        '+52': { min: 10, max: 10, name: 'Mexico' },
        '+54': { min: 10, max: 10, name: 'Argentina' },
        '+82': { min: 9, max: 10, name: 'South Korea' },
        '+66': { min: 9, max: 9, name: 'Thailand' },
        '+60': { min: 9, max: 10, name: 'Malaysia' },
        '+63': { min: 10, max: 10, name: 'Philippines' },
        '+62': { min: 10, max: 13, name: 'Indonesia' },
        '+84': { min: 9, max: 10, name: 'Vietnam' },
        '+90': { min: 10, max: 10, name: 'Turkey' },
        '+966': { min: 9, max: 9, name: 'Saudi Arabia' },
        '+98': { min: 10, max: 10, name: 'Iran' },
        '+964': { min: 10, max: 10, name: 'Iraq' },
        '+972': { min: 9, max: 9, name: 'Israel' },
        '+7': { min: 10, max: 10, name: 'Russia/Kazakhstan' }
    };
    
    function getMobileFormat(countryCodeValue) {
        return COUNTRY_MOBILE_FORMATS[countryCodeValue] || { min: 7, max: 15, name: 'International' };
    }
    
    // ========================================
    // ‚úÖ INITIALIZE SELECT2 FOR COUNTRY CODE (SEARCHABLE DROPDOWN)
    // ========================================
    if (countryCode && typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
        $(countryCode).select2({
            placeholder: 'Search country code...',
            allowClear: false,
            width: '100%',
            dropdownParent: $(countryCode).parent(),
            templateResult: formatCountryCode,
            templateSelection: formatCountryCodeSelection,
            matcher: customMatcher
        });
        
        // Set initial value
        $(countryCode).val('+91').trigger('change');
        
        console.log('‚úÖ Select2 initialized for country code dropdown');
        
        // ‚úÖ Custom formatting for dropdown options
        function formatCountryCode(country) {
            if (!country.id) return country.text;
            var $country = $('<span><strong>' + country.text + '</strong></span>');
            return $country;
        }
        
        // ‚úÖ Custom formatting for selected option
        function formatCountryCodeSelection(country) {
            return country.text || country.id;
        }
        
        // ‚úÖ Custom search matcher
        function customMatcher(params, data) {
            if ($.trim(params.term) === '') {
                return data;
            }
            
            if (typeof data.text === 'undefined') {
                return null;
            }
            
            var term = params.term.toLowerCase();
            var text = data.text.toLowerCase();
            
            if (text.indexOf(term) > -1) {
                return data;
            }
            
            return null;
        }
        
        // ‚úÖ Validation on select
        $(countryCode).on('select2:select', function(e) {
            var selectedValue = e.params.data.id;
            console.log('‚úÖ Country code selected:', selectedValue);
            
            if (selectedValue) {
                $(this).removeClass('is-invalid').addClass('is-valid');
                $(this).next('.select2-container').removeClass('is-invalid').addClass('is-valid');
                $('#countryCodeMsg').hide();
            }
        });
        
        // ‚úÖ Sync Select2 validation with Bootstrap
        $(countryCode).on('change', function() {
            var $select2 = $(this).next('.select2-container');
            if ($(this).hasClass('is-invalid')) {
                $select2.addClass('is-invalid').removeClass('is-valid');
            } else if ($(this).hasClass('is-valid')) {
                $select2.addClass('is-valid').removeClass('is-invalid');
            } else {
                $select2.removeClass('is-invalid is-valid');
            }
        });
    } else {
        console.warn('‚ö†Ô∏è Select2 not loaded, using default dropdown');
    }
    
    let emailVerified = false;
    const commonPasswords = ['password', '12345678', 'qwerty', 'abc123', 'password123'];
    
    // ‚úÖ COMPREHENSIVE BLOCKED DOMAINS LIST
    const blockedDomains = [
        'gmail.com', 'googlemail.com',
        'yahoo.com', 'yahoo.co.in', 'yahoo.co.uk', 'ymail.com', 'rocketmail.com',
        'hotmail.com', 'hotmail.co.uk', 'outlook.com', 'live.com', 'msn.com',
        'aol.com', 'aim.com',
        'icloud.com', 'me.com', 'mac.com',
        'rediffmail.com', 'rediff.com',
        'protonmail.com', 'mail.com', 'gmx.com', 'zoho.com',
        'inbox.com', 'fastmail.com', 'hushmail.com'
    ];
    
    // ========================================
    // PASSWORD TOGGLE VISIBILITY
    // ========================================
    const togglePassword = document.getElementById('togglePassword');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    
    if (togglePassword && password) {
        togglePassword.addEventListener('click', () => {
            const type = password.type === 'password' ? 'text' : 'password';
            password.type = type;
            togglePassword.classList.toggle('fa-eye');
            togglePassword.classList.toggle('fa-eye-slash');
        });
    }
    
    if (toggleConfirmPassword && confirmPassword) {
        toggleConfirmPassword.addEventListener('click', () => {
            const type = confirmPassword.type === 'password' ? 'text' : 'password';
            confirmPassword.type = type;
            toggleConfirmPassword.classList.toggle('fa-eye');
            toggleConfirmPassword.classList.toggle('fa-eye-slash');
        });
    }
    
    // ========================================
    // VALIDATION HELPER FUNCTIONS
    // ========================================
    function showValidation(field, msgId, isValid, message = '') {
        if (!field) return;
        const msg = document.getElementById(msgId);
        if (!msg) return;
        
        field.classList.remove('is-valid', 'is-invalid');
        msg.classList.remove('show', 'success', 'error');
        
        if (isValid) {
            field.classList.add('is-valid');
            msg.classList.add('show', 'success');
        } else {
            field.classList.add('is-invalid');
            msg.classList.add('show', 'error');
        }
        
        msg.textContent = message;
    }
    
    function clearValidation(field, msgId) {
        if (!field) return;
        field.classList.remove('is-valid', 'is-invalid');
        const msg = document.getElementById(msgId);
        if (msg) {
            msg.classList.remove('show', 'success', 'error');
            msg.textContent = '';
        }
    }
    
    // ========================================
    // NAME VALIDATION
    // ========================================
    [firstName, lastName].forEach(field => {
        if (!field) return;
        const msgId = field.id.replace('id_', '') + 'Msg';
        
        field.addEventListener('blur', () => {
            if (!field.value.trim()) {
                showValidation(field, msgId, false, 'This field is required');
            } else {
                showValidation(field, msgId, true, '‚úì Valid');
            }
        });
        
        field.addEventListener('input', () => {
            if (field.classList.contains('is-invalid') && field.value.trim()) {
                showValidation(field, msgId, true, '‚úì Valid');
            }
        });
    });
    
    // ========================================
    // COUNTRY CODE VALIDATION
    // ========================================
    if (countryCode) {
        const validateCountryCode = function() {
            // Handle both Select2 and regular select
            const value = (typeof $ !== 'undefined' && $(countryCode).data('select2')) 
                ? $(countryCode).val() 
                : countryCode.value;
            
            if (value) {
                if (typeof $ !== 'undefined') {
                    $(countryCode).removeClass('is-invalid').addClass('is-valid');
                    $(countryCode).next('.select2-container').removeClass('is-invalid').addClass('is-valid');
                } else {
                    countryCode.classList.remove('is-invalid');
                    countryCode.classList.add('is-valid');
                }
                
                const msg = document.getElementById('countryCodeMsg');
                if (msg) msg.style.display = 'none';
                
                console.log('‚úÖ Country code selected:', value);
                return true;
            } else {
                if (typeof $ !== 'undefined') {
                    $(countryCode).removeClass('is-valid').addClass('is-invalid');
                    $(countryCode).next('.select2-container').removeClass('is-valid').addClass('is-invalid');
                } else {
                    countryCode.classList.remove('is-valid');
                    countryCode.classList.add('is-invalid');
                }
                
                const msg = document.getElementById('countryCodeMsg');
                if (msg) {
                    msg.style.display = 'block';
                    msg.className = 'show error';
                    msg.textContent = 'Country code is required';
                }
                
                console.log('‚ùå Country code validation failed');
                return false;
            }
        };
        
        // Validate on change
        if (typeof $ !== 'undefined') {
            $(countryCode).on('change', validateCountryCode);
        }
        countryCode.addEventListener('change', validateCountryCode);
    }
    
    // ========================================
    // SKIP EMAIL VALIDATION TOGGLE
    // ========================================
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const otpSection = document.getElementById('otpSection');
    
    if (skipValidation) {
        skipValidation.addEventListener('change', function() {
            console.log('üîÑ Skip Validation:', this.checked ? 'ON' : 'OFF');
            
            if (this.checked) {
                // ‚úÖ Skip is ON - Auto-verify email
                emailVerified = true;
                showValidation(email, 'emailMsg', true, '‚úÖ Email domain validation skipped by admin');
                
                // Hide OTP section
                if (otpSection) otpSection.style.display = 'none';
                
                // Disable and update Send OTP button
                if (sendOtpBtn) {
                    sendOtpBtn.disabled = true;
                    sendOtpBtn.innerHTML = '<i class="fas fa-shield-alt me-1"></i>Validation Skipped';
                }
                
                // Remove any invalid state from email
                email.classList.remove('is-invalid');
                email.classList.add('is-valid');
                
            } else {
                // ‚úÖ Skip is OFF - Re-enable validation
                emailVerified = false;
                clearValidation(email, 'emailMsg');
                
                // Re-check email validity
                const emailValue = email.value.trim().toLowerCase();
                if (emailValue) {
                    const validation = validateBusinessEmail(emailValue);
                    
                    if (sendOtpBtn) {
                        sendOtpBtn.disabled = !validation.valid;
                        sendOtpBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send OTP';
                    }
                    
                    if (validation.valid) {
                        showValidation(email, 'emailMsg', true, '‚úì Valid business email');
                    } else {
                        showValidation(email, 'emailMsg', false, validation.message);
                    }
                } else {
                    if (sendOtpBtn) {
                        sendOtpBtn.disabled = true;
                        sendOtpBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send OTP';
                    }
                }
            }
        });
    }
    
    // ========================================
    // EMAIL VALIDATION & OTP
    // ========================================
    const otpInput = document.getElementById('otpInput');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const resendOtpBtn = document.getElementById('resendOtpBtn');
    const otpEmailDisplay = document.getElementById('otpEmailDisplay');
    const otpTimerDisplay = document.getElementById('otpTimerDisplay');
    
    let otpTimer = null;
    let resendCooldown = 60; // seconds
    
    // ‚úÖ BUSINESS EMAIL VALIDATION (Client-side)
    function validateBusinessEmail(emailValue) {
        if (!emailValue) return { valid: false, message: 'Email is required' };
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(emailValue)) {
            return { valid: false, message: 'Invalid email format' };
        }
        
        // Extract domain
        const domain = emailValue.split('@')[1].toLowerCase();
        
        // Check if domain is in blocked list
        if (blockedDomains.includes(domain)) {
            return { 
                valid: false, 
                message: `Personal email domain (${domain}) not allowed. Use business email or enable "Admin Override".` 
            };
        }
        
        return { valid: true, message: '‚úì Valid business email' };
    }
    
    // Email input validation
    if (email && sendOtpBtn) {
        email.addEventListener('input', function() {
            // ‚úÖ If skip is ON, don't validate
            if (skipValidation && skipValidation.checked) {
                showValidation(email, 'emailMsg', true, '‚úÖ Email domain validation skipped by admin');
                sendOtpBtn.disabled = true;
                return;
            }
            
            const emailValue = this.value.trim().toLowerCase();
            const validation = validateBusinessEmail(emailValue);
            
            if (validation.valid) {
                sendOtpBtn.disabled = false;
                clearValidation(email, 'emailMsg');
            } else {
                sendOtpBtn.disabled = true;
                if (emailValue.length > 5) {
                    showValidation(email, 'emailMsg', false, validation.message);
                }
            }
        });
        
        // Email blur validation
        email.addEventListener('blur', function() {
            if (skipValidation && skipValidation.checked) {
                return;
            }
            
            const emailValue = this.value.trim().toLowerCase();
            if (!emailValue) return;
            
            const validation = validateBusinessEmail(emailValue);
            if (!validation.valid) {
                showValidation(email, 'emailMsg', false, validation.message);
            } else {
                showValidation(email, 'emailMsg', true, validation.message);
            }
        });
        
        // ‚úÖ SEND OTP AJAX
        sendOtpBtn.addEventListener('click', function() {
            const emailValue = email.value.trim().toLowerCase();
            
            const validation = validateBusinessEmail(emailValue);
            if (!validation.valid) {
                showValidation(email, 'emailMsg', false, validation.message);
                return;
            }
            
            sendOtpBtn.disabled = true;
            sendOtpBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch('{% url "core:admin_send_otp" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ email: emailValue })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showValidation(email, 'emailMsg', true, '‚úì OTP sent to ' + emailValue);
                    
                    if (otpSection) {
                        otpSection.style.display = 'block';
                        if (otpInput) otpInput.focus();
                    }
                    if (otpEmailDisplay) {
                        otpEmailDisplay.textContent = emailValue;
                    }
                    
                    startResendTimer();
                    sendOtpBtn.innerHTML = '<i class="fas fa-check me-1"></i>OTP Sent';
                    
                } else {
                    showValidation(email, 'emailMsg', false, data.message || 'Failed to send OTP. Please check email.');
                    sendOtpBtn.disabled = false;
                    sendOtpBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send OTP';
                }
            })
            .catch(error => {
                console.error('‚ùå Network error:', error);
                showValidation(email, 'emailMsg', false, 'Network error. Please check your connection.');
                sendOtpBtn.disabled = false;
                sendOtpBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send OTP';
            });
        });
    }
    
    // ‚úÖ VERIFY OTP
    if (verifyOtpBtn && otpInput) {
        verifyOtpBtn.addEventListener('click', function() {
            const otpValue = otpInput.value.trim();
            const emailValue = email.value.trim().toLowerCase();
            const otpMsg = document.getElementById('otpMsg');
            
            if (!otpValue || otpValue.length !== 6) {
                if (otpMsg) {
                    otpMsg.style.display = 'block';
                    otpMsg.className = 'show error';
                    otpMsg.textContent = 'Please enter 6-digit OTP';
                }
                return;
            }
            
            verifyOtpBtn.disabled = true;
            verifyOtpBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Verifying...';
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch('{% url "core:admin_verify_otp" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ 
                    email: emailValue,
                    otp: otpValue 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    emailVerified = true;
                    
                    if (otpMsg) {
                        otpMsg.style.display = 'block';
                        otpMsg.className = 'show success';
                        otpMsg.textContent = '‚úÖ Email verified successfully!';
                    }
                    
                    showValidation(email, 'emailMsg', true, '‚úì Email verified');
                    
                    setTimeout(() => {
                        if (otpSection) otpSection.style.display = 'none';
                    }, 2000);
                    
                    verifyOtpBtn.innerHTML = '<i class="fas fa-check me-1"></i>Verified!';
                    
                } else {
                    if (otpMsg) {
                        otpMsg.style.display = 'block';
                        otpMsg.className = 'show error';
                        otpMsg.textContent = data.message || 'Invalid OTP. Please try again.';
                    }
                    
                    verifyOtpBtn.disabled = false;
                    verifyOtpBtn.innerHTML = '<i class="fas fa-check me-1"></i>Verify';
                }
            })
            .catch(error => {
                console.error('‚ùå Verification error:', error);
                if (otpMsg) {
                    otpMsg.style.display = 'block';
                    otpMsg.className = 'show error';
                    otpMsg.textContent = 'Network error. Please try again.';
                }
                
                verifyOtpBtn.disabled = false;
                verifyOtpBtn.innerHTML = '<i class="fas fa-check me-1"></i>Verify';
            });
        });
        
        otpInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                verifyOtpBtn.click();
            }
        });
    }
    
    // ‚úÖ RESEND OTP
    if (resendOtpBtn) {
        resendOtpBtn.addEventListener('click', function() {
            if (this.disabled) return;
            sendOtpBtn.click();
        });
    }
    
    // ‚úÖ RESEND TIMER
    function startResendTimer() {
        let timeLeft = resendCooldown;
        
        if (resendOtpBtn) resendOtpBtn.disabled = true;
        
        if (otpTimer) clearInterval(otpTimer);
        
        otpTimer = setInterval(() => {
            timeLeft--;
            
            if (otpTimerDisplay) {
                otpTimerDisplay.textContent = `Resend available in ${timeLeft}s`;
            }
            
            if (timeLeft <= 0) {
                clearInterval(otpTimer);
                if (resendOtpBtn) resendOtpBtn.disabled = false;
                if (otpTimerDisplay) otpTimerDisplay.textContent = 'You can resend OTP now';
            }
        }, 1000);
    }
    
    // ========================================
    // ‚úÖ MOBILE VALIDATION (COUNTRY-AWARE)
    // ========================================
    if (mobile && countryCode) {
        // ‚úÖ Update hint text when country changes
        const updateMobileHint = function() {
            const selectedCountry = (typeof $ !== 'undefined' && $(countryCode).data('select2')) 
                ? $(countryCode).val() 
                : countryCode.value || '+91';
            
            const format = getMobileFormat(selectedCountry);
            const hintElement = document.getElementById('mobileHintText');
            
            if (hintElement) {
                if (format.min === format.max) {
                    hintElement.innerHTML = `<i class="fas fa-info-circle"></i> Enter ${format.min}-digit mobile number for ${format.name}`;
                } else {
                    hintElement.innerHTML = `<i class="fas fa-info-circle"></i> Enter ${format.min}-${format.max} digit mobile number for ${format.name}`;
                }
            }
        };
        
        // ‚úÖ Input handler - Dynamic max length based on country
        mobile.addEventListener('input', function() {
            const selectedCountry = (typeof $ !== 'undefined' && $(countryCode).data('select2')) 
                ? $(countryCode).val() 
                : countryCode.value || '+91';
            
            const format = getMobileFormat(selectedCountry);
            
            // Only allow digits and limit to max length
            this.value = this.value.replace(/\D/g, '').slice(0, format.max);
        });
        
        // ‚úÖ Blur validation - Dynamic validation based on country
        mobile.addEventListener('blur', function() {
            const selectedCountry = (typeof $ !== 'undefined' && $(countryCode).data('select2')) 
                ? $(countryCode).val() 
                : countryCode.value || '+91';
            
            const format = getMobileFormat(selectedCountry);
            const mobileValue = this.value.trim();
            
            if (!mobileValue) {
                clearValidation(this, 'mobileMsg');
                return;
            }
            
            const length = mobileValue.length;
            
            if (length < format.min || length > format.max) {
                if (format.min === format.max) {
                    showValidation(this, 'mobileMsg', false, 
                        `Mobile number for ${format.name} must be exactly ${format.min} digits`);
                } else {
                    showValidation(this, 'mobileMsg', false, 
                        `Mobile number for ${format.name} must be ${format.min}-${format.max} digits`);
                }
            } else {
                showValidation(this, 'mobileMsg', true, '‚úì Valid mobile number');
            }
        });
        
        // ‚úÖ Update validation when country code changes
        if (typeof $ !== 'undefined') {
            $(countryCode).on('select2:select', function() {
                updateMobileHint();
                if (mobile.value.trim()) {
                    mobile.dispatchEvent(new Event('blur'));
                }
            });
        }
        
        countryCode.addEventListener('change', function() {
            updateMobileHint();
            if (mobile.value.trim()) {
                mobile.dispatchEvent(new Event('blur'));
            }
        });
        
        // Set initial hint
        updateMobileHint();
    }
    
    // ========================================
    // PASSWORD STRENGTH
    // ========================================
    if (password) {
        password.addEventListener('input', function() {
            const value = this.value;
            const strengthDiv = document.getElementById('passwordStrength');
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');
            
            if (!strengthDiv || !strengthBar || !strengthText) return;
            
            if (!value) {
                strengthDiv.style.display = 'none';
                clearValidation(this, 'passwordMsg');
                return;
            }
            
            strengthDiv.style.display = 'block';
            
            let strength = 0;
            if (value.length >= 8) strength += 20;
            if (value.length >= 12) strength += 10;
            if (/[a-z]/.test(value)) strength += 20;
            if (/[A-Z]/.test(value)) strength += 20;
            if (/\d/.test(value)) strength += 20;
            if (/[^a-zA-Z\d]/.test(value)) strength += 10;
            
            strengthBar.style.width = strength + '%';
            
            if (strength < 50) {
                strengthBar.className = 'progress-bar strength-weak';
                strengthText.textContent = '‚ö† Weak password';
                strengthText.style.color = '#dc3545';
            } else if (strength < 75) {
                strengthBar.className = 'progress-bar strength-medium';
                strengthText.textContent = '‚ö° Medium strength';
                strengthText.style.color = '#ffc107';
            } else {
                strengthBar.className = 'progress-bar strength-strong';
                strengthText.textContent = '‚úì Strong password';
                strengthText.style.color = '#198754';
            }
            
            if (this.classList.contains('is-invalid') || value.length >= 8) {
                validatePassword();
            }
            
            if (confirmPassword && confirmPassword.value) {
                validateConfirmPassword();
            }
        });
        
        password.addEventListener('blur', validatePassword);
    }
    
    function validatePassword() {
        if (!password) return false;
        const value = password.value;
        
        if (!value) {
            showValidation(password, 'passwordMsg', false, 'Password is required');
            return false;
        }
        
        if (value.length < 8) {
            showValidation(password, 'passwordMsg', false, 'Minimum 8 characters required');
            return false;
        }
        
        if (/^\d+$/.test(value)) {
            showValidation(password, 'passwordMsg', false, 'Cannot be entirely numeric');
            return false;
        }
        
        if (commonPasswords.includes(value.toLowerCase())) {
            showValidation(password, 'passwordMsg', false, 'This password is too common');
            return false;
        }
        
        const hasLetters = /[a-zA-Z]/.test(value);
        const hasNumbers = /\d/.test(value);
        
        if (!hasLetters || !hasNumbers) {
            showValidation(password, 'passwordMsg', false, 'Must contain letters and numbers');
            return false;
        }
        
        showValidation(password, 'passwordMsg', true, '‚úì Strong password');
        return true;
    }
    
    // ========================================
    // PASSWORD CONFIRMATION
    // ========================================
    if (confirmPassword) {
        confirmPassword.addEventListener('input', validateConfirmPassword);
        confirmPassword.addEventListener('blur', validateConfirmPassword);
    }
    
    function validateConfirmPassword() {
        if (!confirmPassword) return false;
        
        if (!confirmPassword.value) {
            clearValidation(confirmPassword, 'confirmPasswordMsg');
            return false;
        }
        
        if (password && password.value.length < 8) {
            showValidation(confirmPassword, 'confirmPasswordMsg', false, 'First enter valid password above');
            return false;
        }
        
        if (password && confirmPassword.value !== password.value) {
            showValidation(confirmPassword, 'confirmPasswordMsg', false, 'Passwords do not match');
            return false;
        }
        
        showValidation(confirmPassword, 'confirmPasswordMsg', true, '‚úì Passwords match');
        return true;
    }
    
    // ========================================
    // CATEGORY/SUBCATEGORY
    // ========================================
        // ========================================
    // CATEGORY/SUBCATEGORY
    // ========================================
    if (category && subcategory) {
        console.log('üîß Category/Subcategory: Initializing');
        
        category.addEventListener('change', function() {
            const categoryId = this.value;
            console.log('üìÇ Category changed to:', categoryId);
            
            if (!categoryId) {
                subcategory.innerHTML = '<option value="">Select category first...</option>';
                subcategory.disabled = true;
                return;
            }
            
            subcategory.disabled = true;
            subcategory.innerHTML = '<option value="">Loading...</option>';
            const loader = document.getElementById('subcategoryLoader');
            if (loader) loader.style.display = 'inline-block';
            
            const url = '{% url "core:get_subcategories" %}?category_id=' + categoryId;
            console.log('üåê Fetching from:', url);
            
            fetch(url)
                .then(response => {
                    console.log('üì° Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('üì• Subcategories received:', data);
                    
                    subcategory.innerHTML = '<option value="">Select subcategory</option>';
                    
                    if (data.success && data.subcategories && data.subcategories.length > 0) {
                        data.subcategories.forEach(sub => {
                            const option = document.createElement('option');
                            option.value = sub.id;
                            option.textContent = sub.name;
                            subcategory.appendChild(option);
                        });
                        console.log(`‚úÖ Added ${data.subcategories.length} subcategories`);
                    } else {
                        console.warn('‚ö†Ô∏è No subcategories found for this category');
                    }
                    
                    subcategory.disabled = false;
                    if (loader) loader.style.display = 'none';
                })
                .catch(error => {
                    console.error('‚ùå Error loading subcategories:', error);
                    subcategory.innerHTML = '<option value="">Error loading options</option>';
                    subcategory.disabled = false;
                    if (loader) loader.style.display = 'none';
                });
        });
        
        if (category.value) {
            setTimeout(() => category.dispatchEvent(new Event('change')), 100);
        }
    }
    
    // ========================================
    // FORM SUBMISSION
    // ========================================
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            console.log('üìù Form submission started...');
            
            let isValid = true;
            
            // Validate first name
            if (firstName && !firstName.value.trim()) {
                showValidation(firstName, 'firstNameMsg', false, 'First name is required');
                isValid = false;
            }
            
            // Validate last name
            if (lastName && !lastName.value.trim()) {
                showValidation(lastName, 'lastNameMsg', false, 'Last name is required');
                isValid = false;
            }
            
            // ‚úÖ VALIDATE COUNTRY CODE (Works with Select2)
            if (countryCode) {
                const countryValue = (typeof $ !== 'undefined' && $(countryCode).data('select2')) 
                    ? $(countryCode).val() 
                    : countryCode.value;
                
                if (!countryValue) {
                    if (typeof $ !== 'undefined') {
                        $(countryCode).removeClass('is-valid').addClass('is-invalid');
                        $(countryCode).next('.select2-container').addClass('is-invalid');
                    } else {
                        countryCode.classList.remove('is-valid');
                        countryCode.classList.add('is-invalid');
                    }
                    
                    const msg = document.getElementById('countryCodeMsg');
                    if (msg) {
                        msg.style.display = 'block';
                        msg.className = 'show error';
                        msg.textContent = 'Country code is required';
                    }
                    
                    isValid = false;
                    console.log('‚ùå Country code validation failed');
                } else {
                    console.log('‚úÖ Country code validated:', countryValue);
                }
            }
            
            // ‚úÖ Email validation with proper skip logic
            if (email && email.value.trim()) {
                const skipIsOn = skipValidation && skipValidation.checked;
                
                console.log('üìß Email validation check:', {
                    email: email.value,
                    skipIsOn: skipIsOn,
                    emailVerified: emailVerified
                });
                
                if (skipIsOn) {
                    console.log('‚úÖ Email validation skipped by admin');
                    emailVerified = true;
                } else if (!emailVerified) {
                    showValidation(email, 'emailMsg', false, '‚ö† Please verify email with OTP or enable "Admin Override"');
                    isValid = false;
                    console.log('‚ùå Email not verified and skip is OFF');
                }
            } else {
                showValidation(email, 'emailMsg', false, 'Email is required');
                isValid = false;
            }
            
            // ‚úÖ Validate mobile with country-aware logic
            if (mobile && countryCode) {
                const selectedCountry = (typeof $ !== 'undefined' && $(countryCode).data('select2')) 
                    ? $(countryCode).val() 
                    : countryCode.value || '+91';
                
                const format = getMobileFormat(selectedCountry);
                const mobileValue = mobile.value.trim();
                const length = mobileValue.length;
                
                if (!mobileValue) {
                    showValidation(mobile, 'mobileMsg', false, 'Mobile number is required');
                    isValid = false;
                } else if (length < format.min || length > format.max) {
                    if (format.min === format.max) {
                        showValidation(mobile, 'mobileMsg', false, 
                            `Mobile number for ${format.name} must be exactly ${format.min} digits`);
                    } else {
                        showValidation(mobile, 'mobileMsg', false, 
                            `Mobile number for ${format.name} must be ${format.min}-${format.max} digits`);
                    }
                    isValid = false;
                }
            }
            
            // Validate password
            if (!validatePassword()) {
                console.log('‚ùå Password validation failed');
                isValid = false;
            }
            
            // Validate password confirmation
            if (!validateConfirmPassword()) {
                console.log('‚ùå Confirm password validation failed');
                isValid = false;
            }
            
            // If validation failed, scroll to first error
            if (!isValid) {
                console.log('‚ùå Form validation failed - not submitting');
                const firstInvalid = form.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // If it's a Select2 field, open it
                    if (typeof $ !== 'undefined' && $(firstInvalid).hasClass('select2-hidden-accessible')) {
                        $(firstInvalid).select2('open');
                    } else {
                        firstInvalid.focus();
                    }
                }
                return false;
            }
            
            console.log('‚úÖ All validations passed - submitting form');
            console.log('üìä Form data summary:', {
                firstName: firstName.value,
                lastName: lastName.value,
                email: email.value,
                countryCode: (typeof $ !== 'undefined' && $(countryCode).data('select2')) ? $(countryCode).val() : countryCode.value,
                mobile: mobile.value,
                emailVerified: emailVerified
            });
            
            // Disable submit button
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating Customer...';
            }
            
            // Submit form
            form.submit();
        });
    }
    
    console.log('‚úÖ Customer create form JavaScript initialized successfully');
});
</script>
{% endblock %}