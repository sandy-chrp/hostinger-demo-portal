{% extends 'admin/base.html' %}

{% block admin_title %}Add New Demo{% endblock %}
{% block page_title %}Add New Demo{% endblock %}

{% block breadcrumb %}
<div class="admin-breadcrumb">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a href="{% url 'core:admin_dashboard' %}">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'core:admin_demos' %}">Demo Content</a>
            </li>
            <li class="breadcrumb-item active">Add New Demo</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% comment %} Remove header_actions block to use default from base.html {% endcomment %}

{% block admin_extra_css %}
<style>
    /* Action Buttons Below Breadcrumb */
    .form-header-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .btn-back {
        background: white;
        border: 1px solid var(--gray-300);
        color: var(--gray-700);
        padding: 0.625rem 1.25rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-back:hover {
        background: var(--gray-100);
        border-color: var(--gray-400);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-save-demo {
        background: linear-gradient(135deg, #087fc2 0%, #0669a0 100%);
        border: none;
        color: white;
        padding: 0.625rem 1.5rem;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(8, 127, 194, 0.3);
        transition: all 0.3s ease;
    }

    .btn-save-demo:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(8, 127, 194, 0.4);
        color: white;
    }

    .btn-save-demo:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .page-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: var(--spacing-lg);
    }

    .compact-form {
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: var(--spacing-lg);
    }

    .section-header {
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: var(--spacing-md);
        padding-bottom: var(--spacing-sm);
        border-bottom: 2px solid var(--gray-200);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
    }

    .form-grid .full-width {
        grid-column: 1 / -1;
    }

    .file-upload-area {
        border: 2px dashed var(--gray-300);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        text-align: center;
        background: var(--gray-50);
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .file-upload-area:hover {
        border-color: var(--primary-color);
        background: rgba(8, 127, 194, 0.05);
    }

    .file-upload-area.has-file {
        border-color: var(--success-color);
        background: rgba(16, 185, 129, 0.05);
    }

    .file-preview {
        display: none;
        margin-top: var(--spacing-sm);
        padding: var(--spacing-sm);
        background: white;
        border-radius: var(--radius-sm);
        border: 1px solid var(--gray-200);
    }

    .file-preview.active {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .file-preview-icon {
        font-size: 1.5rem;
        color: var(--success-color);
    }

    .file-preview-info {
        flex: 1;
        text-align: left;
    }

    .file-preview-name {
        font-weight: 600;
        color: var(--dark-color);
        font-size: 0.875rem;
    }

    .file-preview-size {
        font-size: 0.75rem;
        color: var(--gray-600);
    }

    .file-preview-remove {
        color: var(--danger-color);
        cursor: pointer;
        padding: var(--spacing-xs);
    }

    .file-preview-remove:hover {
        color: #c53030;
    }

    /* Live Preview Panel */
    .preview-panel {
        position: sticky;
        top: calc(var(--admin-header-height) + 20px);
        height: calc(100vh - var(--admin-header-height) - 40px);
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .preview-header {
        background: var(--gradient-primary);
        color: white;
        padding: var(--spacing-md);
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .preview-body {
        flex: 1;
        overflow: hidden;
        position: relative;
        background: var(--gray-100);
    }

    .preview-empty {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--gray-500);
        width: 100%;
        padding: var(--spacing-lg);
    }

    .preview-empty i {
        font-size: 3rem;
        margin-bottom: var(--spacing-md);
        opacity: 0.3;
    }

    .preview-content {
        width: 100%;
        height: 100%;
        display: none;
    }

    .preview-content.active {
        display: block;
    }

    .thumbnail-preview-img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        padding: var(--spacing-md);
    }

    .video-preview {
        width: 100%;
        height: 100%;
        object-fit: contain;
        background: black;
    }

    .webgl-preview-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--gray-600);
        background: white;
        padding: var(--spacing-lg);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
    }

    .selection-box {
        padding: var(--spacing-md);
        background: var(--gray-50);
        border-radius: var(--radius-md);
        border: 1px solid var(--gray-200);
        max-height: 200px;
        overflow-y: auto;
    }

    .selection-box.disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    .checkbox-item {
        padding: var(--spacing-xs) var(--spacing-sm);
        margin-bottom: var(--spacing-xs);
        background: white;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .checkbox-item:hover {
        background: var(--gray-100);
    }

    .checkbox-item input {
        margin: 0;
    }

    .checkbox-item label {
        margin: 0;
        font-size: 0.9rem;
        cursor: pointer;
        flex: 1;
    }

    .subcategory-list {
        margin-left: var(--spacing-lg);
        margin-top: var(--spacing-xs);
        padding-left: var(--spacing-sm);
        border-left: 2px solid var(--gray-200);
    }

    .search-box {
        margin-bottom: var(--spacing-sm);
        position: relative;
    }

    .search-box input {
        padding-left: 2rem;
        font-size: 0.9rem;
    }

    .search-box i {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-400);
    }

    .form-actions {
        position: sticky;
        bottom: 0;
        background: white;
        padding: var(--spacing-md);
        border-top: 1px solid var(--gray-200);
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-md);
        margin: var(--spacing-lg) calc(-1 * var(--spacing-lg)) calc(-1 * var(--spacing-lg));
        border-radius: 0 0 var(--radius-lg) var(--radius-lg);
    }

    @media (max-width: 1200px) {
        .page-container {
            grid-template-columns: 1fr;
        }

        .preview-panel {
            position: relative;
            height: 500px;
            top: 0;
        }
    }

    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }

        .form-header-actions {
            flex-direction: column-reverse;
        }

        .btn-back,
        .btn-save-demo {
            width: 100%;
            padding: 0.625rem 1rem;
        }
    }
</style>
{% endblock %}

{% block admin_content %}
<!-- Action Buttons Below Breadcrumb -->
{% comment %} <div class="form-header-actions">
    <a href="{% url 'core:admin_demos' %}" class="btn btn-back">
        <i class="fas fa-arrow-left me-2"></i>Back to Demos
    </a>
    <button type="submit" form="demoForm" class="btn btn-save-demo" id="headerSaveBtn">
        <i class="fas fa-save me-2"></i>Save Demo
    </button>
</div> {% endcomment %}

<div class="page-container">
    <!-- Left Column - Form -->
    <div>
        <form method="post" enctype="multipart/form-data" id="demoForm" class="needs-validation" novalidate>
            {% csrf_token %}

            <div class="compact-form">
                <!-- Basic Information -->
                <div class="section-header">
                    <i class="fas fa-info-circle"></i> Basic Information
                </div>
                <div class="form-grid">
                    <div class="full-width">
                        <label for="id_title" class="form-label">Demo Title <span class="text-danger">*</span></label>
                        <input type="text" name="title" id="id_title" class="form-control" value="{{ form_data.title }}" required>
                    </div>
                    <div class="full-width">
                        <label for="id_description" class="form-label">Description <span class="text-danger">*</span></label>
                        <textarea name="description" id="id_description" class="form-control" rows="3" required>{{ form_data.description }}</textarea>
                    </div>
                </div>

                <!-- File Upload -->
                <div class="section-header">
                    <i class="fas fa-file-upload"></i> File Upload
                </div>
                
                <div class="form-grid">
                    <div>
                        <label for="id_file_type" class="form-label">File Type <span class="text-danger">*</span></label>
                        <select name="file_type" id="id_file_type" class="form-select">
                            <option value="video" {% if form_data.file_type == "video" %}selected{% endif %}>Video Demo</option>
                            <option value="webgl" {% if form_data.file_type == "webgl" %}selected{% endif %}>WebGL Interactive</option>
                        </select>
                    </div>
                    <div id="demoFileField">
                        <label class="form-label">Demo File <span class="text-danger">*</span></label>
                        <div class="file-upload-area" onclick="document.getElementById('actualFileInput').click()">
                            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                            <p class="mb-0">Click to upload or drag & drop</p>
                            <small class="text-muted" id="fileTypeHint">MP4, AVI, MOV, WMV (Max: 200 MB)</small>
                        </div>
                        <input type="file" name="video_file" id="id_video_file" class="d-none" accept="video/*">
                        <input type="file" name="webgl_file" id="id_webgl_file" class="d-none" accept=".html,.zip,.gltf,.glb">
                        <input type="file" id="actualFileInput" class="d-none">
                        
                        <div class="file-preview" id="demoFilePreview">
                            <i class="fas fa-file file-preview-icon"></i>
                            <div class="file-preview-info">
                                <div class="file-preview-name" id="demoFileName"></div>
                                <div class="file-preview-size" id="demoFileSize"></div>
                            </div>
                            <i class="fas fa-times file-preview-remove" onclick="removeDemoFile()"></i>
                        </div>
                    </div>
                    <div class="full-width">
                        <label for="id_thumbnail" class="form-label">Thumbnail <span class="text-danger">*</span></label>
                        <div class="file-upload-area" onclick="document.getElementById('id_thumbnail').click()">
                            <i class="fas fa-image fa-2x text-muted mb-2"></i>
                            <p class="mb-0">Click to upload thumbnail</p>
                            <small class="text-muted">JPG, PNG, WebP (Max: 10 MB)</small>
                        </div>
                        <input type="file" name="thumbnail" id="id_thumbnail" class="d-none" accept="image/*" required>
                        
                        <div class="file-preview" id="thumbnailPreview">
                            <i class="fas fa-image file-preview-icon"></i>
                            <div class="file-preview-info">
                                <div class="file-preview-name" id="thumbnailName"></div>
                                <div class="file-preview-size" id="thumbnailSize"></div>
                            </div>
                            <i class="fas fa-times file-preview-remove" onclick="removeThumbnail()"></i>
                        </div>
                    </div>
                </div>

                <!-- Business Categories & Customers -->
                <div class="section-header mt-4">
                    <i class="fas fa-bullseye"></i> Target Audience
                </div>
                <div class="form-grid">
                    <div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="allBusinessCategoriesCheckbox" {% if form_data.all_business_categories %}checked{% endif %}>
                            <label class="form-check-label" for="allBusinessCategoriesCheckbox">
                                <strong>All Business Categories</strong>
                            </label>
                        </div>
                        <div id="categorySelectionArea" class="selection-box">
                            {% for category in business_categories %}
                            <div class="checkbox-item">
                                <input type="checkbox" name="target_business_categories" value="{{ category.id }}" id="cat_{{ category.id }}" class="category-checkbox" {% if category.id|stringformat:"s" in form_data.selected_business_categories %}checked{% endif %}>
                                <label for="cat_{{ category.id }}">{{ category.name }}</label>
                            </div>
                            {% if category.subcategories.all %}
                            <div class="subcategory-list" id="subcat_list_{{ category.id }}" style="display: none;">
                                {% for subcategory in category.subcategories.all %}
                                <div class="checkbox-item">
                                    <input type="checkbox" name="target_business_subcategories" value="{{ subcategory.id }}" id="subcat_{{ subcategory.id }}" class="subcategory-checkbox" data-parent="{{ category.id }}" {% if subcategory.id|stringformat:"s" in form_data.selected_business_subcategories %}checked{% endif %}>
                                    <label for="subcat_{{ subcategory.id }}">{{ subcategory.name }}</label>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="allCustomersCheckbox" checked>
                            <label class="form-check-label" for="allCustomersCheckbox">
                                <strong>All Customers</strong>
                            </label>
                        </div>
                        <div id="customerSelectionArea" class="selection-box disabled">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="customerSearch" class="form-control form-control-sm" placeholder="Search customers...">
                            </div>
                            <div id="customerList">
                                {% for customer in customers %}
                                <div class="checkbox-item" data-search="{{ customer.full_name|lower }} {{ customer.email|lower }}">
                                    <input type="checkbox" name="target_customers" value="{{ customer.id }}" id="cust_{{ customer.id }}" {% if customer.id|stringformat:"s" in form_data.selected_customers %}checked{% endif %}>
                                    <label for="cust_{{ customer.id }}">{{ customer.full_name }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="section-header mt-4">
                    <i class="fas fa-cogs"></i> Settings
                </div>
                <div class="form-grid">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="is_featured" id="id_is_featured" {% if form_data.is_featured %}checked{% endif %}>
                        <label class="form-check-label" for="id_is_featured">Featured Demo</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="is_active" id="id_is_active" {% if form_data.is_active %}checked{% endif %}>
                        <label class="form-check-label" for="id_is_active">Active</label>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <a href="{% url 'core:admin_demos' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-times me-1"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-primary btn-sm" id="submitBtn">
                        <i class="fas fa-save me-1"></i>Create Demo
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Right Column - Live Preview -->
    <div class="preview-panel">
        <div class="preview-header">
            <span><i class="fas fa-eye me-2"></i>Live Preview</span>
        </div>
        <div class="preview-body">
            <!-- Empty State -->
            <div class="preview-empty" id="previewEmpty">
                <i class="fas fa-eye-slash"></i>
                <h5>No Preview Available</h5>
                <p>Upload a file to see preview</p>
            </div>

            <!-- Thumbnail Preview -->
            <div class="preview-content" id="thumbnailPreviewContent">
                <img id="thumbnailPreviewImg" class="thumbnail-preview-img" alt="Thumbnail Preview">
            </div>

            <!-- Video Preview -->
            <div class="preview-content" id="videoPreviewContent">
                <video id="videoPreviewPlayer" class="video-preview" controls></video>
            </div>

            <!-- WebGL Preview -->
            <div class="preview-content" id="webglPreviewContent">
                <div class="webgl-preview-message">
                    <i class="fas fa-cube fa-3x mb-3 text-primary"></i>
                    <h5>WebGL File Uploaded</h5>
                    <p class="mb-0">Preview will be available after saving</p>
                    <small class="text-muted d-block mt-2" id="webglFileName"></small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_extra_js %}
<script>
// ✅ File size limits (in bytes)
const FILE_SIZE_LIMITS = {
    video: 200 * 1024 * 1024,      // 200 MB
    webgl: 3 * 1024 * 1024 * 1024,  // 3 GB
    thumbnail: 10 * 1024 * 1024     // 10 MB
};

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    if (bytes >= k * k * k) {
        return (bytes / (k * k * k)).toFixed(2) + ' GB';
    } else if (bytes >= k * k) {
        return (bytes / (k * k)).toFixed(2) + ' MB';
    } else if (bytes >= k) {
        return (bytes / k).toFixed(2) + ' KB';
    }
    return bytes + ' Bytes';
}

function validateFileSize(file, fileType) {
    const maxSize = FILE_SIZE_LIMITS[fileType];
    if (file.size > maxSize) {
        const maxSizeFormatted = formatFileSize(maxSize);
        const actualSizeFormatted = formatFileSize(file.size);
        alert(`File size (${actualSizeFormatted}) exceeds maximum allowed size (${maxSizeFormatted}) for ${fileType} files.`);
        return false;
    }
    return true;
}

document.addEventListener('DOMContentLoaded', function() {
    setupFileTypeSelection();
    setupFileUpload();
    setupCategorySelection();
    setupCustomerSelection();
    setupFormValidation();
});

function setupFileTypeSelection() {
    const fileTypeSelect = document.getElementById('id_file_type');
    const actualFileInput = document.getElementById('actualFileInput');
    const fileTypeHint = document.getElementById('fileTypeHint');
    
    fileTypeSelect.addEventListener('change', function() {
        const fileType = this.value;
        
        if (fileType === 'video') {
            actualFileInput.accept = 'video/*';
            fileTypeHint.textContent = 'MP4, AVI, MOV, WMV (Max: 200 MB)';
        } else {
            actualFileInput.accept = '.html,.zip,.gltf,.glb';
            fileTypeHint.textContent = 'HTML, ZIP, GLTF, GLB (Max: 3 GB)';
        }
        
        // Clear previous file
        actualFileInput.value = '';
        document.getElementById('id_video_file').value = '';
        document.getElementById('id_webgl_file').value = '';
        document.getElementById('demoFilePreview').classList.remove('active');
        hideAllPreviews();
    });
}

function setupFileUpload() {
    const actualFileInput = document.getElementById('actualFileInput');
    const videoFileInput = document.getElementById('id_video_file');
    const webglFileInput = document.getElementById('id_webgl_file');
    const fileTypeSelect = document.getElementById('id_file_type');
    const uploadArea = document.querySelector('.file-upload-area');
    
    actualFileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (!file) return;
        
        const fileType = fileTypeSelect.value;
        
        // ✅ Validate file size FIRST
        if (!validateFileSize(file, fileType)) {
            this.value = ''; // Clear the input
            return;
        }
        
        // Copy to appropriate hidden input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        
        if (fileType === 'video') {
            videoFileInput.files = dataTransfer.files;
            webglFileInput.value = '';
        } else {
            webglFileInput.files = dataTransfer.files;
            videoFileInput.value = '';
        }
        
        // Show file preview info
        showFilePreview(file);
        
        // Show live preview
        showLivePreview(file, fileType);
        
        uploadArea.classList.add('has-file');
    });
    
    // Thumbnail upload
    const thumbnailInput = document.getElementById('id_thumbnail');
    thumbnailInput.addEventListener('change', function() {
        const file = this.files[0];
        if (!file) return;
        
        // ✅ Validate thumbnail size
        if (!validateFileSize(file, 'thumbnail')) {
            this.value = ''; // Clear the input
            return;
        }
        
        showThumbnailPreview(file);
    });
}

function showFilePreview(file) {
    const preview = document.getElementById('demoFilePreview');
    const fileName = document.getElementById('demoFileName');
    const fileSize = document.getElementById('demoFileSize');
    
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    preview.classList.add('active');
}

function showThumbnailPreview(file) {
    const preview = document.getElementById('thumbnailPreview');
    const name = document.getElementById('thumbnailName');
    const size = document.getElementById('thumbnailSize');
    
    name.textContent = file.name;
    size.textContent = formatFileSize(file.size);
    preview.classList.add('active');
    
    // Show in preview panel
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('thumbnailPreviewImg').src = e.target.result;
        showPreviewContent('thumbnailPreviewContent');
    };
    reader.readAsDataURL(file);
}

function removeDemoFile() {
    document.getElementById('actualFileInput').value = '';
    document.getElementById('id_video_file').value = '';
    document.getElementById('id_webgl_file').value = '';
    document.getElementById('demoFilePreview').classList.remove('active');
    document.querySelector('.file-upload-area').classList.remove('has-file');
    hideAllPreviews();
}

function removeThumbnail() {
    document.getElementById('id_thumbnail').value = '';
    document.getElementById('thumbnailPreview').classList.remove('active');
    
    const thumbnailContent = document.getElementById('thumbnailPreviewContent');
    if (thumbnailContent.classList.contains('active')) {
        hideAllPreviews();
    }
}

function showLivePreview(file, fileType) {
    if (fileType === 'video') {
        const reader = new FileReader();
        reader.onload = function(e) {
            const video = document.getElementById('videoPreviewPlayer');
            video.src = e.target.result;
            showPreviewContent('videoPreviewContent');
        };
        reader.readAsDataURL(file);
    } else {
        // WebGL preview
        document.getElementById('webglFileName').textContent = file.name;
        showPreviewContent('webglPreviewContent');
    }
}

function showPreviewContent(contentId) {
    hideAllPreviews();
    document.getElementById('previewEmpty').style.display = 'none';
    document.getElementById(contentId).classList.add('active');
}

function hideAllPreviews() {
    document.getElementById('previewEmpty').style.display = 'block';
    document.querySelectorAll('.preview-content').forEach(function(el) {
        el.classList.remove('active');
    });
}

function setupCategorySelection() {
    const allCategoriesCheckbox = document.getElementById('allBusinessCategoriesCheckbox');
    const categorySelectionArea = document.getElementById('categorySelectionArea');
    const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
    
    allCategoriesCheckbox.addEventListener('change', function() {
        if (this.checked) {
            categorySelectionArea.classList.add('disabled');
            categoryCheckboxes.forEach(function(cb) {
                cb.checked = false;
                const subcategoryList = document.getElementById('subcat_list_' + cb.value);
                if (subcategoryList) {
                    subcategoryList.style.display = 'none';
                    subcategoryList.querySelectorAll('input').forEach(function(sub) {
                        sub.checked = false;
                    });
                }
            });
        } else {
            categorySelectionArea.classList.remove('disabled');
        }
    });
    
    categoryCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const subcategoryList = document.getElementById('subcat_list_' + this.value);
            if (subcategoryList) {
                subcategoryList.style.display = this.checked ? 'block' : 'none';
                if (!this.checked) {
                    subcategoryList.querySelectorAll('input').forEach(function(sub) {
                        sub.checked = false;
                    });
                }
            }
            if (this.checked) {
                allCategoriesCheckbox.checked = false;
            }
        });
    });
}

function setupCustomerSelection() {
    const allCustomersCheckbox = document.getElementById('allCustomersCheckbox');
    const customerSelectionArea = document.getElementById('customerSelectionArea');
    const customerSearch = document.getElementById('customerSearch');
    
    allCustomersCheckbox.addEventListener('change', function() {
        if (this.checked) {
            customerSelectionArea.classList.add('disabled');
            document.querySelectorAll('input[name="target_customers"]').forEach(function(cb) {
                cb.checked = false;
            });
        } else {
            customerSelectionArea.classList.remove('disabled');
        }
    });
    
    customerSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        document.querySelectorAll('#customerList .checkbox-item').forEach(function(item) {
            const searchData = item.getAttribute('data-search');
            item.style.display = searchData.includes(searchTerm) ? 'flex' : 'none';
        });
    });
}

function setupFormValidation() {
    const form = document.getElementById('demoForm');
    const submitBtn = document.getElementById('submitBtn');
    const headerSaveBtn = document.getElementById('headerSaveBtn');
    
    form.addEventListener('submit', function(e) {
        // Disable both buttons
        submitBtn.disabled = true;
        headerSaveBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';
        headerSaveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
        
        const fileType = document.getElementById('id_file_type').value;
        const allCategoriesChecked = document.getElementById('allBusinessCategoriesCheckbox').checked;
        const anyCategorySelected = document.querySelectorAll('.category-checkbox:checked').length > 0;
        
        let fileValid = false;
        if (fileType === 'video') {
            fileValid = document.getElementById('id_video_file').files.length > 0;
        } else {
            fileValid = document.getElementById('id_webgl_file').files.length > 0;
        }
        
        if (!fileValid) {
            e.preventDefault();
            alert('Please upload the required demo file');
            submitBtn.disabled = false;
            headerSaveBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Create Demo';
            headerSaveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Demo';
            return false;
        }
        
        if (!allCategoriesChecked && !anyCategorySelected) {
            e.preventDefault();
            alert('Select at least one business category or enable "All Categories"');
            submitBtn.disabled = false;
            headerSaveBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Create Demo';
            headerSaveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Demo';
            return false;
        }
        
        if (!form.checkValidity()) {
            e.preventDefault();
            submitBtn.disabled = false;
            headerSaveBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Create Demo';
            headerSaveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Demo';
        }
        
        form.classList.add('was-validated');
    });
}

// ============================================================================
// UNSAVED CHANGES DETECTION - Popup on Back Button
// ============================================================================

// Track form changes
let formChanged = false;
const demoForm = document.getElementById('demoForm');

// Store original form state
const originalFormData = {};
const formElements = demoForm.querySelectorAll('input, select, textarea');
formElements.forEach(element => {
    if (element.type === 'checkbox' || element.type === 'radio') {
        originalFormData[element.name] = element.checked;
    } else if (element.type === 'file') {
        originalFormData[element.name] = '';
    } else {
        originalFormData[element.name] = element.value;
    }
});

// Check if form has changed
function hasFormChanged() {
    let changed = false;
    
    formElements.forEach(element => {
        if (element.type === 'checkbox' || element.type === 'radio') {
            if (originalFormData[element.name] !== element.checked) {
                changed = true;
            }
        } else if (element.type === 'file') {
            if (element.files && element.files.length > 0) {
                changed = true;
            }
        } else {
            if (originalFormData[element.name] !== element.value) {
                changed = true;
            }
        }
    });
    
    return changed;
}

// Mark form as changed
demoForm.addEventListener('change', function() {
    formChanged = true;
});

demoForm.addEventListener('input', function() {
    formChanged = true;
});

// Browser close/refresh warning
window.addEventListener('beforeunload', function(e) {
    if (formChanged && hasFormChanged()) {
        e.preventDefault();
        e.returnValue = '';
        return '';
    }
});

// Back button handler with popup
const backButtons = document.querySelectorAll('.btn-back');
backButtons.forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (formChanged && hasFormChanged()) {
            // First confirmation: Save changes?
            const saveChanges = confirm(
                '⚠️ You have unsaved changes!\n\n' +
                'Do you want to SAVE your changes?\n\n' +
                '✓ Click "OK" to SAVE and continue\n' +
                '✗ Click "Cancel" to leave WITHOUT saving'
            );
            
            if (saveChanges) {
                // User chose YES - Save the form
                demoForm.submit();
            } else {
                // User chose NO - Double confirm
                const reallyLeave = confirm(
                    '⚠️ Are you sure?\n\n' +
                    'All your changes will be LOST forever!\n\n' +
                    '✓ Click "OK" to LEAVE without saving\n' +
                    '✗ Click "Cancel" to go back'
                );
                
                if (reallyLeave) {
                    // Really leaving
                    formChanged = false;
                    window.location.href = "{% url 'core:admin_demos' %}";
                }
            }
        } else {
            // No changes - navigate
            window.location.href = "{% url 'core:admin_demos' %}";
        }
    });
});

// Disable warning on form submit
demoForm.addEventListener('submit', function() {
    formChanged = false;
});

console.log('✅ Unsaved Changes Protection Active');
</script>
{% endblock %}