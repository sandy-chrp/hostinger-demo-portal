{% extends 'admin/base.html' %}

{% block admin_title %}{{ demo.title }} - WebGL Preview{% endblock %}
{% block page_title %}{{ demo.title }} - WebGL Preview{% endblock %}

{% block breadcrumb %}
<div class="admin-breadcrumb">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a href="{% url 'core:admin_dashboard' %}"><i class="fas fa-home me-1"></i>Dashboard</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'core:admin_demos' %}">Demos</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'core:admin_demo_detail' demo.id %}">{{ demo.title }}</a>
            </li>
            <li class="breadcrumb-item active">WebGL Preview</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block header_actions %}
<div class="d-flex align-items-center gap-2">
    <a href="{% url 'core:admin_demo_detail' demo.id %}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left me-1"></i>Back
    </a>
    <button class="btn btn-outline-primary btn-sm" id="fullscreenBtn" onclick="toggleFullscreen()">
        <i class="fas fa-expand me-2" id="fullscreenIcon"></i>
        <span id="fullscreenText">Fullscreen</span>
    </button>
</div>
{% endblock %}

{% block admin_extra_css %}
<style>
    .admin-main-content { padding: 0 !important; }
    
    .webgl-container {
        position: fixed;
        top: var(--admin-header-height);
        left: var(--admin-sidebar-width);
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        z-index: 1;
    }
    
    .admin-sidebar.collapsed ~ .admin-content .webgl-container {
        left: var(--admin-sidebar-collapsed);
    }
    
    .webgl-iframe {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
        opacity: 0;
        transition: opacity 0.5s ease;
    }
    
    .webgl-iframe.loaded {
        opacity: 1;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #087fc2 0%, #0669a0 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        transition: opacity 0.5s ease;
    }
    
    .loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }
    
    .loading-content {
        text-align: center;
        color: white;
        max-width: 500px;
        padding: 40px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 20px;
        backdrop-filter: blur(10px);
    }
    
    .spinner {
        width: 80px;
        height: 80px;
        border: 8px solid rgba(255,255,255,0.2);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 30px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .loading-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 15px;
    }
    
    .loading-text {
        font-size: 1rem;
        opacity: 0.9;
        margin-bottom: 20px;
    }
    
    .progress-bar-container {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
        margin-top: 20px;
        overflow: hidden;
    }
    
    .progress-bar-fill {
        height: 100%;
        background: white;
        border-radius: 3px;
        transition: width 0.3s ease;
        width: 0%;
    }
    
    .progress-percentage {
        font-size: 1.5rem;
        font-weight: 700;
        margin-top: 15px;
        color: #4ade80;
    }
    
    @media (max-width: 1024px) {
        .webgl-container { left: 0; }
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="webgl-container">
    <!-- Simple Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h4 class="loading-title">
                <i class="fas fa-cube me-2"></i>
                Loading WebGL Content
            </h4>
            <p class="loading-text" id="loadingText">
                Preparing {{ demo.title }}...
            </p>
            <div class="progress-percentage" id="progressPercent">0%</div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBar"></div>
            </div>
        </div>
    </div>
    
    <!-- WebGL Iframe -->
    {% if demo.get_webgl_index_url %}
        <iframe 
            id="webglFrame"
            class="webgl-iframe" 
            src="{% url 'core:serve_webgl_file' slug=demo.slug filepath='index.html' %}"
            allowfullscreen
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; xr-spatial-tracking"
            sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-modals allow-downloads"
            onload="onIframeLoad()">
        </iframe>
    {% endif %}
</div>
{% endblock %}

{% block admin_extra_js %}
<script>
const DEMO_ID = {{ demo.id }};
const loadStartTime = Date.now();
let progressValue = 0;
let progressInterval = null;
let iframeLoaded = false;
let apiAvailable = false;

// ‚úÖ Check if API available
async function checkAPI() {
    try {
        const response = await fetch(`/api/webgl/extraction-progress/${DEMO_ID}/`);
        if (response.ok) {
            apiAvailable = true;
            console.log('‚úÖ Progress API available');
            pollProgress();
        } else {
            console.log('‚ö†Ô∏è Progress API not available, using fallback');
            simulateProgress();
        }
    } catch (error) {
        console.log('‚ö†Ô∏è Progress API failed, using fallback');
        simulateProgress();
    }
}

// ‚úÖ Real progress polling (if API available)
async function pollProgress() {
    try {
        const response = await fetch(`/api/webgl/extraction-progress/${DEMO_ID}/`);
        const data = await response.json();
        
        updateProgress(data.percent, data.message || 'Loading...');
        
        if (data.stage !== 'complete' && data.percent < 100) {
            setTimeout(pollProgress, 500);
        } else if (iframeLoaded) {
            setTimeout(hideLoading, 500);
        }
    } catch (error) {
        console.error('Poll error:', error);
        if (iframeLoaded) {
            hideLoading();
        }
    }
}

// ‚úÖ Fallback: Simulate progress (if API not available)
function simulateProgress() {
    progressInterval = setInterval(() => {
        if (progressValue < 90) {
            progressValue += Math.random() * 10 + 5;
            progressValue = Math.min(progressValue, 90);
            updateProgress(progressValue, 'Loading...');
        }
        
        if (iframeLoaded && progressValue >= 90) {
            progressValue = 100;
            updateProgress(100, 'Complete!');
            clearInterval(progressInterval);
            setTimeout(hideLoading, 500);
        }
    }, 300);
}

// ‚úÖ Update progress UI
function updateProgress(percent, message) {
    progressValue = percent;
    document.getElementById('progressBar').style.width = `${percent}%`;
    document.getElementById('progressPercent').textContent = `${Math.round(percent)}%`;
    document.getElementById('loadingText').textContent = message;
}

// ‚úÖ Hide loading overlay
function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    const iframe = document.getElementById('webglFrame');
    
    if (overlay) {
        overlay.classList.add('hidden');
    }
    
    if (iframe) {
        iframe.classList.add('loaded');
    }
    
    if (progressInterval) {
        clearInterval(progressInterval);
    }
    
    const loadTime = ((Date.now() - loadStartTime) / 1000).toFixed(1);
    console.log(`‚úÖ WebGL loaded in ${loadTime}s`);
}

// ‚úÖ Iframe loaded successfully
function onIframeLoad() {
    console.log('‚úÖ Iframe loaded');
    iframeLoaded = true;
    
    // If using fallback, complete immediately
    if (!apiAvailable) {
        updateProgress(100, 'Complete!');
        setTimeout(hideLoading, 500);
    }
    // If API available, wait for 100%
    else if (progressValue >= 100) {
        setTimeout(hideLoading, 500);
    }
}

// ‚úÖ Toggle fullscreen
function toggleFullscreen() {
    const container = document.querySelector('.webgl-container');
    const icon = document.getElementById('fullscreenIcon');
    const text = document.getElementById('fullscreenText');
    
    if (!document.fullscreenElement) {
        container.requestFullscreen().then(() => {
            icon.className = 'fas fa-compress me-2';
            text.textContent = 'Exit Fullscreen';
        }).catch(err => {
            console.error('Fullscreen error:', err);
        });
    } else {
        document.exitFullscreen().then(() => {
            icon.className = 'fas fa-expand me-2';
            text.textContent = 'Fullscreen';
        });
    }
}

// ‚úÖ Keyboard shortcut (F for fullscreen)
document.addEventListener('keydown', (e) => {
    if ((e.key === 'f' || e.key === 'F') && !e.target.matches('input, textarea')) {
        e.preventDefault();
        toggleFullscreen();
    }
});

// ‚úÖ Initialize
console.log('üöÄ WebGL Viewer initialized');
checkAPI();

// ‚úÖ Fallback timeout (30 seconds max)
setTimeout(() => {
    if (!iframeLoaded) {
        console.warn('‚ö†Ô∏è Load timeout');
    }
    hideLoading();
}, 30000);
</script>
{% endblock %}