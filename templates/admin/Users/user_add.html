{% extends 'admin/base.html' %}
{% load static %}

{% block admin_title %}Add Employee{% endblock %}
{% block page_title %}Add New Employee{% endblock %}

{% block admin_extra_css %}
<!-- Font Awesome CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    .form-section {
        background: #f8f9fa;
        border-left: 3px solid #087fc2;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 0.375rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .form-section h6 {
        color: #087fc2;
        margin-bottom: 1rem;
        font-weight: 600;
    }
    
    .form-section h6 i {
        margin-right: 0.5rem;
    }
    
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    
    @media (max-width: 768px) {
        .form-section {
            padding: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="container-fluid">
    
    <!-- Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
        <div>
            <h5 class="mb-1">Add New Employee</h5>
            <p class="text-muted mb-0">Create employee account with system access</p>
        </div>
        <a href="{% url 'accounts:user_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back
        </a>
    </div>

    <form method="post" id="userAddForm">
        {% csrf_token %}
        
        <div class="row">
            
            <!-- Left Column -->
            <div class="col-12 col-lg-6">
                
                <!-- Basic Information -->
                <div class="form-section">
                    <h6><i class="fas fa-user"></i> Basic Information</h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label required-field">First Name</label>
                            <input type="text" name="first_name" class="form-control" 
                                   value="{{ form_data.first_name|default:'' }}"
                                   required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label required-field">Last Name</label>
                            <input type="text" name="last_name" class="form-control" 
                                   value="{{ form_data.last_name|default:'' }}"
                                   required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required-field">Office Email</label>
                        <input type="email" 
                            name="email" 
                            id="email" 
                            class="form-control" 
                            value="{{ form_data.email|default:'' }}"
                            pattern="^[a-zA-Z0-9._%+-]+@(?!gmail\.com$|yahoo\.com$|hotmail\.com$|outlook\.com$|live\.com$)[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
                            title="Business email only. Gmail, Yahoo, Hotmail, Outlook not allowed."
                            required>
                        <small id="emailFeedback" class="text-muted">Business email required (no Gmail, Yahoo, etc.)</small>
                    </div>
                    
                    <div class="mb-0">
                        <label class="form-label required-field">Contact Number</label>
                        <div class="input-group">
                            <select name="country_code" class="form-select" style="max-width: 120px;">
                                <option value="+91" {% if form_data.country_code == '+91' or not form_data %}selected{% endif %}>ðŸ‡®ðŸ‡³ +91</option>
                                <option value="+1" {% if form_data.country_code == '+1' %}selected{% endif %}>ðŸ‡ºðŸ‡¸ +1</option>
                                <option value="+44" {% if form_data.country_code == '+44' %}selected{% endif %}>ðŸ‡¬ðŸ‡§ +44</option>
                                <option value="+61" {% if form_data.country_code == '+61' %}selected{% endif %}>ðŸ‡¦ðŸ‡º +61</option>
                            </select>
                            <input type="text" name="mobile" class="form-control" 
                                   pattern="[0-9]{10}" 
                                   maxlength="10"
                                   value="{{ form_data.mobile|default:'' }}"
                                   required>
                        </div>
                    </div>
                </div>

                <!-- Employee Details -->
                <div class="form-section">
                    <h6><i class="fas fa-id-card"></i> Employee Details</h6>
                    
                    <div class="mb-3">
                        <label class="form-label required-field">Employee ID</label>
                        <div class="input-group">
                            <input type="text" 
                                   name="employee_id" 
                                   id="employee_id" 
                                   class="form-control" 
                                   value="{{ form_data.employee_id|default:'' }}"
                                   pattern="^EMP\d{5}$"
                                   title="Format: EMP followed by 5 digits (e.g., EMP00001)"
                                   maxlength="8"
                                   style="text-transform: uppercase;"
                                   required>
                            <button type="button" 
                                    class="btn btn-outline-secondary" 
                                    id="autoFillEmployeeId"
                                    title="Auto-fill next Employee ID">
                                <i class="fas fa-magic"></i> Auto
                            </button>
                        </div>
                        <small id="employeeIdFeedback" class="text-muted">
                            Format: EMP00001 (Suggested: <span id="suggestedId" class="text-primary fw-bold">{{ next_employee_id }}</span>)
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required-field">Role</label>
                        <select name="role" class="form-select" required>
                            <option value="">-- Select Role --</option>
                            {% for role in roles %}
                            <option value="{{ role.id }}" {% if form_data.role|stringformat:"s" == role.id|stringformat:"s" %}selected{% endif %}>
                                {{ role.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Assigns permissions and access level</small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" 
                               name="is_active" id="is_active" 
                               {% if not form_data or form_data.is_active == 'on' %}checked{% endif %}>
                        <label class="form-check-label" for="is_active">
                            Active Status
                        </label>
                        <br>
                        <small class="text-muted">Inactive employees cannot login</small>
                    </div>

                    <div class="mb-0">
                        <label class="form-label fw-bold">Email Verification</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" 
                                name="email_verification" id="verifyNow" 
                                value="verify_now" 
                                {% if not form_data or form_data.email_verification == 'verify_now' %}checked{% endif %}>
                            <label class="form-check-label" for="verifyNow">
                               Mark as Verified
                            </label>
                            <br>
                            <small class="text-muted">Skip verification (recommended for employees)</small>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="radio" 
                                name="email_verification" id="sendVerification" 
                                value="send_verification_email" 
                                {% if form_data.email_verification == 'send_verification_email' %}checked{% endif %}>
                            <label class="form-check-label" for="sendVerification">
                                Send Verification Email
                            </label>
                            <br>
                            <small class="text-muted">User must verify email before login</small>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="radio" 
                                name="email_verification" id="skipVerification" 
                                value="skip_verification" 
                                {% if form_data.email_verification == 'skip_verification' %}checked{% endif %}>
                            <label class="form-check-label" for="skipVerification">
                              Skip Verification
                            </label>
                            <br>
                            <small class="text-muted">User can login without verification</small>
                        </div>
                    </div>
                </div>
                
                <!-- System Information -->
                <div class="form-section">
                    <h6><i class="fas fa-desktop"></i> System Information</h6>
                    <p class="text-muted small mb-3">For system binding (optional)</p>
                    
                    <div class="mb-3">
                        <label class="form-label">System MAC Address</label>
                        <input type="text" 
                               name="system_mac_id" 
                               class="form-control" 
                               placeholder="00:1A:2B:3C:4D:5E" 
                               value="{{ form_data.system_mac_id|default:'' }}"
                               pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$"
                               title="MAC Address format: 00:1A:2B:3C:4D:5E">
                    </div>
                    
                    <div class="mb-0">
                        <label class="form-label">System IP Address</label>
                        <input type="text" 
                               name="system_ip_address" 
                               class="form-control" 
                               placeholder="e.g., 192.168.1.100" 
                               value="{{ form_data.system_ip_address|default:'' }}"
                               pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                               title="IPv4 Address format: 192.168.1.100">
                    </div>
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="col-12 col-lg-6">
                
                <!-- Business Category -->
                <div class="form-section">
                    <h6><i class="fas fa-briefcase"></i> Business Category</h6>
                    <p class="text-muted small mb-3">For tracking purposes (optional)</p>
                    
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select name="business_category" id="business_category" class="form-select">
                            <option value="">-- Select Category --</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" {% if form_data.business_category|stringformat:"s" == category.id|stringformat:"s" %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-0">
                        <label class="form-label">Subcategory</label>
                        <select name="business_subcategory" id="business_subcategory" class="form-select">
                            <option value="">-- Select Category First --</option>
                            {% if form_data.business_subcategory %}
                            <!-- Subcategories will load via JS -->
                            {% endif %}
                        </select>
                    </div>
                </div>
                
                <!-- Authentication -->
                <div class="form-section">
                    <h6><i class="fas fa-lock"></i> Authentication</h6>
                    
                    <div class="mb-3">
                        <label class="form-label required-field">Password</label>
                        <div class="input-group">
                            <input type="password" 
                                   name="password" 
                                   id="password" 
                                   class="form-control" 
                                   minlength="8"
                                   required>
                            <button class="btn btn-outline-secondary" 
                                    type="button" 
                                    id="togglePassword" 
                                    title="Show/Hide Password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <small class="text-muted">Minimum 8 characters</small>
                    </div>
                    
                    <div class="mb-0">
                        <label class="form-label required-field">Confirm Password</label>
                        <input type="password" 
                               name="confirm_password" 
                               id="confirm_password" 
                               class="form-control" 
                               minlength="8"
                               required>
                        <div id="passwordMatch" class="text-danger mt-1" style="display: none;">
                            <i class="fas fa-exclamation-circle"></i> Passwords do not match
                        </div>
                    </div>
                </div>
                
                <!-- Submit Section -->
                <div class="mt-4 d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                        <i class="fas fa-user-plus me-1"></i> Create User
                    </button>
                    <a href="{% url 'accounts:user_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i> Cancel
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block admin_extra_js %}
<script>
// Variables to handle debounce
let emailTimeout;
let employeeIdTimeout;

// Toggle password visibility
document.getElementById('togglePassword').addEventListener('click', function() {
    const passwordInput = document.getElementById('password');
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    
    const icon = this.querySelector('i');
    icon.classList.toggle('fa-eye');
    icon.classList.toggle('fa-eye-slash');
});

// Auto-fill Employee ID button
document.getElementById('autoFillEmployeeId').addEventListener('click', function() {
    const suggestedId = document.getElementById('suggestedId').textContent.trim();
    document.getElementById('employee_id').value = suggestedId;
    document.getElementById('employee_id').dispatchEvent(new Event('input'));
});

// âœ… AJAX Email Validation
document.getElementById('email').addEventListener('input', function() {
    clearTimeout(emailTimeout);
    const email = this.value.trim();
    const feedback = document.getElementById('emailFeedback');
    const submitBtn = document.getElementById('submitBtn');
    
    if (!email) {
        feedback.className = 'text-muted';
        feedback.textContent = 'Business email required (no Gmail, Yahoo, etc.)';
        return;
    }
    
    const blockedDomains = [
        'gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 
        'live.com', 'ymail.com', 'aol.com', 'icloud.com', 
        'rediffmail.com', 'protonmail.com'
    ];
    
    try {
        const domain = email.split('@')[1].toLowerCase();
        
        if (blockedDomains.includes(domain)) {
            feedback.className = 'text-danger';
            feedback.innerHTML = '<i class="fas fa-times-circle"></i> Personal email not allowed. Use business email.';
            submitBtn.disabled = true;
            return;
        }
    } catch (e) {
        feedback.className = 'text-danger';
        feedback.textContent = 'Invalid email format';
        return;
    }
    
    feedback.className = 'text-muted';
    feedback.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
    submitBtn.disabled = true;
    
    emailTimeout = setTimeout(() => {
        fetch("{% url 'accounts:check_employee_email' %}?email=" + encodeURIComponent(email))
            .then(response => response.json())
            .then(data => {
                if (data.available) {
                    feedback.className = 'text-success';
                    feedback.innerHTML = '<i class="fas fa-check-circle"></i> ' + data.message;
                    submitBtn.disabled = false;
                } else {
                    feedback.className = 'text-danger';
                    feedback.innerHTML = '<i class="fas fa-times-circle"></i> ' + data.message;
                    submitBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                feedback.className = 'text-muted';
                feedback.textContent = 'Could not validate email';
                submitBtn.disabled = false;
            });
    }, 500);
});

// âœ… AJAX Employee ID Validation
document.getElementById('employee_id').addEventListener('input', function() {
    clearTimeout(employeeIdTimeout);
    const employeeId = this.value.trim().toUpperCase();
    const feedback = document.getElementById('employeeIdFeedback');
    const suggestedId = document.getElementById('suggestedId').textContent;
    const submitBtn = document.getElementById('submitBtn');
    
    if (!employeeId) {
        feedback.className = 'text-muted';
        feedback.innerHTML = `Format: EMP00001 (Suggested: <span id="suggestedId" class="text-primary fw-bold">${suggestedId}</span>)`;
        return;
    }
    
    const pattern = /^EMP\d{5}$/;
    if (!pattern.test(employeeId)) {
        feedback.className = 'text-danger';
        feedback.innerHTML = '<i class="fas fa-times-circle"></i> Format must be EMP followed by 5 digits (e.g., EMP00001)';
        submitBtn.disabled = true;
        return;
    }
    
    feedback.className = 'text-muted';
    feedback.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking availability...';
    
    employeeIdTimeout = setTimeout(() => {
        fetch("{% url 'accounts:check_employee_id' %}?employee_id=" + encodeURIComponent(employeeId))
            .then(response => response.json())
            .then(data => {
                if (data.available) {
                    feedback.className = 'text-success';
                    feedback.innerHTML = '<i class="fas fa-check-circle"></i> Employee ID available';
                    submitBtn.disabled = false;
                } else {
                    feedback.className = 'text-danger';
                    feedback.innerHTML = '<i class="fas fa-times-circle"></i> ' + data.message;
                    submitBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                feedback.className = 'text-muted';
                feedback.innerHTML = `Format: EMP00001 (Suggested: <span id="suggestedId" class="text-primary fw-bold">${suggestedId}</span>)`;
                submitBtn.disabled = false;
            });
    }, 500);
});

// Password match validation
document.getElementById('confirm_password').addEventListener('input', function() {
    const password = document.getElementById('password').value;
    const confirmPassword = this.value;
    const matchMsg = document.getElementById('passwordMatch');
    const submitBtn = document.getElementById('submitBtn');
    
    if (password !== confirmPassword) {
        matchMsg.style.display = 'block';
        submitBtn.disabled = true;
    } else {
        matchMsg.style.display = 'none';
        submitBtn.disabled = false;
    }
});

// Load subcategories
document.getElementById('business_category').addEventListener('change', function() {
    const categoryId = this.value;
    const subcategorySelect = document.getElementById('business_subcategory');
    
    subcategorySelect.innerHTML = '<option value="">-- Loading... --</option>';
    
    if (!categoryId) {
        subcategorySelect.innerHTML = '<option value="">-- Select Category First --</option>';
        return;
    }
    
    fetch("{% url 'accounts:get_subcategories' %}?category_id=" + categoryId)
        .then(response => response.json())
        .then(data => {
            subcategorySelect.innerHTML = '<option value="">-- Select Subcategory --</option>';
            data.subcategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = sub.name;
                subcategorySelect.appendChild(option);
            });
            
            {% if form_data.business_subcategory %}
            subcategorySelect.value = '{{ form_data.business_subcategory }}';
            {% endif %}
        })
        .catch(error => {
            console.error('Error:', error);
            subcategorySelect.innerHTML = '<option value="">-- Error loading --</option>';
        });
});

// Form validation
document.getElementById('userAddForm').addEventListener('submit', function(e) {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    if (password !== confirmPassword) {
        e.preventDefault();
        alert('Passwords do not match!');
        return false;
    }
    
    const employeeId = document.getElementById('employee_id').value.trim();
    const pattern = /^EMP\d{5}$/;
    if (!pattern.test(employeeId)) {
        e.preventDefault();
        alert('Employee ID must be in format EMP00001 (EMP followed by 5 digits)');
        return false;
    }
});

// On page load
document.addEventListener('DOMContentLoaded', function() {
    {% if form_data.business_category %}
    document.getElementById('business_category').dispatchEvent(new Event('change'));
    {% endif %}
});
</script>
{% endblock %}