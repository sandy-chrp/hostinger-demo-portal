{% extends 'admin/base.html' %}
{% load static %}

{% block admin_title %}Edit Employee{% endblock %}
{% block page_title %}Edit Employee{% endblock %}

{% block admin_extra_css %}
<!-- Font Awesome CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    .form-section {
        background: #f8f9fa;
        border-left: 3px solid #087fc2;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 0.375rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .form-section h6 {
        color: #087fc2;
        margin-bottom: 1rem;
        font-weight: 600;
    }
    
    .form-section h5 i {
        margin-right: 0.5rem;
    }
    
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    
    @media (max-width: 768px) {
        .form-section {
            padding: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="container-fluid">
    
    <!-- Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
        <div>
            <h5 class="mb-1">Edit Employee</h5>
            <p class="text-muted mb-0">{{ user_obj.full_name }} ({{ user_obj.employee_id }})</p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <a href="{% url 'accounts:user_detail' user_obj.id %}" class="btn btn-outline-secondary">
                <i class="fas fa-eye me-1"></i> View Details
            </a>
            <a href="{% url 'accounts:user_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back
            </a>
        </div>
    </div>

    <form method="post" id="userEditForm">
        {% csrf_token %}
        
        <div class="row">
            
            <!-- Left Column -->
            <div class="col-12 col-lg-6">
                
                <!-- Basic Information -->
                <div class="form-section">
                    <h6><i class="fas fa-user"></i> Basic Information</h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label required-field">First Name</label>
                            <input type="text" name="first_name" class="form-control" 
                                   value="{{ user_obj.first_name }}" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label required-field">Last Name</label>
                            <input type="text" name="last_name" class="form-control" 
                                   value="{{ user_obj.last_name }}" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required-field">Office Email</label>
                        <input type="email" 
                               name="email" 
                               id="email" 
                               class="form-control" 
                               value="{{ user_obj.email }}"
                               pattern="^[a-zA-Z0-9._%+-]+@(?!gmail\.com$|yahoo\.com$|hotmail\.com$|outlook\.com$|live\.com$)[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
                               title="Business email only. Gmail, Yahoo, Hotmail, Outlook not allowed."
                               required>
                        <small id="emailFeedback" class="text-muted">
                            <i class="fas fa-building"></i> Business email required (no Gmail, Yahoo, etc.)
                        </small>
                    </div>
                    
                    <div class="mb-0">
                        <label class="form-label required-field">Contact Number</label>
                        <div class="input-group">
                            <select name="country_code" class="form-select" style="max-width: 120px;">
                                <option value="+91" {% if user_obj.country_code == '+91' %}selected{% endif %}>ðŸ‡®ðŸ‡³ +91</option>
                                <option value="+1" {% if user_obj.country_code == '+1' %}selected{% endif %}>ðŸ‡ºðŸ‡¸ +1</option>
                                <option value="+44" {% if user_obj.country_code == '+44' %}selected{% endif %}>ðŸ‡¬ðŸ‡§ +44</option>
                                <option value="+61" {% if user_obj.country_code == '+61' %}selected{% endif %}>ðŸ‡¦ðŸ‡º +61</option>
                            </select>
                            <input type="text" name="mobile" class="form-control" 
                                   value="{{ user_obj.mobile }}"
                                   pattern="[0-9]{10}" 
                                   maxlength="10" required>
                        </div>
                    </div>
                </div>

                <!-- Employee Details -->
                <div class="form-section">
                    <h6><i class="fas fa-id-card"></i> Employee Details</h6>
                    
                    <div class="mb-3">
                        <label class="form-label required-field">Employee ID</label>
                        <input type="text" 
                               name="employee_id" 
                               id="employee_id" 
                               class="form-control" 
                               value="{{ user_obj.employee_id }}"
                               pattern="^EMP\d{5}$"
                               title="Format: EMP followed by 5 digits (e.g., EMP00001)"
                               maxlength="8"
                               style="text-transform: uppercase;"
                               required>
                        <small id="employeeIdFeedback" class="text-muted">
                            Format: EMP00001 (EMP followed by 5 digits)
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required-field">Role</label>
                        <select name="role" class="form-select" required>
                            <option value="">-- Select Role --</option>
                            {% for role in roles %}
                            <option value="{{ role.id }}" {% if user_obj.role.id == role.id %}selected{% endif %}>
                                {{ role.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" 
                               name="is_active" id="is_active" 
                               {% if user_obj.is_active %}checked{% endif %}>
                        <label class="form-check-label" for="is_active">
                            Active Status
                        </label>
                        <br>
                        <small class="text-muted">Inactive employees cannot login</small>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" 
                               name="is_email_verified" id="is_email_verified" 
                               {% if user_obj.is_email_verified %}checked{% endif %}>
                        <label class="form-check-label" for="is_email_verified">
                          Email Verified
                        </label>
                    </div>

                    <div class="form-check mb-0">
                        <input class="form-check-input" type="checkbox" 
                               name="is_approved" id="is_approved" 
                               {% if user_obj.is_approved %}checked{% endif %}>
                        <label class="form-check-label" for="is_approved">
                           Account Approved
                        </label>
                    </div>
                </div>

            </div>

            <!-- Right Column -->
            <div class="col-12 col-lg-6">
                
                <!-- Business Category -->
                <div class="form-section">
                    <h6><i class="fas fa-layer-group"></i> Business Category</h6>
                    
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select name="business_category" id="business_category" class="form-select">
                            <option value="">-- Select Category --</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" {% if user_obj.business_category.id == category.id %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-0">
                        <label class="form-label">Subcategory</label>
                        <select name="business_subcategory" id="business_subcategory" class="form-select">
                            <option value="">-- Select Category First --</option>
                            {% for subcategory in subcategories %}
                            <option value="{{ subcategory.id }}" 
                                    data-category="{{ subcategory.category.id }}"
                                    {% if user_obj.business_subcategory.id == subcategory.id %}selected{% endif %}>
                                {{ subcategory.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Change Password (Optional) -->
                <div class="form-section">
                    <h6><i class="fas fa-lock"></i> Change Password</h6>
                    <p class="text-muted small mb-3">Leave blank to keep current password</p>
                    
                    <div class="mb-3">
                        <label class="form-label">New Password</label>
                        <input type="password" name="new_password" id="new_password" 
                               class="form-control" 
                               minlength="8">
                    </div>
                    
                    <div class="mb-0">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" name="confirm_password" id="confirm_password" 
                               class="form-control">
                        <small id="passwordMatch" class="text-danger" style="display: none;">
                            Passwords do not match!
                        </small>
                    </div>
                </div>

                <!-- System Information -->
                <div class="form-section">
                    <h6><i class="fas fa-server"></i> System Information</h6>
                    
                    <div class="mb-3">
                        <label class="form-label">System MAC Address</label>
                        <input type="text" name="system_mac_address" class="form-control" 
                               value="{{ user_obj.system_mac_address|default:'' }}"
                               placeholder="XX:XX:XX:XX:XX:XX"
                               pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$">
                        <small class="text-muted">Auto-captured on login</small>
                    </div>
                    
                    <div class="mb-0">
                        <label class="form-label">IP Address</label>
                        <input type="text" name="system_ip_address" class="form-control" 
                               value="{{ user_obj.last_login_ip|default:'' }}"
                               placeholder="192.168.1.1" readonly>
                        <small class="text-muted">Auto-captured (read-only)</small>
                    </div>
                </div>

            </div>

        </div>

        <!-- Form Actions -->
        <div class="card mt-4">
            <div class="card-body">
                <div class="d-flex flex-column flex-md-row justify-content-end align-items-stretch align-items-md-center gap-2">
                    <a href="{% url 'accounts:user_detail' user_obj.id %}" class="btn btn-secondary">
                        <i class="fas fa-times me-1"></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-save me-1"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>

    </form>

</div>
{% endblock %}

{% block admin_extra_js %}
<script>
let emailTimeout;
let employeeIdTimeout;
const currentEmail = '{{ user_obj.email }}';
const currentEmployeeId = '{{ user_obj.employee_id }}';

// âœ… AJAX Email Validation with Business Email Check
document.getElementById('email').addEventListener('input', function() {
    clearTimeout(emailTimeout);
    const email = this.value.trim();
    const feedback = document.getElementById('emailFeedback');
    const submitBtn = document.getElementById('submitBtn');
    
    if (!email) {
        feedback.className = 'text-muted';
        feedback.innerHTML = '<i class="fas fa-building"></i> Business email required';
        submitBtn.disabled = true;
        return;
    }
    
    // If email unchanged, no need to validate
    if (email === currentEmail) {
        feedback.className = 'text-muted';
        feedback.innerHTML = '<i class="fas fa-building"></i> Business email required';
        submitBtn.disabled = false;
        return;
    }
    
    // âœ… Check if personal email domain
    const blockedDomains = [
        'gmail.com', 'yahoo.com', 'yahoo.co.in', 'hotmail.com', 
        'outlook.com', 'live.com', 'msn.com', 'icloud.com', 
        'me.com', 'aol.com', 'ymail.com', 'rediffmail.com', 
        'protonmail.com', 'mail.com', 'zoho.com'
    ];
    
    try {
        const domain = email.split('@')[1].toLowerCase();
        
        if (blockedDomains.includes(domain)) {
            feedback.className = 'text-danger';
            feedback.innerHTML = '<i class="fas fa-times-circle"></i> Personal email not allowed. Use business email.';
            submitBtn.disabled = true;
            return;
        }
    } catch (e) {
        // Invalid email format
        feedback.className = 'text-danger';
        feedback.textContent = 'Invalid email format';
        submitBtn.disabled = true;
        return;
    }
    
    // âœ… If business email, check if exists
    feedback.className = 'text-muted';
    feedback.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
    submitBtn.disabled = true;
    
    emailTimeout = setTimeout(() => {
        fetch(`/auth/ajax/check-employee-email/?email=${encodeURIComponent(email)}`)
            .then(response => response.json())
            .then(data => {
                if (data.available) {
                    feedback.className = 'text-success';
                    feedback.innerHTML = '<i class="fas fa-check-circle"></i> ' + data.message;
                    submitBtn.disabled = false;
                } else {
                    feedback.className = 'text-danger';
                    feedback.innerHTML = '<i class="fas fa-times-circle"></i> ' + data.message;
                    submitBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                feedback.className = 'text-muted';
                feedback.textContent = 'Could not validate email';
                submitBtn.disabled = false;
            });
    }, 500);
});

// âœ… AJAX Employee ID Validation with Format Check
document.getElementById('employee_id').addEventListener('input', function() {
    clearTimeout(employeeIdTimeout);
    const employeeId = this.value.trim().toUpperCase();
    const feedback = document.getElementById('employeeIdFeedback');
    const submitBtn = document.getElementById('submitBtn');
    
    if (!employeeId) {
        feedback.className = 'text-muted';
        feedback.textContent = 'Format: EMP00001 (EMP followed by 5 digits)';
        submitBtn.disabled = true;
        return;
    }
    
    // If employee ID unchanged, no need to validate
    if (employeeId === currentEmployeeId) {
        feedback.className = 'text-muted';
        feedback.textContent = 'Format: EMP00001 (EMP followed by 5 digits)';
        submitBtn.disabled = false;
        return;
    }
    
    // âœ… Frontend format validation
    const pattern = /^EMP\d{5}$/;
    if (!pattern.test(employeeId)) {
        feedback.className = 'text-danger';
        feedback.innerHTML = '<i class="fas fa-times-circle"></i> Format must be EMP followed by 5 digits (e.g., EMP00001)';
        submitBtn.disabled = true;
        return;
    }
    
    feedback.className = 'text-muted';
    feedback.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking availability...';
    
    employeeIdTimeout = setTimeout(() => {
        fetch(`/auth/ajax/check-employee-id/?employee_id=${encodeURIComponent(employeeId)}`)
            .then(response => response.json())
            .then(data => {
                if (data.available) {
                    feedback.className = 'text-success';
                    feedback.innerHTML = '<i class="fas fa-check-circle"></i> Employee ID available';
                    submitBtn.disabled = false;
                } else {
                    feedback.className = 'text-danger';
                    feedback.innerHTML = '<i class="fas fa-times-circle"></i> ' + data.message;
                    submitBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                feedback.className = 'text-muted';
                feedback.textContent = 'Format: EMP00001 (EMP followed by 5 digits)';
                submitBtn.disabled = false;
            });
    }, 500);
});

// Password match validation
document.getElementById('confirm_password').addEventListener('input', function() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = this.value;
    const matchMsg = document.getElementById('passwordMatch');
    const submitBtn = document.getElementById('submitBtn');
    
    if (newPassword && confirmPassword && newPassword !== confirmPassword) {
        matchMsg.style.display = 'block';
        submitBtn.disabled = true;
    } else {
        matchMsg.style.display = 'none';
        submitBtn.disabled = false;
    }
});

// Load subcategories based on category
document.getElementById('business_category').addEventListener('change', function() {
    const categoryId = this.value;
    const subcategorySelect = document.getElementById('business_subcategory');
    
    if (!categoryId) {
        // Hide all subcategories
        Array.from(subcategorySelect.options).forEach(option => {
            if (option.value) option.style.display = 'none';
        });
        subcategorySelect.value = '';
        return;
    }
    
    // Show only subcategories for selected category
    Array.from(subcategorySelect.options).forEach(option => {
        if (option.value) {
            if (option.dataset.category === categoryId) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        }
    });
    
    // Reset if current selection is not valid
    const currentOption = subcategorySelect.options[subcategorySelect.selectedIndex];
    if (currentOption.dataset.category !== categoryId) {
        subcategorySelect.value = '';
    }
});

// Form validation
document.getElementById('userEditForm').addEventListener('submit', function(e) {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    if (newPassword && newPassword !== confirmPassword) {
        e.preventDefault();
        alert('Passwords do not match!');
        return false;
    }
    
    // âœ… Validate Employee ID format before submit
    const employeeId = document.getElementById('employee_id').value.trim();
    const pattern = /^EMP\d{5}$/;
    if (!pattern.test(employeeId)) {
        e.preventDefault();
        alert('Employee ID must be in format EMP00001 (EMP followed by 5 digits)');
        return false;
    }
});

// Initialize subcategory visibility on page load
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('business_category').dispatchEvent(new Event('change'));
});
</script>
{% endblock %}