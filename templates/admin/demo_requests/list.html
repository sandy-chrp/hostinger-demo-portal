{% extends 'admin/base.html' %}
{% load permission_tags %}

{% block admin_title %}Demo Requests Management{% endblock %}
{% block page_title %}Demo Requests{% endblock %}

{% block breadcrumb %}
<div class="admin-breadcrumb">
    <div class="d-flex justify-content-between align-items-center">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="{% url 'core:admin_dashboard' %}">
                        <i class="fas fa-home me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item active">Demo Requests</li>
            </ol>
        </nav>
        <div class="d-flex align-items-center gap-2 mb-2">
            {% if user|has_permission:'approve_demo_request' %}
            <a href="{% url 'core:admin_create_demo_request' %}" class="btn btn-primary btn-sm">
                <i class="fas fa-plus me-1"></i>Create Request
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block admin_extra_css %}
<style>
    /* Stats Cards */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .stat-card {
        background: white;
        padding: 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
        text-align: center;
        min-height: 70px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .stat-card.total { border-left: 3px solid #087fc2; }
    .stat-card.pending { border-left: 3px solid #f59e0b; }
    .stat-card.confirmed { border-left: 3px solid #10b981; }
    .stat-card.completed { border-left: 3px solid #6366f1; }
    .stat-card.cancelled { border-left: 3px solid #ef4444; }

    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
    }

    .stat-label {
        color: #6b7280;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    /* Filter Card */
    .filter-card {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .date-range-container {
        display: none;
        margin-top: 0.75rem;
    }
    
    .date-range-container.show {
        display: flex;
    }

    /* Admin Card & Table */
    .admin-card {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .table thead th {
        background: #f3f4f6;
        color: #374151;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        padding: 0.75rem;
        border-bottom: 2px solid #e5e7eb;
    }

    .table tbody td {
        padding: 0.75rem;
        vertical-align: middle;
        border-bottom: 1px solid #f3f4f6;
        font-size: 0.875rem;
        font-weight: normal;
    }

    .table tbody tr:hover {
        background-color: #f9fafb;
    }

    /* Only customer name and demo title bold */
    .customer-name,
    .demo-title {
        font-weight: 600;
    }

    .text-secondary {
        color: #6b7280;
        font-weight: normal;
    }

    /* Badges */
    .badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .badge.bg-warning { background-color: #f59e0b !important; }
    .badge.bg-success { background-color: #10b981 !important; }
    .badge.bg-info { background-color: #3b82f6 !important; }
    .badge.bg-danger { background-color: #ef4444 !important; }

    /* Action Buttons */
    .btn-group {
        display: inline-flex;
        gap: 0.25rem;
    }

    .btn-group .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
        height: 32px;
        padding: 0.375rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        border: 1px solid;
        background: white;
        transition: all 0.2s ease;
    }

    .btn-outline-secondary {
        border-color: #d1d5db;
        color: #6b7280;
    }

    .btn-outline-secondary:hover {
        background: #6b7280;
        color: white;
    }

    .btn-outline-success {
        border-color: #10b981;
        color: #10b981;
    }

    .btn-outline-success:hover {
        background: #10b981;
        color: white;
    }

    .btn-outline-primary {
        border-color: #087fc2;
        color: #087fc2;
    }

    .btn-outline-primary:hover {
        background: #087fc2;
        color: white;
    }

    .btn-outline-danger {
        border-color: #ef4444;
        color: #ef4444;
    }

    .btn-outline-danger:hover {
        background: #ef4444;
        color: white;
    }

    /* Pagination */
    .pagination .page-link {
        color: #087fc2;
        border: 1px solid #e5e7eb;
        padding: 0.5rem 0.75rem;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #087fc2;
        border-color: #087fc2;
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }

    .toast {
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    @media (max-width: 768px) {
        .stats-row {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .table {
            font-size: 0.75rem;
        }

        .btn-group .btn {
            min-width: 28px;
            height: 28px;
        }
    }
</style>
{% endblock %}

{% block admin_content %}
<!-- Statistics Cards -->
<div class="stats-row">
    <div class="stat-card total">
        <div class="stat-number">{{ stats.total_requests }}</div>
        <div class="stat-label">Total</div>
    </div>
    <div class="stat-card pending">
        <div class="stat-number">{{ stats.pending }}</div>
        <div class="stat-label">Pending</div>
    </div>
    <div class="stat-card confirmed">
        <div class="stat-number">{{ stats.confirmed }}</div>
        <div class="stat-label">Confirmed</div>
    </div>
    <div class="stat-card completed">
        <div class="stat-number">{{ stats.completed }}</div>
        <div class="stat-label">Completed</div>
    </div>
    <div class="stat-card cancelled">
        <div class="stat-number">{{ stats.cancelled }}</div>
        <div class="stat-label">Cancelled</div>
    </div>
</div>

<!-- Filters -->
<div class="filter-card">
    <form method="get" class="row g-3" id="filtersForm">
        <div class="col-md-3">
            <input type="text" name="search" class="form-control" 
                   placeholder="Search..." value="{{ search|default:'' }}">
        </div>
        
        <div class="col-md-3">
            <select name="status" class="form-select" onchange="this.form.submit()">
                <option value="">All Status</option>
                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>Confirmed</option>
                <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
        </div>
        
        <div class="col-md-3">
            <select name="assigned_to" class="form-select" onchange="this.form.submit()">
                <option value="">All Assigned</option>
                <option value="unassigned" {% if assigned_to_filter == 'unassigned' %}selected{% endif %}>Unassigned</option>
                <option value="me" {% if assigned_to_filter == 'me' %}selected{% endif %}>Assigned to Me</option>
                {% for employee in sales_employees %}
                    <option value="{{ employee.id }}" {% if assigned_to_filter == employee.id|stringformat:"s" %}selected{% endif %}>
                        {{ employee.get_full_name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-3">
            <select name="time_range" class="form-select" id="timeRangeSelect" onchange="handleTimeRangeChange(this.value)">
                <option value="">All Time</option>
                <option value="today" {% if time_range == 'today' %}selected{% endif %}>Today</option>
                <option value="tomorrow" {% if time_range == 'tomorrow' %}selected{% endif %}>Tomorrow</option>
                <option value="this_week" {% if time_range == 'this_week' %}selected{% endif %}>This Week</option>
                <option value="next_week" {% if time_range == 'next_week' %}selected{% endif %}>Next Week</option>
                <option value="this_month" {% if time_range == 'this_month' %}selected{% endif %}>This Month</option>
                <option value="custom_range" {% if time_range == 'custom_range' %}selected{% endif %}>Custom Range</option>
            </select>
            
            <div class="date-range-container row g-2 mt-2 {% if time_range == 'custom_range' %}show{% endif %}" id="dateRangeContainer">
                <div class="col-6">
                    <input type="date" name="date_from" class="form-control" value="{{ date_from|default:'' }}">
                </div>
                <div class="col-6">
                    <input type="date" name="date_to" class="form-control" value="{{ date_to|default:'' }}">
                </div>
                <div class="col-12 mt-2">
                    <button type="submit" class="btn btn-sm btn-primary w-100">Apply</button>
                </div>
            </div>
        </div>
        
        <div class="col-md-12 text-end mt-1">
            <button type="submit" class="btn btn-primary btn-sm me-2">
                <i class="fas fa-search me-1"></i>Search
            </button>
            <a href="{% url 'core:admin_demo_requests' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-times me-1"></i>Clear
            </a>
        </div>
    </form>
</div>

<!-- Demo Requests Table -->
{% if demo_requests %}
    <div class="admin-card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Demo</th>
                        <th>Date & Time</th>
                        <th>Assigned To</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for request in demo_requests %}
                        <tr data-request-id="{{ request.id }}" 
                            data-demo="{{ request.demo.title }}"
                            data-customer="{{ request.user.get_full_name }}"
                            data-date="{{ request.requested_date|date:"D, M d, Y" }}"
                            data-time="{{ request.requested_time_slot.get_display_time }}"
                            data-date-iso="{{ request.requested_date|date:"Y-m-d" }}"
                            data-timeslot-id="{{ request.requested_time_slot.id }}"
                            data-status="{{ request.status }}">
                            
                            <td>
                                <div class="customer-name">{{ request.user.get_full_name }}</div>
                                <div class="small text-secondary">{{ request.user.email }}</div>
                                {% if request.user.mobile %}
                                <div class="small text-secondary mt-1">
                                    <i class="fas fa-phone-alt me-1"></i>{{ request.user.full_mobile }}
                                </div>
                                {% endif %}
                            </td>
                            
                            <td>
                                <div class="demo-title">{{ request.demo.title }}</div>
                                <div class="small text-secondary">{{ request.demo.get_file_type_display }}</div>
                            </td>
                            
                            <td>
                                <div>{{ request.requested_date|date:"D, M d, Y" }}</div>
                                <div class="small text-secondary">{{ request.requested_time_slot.get_display_time }}</div>
                                <div class="small text-secondary mt-1">
                                    <i class="far fa-clock me-1"></i>{{ request.created_at|timesince }} ago
                                </div>
                            </td>
                            
                            <td>
                                {% if request.assigned_to %}
                                <div>{{ request.assigned_to.get_full_name }}</div>
                                <div class="small text-secondary">{{ request.assigned_to.email }}</div>
                                {% else %}
                                <div class="text-secondary">
                                    <i class="fas fa-user-slash me-1"></i>Not assigned
                                </div>
                                {% endif %}
                            </td>
                            
                            <td>
                                {% if request.status == 'pending' %}
                                <span class="badge bg-warning">Pending</span>
                                {% elif request.status == 'confirmed' %}
                                <span class="badge bg-success">Confirmed</span>
                                {% elif request.status == 'completed' %}
                                <span class="badge bg-info">Completed</span>
                                {% elif request.status == 'cancelled' %}
                                <span class="badge bg-danger">Cancelled</span>
                                {% endif %}
                            </td>
                            
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'core:admin_demo_request_detail' request.id %}" 
                                       class="btn btn-sm btn-outline-secondary" title="View">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    
                                    {% if request.status == 'pending' and user|has_permission:'approve_demo_request' %}
                                    <button type="button" class="btn btn-sm btn-outline-success" 
                                            onclick="confirmRequest({{ request.id }})" title="Confirm">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    {% endif %}
                                    
                                    {% if not request.assigned_to and request.status in 'pending,confirmed' and user|has_permission:'manage_demo_requests' %}
                                    <button type="button" class="btn btn-sm btn-outline-primary" 
                                            onclick="quickAssign({{ request.id }})" title="Assign">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                    {% endif %}
                                    
                                    {% if request.status not in 'cancelled,completed' and user|has_permission:'approve_demo_request' %}
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="cancelRequest({{ request.id }})" title="Cancel">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    {% endif %}
                                    
                                    {% if request.status == 'cancelled' and user|has_permission:'reject_demo_request' %}
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="deleteRequest({{ request.id }})" title="Delete">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Pagination -->
    {% if paginator.num_pages > 1 %}
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
            <p class="text-muted mb-0">
                Showing {{ demo_requests.start_index }} to {{ demo_requests.end_index }} of {{ paginator.count }} entries
            </p>
        </div>
        <div>
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    {% if demo_requests.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ demo_requests.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if time_range %}&time_range={{ time_range }}{% endif %}{% if assigned_to_filter %}&assigned_to={{ assigned_to_filter }}{% endif %}">Previous</a>
                    </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">{{ demo_requests.number }}</span>
                    </li>
                    
                    {% if demo_requests.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ demo_requests.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if time_range %}&time_range={{ time_range }}{% endif %}{% if assigned_to_filter %}&assigned_to={{ assigned_to_filter }}{% endif %}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
{% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>No demo requests found.
    </div>
{% endif %}

<!-- Assign Modal -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-check me-2"></i>Assign Demo Request
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickAssignForm">
                    {% csrf_token %}
                    
                    <div class="alert alert-info">
                        <div class="mb-1"><strong>Demo:</strong> <span id="assignModalDemo"></span></div>
                        <div class="mb-1"><strong>Customer:</strong> <span id="assignModalCustomer"></span></div>
                        <div><strong>Date/Time:</strong> <span id="assignModalDateTime"></span></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Select Employee <span class="text-danger">*</span></label>
                        
                        <div id="quickLoadingEmployees" class="text-center py-3">
                            <div class="spinner-border spinner-border-sm"></div>
                            <span class="ms-2">Loading...</span>
                        </div>
                        
                        <select id="quickEmployeeSelect" name="employee_id" class="form-select" required style="display:none;">
                            <option value="">-- Select Employee --</option>
                        </select>
                        
                        <div id="noEmployeesMessage" class="alert alert-warning" style="display:none;">
                            No employees available.
                        </div>
                    </div>
                    
                    <div id="quickAvailabilityStatus" style="display:none;"></div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea name="assignment_notes" class="form-control" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="send_notification" checked>
                            <label class="form-check-label">Send email notification</label>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" id="quickAssignBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-user-check me-2"></i>Assign
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3"></div>

{% endblock %}

{% block admin_extra_js %}
<script>
const csrfToken = '{{ csrf_token }}';
const HAS_MANAGE_PERMISSION = {{ user|has_permission:'manage_demo_requests'|yesno:'true,false' }};
const HAS_APPROVE_PERMISSION = {{ user|has_permission:'approve_demo_request'|yesno:'true,false' }};
const HAS_REJECT_PERMISSION = {{ user|has_permission:'reject_demo_request'|yesno:'true,false' }};

let quickAssignModal = null;
let currentAssignRequestId = null;

function showToast(type, message, duration = 5000) {
    const container = document.querySelector('.toast-container');
    if (!container) {
        alert(message);
        return;
    }
    
    const toastId = `toast-${Date.now()}`;
    const icons = {
        success: 'fa-check-circle text-success',
        error: 'fa-exclamation-circle text-danger',
        warning: 'fa-exclamation-triangle text-warning',
        info: 'fa-info-circle text-info'
    };
    
    const titles = {
        success: 'Success',
        error: 'Error',
        warning: 'Warning',
        info: 'Information'
    };
    
    const html = `
        <div id="${toastId}" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas ${icons[type]} me-2"></i>
                <strong class="me-auto">${titles[type]}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">${message}</div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', html);
    const toastElement = document.getElementById(toastId);
    
    if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
        const toast = new bootstrap.Toast(toastElement, { delay: duration });
        toast.show();
        toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
    }
}

function getRowData(requestId) {
    const row = document.querySelector(`tr[data-request-id="${requestId}"]`);
    if (!row) return null;
    
    return {
        id: requestId,
        demo: row.getAttribute('data-demo') || 'N/A',
        customer: row.getAttribute('data-customer') || 'N/A',
        date: row.getAttribute('data-date') || 'N/A',
        time: row.getAttribute('data-time') || 'N/A',
        dateIso: row.getAttribute('data-date-iso') || '',
        timeSlotId: row.getAttribute('data-timeslot-id') || '',
        status: row.getAttribute('data-status') || ''
    };
}

function confirmRequest(requestId) {
    if (!HAS_APPROVE_PERMISSION) {
        showToast('error', 'No permission to confirm');
        return;
    }
    
    const data = getRowData(requestId);
    if (!data) {
        showToast('error', 'Request not found');
        return;
    }
    
    if (!confirm(`Confirm demo for ${data.customer}?\n\nDemo: ${data.demo}\nDate: ${data.date}\nTime: ${data.time}`)) {
        return;
    }
    
    showToast('info', 'Confirming...', 2000);
    
    fetch(`/admin/demo-requests/${requestId}/confirm/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: 'confirm',
            confirmed_date: data.dateIso,
            confirmed_time_slot_id: data.timeSlotId
        })
    })
    .then(r => r.json())
    .then(res => {
        if (res.success) {
            showToast('success', 'Confirmed! Reloading...');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('error', res.error || 'Failed');
        }
    })
    .catch(err => showToast('error', err.message));
}

function quickAssign(requestId) {
    if (!HAS_MANAGE_PERMISSION) {
        showToast('error', 'No permission to assign');
        return;
    }
    
    currentAssignRequestId = requestId;
    const data = getRowData(requestId);
    
    if (!data) {
        showToast('error', 'Request not found');
        return;
    }
    
    setTimeout(() => {
        const modalDemo = document.getElementById('assignModalDemo');
        const modalCustomer = document.getElementById('assignModalCustomer');
        const modalDateTime = document.getElementById('assignModalDateTime');
        
        if (!modalDemo || !modalCustomer || !modalDateTime) {
            showToast('error', 'Modal elements missing. Please refresh.');
            return;
        }
        
        modalDemo.textContent = data.demo;
        modalCustomer.textContent = data.customer;
        modalDateTime.textContent = `${data.date} at ${data.time}`;
        
        const employeeSelect = document.getElementById('quickEmployeeSelect');
        const loadingDiv = document.getElementById('quickLoadingEmployees');
        const availabilityDiv = document.getElementById('quickAvailabilityStatus');
        const noEmployeesDiv = document.getElementById('noEmployeesMessage');
        const assignBtn = document.getElementById('quickAssignBtn');
        
        if (employeeSelect) {
            employeeSelect.value = '';
            employeeSelect.style.display = 'none';
        }
        
        if (loadingDiv) loadingDiv.style.display = 'block';
        if (availabilityDiv) availabilityDiv.style.display = 'none';
        if (noEmployeesDiv) noEmployeesDiv.style.display = 'none';
        if (assignBtn) assignBtn.disabled = true;
        
        const form = document.getElementById('quickAssignForm');
        if (form) {
            form.action = `/admin/demo-requests/${requestId}/assign/`;
            form.reset();
        }
        
        loadQuickEmployees(data.dateIso, data.timeSlotId);
        
        try {
            if (quickAssignModal && typeof quickAssignModal.show === 'function') {
                quickAssignModal.show();
            } else if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const modalEl = document.getElementById('assignModal');
                const tempModal = new bootstrap.Modal(modalEl);
                tempModal.show();
            }
        } catch (error) {
            showToast('error', 'Failed to open modal');
        }
    }, 100);
}

function loadQuickEmployees(dateIso, timeSlotId) {
    const loadingDiv = document.getElementById('quickLoadingEmployees');
    const employeeSelect = document.getElementById('quickEmployeeSelect');
    const noEmployeesDiv = document.getElementById('noEmployeesMessage');
    
    if (loadingDiv) loadingDiv.style.display = 'block';
    if (employeeSelect) employeeSelect.style.display = 'none';
    if (noEmployeesDiv) noEmployeesDiv.style.display = 'none';
    
    fetch(`/api/demo-requests/available-employees/?date=${dateIso}&time_slot_id=${timeSlotId}`)
        .then(r => r.json())
        .then(data => {
            if (loadingDiv) loadingDiv.style.display = 'none';
            
            if (data.success && data.employees && data.employees.length > 0) {
                if (employeeSelect) {
                    employeeSelect.innerHTML = '<option value="">-- Select Employee --</option>';
                    data.employees.forEach(emp => {
                        const opt = document.createElement('option');
                        opt.value = emp.id;
                        opt.textContent = `${emp.name} (${emp.current_demos} demos)`;
                        employeeSelect.appendChild(opt);
                    });
                    employeeSelect.style.display = 'block';
                }
            } else {
                if (noEmployeesDiv) noEmployeesDiv.style.display = 'block';
            }
        })
        .catch(err => {
            if (loadingDiv) loadingDiv.style.display = 'none';
            showToast('error', 'Failed to load employees');
        });
}

function checkQuickAvailability(employeeId) {
    const data = getRowData(currentAssignRequestId);
    if (!data) return;
    
    const statusDiv = document.getElementById('quickAvailabilityStatus');
    const assignBtn = document.getElementById('quickAssignBtn');
    
    if (statusDiv) {
        statusDiv.innerHTML = '<div class="alert alert-info"><div class="spinner-border spinner-border-sm me-2"></div>Checking...</div>';
        statusDiv.style.display = 'block';
    }
    
    if (assignBtn) assignBtn.disabled = true;
    
    fetch(`/api/demo-requests/check-availability/?employee_id=${employeeId}&date=${data.dateIso}&time_slot_id=${data.timeSlotId}&demo_request_id=${currentAssignRequestId}`)
        .then(r => r.json())
        .then(res => {
            if (res.available) {
                if (statusDiv) statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check me-2"></i>Available</div>';
                if (assignBtn) assignBtn.disabled = false;
            } else {
                if (statusDiv) statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times me-2"></i>${res.message || 'Not available'}</div>`;
                if (assignBtn) assignBtn.disabled = true;
            }
        });
}

function cancelRequest(requestId) {
    if (!HAS_REJECT_PERMISSION) {
        showToast('error', 'No permission');
        return;
    }
    
    const data = getRowData(requestId);
    const reason = prompt(`Cancel request for ${data.customer}?\n\nReason:`);
    
    if (!reason || !reason.trim()) return;
    
    showToast('info', 'Cancelling...', 2000);
    
    fetch(`/admin/demo-requests/${requestId}/confirm/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: 'cancel',
            cancel_reason: reason.trim()
        })
    })
    .then(r => r.json())
    .then(res => {
        if (res.success) {
            showToast('success', 'Cancelled! Reloading...');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('error', res.error || 'Failed');
        }
    });
}

function deleteRequest(requestId) {
    if (!HAS_REJECT_PERMISSION) {
        showToast('error', 'No permission');
        return;
    }
    
    const data = getRowData(requestId);
    
    if (data.status !== 'cancelled') {
        showToast('warning', 'Only cancelled requests can be deleted');
        return;
    }
    
    if (!confirm(`DELETE permanently?\n\n${data.customer} - ${data.demo}\n\nCannot be undone!`)) {
        return;
    }
    
    showToast('info', 'Deleting...', 2000);
    
    fetch(`/admin/demo-requests/${requestId}/delete/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken }
    })
    .then(r => r.json())
    .then(res => {
        if (res.success) {
            showToast('success', 'Deleted! Reloading...');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('error', res.error || 'Failed');
        }
    });
}

function handleTimeRangeChange(value) {
    const container = document.getElementById('dateRangeContainer');
    if (value === 'custom_range') {
        container.classList.add('show');
    } else {
        container.classList.remove('show');
        if (value) document.getElementById('filtersForm').submit();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('üîµ Initializing...');
    
    if (typeof bootstrap === 'undefined') {
        console.error('‚ùå Bootstrap not loaded');
        return;
    }
    
    function initModal(retry = 0) {
        const modalEl = document.getElementById('assignModal');
        if (!modalEl) {
            if (retry < 3) {
                setTimeout(() => initModal(retry + 1), 200);
            }
            return;
        }
        
        try {
            quickAssignModal = new bootstrap.Modal(modalEl);
            console.log('‚úÖ Modal initialized');
        } catch (error) {
            console.error('‚ùå Modal init error:', error);
        }
    }
    
    initModal();
    
    const employeeSelect = document.getElementById('quickEmployeeSelect');
    if (employeeSelect) {
        employeeSelect.addEventListener('change', function() {
            if (this.value && currentAssignRequestId) {
                checkQuickAvailability(this.value);
            }
        });
    }
    
    const assignForm = document.getElementById('quickAssignForm');
    if (assignForm) {
        assignForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const employeeId = formData.get('employee_id');
            
            if (!employeeId) {
                showToast('error', 'Please select an employee');
                return;
            }
            
            const btn = document.getElementById('quickAssignBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Assigning...';
            }
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: { 
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    showToast('success', 'Assigned! Reloading...');
                    
                    if (quickAssignModal) {
                        quickAssignModal.hide();
                    }
                    
                    setTimeout(() => location.reload(), 1500);
                } else {
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-user-check me-2"></i>Assign';
                    }
                    showToast('error', res.error || 'Failed');
                }
            })
            .catch(error => {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-user-check me-2"></i>Assign';
                }
                showToast('error', error.message);
            });
        });
    }
    
    console.log('‚úÖ Initialization complete');
});
</script>
{% endblock %}