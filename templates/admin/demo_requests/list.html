{% extends 'admin/base.html' %}
{% load permission_tags %}

{% block admin_title %}Demo Requests Management{% endblock %}
{% block page_title %}Demo Requests{% endblock %}

{% block breadcrumb %}
<div class="admin-breadcrumb">
    <div class="d-flex justify-content-between align-items-center">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="{% url 'core:admin_dashboard' %}">
                        <i class="fas fa-home me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item active">Demo Requests</li>
            </ol>
        </nav>
        <div class="d-flex align-items-center gap-2 mb-2">
            {% if user|has_permission:'approve_demo_request' %}
            <a href="{% url 'core:admin_create_demo_request' %}" class="btn btn-primary btn-sm">
                <i class="fas fa-plus me-1"></i>Create Request
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block admin_extra_css %}
<style>
    /* Stats Cards */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .stat-card {
        background: white;
        padding: 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
        text-align: center;
        min-height: 70px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .stat-card.total { border-left: 3px solid #087fc2; }
    .stat-card.pending { border-left: 3px solid #f59e0b; }
    .stat-card.confirmed { border-left: 3px solid #10b981; }
    .stat-card.completed { border-left: 3px solid #6366f1; }
    .stat-card.cancelled { border-left: 3px solid #ef4444; }

    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
    }

    .stat-label {
        color: #6b7280;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    /* Filter Card */
    .filter-card {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .date-range-container {
        display: none;
        margin-top: 0.75rem;
    }
    
    .date-range-container.show {
        display: flex;
    }

    /* Admin Card & Table */
    .admin-card {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .table thead th {
        background: #f3f4f6;
        color: #374151;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        padding: 0.75rem;
        border-bottom: 2px solid #e5e7eb;
    }

    .table tbody td {
        padding: 0.75rem;
        vertical-align: middle;
        border-bottom: 1px solid #f3f4f6;
        font-size: 0.875rem;
        font-weight: normal;
    }

    .table tbody tr:hover {
        background-color: #f9fafb;
    }

    /* Only customer name and demo title bold */
    .customer-name,
    .demo-title {
        font-weight: 600;
    }

    .text-secondary {
        color: #6b7280;
        font-weight: normal;
    }

    /* Badges */
    .badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .badge.bg-warning { background-color: #f59e0b !important; }
    .badge.bg-success { background-color: #10b981 !important; }
    .badge.bg-info { background-color: #3b82f6 !important; }
    .badge.bg-danger { background-color: #ef4444 !important; }

    /* Action Buttons */
    .btn-group {
        display: inline-flex;
        gap: 0.25rem;
    }

    .btn-group .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
        height: 32px;
        padding: 0.375rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        border: 1px solid;
        background: white;
        transition: all 0.2s ease;
    }

    .btn-outline-secondary {
        border-color: #d1d5db;
        color: #6b7280;
    }

    .btn-outline-secondary:hover {
        background: #6b7280;
        color: white;
    }

    .btn-outline-success {
        border-color: #10b981;
        color: #10b981;
    }

    .btn-outline-success:hover {
        background: #10b981;
        color: white;
    }

    .btn-outline-danger {
        border-color: #ef4444;
        color: #ef4444;
    }

    .btn-outline-danger:hover {
        background: #ef4444;
        color: white;
    }

    /* ‚úÖ ENHANCED: Employee Selection Styles */
    .employee-card {
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .employee-card:hover:not(.unavailable):not(.past-slot) {
        border-color: #087fc2;
        background-color: #f0f9ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .employee-card.selected {
        border-color: #087fc2;
        background-color: #dbeafe;
        box-shadow: 0 0 0 3px rgba(8, 127, 194, 0.1);
    }

    .employee-card.unavailable,
    .employee-card.past-slot {
        border-color: #f3f4f6;
        background-color: #f9fafb;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .employee-card.booked {
        border-color: #fef3c7;
        background-color: #fffbeb;
    }

    .employee-card .employee-name {
        font-weight: 600;
        color: #1f2937;
        font-size: 0.95rem;
        margin-bottom: 0.25rem;
    }

    .employee-card .employee-email {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }

    .employee-card .employee-status {
        font-size: 0.75rem;
        margin-top: 0.5rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        display: inline-block;
        font-weight: 600;
    }

    .employee-card .status-available {
        background-color: #d1fae5;
        color: #065f46;
    }

    .employee-card .status-busy {
        background-color: #fed7aa;
        color: #92400e;
    }

    .employee-card .status-conflict {
        background-color: #fecaca;
        color: #991b1b;
    }

    .employee-card .workload-info {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }

    .employee-card .conflict-badge {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background-color: #ef4444;
        color: white;
        font-size: 0.65rem;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        animation: pulse-red 2s ease-in-out infinite;
        z-index: 10;
    }

    @keyframes pulse-red {
        0%, 100% { 
            opacity: 1;
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        50% { 
            opacity: 0.9;
            box-shadow: 0 0 0 5px rgba(239, 68, 68, 0);
        }
    }

    /* Alert for conflict details */
    .alert-sm {
        font-size: 0.8rem;
        padding: 0.75rem;
        margin-top: 0.5rem;
        border-radius: 0.375rem;
        border: 1px solid;
    }

    .employee-card .alert-danger {
        background-color: #fee2e2;
        border-color: #fecaca;
        color: #991b1b;
    }

    .employee-card .alert-success {
        background-color: #d1fae5;
        border-color: #a7f3d0;
        color: #065f46;
    }

    .employee-card .alert-warning {
        background-color: #fef3c7;
        border-color: #fde68a;
        color: #92400e;
    }

    .employee-card .alert-info {
        background-color: #dbeafe;
        border-color: #bfdbfe;
        color: #1e40af;
    }

    .employee-role {
        font-size: 0.75rem;
        color: #6b7280;
        font-style: italic;
    }

    /* Enhanced status badges */
    .employee-status {
        white-space: nowrap;
    }

    /* Sorting indicator */
    .employee-count-badge {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.8rem;
        font-weight: 600;
    }

    /* Pagination */
    .pagination .page-link {
        color: #087fc2;
        border: 1px solid #e5e7eb;
        padding: 0.5rem 0.75rem;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #087fc2;
        border-color: #087fc2;
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }

    .toast {
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Modal Enhancements */
    .modal-header {
        background: linear-gradient(135deg, #087fc2 0%, #0a5f8a 100%);
        color: white;
    }

    .modal-header .btn-close {
        filter: brightness(0) invert(1);
    }

    /* Loading Animation */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .loading-pulse {
        animation: pulse 1.5s ease-in-out infinite;
    }

    @media (max-width: 768px) {
        .stats-row {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .table {
            font-size: 0.75rem;
        }

        .btn-group .btn {
            min-width: 28px;
            height: 28px;
        }
    }
</style>
{% endblock %}

{% block admin_content %}
<!-- Statistics Cards -->
<div class="stats-row">
    <div class="stat-card total">
        <div class="stat-number">{{ stats.total_requests }}</div>
        <div class="stat-label">Total</div>
    </div>
    <div class="stat-card pending">
        <div class="stat-number">{{ stats.pending }}</div>
        <div class="stat-label">Pending</div>
    </div>
    <div class="stat-card confirmed">
        <div class="stat-number">{{ stats.confirmed }}</div>
        <div class="stat-label">Confirmed</div>
    </div>
    <div class="stat-card completed">
        <div class="stat-number">{{ stats.completed }}</div>
        <div class="stat-label">Completed</div>
    </div>
    <div class="stat-card cancelled">
        <div class="stat-number">{{ stats.cancelled }}</div>
        <div class="stat-label">Cancelled</div>
    </div>
</div>

<!-- Filters -->
<div class="filter-card">
    <form method="get" class="row g-3" id="filtersForm">
        <div class="col-md-3">
            <input type="text" name="search" class="form-control" 
                   placeholder="Search customer, demo..." value="{{ search|default:'' }}">
        </div>
        
        <div class="col-md-3">
            <select name="status" class="form-select" onchange="this.form.submit()">
                <option value="">All Status</option>
                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>Confirmed</option>
                <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
        </div>
        
        <div class="col-md-3">
            <select name="assigned_to" class="form-select" onchange="this.form.submit()">
                <option value="">All Assigned</option>
                <option value="unassigned" {% if assigned_to_filter == 'unassigned' %}selected{% endif %}>Unassigned</option>
                <option value="me" {% if assigned_to_filter == 'me' %}selected{% endif %}>Assigned to Me</option>
                {% for employee in sales_employees %}
                    <option value="{{ employee.id }}" {% if assigned_to_filter == employee.id|stringformat:"s" %}selected{% endif %}>
                        {{ employee.get_full_name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-3">
            <select name="time_range" class="form-select" id="timeRangeSelect" onchange="handleTimeRangeChange(this.value)">
                <option value="">All Time</option>
                <option value="today" {% if time_range == 'today' %}selected{% endif %}>Today</option>
                <option value="tomorrow" {% if time_range == 'tomorrow' %}selected{% endif %}>Tomorrow</option>
                <option value="this_week" {% if time_range == 'this_week' %}selected{% endif %}>This Week</option>
                <option value="next_week" {% if time_range == 'next_week' %}selected{% endif %}>Next Week</option>
                <option value="this_month" {% if time_range == 'this_month' %}selected{% endif %}>This Month</option>
                <option value="custom_range" {% if time_range == 'custom_range' %}selected{% endif %}>Custom Range</option>
            </select>
            
            <div class="date-range-container row g-2 mt-2 {% if time_range == 'custom_range' %}show{% endif %}" id="dateRangeContainer">
                <div class="col-6">
                    <input type="date" name="date_from" class="form-control" placeholder="From" value="{{ date_from|default:'' }}">
                </div>
                <div class="col-6">
                    <input type="date" name="date_to" class="form-control" placeholder="To" value="{{ date_to|default:'' }}">
                </div>
                <div class="col-12 mt-2">
                    <button type="submit" class="btn btn-sm btn-primary w-100">Apply Date Range</button>
                </div>
            </div>
        </div>
        
        <div class="col-md-12 text-end mt-1">
            <button type="submit" class="btn btn-primary btn-sm me-2">
                <i class="fas fa-search me-1"></i>Search
            </button>
            <a href="{% url 'core:admin_demo_requests' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-times me-1"></i>Clear Filters
            </a>
        </div>
    </form>
</div>

<!-- Demo Requests Table -->
{% if demo_requests %}
    <div class="admin-card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 20%;">Customer</th>
                        <th style="width: 20%;">Demo</th>
                        <th style="width: 20%;">Date & Time</th>
                        <th style="width: 18%;">Assigned To</th>
                        <th style="width: 10%;">Status</th>
                        <th style="width: 12%;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for request in demo_requests %}
                        <tr data-request-id="{{ request.id }}" 
                            data-demo="{{ request.demo.title }}"
                            data-customer="{{ request.user.get_full_name }}"
                            data-date="{{ request.requested_date|date:"D, M d, Y" }}"
                            data-time="{{ request.requested_time_slot.get_display_time }}"
                            data-date-iso="{{ request.requested_date|date:"Y-m-d" }}"
                            data-timeslot-id="{{ request.requested_time_slot.id }}"
                            data-status="{{ request.status }}">
                            
                            <td>
                                <div class="customer-name">{{ request.user.get_full_name }}</div>
                                <div class="small text-secondary">{{ request.user.email }}</div>
                                {% if request.user.mobile %}
                                <div class="small text-secondary mt-1">
                                    <i class="fas fa-phone-alt me-1"></i>{{ request.user.full_mobile }}
                                </div>
                                {% endif %}
                            </td>
                            
                            <td>
                                <div class="demo-title">{{ request.demo.title }}</div>
                                <div class="small text-secondary">{{ request.demo.get_file_type_display }}</div>
                            </td>
                            
                            <td>
                                <div>{{ request.requested_date|date:"D, M d, Y" }}</div>
                                <div class="small text-secondary">{{ request.requested_time_slot.get_display_time }}</div>
                                <div class="small text-secondary mt-1">
                                    <i class="far fa-clock me-1"></i>{{ request.created_at|timesince }} ago
                                </div>
                            </td>
                            
                            <td>
                                {% if request.assigned_to %}
                                <div>
                                    <i class="fas fa-user-check me-1 text-success"></i>{{ request.assigned_to.get_full_name }}
                                </div>
                                <div class="small text-secondary">{{ request.assigned_to.email }}</div>
                                {% else %}
                                <div class="text-secondary">
                                    <i class="fas fa-user-slash me-1"></i>Not assigned
                                </div>
                                {% endif %}
                            </td>
                            
                            <td>
                                {% if request.status == 'pending' %}
                                <span class="badge bg-warning">Pending</span>
                                {% elif request.status == 'confirmed' %}
                                <span class="badge bg-success">Confirmed</span>
                                {% elif request.status == 'completed' %}
                                <span class="badge bg-info">Completed</span>
                                {% elif request.status == 'cancelled' %}
                                <span class="badge bg-danger">Cancelled</span>
                                {% endif %}
                            </td>
                            
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'core:admin_demo_request_detail' request.id %}" 
                                       class="btn btn-sm btn-outline-secondary" 
                                       title="View Full Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    
                                    {% if request.status == 'pending' and user|has_permission:'approve_demo_request' %}
                                    <button type="button" class="btn btn-sm btn-outline-success" 
                                            onclick="openConfirmModal({{ request.id }})" 
                                            title="Confirm & Assign Employee">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    {% endif %}
                                    
                                    {% if request.status not in 'cancelled,completed' and user|has_permission:'approve_demo_request' %}
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="cancelRequest({{ request.id }})" 
                                            title="Cancel Request">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    {% endif %}
                                    
                                    {% if request.status == 'cancelled' and user|has_permission:'reject_demo_request' %}
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="deleteRequest({{ request.id }})" 
                                            title="Delete Permanently">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Pagination -->
    {% if paginator.num_pages > 1 %}
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
            <p class="text-muted mb-0">
                Showing {{ demo_requests.start_index }} to {{ demo_requests.end_index }} of {{ paginator.count }} entries
            </p>
        </div>
        <div>
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    {% if demo_requests.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ demo_requests.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if time_range %}&time_range={{ time_range }}{% endif %}{% if assigned_to_filter %}&assigned_to={{ assigned_to_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">{{ demo_requests.number }} / {{ paginator.num_pages }}</span>
                    </li>
                    
                    {% if demo_requests.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ demo_requests.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if time_range %}&time_range={{ time_range }}{% endif %}{% if assigned_to_filter %}&assigned_to={{ assigned_to_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
{% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        <strong>No demo requests found.</strong>
        {% if search or status_filter or time_range or assigned_to_filter %}
        <p class="mb-0 mt-2">Try adjusting your filters or <a href="{% url 'core:admin_demo_requests' %}">clear all filters</a>.</p>
        {% endif %}
    </div>
{% endif %}

<!-- ‚úÖ ENHANCED: Confirm & Assign Modal -->
<div class="modal fade" id="confirmAssignModal" tabindex="-1" aria-labelledby="confirmAssignModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmAssignModalLabel">
                    <i class="fas fa-check-circle me-2"></i>Confirm Demo & Assign Employee
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Demo Request Info -->
                <div class="alert alert-light border mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-2">
                                <strong><i class="fas fa-user me-1 text-primary"></i>Customer:</strong>
                                <span id="modalCustomer" class="ms-1"></span>
                            </div>
                            <div>
                                <strong><i class="fas fa-desktop me-1 text-primary"></i>Demo:</strong>
                                <span id="modalDemo" class="ms-1"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <strong><i class="far fa-calendar me-1 text-primary"></i>Date:</strong>
                                <span id="modalDate" class="ms-1"></span>
                            </div>
                            <div>
                                <strong><i class="far fa-clock me-1 text-primary"></i>Time:</strong>
                                <span id="modalTime" class="ms-1"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="employeeLoadingState" class="text-center py-5 loading-pulse">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mb-0">Loading available employees...</p>
                    <small class="text-muted">Please wait</small>
                </div>

                <!-- Employee Selection -->
                <div id="employeeSelectionContainer" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="fas fa-users me-2 text-primary"></i>Available Employees
                        </h6>
                        <small class="text-muted" id="employeeCount"></small>
                    </div>
                    
                    <div id="employeeList" class="mb-3" style="max-height: 400px; overflow-y: auto; padding-right: 0.5rem;">
                        <!-- Populated dynamically via JavaScript -->
                    </div>

                    <div id="selectedEmployeeInfo" class="alert alert-success border-success" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle me-2 fs-5"></i>
                            <div>
                                <strong>Selected Employee:</strong>
                                <div id="selectedEmployeeName" class="mt-1"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- No Employees Available -->
                <div id="noEmployeesMessage" class="alert alert-warning border-warning" style="display: none;">
                    <div class="d-flex">
                        <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
                        <div>
                            <strong>No employees available for this time slot</strong>
                            <p class="mb-2 mt-2">All employees are busy or unavailable at the selected time.</p>
                            <p class="mb-0"><strong>Options:</strong></p>
                            <ul class="mb-0 mt-1">
                                <li>Proceed without assignment (you can assign later)</li>
                                <li>Cancel and reschedule to a different time</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Admin Notes -->
                <div class="mt-4">
                    <label for="confirmAdminNotes" class="form-label">
                        <i class="far fa-sticky-note me-1"></i>Admin Notes <small class="text-muted">(Optional)</small>
                    </label>
                    <textarea id="confirmAdminNotes" class="form-control" rows="3" 
                              placeholder="Add any notes about this confirmation..."></textarea>
                    <small class="text-muted">These notes will be visible to assigned employee and in request history.</small>
                </div>
            </div>
            
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" id="proceedWithoutAssignBtn" class="btn btn-warning" 
                        onclick="confirmWithoutAssignment()" style="display: none;">
                    <i class="fas fa-forward me-1"></i>Confirm Without Assignment
                </button>
                <button type="button" id="confirmAssignBtn" class="btn btn-success" 
                        onclick="confirmWithAssignment()" disabled>
                    <i class="fas fa-check-circle me-1"></i>Confirm & Assign
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

{% endblock %}

{% block admin_extra_js %}
<script>
// ============================================================================
// CONFIGURATION & GLOBAL VARIABLES
// ============================================================================

const csrfToken = '{{ csrf_token }}';
const HAS_MANAGE_PERMISSION = {{ user|has_permission:'manage_demo_requests'|yesno:'true,false' }};
const HAS_APPROVE_PERMISSION = {{ user|has_permission:'approve_demo_request'|yesno:'true,false' }};
const HAS_REJECT_PERMISSION = {{ user|has_permission:'reject_demo_request'|yesno:'true,false' }};

let confirmAssignModal = null;
let currentRequestId = null;
let currentRequestData = null;
let selectedEmployeeId = null;
let availableEmployees = [];

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function showToast(type, message, duration = 5000) {
    const container = document.querySelector('.toast-container');
    if (!container) {
        alert(message);
        return;
    }
    
    const toastId = `toast-${Date.now()}`;
    const icons = {
        success: 'fa-check-circle text-success',
        error: 'fa-exclamation-circle text-danger',
        warning: 'fa-exclamation-triangle text-warning',
        info: 'fa-info-circle text-info'
    };
    
    const titles = {
        success: 'Success',
        error: 'Error',
        warning: 'Warning',
        info: 'Information'
    };
    
    const bgColors = {
        success: 'bg-success',
        error: 'bg-danger',
        warning: 'bg-warning',
        info: 'bg-info'
    };
    
    const html = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgColors[type]} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas ${icons[type]} me-2"></i>
                    <strong>${titles[type]}:</strong> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', html);
    const toastElement = document.getElementById(toastId);
    
    if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
        const toast = new bootstrap.Toast(toastElement, { delay: duration });
        toast.show();
        toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
    }
}

function getRowData(requestId) {
    const row = document.querySelector(`tr[data-request-id="${requestId}"]`);
    if (!row) return null;
    
    return {
        id: requestId,
        demo: row.getAttribute('data-demo') || 'N/A',
        customer: row.getAttribute('data-customer') || 'N/A',
        date: row.getAttribute('data-date') || 'N/A',
        time: row.getAttribute('data-time') || 'N/A',
        dateIso: row.getAttribute('data-date-iso') || '',
        timeSlotId: row.getAttribute('data-timeslot-id') || '',
        status: row.getAttribute('data-status') || ''
    };
}

// ============================================================================
// ‚úÖ ENHANCED: CONFIRM & ASSIGN MODAL FUNCTIONS
// ============================================================================

function openConfirmModal(requestId) {
    if (!HAS_APPROVE_PERMISSION) {
        showToast('error', 'You do not have permission to confirm demo requests');
        return;
    }

    console.log('üîµ Opening confirm modal for request:', requestId);

    if (!confirmAssignModal) {
        console.error('‚ùå Modal not initialized');
        showToast('error', 'Modal not initialized. Please refresh the page.');
        return;
    }

    currentRequestId = requestId;
    currentRequestData = getRowData(requestId);
    selectedEmployeeId = null;

    if (!currentRequestData) {
        showToast('error', 'Request data not found. Please refresh the page.');
        return;
    }

    // Set modal data
    const modalCustomer = document.getElementById('modalCustomer');
    const modalDemo = document.getElementById('modalDemo');
    const modalDate = document.getElementById('modalDate');
    const modalTime = document.getElementById('modalTime');
    const confirmAdminNotes = document.getElementById('confirmAdminNotes');

    if (!modalCustomer || !modalDemo || !modalDate || !modalTime) {
        console.error('‚ùå Modal elements not found');
        showToast('error', 'Modal elements missing. Please refresh the page.');
        return;
    }

    modalCustomer.textContent = currentRequestData.customer;
    modalDemo.textContent = currentRequestData.demo;
    modalDate.textContent = currentRequestData.date;
    modalTime.textContent = currentRequestData.time;
    
    if (confirmAdminNotes) {
        confirmAdminNotes.value = '';
    }

    // Reset UI
    const employeeLoadingState = document.getElementById('employeeLoadingState');
    const employeeSelectionContainer = document.getElementById('employeeSelectionContainer');
    const noEmployeesMessage = document.getElementById('noEmployeesMessage');
    const selectedEmployeeInfo = document.getElementById('selectedEmployeeInfo');
    const confirmAssignBtn = document.getElementById('confirmAssignBtn');
    const proceedWithoutAssignBtn = document.getElementById('proceedWithoutAssignBtn');

    if (employeeLoadingState) employeeLoadingState.style.display = 'block';
    if (employeeSelectionContainer) employeeSelectionContainer.style.display = 'none';
    if (noEmployeesMessage) noEmployeesMessage.style.display = 'none';
    if (selectedEmployeeInfo) selectedEmployeeInfo.style.display = 'none';
    if (confirmAssignBtn) confirmAssignBtn.disabled = true;
    if (proceedWithoutAssignBtn) proceedWithoutAssignBtn.style.display = 'none';

    // Show modal
    try {
        confirmAssignModal.show();
        console.log('‚úÖ Modal opened successfully');
    } catch (error) {
        console.error('‚ùå Error opening modal:', error);
        showToast('error', 'Failed to open modal: ' + error.message);
        return;
    }

    // Load available employees
    loadAvailableEmployees(currentRequestData.dateIso, currentRequestData.timeSlotId);
}

function loadAvailableEmployees(dateIso, timeSlotId) {
    console.log('üîç Loading employees for:', dateIso, timeSlotId);

    const loadingDiv = document.getElementById('employeeLoadingState');
    const employeeSelect = document.getElementById('employeeSelectionContainer');
    const noEmployeesDiv = document.getElementById('noEmployeesMessage');
    
    if (loadingDiv) loadingDiv.style.display = 'block';
    if (employeeSelect) employeeSelect.style.display = 'none';
    if (noEmployeesDiv) noEmployeesDiv.style.display = 'none';

    // First get available employees for this specific time slot
    fetch(`/api/demo-requests/available-employees/?date=${dateIso}&time_slot_id=${timeSlotId}`)
        .then(response => response.json())
        .then(data => {
            console.log('‚úÖ API Response:', data);

            if (loadingDiv) loadingDiv.style.display = 'none';

            if (data.success && data.employees) {
                
                // Now check slot-specific availability
                return fetch(`/admin/demo-requests/ajax-check-slots/?date=${dateIso}`)
                    .then(r => r.json())
                    .then(slotData => {
                        console.log('üìÖ Slot data:', slotData);
                        
                        // Find current time slot data
                        const currentSlot = slotData.slots?.find(s => s.id == timeSlotId);
                        console.log('üéØ Current slot:', currentSlot);
                        
                        // Add slot-specific booking info to employees
                        const enhancedEmployees = data.employees.map(emp => {
                            // Check if employee has booking in this slot
                            const hasBooking = currentSlot?.booking_details?.some(
                                booking => booking.assigned_employee_id == emp.id
                            );
                            
                            const bookedDemo = hasBooking ? currentSlot.booking_details.find(
                                b => b.assigned_employee_id == emp.id
                            ) : null;
                            
                            return {
                                ...emp,
                                slot_available: !hasBooking,
                                slot_status: hasBooking ? 'booked_in_slot' : 'available_in_slot',
                                booked_demo: bookedDemo
                            };
                        });

                        availableEmployees = enhancedEmployees;
                        
                        console.log('\nüìã Enhanced employees:', enhancedEmployees);
                        
                        if (enhancedEmployees.length > 0) {
                            displayEmployees(enhancedEmployees, dateIso, timeSlotId);
                            
                            if (employeeSelect) employeeSelect.style.display = 'block';
                            
                            const availableCount = enhancedEmployees.filter(e => e.slot_available).length;
                            const busyCount = enhancedEmployees.length - availableCount;
                            
                            const countDiv = document.getElementById('employeeCount');
                            if (countDiv) {
                                countDiv.textContent = `${availableCount} available, ${busyCount} busy in this slot`;
                            }
                        } else {
                            if (noEmployeesDiv) noEmployeesDiv.style.display = 'block';
                            const proceedBtn = document.getElementById('proceedWithoutAssignBtn');
                            if (proceedBtn) proceedBtn.style.display = 'inline-block';
                        }
                        
                        return enhancedEmployees;
                    })
                    .catch(slotError => {
                        console.error('‚ùå Error fetching slot data:', slotError);
                        availableEmployees = data.employees;
                        displayEmployees(data.employees, dateIso, timeSlotId);
                        if (employeeSelect) employeeSelect.style.display = 'block';
                    });
            } else {
                console.log('‚ö†Ô∏è No employees in API response');
                if (noEmployeesDiv) noEmployeesDiv.style.display = 'block';
                const proceedBtn = document.getElementById('proceedWithoutAssignBtn');
                if (proceedBtn) proceedBtn.style.display = 'inline-block';
            }
        })
        .catch(error => {
            console.error('‚ùå Error loading employees:', error);
            if (loadingDiv) loadingDiv.style.display = 'none';
            showToast('error', 'Failed to load employees: ' + error.message);
            if (noEmployeesDiv) noEmployeesDiv.style.display = 'block';
            const proceedBtn = document.getElementById('proceedWithoutAssignBtn');
            if (proceedBtn) proceedBtn.style.display = 'inline-block';
        });
}

// ============================================================================
// FIXED: JavaScript for admin/demo_requests/list.html


function displayEmployees(employees, dateIso, timeSlotId) {
    const container = document.getElementById('employeeList');
    if (!container) {
        console.error('‚ùå Employee list container not found');
        return;
    }
    
    container.innerHTML = '';

    if (employees.length === 0) {
        container.innerHTML = '<p class="text-muted text-center py-3">No employees available</p>';
        return;
    }

    console.log(`\nüìã Displaying ${employees.length} employees with enhanced status`);

    // Employees are already sorted by backend (available first, then by workload)

    employees.forEach((emp, index) => {
        console.log(`\n   ${index + 1}. ${emp.name}`);
        console.log(`      - Status: ${emp.status}`);
        console.log(`      - Available: ${emp.available}`);
        console.log(`      - Total Demos: ${emp.current_demos || 0}`);
        
        let cardClass = '';
        let statusBadge = '';
        let statusClass = '';
        let canSelect = emp.available;
        let availabilityHTML = '';
        let conflictBadge = '';

        // ‚úÖ ENHANCED: Handle all status types properly
        switch(emp.status) {
            case 'CONFLICT':
                // ‚ùå Conflicted at exact same time slot
                cardClass = 'unavailable';
                statusClass = 'status-conflict';
                statusBadge = '<i class="fas fa-times-circle me-1"></i>Booked in This Slot';
                canSelect = false;
                conflictBadge = '<span class="conflict-badge">CONFLICT</span>';
                
                if (emp.slot_conflict) {
                    const booking = emp.slot_conflict;
                    const statusIcon = booking.status === 'confirmed' ? 'check-circle' : 'clock';
                    const statusColor = booking.status === 'confirmed' ? 'success' : 'warning';
                    
                    availabilityHTML = `
                        <div class="alert alert-danger alert-sm mt-2 mb-0 py-2">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                                <div class="flex-grow-1">
                                    <strong class="text-danger">‚ùå Conflict on ${dateIso}</strong>
                                    <hr class="my-2" style="border-color: rgba(220, 53, 69, 0.3);">
                                    <div class="mb-1">
                                        <i class="fas fa-desktop me-1"></i>
                                        <strong>Demo:</strong> ${booking.demo_title}
                                    </div>
                                    <div class="mb-1">
                                        <i class="fas fa-user me-1"></i>
                                        <strong>Customer:</strong> ${booking.customer_name}
                                    </div>
                                    ${booking.customer_email ? `
                                    <div class="mb-1">
                                        <i class="fas fa-envelope me-1"></i>
                                        <small>${booking.customer_email}</small>
                                    </div>
                                    ` : ''}
                                    <div>
                                        <i class="fas fa-${statusIcon} me-1 text-${statusColor}"></i>
                                        <strong>Status:</strong> 
                                        <span class="badge bg-${statusColor} text-white">${booking.status.toUpperCase()}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                break;

            case 'BUSY_OTHER_SLOTS':
                // ‚ö†Ô∏è Busy at OTHER slots on SAME date, but FREE in target slot
                cardClass = 'booked';
                statusClass = 'status-busy';
                statusBadge = `<i class="fas fa-clock me-1"></i>Free in This Slot`;
                canSelect = true;
                
                if (emp.same_date_schedule && emp.same_date_schedule.length > 0) {
                    const schedule = emp.same_date_schedule.map(s => 
                        `<div class="small"><i class="fas fa-clock me-1"></i>${s.time}: ${s.demo} (${s.customer})</div>`
                    ).join('');
                    
                    availabilityHTML = `
                        <div class="alert alert-warning alert-sm mt-2 mb-0 py-2">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-info-circle me-2 mt-1 text-warning"></i>
                                <div class="flex-grow-1">
                                    <strong class="text-warning">‚úÖ Available in This Slot</strong>
                                    <hr class="my-2" style="border-color: rgba(245, 158, 11, 0.3);">
                                    <div class="mb-1">
                                        <strong>Busy at other times on ${dateIso}:</strong>
                                    </div>
                                    <div class="ms-2">
                                        ${schedule}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                break;

            case 'BUSY_OTHER_DATES':
                // ‚ÑπÔ∏è Has demos on OTHER dates, but completely FREE on this date
                cardClass = 'available';
                statusClass = 'status-available';
                statusBadge = '<i class="fas fa-check-circle me-1"></i>Free on This Date';
                canSelect = true;
                
                availabilityHTML = `
                    <div class="alert alert-info alert-sm mt-2 mb-0 py-2">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-calendar-check me-2 mt-1 text-info"></i>
                            <div class="flex-grow-1">
                                <strong class="text-info">‚úÖ Fully Available on ${dateIso}</strong>
                                <hr class="my-2" style="border-color: rgba(59, 130, 246, 0.3);">
                                <div>
                                    <i class="fas fa-tasks me-1"></i>
                                    Has ${emp.current_demos} demo${emp.current_demos > 1 ? 's' : ''} on other dates
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'FULLY_AVAILABLE':
            default:
                // ‚úÖ Completely free - no demos anywhere
                cardClass = 'available';
                statusClass = 'status-available';
                statusBadge = '<i class="fas fa-check-circle me-1"></i>Fully Available';
                canSelect = true;
                
                availabilityHTML = `
                    <div class="alert alert-success alert-sm mt-2 mb-0 py-2">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-calendar-check me-2 mt-1 text-success"></i>
                            <div class="flex-grow-1">
                                <strong class="text-success">‚úÖ Fully Available</strong>
                                <hr class="my-2" style="border-color: rgba(16, 185, 129, 0.3);">
                                <div>
                                    <i class="fas fa-info-circle me-1"></i>
                                    No demos scheduled
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                break;
        }

        const card = document.createElement('div');
        card.className = `employee-card ${cardClass}`;
        card.setAttribute('data-employee-id', emp.id);
        
        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-start position-relative">
                ${!canSelect ? conflictBadge : ''}
                <div class="flex-grow-1">
                    <div class="employee-name">
                        <i class="fas fa-user-circle me-2"></i>${emp.name || 'N/A'}
                    </div>
                    <div class="employee-email">
                        <i class="fas fa-envelope me-1"></i>${emp.email || 'N/A'}
                    </div>
                    ${emp.role ? `<div class="employee-role mt-1"><small class="text-muted"><i class="fas fa-user-tag me-1"></i>${emp.role}</small></div>` : ''}
                    <div class="workload-info mt-2">
                        <i class="fas fa-tasks me-1"></i>
                        <strong>Total Demos:</strong> ${emp.current_demos || 0}
                    </div>
                    ${availabilityHTML}
                </div>
                <div>
                    <span class="employee-status ${statusClass}">
                        ${statusBadge}
                    </span>
                </div>
            </div>
        `;

        if (canSelect) {
            card.onclick = () => selectEmployee(emp.id, emp.name);
            card.style.cursor = 'pointer';
            card.title = 'Click to select this employee';
        } else {
            card.style.cursor = 'not-allowed';
            card.title = '‚õî Cannot assign - Employee already booked at this exact time';
        }

        container.appendChild(card);
    });

    console.log(`‚úÖ Displayed ${employees.length} employee cards with enhanced status\n`);
}
function selectEmployee(employeeId, employeeName) {
    selectedEmployeeId = employeeId;

    console.log('‚úÖ Selected employee:', employeeId, employeeName);

    // Update UI - remove previous selections
    document.querySelectorAll('.employee-card').forEach(card => {
        card.classList.remove('selected');
    });

    // Highlight selected card
    const selectedCard = document.querySelector(`.employee-card[data-employee-id="${employeeId}"]`);
    if (selectedCard) {
        selectedCard.classList.add('selected');
        selectedCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Show selected info
    document.getElementById('selectedEmployeeName').textContent = employeeName;
    document.getElementById('selectedEmployeeInfo').style.display = 'block';
    
    // Enable confirm button
    document.getElementById('confirmAssignBtn').disabled = false;
}

function confirmWithAssignment() {
    if (!selectedEmployeeId) {
        showToast('warning', 'Please select an employee to assign');
        return;
    }

    const adminNotes = document.getElementById('confirmAdminNotes').value.trim();

    const btn = document.getElementById('confirmAssignBtn');
    const originalBtnHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

    console.log('üîÑ Starting confirmation and assignment process...');

    // Step 1: Confirm the demo request
    fetch(`/admin/demo-requests/${currentRequestId}/confirm/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: 'confirm',
            confirmed_date: currentRequestData.dateIso,
            confirmed_time_slot_id: currentRequestData.timeSlotId,
            admin_notes: adminNotes
        })
    })
    .then(response => response.json())
    .then(confirmResult => {
        if (!confirmResult.success) {
            throw new Error(confirmResult.error || 'Failed to confirm demo request');
        }

        console.log('‚úÖ Demo confirmed, now assigning employee...');

        // Step 2: Assign employee
        const formData = new FormData();
        formData.append('employee_id', selectedEmployeeId);
        formData.append('send_notification', 'on');
        if (adminNotes) {
            formData.append('assignment_notes', adminNotes);
        }

        return fetch(`/admin/demo-requests/${currentRequestId}/assign/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });
    })
    .then(response => response.json())
    .then(assignResult => {
        if (assignResult.success) {
            console.log('‚úÖ Employee assigned successfully!');
            showToast('success', 'Demo confirmed and employee assigned successfully! Reloading page...');
            
            confirmAssignModal.hide();
            
            // Reload page after 1.5 seconds
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(assignResult.error || 'Failed to assign employee');
        }
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        showToast('error', error.message);
        btn.disabled = false;
        btn.innerHTML = originalBtnHtml;
    });
}

function confirmWithoutAssignment() {
    const adminNotes = document.getElementById('confirmAdminNotes').value.trim();

    if (!confirm('Are you sure you want to confirm this demo WITHOUT assigning an employee?\n\nYou can assign an employee later from the details page.')) {
        return;
    }

    const btn = document.getElementById('proceedWithoutAssignBtn');
    const originalBtnHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Confirming...';

    console.log('üîÑ Confirming without assignment...');

    fetch(`/admin/demo-requests/${currentRequestId}/confirm/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: 'confirm',
            confirmed_date: currentRequestData.dateIso,
            confirmed_time_slot_id: currentRequestData.timeSlotId,
            admin_notes: adminNotes || 'Confirmed without employee assignment - will assign later'
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            console.log('‚úÖ Demo confirmed without assignment');
            showToast('success', 'Demo confirmed! You can assign an employee later. Reloading...');
            
            confirmAssignModal.hide();
            
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(result.error || 'Failed to confirm demo request');
        }
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        showToast('error', error.message);
        btn.disabled = false;
        btn.innerHTML = originalBtnHtml;
    });
}

// ============================================================================
// CANCEL & DELETE FUNCTIONS
// ============================================================================

function cancelRequest(requestId) {
    if (!HAS_REJECT_PERMISSION) {
        showToast('error', 'You do not have permission to cancel requests');
        return;
    }
    
    const data = getRowData(requestId);
    if (!data) {
        showToast('error', 'Request not found');
        return;
    }
    
    const reason = prompt(`Cancel demo request for ${data.customer}?\n\nPlease provide a reason for cancellation:`);
    
    if (!reason || !reason.trim()) {
        return;
    }
    
    showToast('info', 'Cancelling request...', 2000);
    
    fetch(`/admin/demo-requests/${requestId}/confirm/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: 'cancel',
            cancel_reason: reason.trim()
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('success', 'Request cancelled successfully! Reloading...');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showToast('error', result.error || 'Failed to cancel request');
        }
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        showToast('error', 'An error occurred: ' + error.message);
    });
}

function deleteRequest(requestId) {
    if (!HAS_REJECT_PERMISSION) {
        showToast('error', 'You do not have permission to delete requests');
        return;
    }
    
    const data = getRowData(requestId);
    
    if (!data) {
        showToast('error', 'Request not found');
        return;
    }
    
    if (data.status !== 'cancelled') {
        showToast('warning', 'Only cancelled requests can be deleted permanently');
        return;
    }
    
    if (!confirm(`‚ö†Ô∏è DELETE PERMANENTLY?\n\nCustomer: ${data.customer}\nDemo: ${data.demo}\n\nThis action CANNOT be undone!\n\nAre you sure you want to proceed?`)) {
        return;
    }
    
    showToast('info', 'Deleting request...', 2000);
    
    fetch(`/admin/demo-requests/${requestId}/delete/`, {
        method: 'POST',
        headers: { 
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('success', 'Request deleted permanently! Reloading...');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showToast('error', result.error || 'Failed to delete request');
        }
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        showToast('error', 'An error occurred: ' + error.message);
    });
}

// ============================================================================
// FILTER FUNCTIONS
// ============================================================================

function handleTimeRangeChange(value) {
    const container = document.getElementById('dateRangeContainer');
    if (value === 'custom_range') {
        container.classList.add('show');
    } else {
        container.classList.remove('show');
        if (value) {
            document.getElementById('filtersForm').submit();
        }
    }
}

// ============================================================================
// INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üîµ Initializing demo requests management page...');
    
    // Check Bootstrap
    if (typeof bootstrap === 'undefined') {
        console.error('‚ùå Bootstrap is not loaded!');
        alert('Error: Bootstrap library not loaded. Please refresh the page.');
        return;
    }
    console.log('‚úÖ Bootstrap loaded');
    
    // Initialize confirm & assign modal
    const modalElement = document.getElementById('confirmAssignModal');
    
    if (!modalElement) {
        console.error('‚ùå Confirm modal element not found');
        return;
    }
    
    try {
        confirmAssignModal = new bootstrap.Modal(modalElement, {
            backdrop: 'static',
            keyboard: false
        });
        console.log('‚úÖ Confirm & Assign modal initialized successfully');
    } catch (error) {
        console.error('‚ùå Error initializing modal:', error);
    }
    
    console.log('‚úÖ Page initialization complete');
});
</script>
{% endblock %}