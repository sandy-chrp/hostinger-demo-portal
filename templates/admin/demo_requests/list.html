{% extends 'admin/base.html' %}
{% load permission_tags %}

{% block admin_title %}Demo Requests Management{% endblock %}
{% block page_title %}Demo Requests{% endblock %}

{% block breadcrumb %}
<div class="admin-breadcrumb">
    <div class="d-flex justify-content-between align-items-center">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="{% url 'core:admin_dashboard' %}">
                        <i class="fas fa-home me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item active">Demo Requests</li>
            </ol>
        </nav>
        <div class="d-flex align-items-center gap-2 mb-2">
            {% if user|has_permission:'approve_demo_request' %}
            <a href="{% url 'core:admin_create_demo_request' %}" class="btn btn-primary btn-sm">
                <i class="fas fa-plus me-1"></i>Create Request
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block admin_extra_css %}
<style>
    /* Stats Cards */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .stat-card {
        background: white;
        padding: 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
        text-align: center;
        min-height: 70px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .stat-card.total { border-left: 3px solid #087fc2; }
    .stat-card.pending { border-left: 3px solid #f59e0b; }
    .stat-card.confirmed { border-left: 3px solid #10b981; }
    .stat-card.completed { border-left: 3px solid #6366f1; }
    .stat-card.cancelled { border-left: 3px solid #ef4444; }

    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
    }

    .stat-label {
        color: #6b7280;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    /* Filter Card */
    .filter-card {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .date-range-container {
        display: none;
        margin-top: 0.75rem;
    }
    
    .date-range-container.show {
        display: flex;
    }

    /* Admin Card & Table */
    .admin-card {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .table thead th {
        background: #f3f4f6;
        color: #374151;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        padding: 0.75rem;
        border-bottom: 2px solid #e5e7eb;
    }

    .table tbody td {
        padding: 0.75rem;
        vertical-align: middle;
        border-bottom: 1px solid #f3f4f6;
        font-size: 0.875rem;
        font-weight: normal;
    }

    .table tbody tr:hover {
        background-color: #f9fafb;
    }

    /* Only customer name and demo title bold */
    .customer-name,
    .demo-title {
        font-weight: 600;
    }

    .text-secondary {
        color: #6b7280;
        font-weight: normal;
    }

    /* Badges */
    .badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .badge.bg-warning { background-color: #f59e0b !important; }
    .badge.bg-success { background-color: #10b981 !important; }
    .badge.bg-info { background-color: #3b82f6 !important; }
    .badge.bg-danger { background-color: #ef4444 !important; }

    /* Action Buttons */
    .btn-group {
        display: inline-flex;
        gap: 0.25rem;
    }

    .btn-group .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
        height: 32px;
        padding: 0.375rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        border: 1px solid;
        background: white;
        transition: all 0.2s ease;
    }

    .btn-outline-secondary {
        border-color: #d1d5db;
        color: #6b7280;
    }

    .btn-outline-secondary:hover {
        background: #6b7280;
        color: white;
    }

    .btn-outline-success {
        border-color: #10b981;
        color: #10b981;
    }

    .btn-outline-success:hover {
        background: #10b981;
        color: white;
    }

    .btn-outline-danger {
        border-color: #ef4444;
        color: #ef4444;
    }

    .btn-outline-danger:hover {
        background: #ef4444;
        color: white;
    }

    /* Pagination */
    .pagination .page-link {
        color: #087fc2;
        border: 1px solid #e5e7eb;
        padding: 0.5rem 0.75rem;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #087fc2;
        border-color: #087fc2;
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }

    .toast {
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Modal Enhancements */
    .modal-header {
        background: linear-gradient(135deg, #087fc2 0%, #0a5f8a 100%);
        color: white;
    }

    .modal-header .btn-close {
        filter: brightness(0) invert(1);
    }

    /* Loading Animation */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .loading-pulse {
        animation: pulse 1.5s ease-in-out infinite;
    }

    /* Time Slot Dropdown Styles */
    .time-slot-select option.slot-available {
        background-color: #d1fae5;
        color: #065f46;
    }

    .time-slot-select option.slot-partial {
        background-color: #fef3c7;
        color: #92400e;
    }

    .time-slot-select option.slot-full {
        background-color: #fee2e2;
        color: #991b1b;
    }

    .time-slot-select option:disabled {
        background-color: #f3f4f6;
        color: #9ca3af;
    }

    /* Date Input Enhancement */
    #confirmDate {
        cursor: pointer !important;
        position: relative;
    }

    #confirmDate::-webkit-calendar-picker-indicator {
        cursor: pointer;
        opacity: 0;
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
    }

    .input-group-text {
        background-color: #f8f9fa;
        border-right: 0;
    }

    #confirmDate:focus {
        border-color: #087fc2;
        box-shadow: 0 0 0 0.2rem rgba(8, 127, 194, 0.25);
    }

    .input-group:focus-within .input-group-text {
        border-color: #087fc2;
    }

    /* Slot Details Card */
    .slot-details-card {
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .slot-details-card .card {
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        background: #f9fafb;
    }

    .assigned-employee-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        margin: 0.125rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #bfdbfe;
    }

    .no-assignment {
        color: #9ca3af;
        font-style: italic;
    }

    /* ‚úÖ NEW: Conflict Warning Styles */
    .conflict-warning .alert-danger {
        background-color: #fee2e2;
        border: 1px solid #ef4444;
        border-left: 4px solid #dc2626;
    }

    .conflict-item {
        padding: 0.5rem;
        background: white;
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
        border-left: 3px solid #dc2626;
    }

    .conflict-item:last-child {
        margin-bottom: 0;
    }

    .conflict-employee-name {
        font-weight: 600;
        color: #991b1b;
        font-size: 0.875rem;
    }

    .conflict-detail {
        color: #6b7280;
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }

    .conflict-demo-info {
        background: #fef3c7;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        display: inline-block;
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: #92400e;
    }

    .conflict-customer-info {
        color: #6b7280;
        font-size: 0.75rem;
    }

    /* Employee Dropdown */
    #confirmEmployee option.available {
        background-color: #d1fae5;
        color: #065f46;
    }

    #confirmEmployee option.busy {
        background-color: #fef3c7;
        color: #92400e;
    }

    #confirmEmployee option.conflict {
        background-color: #fee2e2;
        color: #991b1b;
    }

    /* Modal */
    .modal-dialog-centered {
        max-width: 600px;
    }

    .modal-header {
        background: linear-gradient(135deg, #087fc2 0%, #0a5f8a 100%);
        padding: 0.5rem 1rem;
    }

    .info-box {
        background: #f8f9fa;
        border-left: 3px solid #087fc2;
    }

    @media (max-width: 768px) {
        .stats-row {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .table {
            font-size: 0.75rem;
        }

        .btn-group .btn {
            min-width: 28px;
            height: 28px;
        }
    }
</style>
{% endblock %}

{% block admin_content %}
<!-- Statistics Cards -->
<div class="stats-row">
    <div class="stat-card total">
        <div class="stat-number">{{ stats.total_requests }}</div>
        <div class="stat-label">Total</div>
    </div>
    <div class="stat-card pending">
        <div class="stat-number">{{ stats.pending }}</div>
        <div class="stat-label">Pending</div>
    </div>
    <div class="stat-card confirmed">
        <div class="stat-number">{{ stats.confirmed }}</div>
        <div class="stat-label">Confirmed</div>
    </div>
    <div class="stat-card completed">
        <div class="stat-number">{{ stats.completed }}</div>
        <div class="stat-label">Completed</div>
    </div>
    <div class="stat-card cancelled">
        <div class="stat-number">{{ stats.cancelled }}</div>
        <div class="stat-label">Cancelled</div>
    </div>
</div>

<!-- Filters -->
<div class="filter-card">
    <form method="get" class="row g-3" id="filtersForm">
        <div class="col-md-3">
            <input type="text" name="search" class="form-control" 
                   placeholder="Search customer, demo..." value="{{ search|default:'' }}">
        </div>
        
        <div class="col-md-3">
            <select name="status" class="form-select" onchange="this.form.submit()">
                <option value="">All Status</option>
                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>Confirmed</option>
                <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
        </div>
        
        <div class="col-md-3">
            <select name="assigned_to" class="form-select" onchange="this.form.submit()">
                <option value="">All Assigned</option>
                <option value="unassigned" {% if assigned_to_filter == 'unassigned' %}selected{% endif %}>Unassigned</option>
                <option value="me" {% if assigned_to_filter == 'me' %}selected{% endif %}>Assigned to Me</option>
                {% for employee in sales_employees %}
                    <option value="{{ employee.id }}" {% if assigned_to_filter == employee.id|stringformat:"s" %}selected{% endif %}>
                        {{ employee.get_full_name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-3">
            <select name="time_range" class="form-select" id="timeRangeSelect" onchange="handleTimeRangeChange(this.value)">
                <option value="">All Time</option>
                <option value="today" {% if time_range == 'today' %}selected{% endif %}>Today</option>
                <option value="tomorrow" {% if time_range == 'tomorrow' %}selected{% endif %}>Tomorrow</option>
                <option value="this_week" {% if time_range == 'this_week' %}selected{% endif %}>This Week</option>
                <option value="next_week" {% if time_range == 'next_week' %}selected{% endif %}>Next Week</option>
                <option value="this_month" {% if time_range == 'this_month' %}selected{% endif %}>This Month</option>
                <option value="custom_range" {% if time_range == 'custom_range' %}selected{% endif %}>Custom Range</option>
            </select>
            
            <div class="date-range-container row g-2 mt-2 {% if time_range == 'custom_range' %}show{% endif %}" id="dateRangeContainer">
                <div class="col-6">
                    <input type="date" name="date_from" class="form-control" placeholder="From" value="{{ date_from|default:'' }}">
                </div>
                <div class="col-6">
                    <input type="date" name="date_to" class="form-control" placeholder="To" value="{{ date_to|default:'' }}">
                </div>
                <div class="col-12 mt-2">
                    <button type="submit" class="btn btn-sm btn-primary w-100">Apply Date Range</button>
                </div>
            </div>
        </div>
        
        <div class="col-md-12 text-end mt-1">
            <button type="submit" class="btn btn-primary btn-sm me-2">
                <i class="fas fa-search me-1"></i>Search
            </button>
            <a href="{% url 'core:admin_demo_requests' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-times me-1"></i>Clear Filters
            </a>
        </div>
    </form>
</div>

<!-- Demo Requests Table -->
{% if demo_requests %}
    <div class="admin-card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 20%;">Customer</th>
                        <th style="width: 20%;">Demo</th>
                        <th style="width: 20%;">Date & Time</th>
                        <th style="width: 18%;">Assigned To</th>
                        <th style="width: 10%;">Status</th>
                        <th style="width: 12%;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for request in demo_requests %}
                        <tr data-request-id="{{ request.id }}" 
                            data-demo="{{ request.demo.title }}"
                            data-customer="{{ request.user.get_full_name }}"
                            data-date="{{ request.requested_date|date:"D, M d, Y" }}"
                            data-time="{{ request.requested_time_slot.get_display_time }}"
                            data-date-iso="{{ request.requested_date|date:"Y-m-d" }}"
                            data-timeslot-id="{{ request.requested_time_slot.id }}"
                            data-status="{{ request.status }}">
                            
                            <td>
                                <div class="customer-name">{{ request.user.get_full_name }}</div>
                                <div class="small text-secondary">{{ request.user.email }}</div>
                                {% if request.user.mobile %}
                                <div class="small text-secondary mt-1">
                                    <i class="fas fa-phone-alt me-1"></i>{{ request.user.full_mobile }}
                                </div>
                                {% endif %}
                            </td>
                            
                            <td>
                                <div class="demo-title">{{ request.demo.title }}</div>
                                <div class="small text-secondary">{{ request.demo.get_file_type_display }}</div>
                            </td>
                            
                            <td>
                                <div>{{ request.requested_date|date:"D, M d, Y" }}</div>
                                <div class="small text-secondary">{{ request.requested_time_slot.get_display_time }}</div>
                                <div class="small text-secondary mt-1">
                                    <i class="far fa-clock me-1"></i>{{ request.created_at|timesince }} ago
                                </div>
                            </td>
                            
                            <td>
                                {% if request.assigned_to %}
                                <div>
                                    <i class="fas fa-user-check me-1 text-success"></i>{{ request.assigned_to.get_full_name }}
                                </div>
                                <div class="small text-secondary">{{ request.assigned_to.email }}</div>
                                {% else %}
                                <div class="text-secondary">
                                    <i class="fas fa-user-slash me-1"></i>Not assigned
                                </div>
                                {% endif %}
                            </td>
                            
                            <td>
                                {% if request.status == 'pending' %}
                                <span class="badge bg-warning">Pending</span>
                                {% elif request.status == 'confirmed' %}
                                <span class="badge bg-success">Confirmed</span>
                                {% elif request.status == 'completed' %}
                                <span class="badge bg-info">Completed</span>
                                {% elif request.status == 'cancelled' %}
                                <span class="badge bg-danger">Cancelled</span>
                                {% endif %}
                            </td>
                            
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'core:admin_demo_request_detail' request.id %}" 
                                       class="btn btn-sm btn-outline-secondary" 
                                       title="View Full Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    
                                    {% if request.status == 'pending' and user|has_permission:'approve_demo_request' %}
                                    <button type="button" class="btn btn-sm btn-outline-success" 
                                            onclick="openConfirmModal({{ request.id }})" 
                                            title="Confirm & Assign Employee">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    {% endif %}
                                    
                                    {% if request.status not in 'cancelled,completed' and user|has_permission:'approve_demo_request' %}
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="cancelRequest({{ request.id }})" 
                                            title="Cancel Request">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    {% endif %}
                                    
                                    {% if request.status == 'cancelled' and user|has_permission:'reject_demo_request' %}
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="deleteRequest({{ request.id }})" 
                                            title="Delete Permanently">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Pagination -->
    {% if paginator.num_pages > 1 %}
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
            <p class="text-muted mb-0">
                Showing {{ demo_requests.start_index }} to {{ demo_requests.end_index }} of {{ paginator.count }} entries
            </p>
        </div>
        <div>
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    {% if demo_requests.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ demo_requests.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if time_range %}&time_range={{ time_range }}{% endif %}{% if assigned_to_filter %}&assigned_to={{ assigned_to_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">{{ demo_requests.number }} / {{ paginator.num_pages }}</span>
                    </li>
                    
                    {% if demo_requests.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ demo_requests.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if time_range %}&time_range={{ time_range }}{% endif %}{% if assigned_to_filter %}&assigned_to={{ assigned_to_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
{% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        <strong>No demo requests found.</strong>
        {% if search or status_filter or time_range or assigned_to_filter %}
        <p class="mb-0 mt-2">Try adjusting your filters or <a href="{% url 'core:admin_demo_requests' %}">clear all filters</a>.</p>
        {% endif %}
    </div>
{% endif %}

<!-- ‚úÖ UPDATED MODAL with Conflict Details -->
<div class="modal fade" id="confirmAssignModal" tabindex="-1" aria-labelledby="confirmAssignModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 600px;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-2">
                <h6 class="modal-title mb-0" id="confirmAssignModalLabel">
                    <i class="fas fa-check-circle me-2"></i>Confirm Demo & Assign Employee
                </h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body p-3">
                <!-- Customer & Demo Info -->
                <div class="info-box mb-3 p-2 bg-light rounded">
                    <div class="row g-2 small">
                        <div class="col-6">
                            <i class="fas fa-user text-primary me-1"></i>
                            <strong id="modalCustomer"></strong>
                        </div>
                        <div class="col-6">
                            <i class="fas fa-desktop text-primary me-1"></i>
                            <strong id="modalDemo"></strong>
                        </div>
                    </div>
                </div>

                <!-- Date Selection -->
                <div class="mb-3">
                    <label class="form-label small mb-1" for="confirmDate" style="cursor: pointer;">
                        <i class="far fa-calendar me-1"></i>Select Date
                    </label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text" style="cursor: pointer;" onclick="document.getElementById('confirmDate').showPicker()">
                            <i class="far fa-calendar"></i>
                        </span>
                        <input type="date" id="confirmDate" class="form-control" required style="cursor: pointer;">
                    </div>
                    <small class="text-muted">Current: <span id="currentDate"></span></small>
                </div>

                <!-- Time Slot Selection -->
                <div class="mb-3">
                    <label class="form-label small mb-1">
                        <i class="far fa-clock me-1"></i>Select Time Slot
                    </label>
                    <select id="confirmTimeSlot" class="form-select form-select-sm time-slot-select" required>
                        <option value="">Loading slots...</option>
                    </select>
                    <small class="text-muted">Current: <span id="currentTime"></span></small>
                    
                    <!-- ‚úÖ UPDATED: Slot Details Card with Conflict Warning -->
                    <div id="slotDetailsCard" class="slot-details-card mt-2" style="display: none;">
                        <div class="card">
                            <div class="card-body p-2">
                                <h6 class="card-title mb-2 small">
                                    <i class="fas fa-info-circle text-primary"></i>
                                    Slot Details: <span id="slotDetailsTime"></span>
                                </h6>
                                <div id="slotDetailsContent" class="small"></div>
                                
                                <!-- ‚úÖ NEW: Conflict Warning Section -->
                                <div id="conflictWarning" class="conflict-warning mt-2" style="display: none;">
                                    <div class="alert alert-danger py-2 px-2 mb-0">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                                            <div class="flex-grow-1">
                                                <strong class="d-block mb-1">‚ö†Ô∏è Scheduling Conflicts</strong>
                                                <div id="conflictDetails" class="small"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Employee Selection -->
                <div class="mb-3">
                    <label class="form-label small mb-1">
                        <i class="fas fa-user-tie me-1"></i>Assign Employee
                        <span class="badge bg-info ms-1" id="employeeCountBadge">Select slot first</span>
                    </label>
                    <select id="confirmEmployee" class="form-select form-select-sm">
                        <option value="">First select date & time</option>
                    </select>
                    
                    <div class="d-flex gap-2 mt-2 flex-wrap small">
                        <span><span class="badge bg-success">‚óè</span> Available</span>
                        <span><span class="badge bg-warning">‚óè</span> Busy</span>
                        <span><span class="badge bg-danger">‚óè</span> Conflict</span>
                    </div>
                </div>

                <!-- Selected Employee Info -->
                <div id="selectedEmployeeInfo" class="alert alert-success py-2 mb-3" style="display: none;">
                    <small>
                        <i class="fas fa-check-circle me-1"></i>
                        <strong>Selected:</strong> <span id="selectedEmployeeName"></span>
                    </small>
                </div>

                <!-- Loading State -->
                <div id="employeeLoadingState" class="text-center py-2" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <small class="text-muted ms-2">Loading employees...</small>
                </div>

                <!-- Admin Notes -->
                <div class="mb-0">
                    <label class="form-label small mb-1">
                        <i class="far fa-sticky-note me-1"></i>Admin Notes <span class="text-muted">(Optional)</span>
                    </label>
                    <textarea id="confirmAdminNotes" class="form-control form-control-sm" rows="2" 
                              placeholder="Add any notes..."></textarea>
                </div>
            </div>
            
            <div class="modal-footer bg-light py-2">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" id="proceedWithoutAssignBtn" class="btn btn-sm btn-warning" 
                        style="display: none;">
                    <i class="fas fa-forward me-1"></i>Without Employee
                </button>
                <button type="button" id="confirmAssignBtn" class="btn btn-sm btn-success">
                    <i class="fas fa-check-circle me-1"></i>Confirm & Assign
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// ‚úÖ UPDATED SCRIPT with Detailed Conflict Display
// ============================================================================

if (typeof window.demoModalVars === 'undefined') {
    window.demoModalVars = {
        confirmAssignModal: null,
        currentRequestId: null,
        currentRequestData: null,
        selectedEmployeeId: null,
        availableEmployees: [],
        availableSlots: [],
        csrfToken: document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}'
    };
}

const vars = window.demoModalVars;
const HAS_APPROVE_PERMISSION = {{ user|has_permission:'approve_demo_request'|yesno:'true,false' }};
const HAS_REJECT_PERMISSION = {{ user|has_permission:'reject_demo_request'|yesno:'true,false' }};

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function getRowData(requestId) {
    const row = document.querySelector(`tr[data-request-id="${requestId}"]`);
    if (!row) return null;
    
    return {
        id: requestId,
        demo: row.getAttribute('data-demo') || 'N/A',
        customer: row.getAttribute('data-customer') || 'N/A',
        date: row.getAttribute('data-date') || 'N/A',
        time: row.getAttribute('data-time') || 'N/A',
        dateIso: row.getAttribute('data-date-iso') || '',
        timeSlotId: row.getAttribute('data-timeslot-id') || '',
        status: row.getAttribute('data-status') || ''
    };
}

function showToast(type, message, duration = 5000) {
    const container = document.querySelector('.toast-container');
    if (!container) {
        console.log(`[${type.toUpperCase()}] ${message}`);
        return;
    }
    
    const toastId = `toast-${Date.now()}`;
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    
    const bgColors = {
        success: 'bg-success',
        error: 'bg-danger',
        warning: 'bg-warning',
        info: 'bg-info'
    };
    
    const html = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgColors[type]} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas ${icons[type]} me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', html);
    const toastElement = document.getElementById(toastId);
    
    if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
        const toast = new bootstrap.Toast(toastElement, { delay: duration });
        toast.show();
        toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
    }
}

// ============================================================================
// OPEN MODAL
// ============================================================================

function openConfirmModal(requestId) {
    if (!HAS_APPROVE_PERMISSION) {
        showToast('error', 'You do not have permission to confirm requests');
        return;
    }

    console.log('üîµ Opening modal for request:', requestId);

    if (!vars.confirmAssignModal) {
        console.error('‚ùå Modal not initialized');
        showToast('error', 'Modal not initialized');
        return;
    }

    vars.currentRequestId = requestId;
    vars.currentRequestData = getRowData(requestId);
    vars.selectedEmployeeId = null;

    if (!vars.currentRequestData) {
        showToast('error', 'Request data not found');
        return;
    }

    const modalCustomer = document.getElementById('modalCustomer');
    const modalDemo = document.getElementById('modalDemo');
    const currentDate = document.getElementById('currentDate');
    const currentTime = document.getElementById('currentTime');
    const confirmDate = document.getElementById('confirmDate');
    const confirmAdminNotes = document.getElementById('confirmAdminNotes');
    const confirmEmployee = document.getElementById('confirmEmployee');
    const selectedEmployeeInfo = document.getElementById('selectedEmployeeInfo');
    const slotDetailsCard = document.getElementById('slotDetailsCard');
    const conflictWarning = document.getElementById('conflictWarning');
    const confirmAssignBtn = document.getElementById('confirmAssignBtn');

    if (modalCustomer) modalCustomer.textContent = vars.currentRequestData.customer;
    if (modalDemo) modalDemo.textContent = vars.currentRequestData.demo;
    if (currentDate) currentDate.textContent = vars.currentRequestData.date;
    if (currentTime) currentTime.textContent = vars.currentRequestData.time;
    if (confirmDate) confirmDate.value = vars.currentRequestData.dateIso;
    if (confirmAdminNotes) confirmAdminNotes.value = '';
    if (confirmEmployee) confirmEmployee.innerHTML = '<option value="">First select time slot</option>';
    if (selectedEmployeeInfo) selectedEmployeeInfo.style.display = 'none';
    if (slotDetailsCard) slotDetailsCard.style.display = 'none';
    if (conflictWarning) conflictWarning.style.display = 'none';
    if (confirmAssignBtn) confirmAssignBtn.disabled = false;

    vars.confirmAssignModal.show();
    loadTimeSlotsForDate(vars.currentRequestData.dateIso);
}

// ============================================================================
// LOAD TIME SLOTS
// ============================================================================

function loadTimeSlotsForDate(dateIso) {
    console.log('üîç Loading slots for:', dateIso);
    
    const timeSlotSelect = document.getElementById('confirmTimeSlot');
    const employeeSelect = document.getElementById('confirmEmployee');
    
    if (timeSlotSelect) timeSlotSelect.innerHTML = '<option value="">Loading...</option>';
    if (employeeSelect) employeeSelect.innerHTML = '<option value="">First select time slot</option>';
    
    fetch(`/admin/demo-requests/ajax-check-slots/?date=${dateIso}`)
        .then(response => response.json())
        .then(data => {
            console.log('‚úÖ Slots loaded:', data);
            
            if (!data.success || !data.slots || data.slots.length === 0) {
                if (timeSlotSelect) timeSlotSelect.innerHTML = '<option value="">No slots available</option>';
                return;
            }
            
            vars.availableSlots = data.slots;
            
            let optionsHTML = '<option value="">-- Select Time Slot --</option>';
            
            data.slots.forEach(slot => {
                let statusIcon = '';
                let statusClass = '';
                let disabled = '';
                let assignedText = '';
                
                const assignedEmployees = slot.booking_details || [];
                
                if (assignedEmployees.length > 0) {
                    const employeeNames = assignedEmployees
                        .map(b => b.assigned_employee_name || 'Unassigned')
                        .filter(name => name !== 'Not assigned' && name !== 'Unassigned')
                        .join(', ');
                    
                    assignedText = employeeNames ? ` ‚Üí ${employeeNames}` : ' ‚Üí -';
                } else {
                    assignedText = ' ‚Üí -';
                }
                
                const assignedCount = assignedEmployees.filter(
                    b => b.assigned_employee_name && b.assigned_employee_name !== 'Not assigned' && b.assigned_employee_name !== 'Unassigned'
                ).length;
                
                const realAvailableSpots = slot.total_capacity - assignedCount;
                
                if (slot.is_past || slot.is_starting_soon) {
                    statusIcon = '‚è∞';
                    statusClass = 'slot-unavailable';
                    disabled = 'disabled';
                } else if (realAvailableSpots === 0) {
                    statusIcon = 'üî¥';
                    statusClass = 'slot-full';
                    disabled = 'disabled';
                } else if (assignedCount > 0 && realAvailableSpots > 0) {
                    statusIcon = 'üü°';
                    statusClass = 'slot-partial';
                } else {
                    statusIcon = 'üü¢';
                    statusClass = 'slot-available';
                }
                
                const displayAvailableSpots = realAvailableSpots;
                const isCurrentSlot = (slot.id == vars.currentRequestData.timeSlotId);
                const selected = isCurrentSlot ? 'selected' : '';
                
                optionsHTML += `
                    <option value="${slot.id}" ${disabled} ${selected} class="${statusClass}">
                        ${statusIcon} ${slot.start_time} - ${slot.end_time} (${displayAvailableSpots} free)${assignedText}
                    </option>
                `;
            });
            
            if (timeSlotSelect) timeSlotSelect.innerHTML = optionsHTML;
            
            if (timeSlotSelect && timeSlotSelect.value) {
                const slot = vars.availableSlots.find(s => s.id == timeSlotSelect.value);
                if (slot) displaySlotDetails(slot);
                loadAvailableEmployees(dateIso, timeSlotSelect.value);
            }
        })
        .catch(error => {
            console.error('‚ùå Error:', error);
            if (timeSlotSelect) timeSlotSelect.innerHTML = '<option value="">Error loading slots</option>';
            showToast('error', 'Failed to load time slots');
        });
}

// ============================================================================
// ‚úÖ UPDATED: DISPLAY SLOT DETAILS with CONFLICTS
// ============================================================================

function displaySlotDetails(slot) {
    console.log('üìã Displaying slot details with conflicts');
    
    const detailsCard = document.getElementById('slotDetailsCard');
    const detailsTime = document.getElementById('slotDetailsTime');
    const detailsContent = document.getElementById('slotDetailsContent');
    const conflictWarning = document.getElementById('conflictWarning');
    const conflictDetails = document.getElementById('conflictDetails');
    
    if (!detailsCard || !detailsTime || !detailsContent) return;
    
    detailsTime.textContent = `${slot.start_time} - ${slot.end_time}`;
    
    const assignedEmployees = slot.booking_details || [];
    const assignedCount = assignedEmployees.filter(
        b => b.assigned_employee_name && 
        b.assigned_employee_name !== 'Not assigned' && 
        b.assigned_employee_name !== 'Unassigned'
    ).length;
    
    let contentHTML = `
        <div class="mb-2">
            <strong>Capacity:</strong> 
            ${assignedCount} assigned / ${slot.total_capacity} total
            <span class="badge ${assignedCount < slot.total_capacity ? 'bg-success' : 'bg-danger'} ms-1">
                ${slot.total_capacity - assignedCount} free
            </span>
        </div>
    `;
    
    if (assignedEmployees.length > 0) {
        contentHTML += '<div class="mb-2"><strong>Current Bookings:</strong></div>';
        
        // ‚úÖ Group by employee to show conflicts
        const employeeBookings = {};
        
        assignedEmployees.forEach(booking => {
            const empName = booking.assigned_employee_name || 'Unassigned';
            if (empName !== 'Not assigned' && empName !== 'Unassigned') {
                if (!employeeBookings[empName]) {
                    employeeBookings[empName] = [];
                }
                employeeBookings[empName].push(booking);
            }
        });
        
        // Display bookings
        Object.entries(employeeBookings).forEach(([empName, bookings]) => {
            contentHTML += `<div class="assigned-employee-badge"><i class="fas fa-user-check me-1"></i>${empName}</div>`;
        });
        
        contentHTML += '<div class="mt-2"><small class="text-muted">Bookings:</small></div>';
        
        assignedEmployees.forEach(booking => {
            contentHTML += `
                <div class="small text-muted">
                    ‚Ä¢ ${booking.customer_name} - ${booking.demo_title}
                    ${booking.assigned_employee_name && booking.assigned_employee_name !== 'Not assigned' 
                        ? `(${booking.assigned_employee_name})` 
                        : '(Unassigned)'}
                </div>
            `;
        });
        
        // ‚úÖ Show conflicts if multiple bookings for same employee
        let conflictsHTML = '';
        let hasConflicts = false;
        
        Object.entries(employeeBookings).forEach(([empName, bookings]) => {
            if (bookings.length > 1) {
                hasConflicts = true;
                conflictsHTML += `
                    <div class="conflict-item">
                        <div class="conflict-employee-name">
                            <i class="fas fa-user-times me-1"></i>${empName}
                        </div>
                        <div class="conflict-detail">
                            Has ${bookings.length} demos at same time:
                        </div>
                `;
                
                bookings.forEach((booking, idx) => {
                    conflictsHTML += `
                        <div class="conflict-demo-info mt-1">
                            ${idx + 1}. <strong>${booking.demo_title}</strong> 
                            <span class="conflict-customer-info">for ${booking.customer_name}</span>
                        </div>
                    `;
                });
                
                conflictsHTML += `</div>`;
            }
        });
        
        if (hasConflicts && conflictWarning && conflictDetails) {
            conflictDetails.innerHTML = conflictsHTML;
            conflictWarning.style.display = 'block';
        } else if (conflictWarning) {
            conflictWarning.style.display = 'none';
        }
        
    } else {
        contentHTML += '<div class="no-assignment"><i class="fas fa-minus-circle me-1"></i>No employees assigned yet</div>';
        if (conflictWarning) conflictWarning.style.display = 'none';
    }
    
    detailsContent.innerHTML = contentHTML;
    detailsCard.style.display = 'block';
}

// ============================================================================
// LOAD EMPLOYEES
// ============================================================================

function loadAvailableEmployees(dateIso, timeSlotId) {
    console.log('üîç Loading employees');
    
    const employeeSelect = document.getElementById('confirmEmployee');
    const loadingState = document.getElementById('employeeLoadingState');
    const selectedEmployeeInfo = document.getElementById('selectedEmployeeInfo');
    const employeeCountBadge = document.getElementById('employeeCountBadge');
    const proceedWithoutAssignBtn = document.getElementById('proceedWithoutAssignBtn');
    
    if (loadingState) loadingState.style.display = 'block';
    if (employeeSelect) employeeSelect.innerHTML = '<option value="">Loading...</option>';
    if (selectedEmployeeInfo) selectedEmployeeInfo.style.display = 'none';
    
    fetch(`/api/demo-requests/available-employees/?date=${dateIso}&time_slot_id=${timeSlotId}`)
        .then(response => response.json())
        .then(data => {
            console.log('‚úÖ Employees loaded');
            
            if (loadingState) loadingState.style.display = 'none';
            
            if (!data.success || !data.employees || data.employees.length === 0) {
                if (employeeSelect) employeeSelect.innerHTML = '<option value="">No employees available</option>';
                if (employeeCountBadge) employeeCountBadge.textContent = '0 available';
                if (proceedWithoutAssignBtn) proceedWithoutAssignBtn.style.display = 'inline-block';
                return;
            }
            
            vars.availableEmployees = data.employees;
            const availableCount = data.employees.filter(e => e.available).length;
            if (employeeCountBadge) employeeCountBadge.textContent = `${availableCount} available`;
            
            let optionsHTML = '<option value="">-- Select Employee --</option>';
            
            data.employees.forEach(emp => {
                let icon = '';
                let statusText = '';
                let className = '';
                let disabled = '';
                
                switch(emp.status) {
                    case 'CONFLICT':
                        icon = 'üî¥';
                        statusText = ` (Booked)`;
                        className = 'conflict';
                        disabled = 'disabled';
                        break;
                    case 'BUSY_OTHER_SLOTS':
                        icon = 'üü°';
                        statusText = ` (${emp.current_demos} demos, free)`;
                        className = 'busy';
                        break;
                    default:
                        icon = 'üü¢';
                        statusText = ' (Available)';
                        className = 'available';
                        break;
                }
                
                optionsHTML += `
                    <option value="${emp.id}" class="${className}" ${disabled} data-name="${emp.name}">
                        ${icon} ${emp.name}${statusText}
                    </option>
                `;
            });
            
            if (employeeSelect) {
                employeeSelect.innerHTML = optionsHTML;
                
                employeeSelect.onchange = function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const selectedEmployeeInfo = document.getElementById('selectedEmployeeInfo');
                    const selectedEmployeeName = document.getElementById('selectedEmployeeName');
                    
                    if (this.value) {
                        vars.selectedEmployeeId = this.value;
                        const employeeName = selectedOption.getAttribute('data-name');
                        if (selectedEmployeeName) selectedEmployeeName.textContent = employeeName;
                        if (selectedEmployeeInfo) selectedEmployeeInfo.style.display = 'block';
                    } else {
                        vars.selectedEmployeeId = null;
                        if (selectedEmployeeInfo) selectedEmployeeInfo.style.display = 'none';
                    }
                };
            }
            
            if (proceedWithoutAssignBtn) {
                proceedWithoutAssignBtn.style.display = availableCount === 0 ? 'inline-block' : 'none';
            }
        })
        .catch(error => {
            console.error('‚ùå Error:', error);
            if (loadingState) loadingState.style.display = 'none';
            if (employeeSelect) employeeSelect.innerHTML = '<option value="">Error loading</option>';
            showToast('error', 'Failed to load employees');
        });
}

// ============================================================================
// ‚úÖ UPDATED: CONFIRM WITH DETAILED CONFLICT ERROR
// ============================================================================

function confirmWithAssignment() {
    const selectedDate = document.getElementById('confirmDate')?.value;
    const selectedTimeSlotId = document.getElementById('confirmTimeSlot')?.value;
    const adminNotes = document.getElementById('confirmAdminNotes')?.value?.trim();
    
    if (!selectedDate || !selectedTimeSlotId) {
        showToast('warning', 'Please select date and time slot');
        return;
    }
    
    const btn = document.getElementById('confirmAssignBtn');
    if (!btn) return;
    
    const originalBtnHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

    // ‚úÖ STEP 1: Confirm the demo request
    fetch(`/admin/demo-requests/${vars.currentRequestId}/confirm/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': vars.csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: 'confirm',
            confirmed_date: selectedDate,
            confirmed_time_slot_id: selectedTimeSlotId,
            admin_notes: adminNotes
        })
    })
    .then(response => response.json())
    .then(confirmResult => {
        // ‚úÖ Handle confirmation errors (including slot full)
        if (!confirmResult.success) {
            if (confirmResult.conflict_details && confirmResult.conflict_details.length > 0) {
                let detailedMessage = `‚ö†Ô∏è TIME SLOT CONFLICT\n\n`;
                detailedMessage += `Date: ${confirmResult.date}\n`;
                detailedMessage += `Time: ${confirmResult.time}\n\n`;
                detailedMessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                detailedMessage += `Already Scheduled:\n\n`;
                
                confirmResult.conflict_details.forEach((conflict, index) => {
                    detailedMessage += `${index + 1}. ${conflict.demo_title}\n`;
                    detailedMessage += `   Customer: ${conflict.customer_name}\n`;
                    detailedMessage += `   Email: ${conflict.customer_email}\n`;
                    if (conflict.employee_name && conflict.employee_name !== 'Unassigned') {
                        detailedMessage += `   Assigned to: ${conflict.employee_name}\n`;
                    }
                    detailedMessage += `\n`;
                });
                
                detailedMessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                detailedMessage += `\nPlease select a different time slot or date.`;
                
                alert(detailedMessage);
                console.error('‚ö†Ô∏è Conflict Details:', confirmResult.conflict_details);
            } else {
                alert(confirmResult.error || 'Failed to confirm request');
            }
            
            throw new Error(confirmResult.error || 'Failed');
        }

        // ‚úÖ STEP 2: Assign employee if selected
        if (vars.selectedEmployeeId) {
            const formData = new FormData();
            formData.append('employee_id', vars.selectedEmployeeId);
            formData.append('send_notification', 'on');
            if (adminNotes) formData.append('assignment_notes', adminNotes);

            return fetch(`/admin/demo-requests/${vars.currentRequestId}/assign/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': vars.csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            });
        } else {
            return Promise.resolve({ json: () => Promise.resolve({ success: true }) });
        }
    })
    .then(response => response.json ? response.json() : response)
    .then(assignResult => {
        // ‚úÖ Handle assignment errors (employee conflict)
        if (assignResult.success === false) {
            // Check if it's an employee conflict
            if (assignResult.conflict) {
                let conflictMsg = `‚ùå EMPLOYEE SCHEDULING CONFLICT\n\n`;
                conflictMsg += `Employee: Cannot assign this employee\n\n`;
                conflictMsg += `Already Scheduled:\n`;
                conflictMsg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                conflictMsg += `Demo: ${assignResult.conflict.demo_title}\n`;
                conflictMsg += `Customer: ${assignResult.conflict.customer_name}\n`;
                conflictMsg += `Date: ${assignResult.conflict.date}\n`;
                conflictMsg += `Time: ${assignResult.conflict.time}\n`;
                conflictMsg += `Status: ${assignResult.conflict.status}\n`;
                conflictMsg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
                conflictMsg += `Please select a different employee or time slot.`;
                
                alert(conflictMsg);
                console.error('‚ö†Ô∏è Employee Conflict:', assignResult.conflict);
            } else {
                alert(assignResult.error || 'Failed to assign employee');
            }
            
            throw new Error(assignResult.error || 'Failed');
        }
        
        // ‚úÖ Success
        showToast('success', 'Demo confirmed! Reloading...');
        if (vars.confirmAssignModal) vars.confirmAssignModal.hide();
        setTimeout(() => window.location.reload(), 1500);
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        btn.disabled = false;
        btn.innerHTML = originalBtnHtml;
    });
}

function confirmWithoutAssignment() {
    const selectedDate = document.getElementById('confirmDate')?.value;
    const selectedTimeSlotId = document.getElementById('confirmTimeSlot')?.value;
    const adminNotes = document.getElementById('confirmAdminNotes')?.value?.trim();
    
    if (!selectedDate || !selectedTimeSlotId) {
        showToast('warning', 'Please select date and time');
        return;
    }

    if (!confirm('Confirm without employee?')) return;

    const btn = document.getElementById('proceedWithoutAssignBtn');
    if (!btn) return;
    
    const originalBtnHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Confirming...';

    fetch(`/admin/demo-requests/${vars.currentRequestId}/confirm/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': vars.csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: 'confirm',
            confirmed_date: selectedDate,
            confirmed_time_slot_id: selectedTimeSlotId,
            admin_notes: adminNotes || 'Confirmed without assignment'
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('success', 'Confirmed! Reloading...');
            if (vars.confirmAssignModal) vars.confirmAssignModal.hide();
            setTimeout(() => window.location.reload(), 1500);
        } else {
            throw new Error(result.error || 'Failed');
        }
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        showToast('error', error.message);
        btn.disabled = false;
        btn.innerHTML = originalBtnHtml;
    });
}

// ============================================================================
// CANCEL & DELETE FUNCTIONS
// ============================================================================

function cancelRequest(requestId) {
    if (!HAS_REJECT_PERMISSION) {
        showToast('error', 'You do not have permission to cancel requests');
        return;
    }
    
    const data = getRowData(requestId);
    if (!data) {
        showToast('error', 'Request not found');
        return;
    }
    
    const reason = prompt(`Cancel demo request for ${data.customer}?\n\nPlease provide a reason:`);
    
    if (!reason || !reason.trim()) return;
    
    showToast('info', 'Cancelling request...', 2000);
    
    fetch(`/admin/demo-requests/${requestId}/confirm/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': vars.csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: 'cancel',
            cancel_reason: reason.trim()
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('success', 'Request cancelled! Reloading...');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showToast('error', result.error || 'Failed to cancel');
        }
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        showToast('error', 'An error occurred: ' + error.message);
    });
}

function deleteRequest(requestId) {
    if (!HAS_REJECT_PERMISSION) {
        showToast('error', 'You do not have permission to delete requests');
        return;
    }
    
    const data = getRowData(requestId);
    
    if (!data || data.status !== 'cancelled') {
        showToast('warning', 'Only cancelled requests can be deleted');
        return;
    }
    
    if (!confirm(`‚ö†Ô∏è DELETE PERMANENTLY?\n\nCustomer: ${data.customer}\nDemo: ${data.demo}\n\nThis CANNOT be undone!`)) {
        return;
    }
    
    showToast('info', 'Deleting request...', 2000);
    
    fetch(`/admin/demo-requests/${requestId}/delete/`, {
        method: 'POST',
        headers: { 
            'X-CSRFToken': vars.csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('success', 'Request deleted! Reloading...');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showToast('error', result.error || 'Failed to delete');
        }
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        showToast('error', 'An error occurred: ' + error.message);
    });
}

// ============================================================================
// FILTER FUNCTIONS
// ============================================================================

function handleTimeRangeChange(value) {
    const container = document.getElementById('dateRangeContainer');
    if (value === 'custom_range') {
        container.classList.add('show');
    } else {
        container.classList.remove('show');
        if (value) {
            document.getElementById('filtersForm').submit();
        }
    }
}

// ============================================================================
// EVENT LISTENERS
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üîµ Initializing modal...');
    
    if (typeof bootstrap === 'undefined') {
        console.error('‚ùå Bootstrap not loaded');
        return;
    }
    
    const modalElement = document.getElementById('confirmAssignModal');
    if (modalElement && !vars.confirmAssignModal) {
        vars.confirmAssignModal = new bootstrap.Modal(modalElement, {
            backdrop: 'static',
            keyboard: false
        });
        console.log('‚úÖ Modal initialized');
    }
    
    const dateInput = document.getElementById('confirmDate');
    if (dateInput) {
        dateInput.addEventListener('change', function() {
            const selectedDate = this.value;
            if (selectedDate) {
                const slotDetailsCard = document.getElementById('slotDetailsCard');
                const conflictWarning = document.getElementById('conflictWarning');
                if (slotDetailsCard) slotDetailsCard.style.display = 'none';
                if (conflictWarning) conflictWarning.style.display = 'none';
                loadTimeSlotsForDate(selectedDate);
            }
        });
    }
    
    const timeSlotSelect = document.getElementById('confirmTimeSlot');
    if (timeSlotSelect) {
        timeSlotSelect.addEventListener('change', function() {
            const selectedDate = document.getElementById('confirmDate')?.value;
            const selectedSlotId = this.value;
            
            if (selectedDate && selectedSlotId) {
                const slot = vars.availableSlots.find(s => s.id == selectedSlotId);
                if (slot) displaySlotDetails(slot);
                loadAvailableEmployees(selectedDate, selectedSlotId);
            } else {
                const slotDetailsCard = document.getElementById('slotDetailsCard');
                const conflictWarning = document.getElementById('conflictWarning');
                if (slotDetailsCard) slotDetailsCard.style.display = 'none';
                if (conflictWarning) conflictWarning.style.display = 'none';
            }
        });
    }
    
    const confirmAssignBtn = document.getElementById('confirmAssignBtn');
    if (confirmAssignBtn) {
        confirmAssignBtn.addEventListener('click', confirmWithAssignment);
    }
    
    const proceedWithoutAssignBtn = document.getElementById('proceedWithoutAssignBtn');
    if (proceedWithoutAssignBtn) {
        proceedWithoutAssignBtn.addEventListener('click', confirmWithoutAssignment);
    }
});
</script>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

{% endblock %}
