{% extends 'admin/base.html' %}
{% load permission_tags %}

{% block admin_title %}Demo Request #{{ demo_request.id }}{% endblock %}
{% block page_title %}Demo Request #{{ demo_request.id }}{% endblock %}

{% block breadcrumb %}
<div class="admin-breadcrumb">
    <div class="d-flex justify-content-between align-items-center">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="{% url 'core:admin_dashboard' %}">
                        <i class="fas fa-home me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'core:admin_demo_requests' %}">Demo Requests</a>
                </li>
                <li class="breadcrumb-item active">Request #{{ demo_request.id }}</li>
            </ol>
        </nav>
        <div class="d-flex align-items-center gap-2">
            <a href="{% url 'core:admin_demo_requests' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i>Back to List
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_extra_css %}
<style>
    .demo-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
    }
    
    .demo-header h1 {
        font-size: var(--font-2xl);
        font-weight: 600;
        margin-bottom: 0.25rem;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .demo-header .text-secondary {
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .info-card {
        background: white;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        margin-bottom: 1.25rem;
        overflow: hidden;
    }
    
    .info-card-header {
        background-color: #f9fafb;
        padding: 0.875rem 1rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
    }
    
    .info-card-header i, 
    .info-card-header svg {
        margin-right: 0.5rem;
        color: #0d6efd;
        font-size: var(--font-md);
    }
    
    .info-card-header h5,
    .card-title {
        font-size: var(--font-lg);
        font-weight: 600;
        margin-bottom: 0;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .info-card-body {
        padding: 1.25rem;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: 200px 1fr;
        row-gap: 1rem;
    }
    
    .info-label {
        font-weight: 600;
        color: #374151;
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .info-value {
        color: #1f2937;
        font-size: var(--font-sm);
        font-weight: 400;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .info-value a {
        color: #0d6efd;
        text-decoration: none;
        font-size: var(--font-sm);
    }
    
    .info-value a:hover {
        text-decoration: underline;
    }
    
    .badge {
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: var(--font-xs);
        font-weight: 600;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .badge.bg-warning { background-color: #f59e0b !important; }
    .badge.bg-success { background-color: #10b981 !important; }
    .badge.bg-info { background-color: #0ea5e9 !important; }
    .badge.bg-danger { background-color: #ef4444 !important; }
    .badge.bg-secondary { background-color: #6b7280 !important; }
    
    .status-badge-lg {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .assign-card {
        background-color: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.2);
        border-radius: 8px;
        padding: 1.25rem;
        margin-top: 1rem;
    }
    
    .unassign-card {
        background-color: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        border-radius: 8px;
        padding: 1.25rem;
        margin-top: 1rem;
    }
    
    .reassign-card {
        background-color: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.2);
        border-radius: 8px;
        padding: 1.25rem;
        margin-top: 1rem;
    }
    
    .assign-card h5,
    .reassign-card h5 {
        font-size: var(--font-lg);
        font-weight: 600;
        margin-bottom: 0.75rem;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }

    .employee-card {
        background-color: #f0f9ff;
        border: 1px solid #e0f2fe;
        border-radius: 8px;
        padding: 1.25rem;
        margin-top: 1rem;
        display: flex;
        align-items: center;
    }
    
    .employee-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background-color: #0ea5e9;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-2xl);
        margin-right: 1rem;
    }
    
    .employee-info {
        flex-grow: 1;
    }
    
    .employee-info h5 {
        font-size: var(--font-lg);
        font-weight: 600;
        margin-bottom: 0.25rem;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .employee-info p {
        font-size: var(--font-sm);
        margin-bottom: 0.25rem;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .employee-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .status-timeline {
        position: relative;
        margin-top: 1.5rem;
    }
    
    .timeline-item {
        display: flex;
        margin-bottom: 1.25rem;
    }
    
    .timeline-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #0ea5e9;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        position: relative;
        z-index: 2;
        font-size: var(--font-sm);
    }
    
    .timeline-icon.bg-warning { background-color: #f59e0b; }
    .timeline-icon.bg-success { background-color: #10b981; }
    .timeline-icon.bg-danger { background-color: #ef4444; }
    
    .timeline-content {
        flex-grow: 1;
    }
    
    .timeline-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .timeline-date {
        font-size: var(--font-xs);
        color: #6b7280;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .timeline-line {
        position: absolute;
        left: 16px;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: #e5e7eb;
        z-index: 1;
    }

    .form-label {
        font-size: var(--font-sm);
        font-weight: 500;
        margin-bottom: 0.375rem;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .form-control, .form-select {
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #087fc2;
        box-shadow: 0 0 0 3px rgba(8, 127, 194, 0.1);
    }
    
    .form-check-label {
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    textarea.form-control {
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }

    .btn {
        font-size: var(--font-sm);
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: var(--font-xs);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }

    .card {
        border-radius: 8px;
    }
    
    .card-body h3 {
        font-size: var(--font-4xl);
        font-weight: 700;
        margin-bottom: 0.25rem;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .card-body .small {
        font-size: var(--font-xs);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .card.bg-light {
        padding: 0.75rem;
    }

    .modal-title {
        font-size: var(--font-lg);
        font-weight: 600;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .modal-body {
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
        padding: 1.25rem;
    }
    
    .modal-header {
        padding: 1rem 1.25rem;
    }
    
    .modal-footer {
        padding: 0.875rem 1.25rem;
    }

    .alert {
        font-size: var(--font-sm);
        padding: 0.75rem;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }

    .text-muted,
    .text-secondary {
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }

    h6 {
        font-size: var(--font-md);
        font-weight: 600;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }

    #assignmentSection {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    @media (max-width: 768px) {
        .info-grid {
            grid-template-columns: 1fr;
            row-gap: 0.75rem;
        }
        
        .info-label {
            margin-bottom: 0.25rem;
        }
        
        .demo-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .demo-header h1 {
            font-size: var(--font-xl);
        }
        
        .status-badge-lg {
            padding: 0.375rem 0.75rem;
            font-size: var(--font-xs);
        }
        
        .info-card-body {
            padding: 1rem;
        }
        
        .info-card-header {
            padding: 0.75rem 1rem;
        }
        
        .employee-card {
            flex-direction: column;
            text-align: center;
            padding: 1rem;
        }
        
        .employee-avatar {
            width: 48px;
            height: 48px;
            margin-right: 0;
            margin-bottom: 0.75rem;
        }
        
        .employee-actions {
            margin-top: 0.75rem;
            width: 100%;
            flex-direction: column;
        }
        
        .timeline-item {
            margin-bottom: 1rem;
        }
        
        .card-body h3 {
            font-size: var(--font-3xl);
        }
    }
</style>
{% endblock %}

{% block admin_content %}

{# ✅ SUCCESS/ERROR MESSAGES SECTION - ADDED #}
{% if messages %}
<div class="container-fluid mb-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Demo Request Header -->
<div class="demo-header">
    <div>
        <h1 class="h3 mb-1">Demo Request #{{ demo_request.id }}</h1>
        <p class="text-secondary mb-0">
            <i class="far fa-calendar-alt me-1"></i>Submitted {{ demo_request.created_at|date:"M d, Y" }} at {{ demo_request.created_at|date:"h:i A" }}
        </p>
    </div>
    <div>
        {% if demo_request.status == 'pending' %}
        <span class="status-badge-lg bg-warning text-white">
            <i class="fas fa-clock me-1"></i>Pending
        </span>
        {% elif demo_request.status == 'confirmed' %}
        <span class="status-badge-lg bg-success text-white">
            <i class="fas fa-check-circle me-1"></i>Confirmed
        </span>
        {% elif demo_request.status == 'completed' %}
        <span class="status-badge-lg bg-info text-white">
            <i class="fas fa-flag-checkered me-1"></i>Completed
        </span>
        {% elif demo_request.status == 'cancelled' %}
        <span class="status-badge-lg bg-danger text-white">
            <i class="fas fa-times-circle me-1"></i>Cancelled
        </span>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Customer Information -->
        <div class="info-card">
            <div class="info-card-header">
                <i class="fas fa-user"></i>
                <h5 class="card-title mb-0">Customer Information</h5>
            </div>
            <div class="info-card-body">
                <div class="info-grid">
                    <div class="info-label">Full Name:</div>
                    <div class="info-value">
                        <a href="{% url 'core:admin_customer_detail' demo_request.user.id %}">{{ demo_request.user.get_full_name }}</a>
                    </div>
                    
                    <div class="info-label">Email:</div>
                    <div class="info-value">
                        <a href="mailto:{{ demo_request.user.email }}">{{ demo_request.user.email }}</a>
                    </div>
                    
                    <div class="info-label">Phone:</div>
                    <div class="info-value">
                        {% if demo_request.user.mobile %}
                            <a href="tel:{{ demo_request.user.full_mobile }}">{{ demo_request.user.full_mobile }}</a>
                        {% else %}
                            <span class="text-muted">Not provided</span>
                        {% endif %}
                    </div>
                    
                    <div class="info-label">Company:</div>
                    <div class="info-value">
                        {% if demo_request.user.organization %}
                            {{ demo_request.user.organization }}
                        {% else %}
                            <span class="text-muted">Not provided</span>
                        {% endif %}
                    </div>
                    
                    <div class="info-label">Job Title:</div>
                    <div class="info-value">
                        {% if demo_request.user.job_title %}
                            {{ demo_request.user.job_title }}
                        {% else %}
                            <span class="text-muted">Not provided</span>
                        {% endif %}
                    </div>
                    
                    <div class="info-label">Business Category:</div>
                    <div class="info-value">
                        {% if demo_request.business_category %}
                            {{ demo_request.business_category.name }}
                            
                            {% if demo_request.business_subcategory %}
                                <span class="text-secondary">
                                    <i class="fas fa-angle-right mx-1"></i>{{ demo_request.business_subcategory.name }}
                                </span>
                            {% endif %}
                        {% elif demo_request.user.business_category %}
                            {{ demo_request.user.business_category.name }}
                            
                            {% if demo_request.user.business_subcategory %}
                                <span class="text-secondary">
                                    <i class="fas fa-angle-right mx-1"></i>{{ demo_request.user.business_subcategory.name }}
                                </span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Not specified</span>
                        {% endif %}
                    </div>
                    
                    <div class="info-label">Account Status:</div>
                    <div class="info-value">
                        {% if demo_request.user.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-danger">Inactive</span>
                        {% endif %}
                        
                        {% if demo_request.user.is_approved %}
                            <span class="badge bg-success">Approved</span>
                        {% else %}
                            <span class="badge bg-warning">Not Approved</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Demo Information -->
        <div class="info-card">
            <div class="info-card-header">
                <i class="fas fa-desktop"></i>
                <h5 class="card-title mb-0">Demo Information</h5>
            </div>
            <div class="info-card-body">
                <div class="info-grid">
                    <div class="info-label">Demo Title:</div>
                    <div class="info-value">
                        <a href="{% url 'core:admin_demo_detail' demo_request.demo.id %}">{{ demo_request.demo.title }}</a>
                        
                        {% if demo_request.demo.is_featured %}
                            <span class="badge bg-info ms-2">Featured</span>
                        {% endif %}
                    </div>
                    
                    <div class="info-label">Demo Type:</div>
                    <div class="info-value">
                        {{ demo_request.demo.get_file_type_display }}
                        <span class="text-secondary">({{ demo_request.demo.get_demo_type_display }})</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Schedule Information - ✅ FIXED TIME SLOT DISPLAY -->
        <div class="info-card">
            <div class="info-card-header">
                <i class="far fa-calendar-alt"></i>
                <h5 class="card-title mb-0">Schedule</h5>
            </div>
            <div class="info-card-body">
                <div class="info-grid">
                    <div class="info-label">Requested Date:</div>
                    <div class="info-value">
                        <i class="far fa-calendar text-primary me-1"></i>{{ demo_request.requested_date|date:"l, F d, Y" }}
                    </div>
                    
                    <div class="info-label">Time Slot:</div>
                    <div class="info-value">
                        <i class="far fa-clock text-primary me-1"></i>
                        {# ✅ FIXED: Proper time slot display with null check #}
                        {% if demo_request.requested_time_slot %}
                            {{ demo_request.requested_time_slot.get_display_time }}
                        {% else %}
                            <span class="text-muted">Not specified</span>
                        {% endif %}
                    </div>
                    
                    {% if demo_request.status == 'confirmed' and demo_request.confirmed_date %}
                    <div class="info-label">Confirmed Date:</div>
                    <div class="info-value">
                        <i class="fas fa-calendar-check text-success me-1"></i>{{ demo_request.confirmed_date|date:"l, F d, Y" }}
                        {% if demo_request.confirmed_date != demo_request.requested_date %}
                            <span class="badge bg-info">Rescheduled</span>
                        {% endif %}
                    </div>
                    
                    <div class="info-label">Confirmed Time:</div>
                    <div class="info-value">
                        <i class="fas fa-check-circle text-success me-1"></i>
                        {# ✅ FIXED: Proper confirmed time slot display with null check #}
                        {% if demo_request.confirmed_time_slot %}
                            {{ demo_request.confirmed_time_slot.get_display_time }}
                        {% elif demo_request.requested_time_slot %}
                            {{ demo_request.requested_time_slot.get_display_time }}
                        {% else %}
                            <span class="text-muted">Not specified</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="info-label">Customer Notes:</div>
                    <div class="info-value">
                        {% if demo_request.notes %}
                            {{ demo_request.notes }}
                        {% else %}
                            <span class="text-muted">No notes provided</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Assignment Information -->
        <div class="info-card" id="assignmentSection">
            <div class="info-card-header">
                <i class="fas fa-user-check"></i>
                <h5 class="card-title mb-0">Assignment</h5>
                <span class="badge bg-{% if demo_request.assigned_to %}success{% else %}secondary{% endif %} ms-2">
                    {% if demo_request.assigned_to %}Assigned{% else %}Unassigned{% endif %}
                </span>
            </div>
            <div class="info-card-body">
                {% if demo_request.assigned_to %}
                    <div class="employee-card">
                        <div class="employee-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="employee-info">
                            <h5 class="mb-0">{{ demo_request.assigned_to.get_full_name }}</h5>
                            <p class="mb-1">
                                <a href="mailto:{{ demo_request.assigned_to.email }}">{{ demo_request.assigned_to.email }}</a>
                            </p>
                            <p class="text-secondary mb-0">
                                <i class="far fa-clock me-1"></i>Assigned {{ demo_request.assigned_at|date:"M d, Y" }} at {{ demo_request.assigned_at|date:"h:i A" }}
                                {% if demo_request.assigned_by %}
                                by {{ demo_request.assigned_by.get_full_name }}
                                {% endif %}
                            </p>
                        </div>
                        <div class="employee-actions">
                            {% if user|has_permission:'manage_demo_requests' and demo_request.status != 'completed' and demo_request.status != 'cancelled' %}
                            <button type="button" class="btn btn-warning" onclick="showReassignForm()">
                                <i class="fas fa-sync-alt me-1"></i>Reassign
                            </button>
                            <button type="button" class="btn btn-danger" onclick="confirmUnassign({{ demo_request.id }})">
                                <i class="fas fa-user-minus me-1"></i>Unassign
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="reassign-card" id="reassignForm" style="display: none;">
                        <h5 class="card-title">Reassign Demo Request</h5>
                        <form id="reassignDemoForm">
                            {% csrf_token %}
                            
                            <div class="mb-3">
                                <label for="employeeSelect" class="form-label">Select Employee</label>
                                <div id="loadingEmployees" class="text-center py-2" style="display: none;">
                                    <div class="spinner-border spinner-border-sm" role="status"></div>
                                    <span class="ms-2">Loading available employees...</span>
                                </div>
                                <select id="employeeSelect" name="employee_id" class="form-select" required>
                                    <option value="">-- Select Employee --</option>
                                </select>
                            </div>
                            
                            <div id="availabilityStatus" class="mb-3" style="display: none;"></div>
                            
                            <div class="mb-3">
                                <label for="assignmentNotes" class="form-label">Assignment Notes (Optional)</label>
                                <textarea id="assignmentNotes" name="assignment_notes" class="form-control" rows="3" 
                                        placeholder="Any notes about this assignment"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sendNotificationCheck" name="send_notification" checked>
                                    <label class="form-check-label" for="sendNotificationCheck">
                                        Send email notification to employee
                                    </label>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" onclick="handleReassign({{ demo_request.id }})">
                                    <i class="fas fa-user-plus me-1"></i>Reassign
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="hideReassignForm()">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                {% else %}
                    <p class="mb-3">This demo request is currently unassigned.</p>
                    
                    {% if user|has_permission:'manage_demo_requests' and demo_request.status != 'completed' and demo_request.status != 'cancelled' %}
                        <div class="assign-card">
                            <h5 class="card-title">Assign Demo Request</h5>
                            <form id="assignDemoForm">
                                {% csrf_token %}
                                
                                <div class="mb-3">
                                    <label for="employeeSelect" class="form-label">Select Employee</label>
                                    <div id="loadingEmployees" class="text-center py-2">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <span class="ms-2">Loading available employees...</span>
                                    </div>
                                    <select id="employeeSelect" name="employee_id" class="form-select" required disabled>
                                        <option value="">-- Select Employee --</option>
                                    </select>
                                </div>
                                
                                <div id="availabilityStatus" class="mb-3" style="display:none"></div>
                                
                                <div class="mb-3">
                                    <label for="assignmentNotes" class="form-label">Assignment Notes (Optional)</label>
                                    <textarea id="assignmentNotes" name="assignment_notes" class="form-control" rows="3" 
                                            placeholder="Any notes about this assignment"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sendNotificationCheck" name="send_notification" checked>
                                        <label class="form-check-label" for="sendNotificationCheck">
                                            Send email notification to employee
                                        </label>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-primary" onclick="handleAssign({{ demo_request.id }})">
                                    <i class="fas fa-user-plus me-1"></i>Assign
                                </button>
                            </form>
                        </div>
                    {% endif %}
                {% endif %}
                
                {% if demo_request.assigned_to %}
                <div class="mt-4">
                    <h6 class="mb-3">
                        <i class="fas fa-tasks me-1"></i>{{ demo_request.assigned_to.get_full_name }}'s Workload
                    </h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card text-center bg-light mb-3">
                                <div class="card-body">
                                    <h3 class="text-warning">{{ workload_stats.pending }}</h3>
                                    <div class="small text-secondary">Pending</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center bg-light mb-3">
                                <div class="card-body">
                                    <h3 class="text-success">{{ workload_stats.confirmed }}</h3>
                                    <div class="small text-secondary">Confirmed</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center bg-light mb-3">
                                <div class="card-body">
                                    <h3 class="text-info">{{ workload_stats.completed }}</h3>
                                    <div class="small text-secondary">Completed</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Admin Notes -->
        <div class="info-card">
            <div class="info-card-header">
                <i class="fas fa-sticky-note"></i>
                <h5 class="card-title mb-0">Admin Notes</h5>
            </div>
            <div class="info-card-body">
                <form id="adminNotesForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <textarea class="form-control" rows="4" id="adminNotes" name="admin_notes">{{ demo_request.admin_notes }}</textarea>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-primary" onclick="saveAdminNotes({{ demo_request.id }})">
                            <i class="fas fa-save me-1"></i>Save Notes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="info-card">
            <div class="info-card-header">
                <i class="fas fa-bolt"></i>
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="info-card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'core:admin_demo_requests' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to List
                    </a>
                    
                    {% if demo_request.status == 'pending' %}
                        {% if user|has_permission:'approve_demo_request' %}
                        <button type="button" class="btn btn-success" onclick="confirmDemoRequest({{ demo_request.id }})">
                            <i class="fas fa-check-circle me-1"></i>Confirm Demo
                        </button>
                        {% endif %}
                        
                        <button type="button" class="btn btn-warning" onclick="showRescheduleModal({{ demo_request.id }})">
                            <i class="fas fa-calendar-alt me-1"></i>Reschedule
                        </button>
                        
                        {% if user|has_permission:'reject_demo_request' %}
                        <button type="button" class="btn btn-danger" onclick="showCancelModal({{ demo_request.id }})">
                            <i class="fas fa-times-circle me-1"></i>Cancel Request
                        </button>
                        {% endif %}
                    {% elif demo_request.status == 'confirmed' %}
                        <button type="button" class="btn btn-info" onclick="markCompleted({{ demo_request.id }})">
                            <i class="fas fa-flag-checkered me-1"></i>Mark as Completed
                        </button>
                        
                        <button type="button" class="btn btn-warning" onclick="showRescheduleModal({{ demo_request.id }})">
                            <i class="fas fa-calendar-alt me-1"></i>Reschedule
                        </button>
                        
                        {% if user|has_permission:'reject_demo_request' %}
                        <button type="button" class="btn btn-danger" onclick="showCancelModal({{ demo_request.id }})">
                            <i class="fas fa-times-circle me-1"></i>Cancel Request
                        </button>
                        {% endif %}
                    {% elif demo_request.status == 'cancelled' %}
                        {% if user|has_permission:'approve_demo_request' %}
                        <button type="button" class="btn btn-success" onclick="reactivateRequest({{ demo_request.id }})">
                            <i class="fas fa-redo me-1"></i>Reactivate Request
                        </button>
                        {% endif %}
                    {% endif %}
                    
                    {% if user|has_permission:'reject_demo_request' %}
                    <button type="button" class="btn btn-outline-danger" onclick="confirmDelete({{ demo_request.id }})">
                        <i class="fas fa-trash me-1"></i>Delete Request
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Activity Timeline -->
        <div class="info-card">
            <div class="info-card-header">
                <i class="fas fa-history"></i>
                <h5 class="card-title mb-0">Activity Timeline</h5>
            </div>
            <div class="info-card-body">
                <div class="status-timeline">
                    <div class="timeline-line"></div>
                    
                    <div class="timeline-item">
                        <div class="timeline-icon bg-info">
                            <i class="fas fa-plus"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">Request Submitted</div>
                            <div class="timeline-date">{{ demo_request.created_at|date:"M d, Y h:i A" }}</div>
                        </div>
                    </div>
                    
                    {% if demo_request.assigned_to %}
                    <div class="timeline-item">
                        <div class="timeline-icon bg-primary">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">
                                Assigned to {{ demo_request.assigned_to.get_full_name }}
                            </div>
                            <div class="timeline-date">
                                {{ demo_request.assigned_at|date:"M d, Y h:i A" }}
                                {% if demo_request.assigned_by %}
                                by {{ demo_request.assigned_by.get_full_name }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if demo_request.status == 'confirmed' %}
                    <div class="timeline-item">
                        <div class="timeline-icon bg-success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">Request Confirmed</div>
                            <div class="timeline-date">{{ demo_request.updated_at|date:"M d, Y h:i A" }}</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if demo_request.status == 'completed' %}
                    <div class="timeline-item">
                        <div class="timeline-icon bg-info">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">Demo Completed</div>
                            <div class="timeline-date">{{ demo_request.updated_at|date:"M d, Y h:i A" }}</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if demo_request.status == 'cancelled' %}
                    <div class="timeline-item">
                        <div class="timeline-icon bg-danger">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">Request Cancelled</div>
                            <div class="timeline-date">
                                {% if demo_request.cancelled_at %}
                                    {{ demo_request.cancelled_at|date:"M d, Y h:i A" }}
                                {% else %}
                                    {{ demo_request.updated_at|date:"M d, Y h:i A" }}
                                {% endif %}
                            </div>
                            
                            {% if demo_request.cancellation_reason %}
                            <div class="mt-2">
                                <strong>Reason:</strong> {{ demo_request.get_cancellation_reason_display }}
                                {% if demo_request.cancellation_details %}
                                <div>{{ demo_request.cancellation_details }}</div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reschedule Modal - ✅ UPDATED WITH VALIDATION -->
<div class="modal fade" id="rescheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-alt me-2"></i>Reschedule Demo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="rescheduleForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="rescheduleDate" class="form-label">Select New Date</label>
                        <input type="date" id="rescheduleDate" name="reschedule_date" class="form-control" required 
                               min="{{ current_date|date:'Y-m-d' }}">
                        <small class="text-muted">Sundays are not available for demos</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="rescheduleTimeSlot" class="form-label">Select New Time Slot</label>
                        <div id="loadingTimeSlots" class="text-center py-2" style="display: none;">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span class="ms-2">Loading available time slots...</span>
                        </div>
                        <select id="rescheduleTimeSlot" name="reschedule_time_slot" class="form-select" required disabled>
                            <option value="">-- Select Time Slot --</option>
                        </select>
                        <small class="text-muted">Only available slots are shown</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="rescheduleReason" class="form-label">Reason for Rescheduling</label>
                        <textarea id="rescheduleReason" name="reschedule_reason" class="form-control" rows="3" 
                                  placeholder="Provide a reason for rescheduling" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notifyCustomerCheck" name="notify_customer" checked>
                            <label class="form-check-label" for="notifyCustomerCheck">
                                Send notification to customer
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="handleReschedule({{ demo_request.id }})">
                    <i class="fas fa-calendar-check me-1"></i>Reschedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-times-circle me-2"></i>Cancel Demo Request
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="cancelForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="cancelReason" class="form-label">Cancellation Reason</label>
                        <select id="cancelReason" name="cancel_reason" class="form-select" required>
                            <option value="">-- Select Reason --</option>
                            <option value="customer_request">Customer Request</option>
                            <option value="scheduling_conflict">Scheduling Conflict</option>
                            <option value="no_longer_needed">No Longer Needed</option>
                            <option value="duplicate">Duplicate Request</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="cancelDetails" class="form-label">Additional Details</label>
                        <textarea id="cancelDetails" name="cancel_details" class="form-control" rows="3" 
                                  placeholder="Provide additional details about cancellation"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notifyCancelCheck" name="notify_cancel" checked>
                            <label class="form-check-label" for="notifyCancelCheck">
                                Send cancellation notice to customer
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Go Back</button>
                <button type="button" class="btn btn-danger" onclick="handleCancel({{ demo_request.id }})">
                    <i class="fas fa-times-circle me-1"></i>Cancel Request
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_extra_js %}
<script>
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

let rescheduleModal;
let cancelModal;

// ✅ HELPER FUNCTION - Show Success/Error Messages
function showMessage(message, type = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    const container = document.querySelector('.container-fluid') || document.querySelector('main');
    if (container.firstChild) {
        container.insertBefore(alertDiv, container.firstChild);
    } else {
        container.appendChild(alertDiv);
    }
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

document.addEventListener('DOMContentLoaded', function() {
    rescheduleModal = new bootstrap.Modal(document.getElementById('rescheduleModal'));
    cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));
    
    if (document.getElementById('assignDemoForm')) {
        loadAvailableEmployees();
    }
    
    const assignmentSection = document.getElementById('assignmentSection');
    if (assignmentSection) {
        assignmentSection.style.display = 'block';
        assignmentSection.style.opacity = '1';
        assignmentSection.style.visibility = 'visible';
    }
});

function loadAvailableEmployees() {
    const loadingDiv = document.getElementById('loadingEmployees');
    const employeeSelect = document.getElementById('employeeSelect');
    
    if (!loadingDiv || !employeeSelect) return;
    
    loadingDiv.style.display = 'block';
    employeeSelect.disabled = true;
    
    const date = "{{ demo_request.requested_date|date:'Y-m-d' }}";
    const timeSlotId = "{{ demo_request.requested_time_slot.id }}";
    
    fetch(`/api/demo-requests/available-employees/?date=${date}&time_slot_id=${timeSlotId}`)
        .then(r => r.json())
        .then(data => {
            loadingDiv.style.display = 'none';
            employeeSelect.innerHTML = '<option value="">-- Select Employee --</option>';
            
            if (data.success && data.employees && data.employees.length > 0) {
                data.employees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.name} (${emp.current_demos} demos)`;
                    employeeSelect.appendChild(option);
                });
                employeeSelect.disabled = false;
            } else {
                employeeSelect.innerHTML = '<option>No employees available</option>';
                employeeSelect.disabled = true;
            }
        })
        .catch(error => {
            loadingDiv.style.display = 'none';
            showMessage('Error loading employees: ' + error.message, 'error');
        });
}

function checkEmployeeAvailability(employeeId) {
    const statusDiv = document.getElementById('availabilityStatus');
    if (!statusDiv) return;
    
    statusDiv.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> Checking...</div>';
    statusDiv.style.display = 'block';
    
    const date = "{{ demo_request.requested_date|date:'Y-m-d' }}";
    const timeSlotId = "{{ demo_request.requested_time_slot.id }}";
    const requestId = "{{ demo_request.id }}";
    
    fetch(`/api/demo-requests/check-availability/?employee_id=${employeeId}&date=${date}&time_slot_id=${timeSlotId}&demo_request_id=${requestId}`)
        .then(r => r.json())
        .then(data => {
            const assignBtn = document.querySelector('#assignDemoForm button[type="button"]');
            const reassignBtn = document.querySelector('#reassignDemoForm button[type="button"]');
            
            if (data.available) {
                statusDiv.innerHTML = `<div class="alert alert-success mb-0">✓ Available</div>`;
                if (assignBtn) assignBtn.disabled = false;
                if (reassignBtn) reassignBtn.disabled = false;
            } else {
                statusDiv.innerHTML = `<div class="alert alert-danger mb-0">✗ Conflict: ${data.message}</div>`;
                if (assignBtn) assignBtn.disabled = true;
                if (reassignBtn) reassignBtn.disabled = true;
            }
        });
}

function showReassignForm() {
    document.getElementById('reassignForm').style.display = 'block';
    
    const loadingDiv = document.getElementById('loadingEmployees');
    const employeeSelect = document.getElementById('employeeSelect');
    
    loadingDiv.style.display = 'block';
    employeeSelect.disabled = true;
    
    const date = "{{ demo_request.requested_date|date:'Y-m-d' }}";
    const timeSlotId = "{{ demo_request.requested_time_slot.id }}";
    
    fetch(`/api/demo-requests/available-employees/?date=${date}&time_slot_id=${timeSlotId}`)
        .then(r => r.json())
        .then(data => {
            loadingDiv.style.display = 'none';
            employeeSelect.innerHTML = '<option value="">-- Select Employee --</option>';
            
            if (data.success && data.employees && data.employees.length > 0) {
                data.employees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.name} (${emp.current_demos} demos)`;
                    employeeSelect.appendChild(option);
                });
                employeeSelect.disabled = false;
                
                employeeSelect.addEventListener('change', function() {
                    if (this.value) {
                        checkEmployeeAvailability(this.value);
                    }
                });
            } else {
                employeeSelect.innerHTML = '<option>No employees available</option>';
            }
        })
        .catch(error => {
            loadingDiv.style.display = 'none';
            showMessage('Error loading employees: ' + error.message, 'error');
        });
}

function hideReassignForm() {
    document.getElementById('reassignForm').style.display = 'none';
}

function handleAssign(requestId) {
    const form = document.getElementById('assignDemoForm');
    const formData = new FormData(form);
    const employeeId = formData.get('employee_id');
    
    if (!employeeId) {
        showMessage('Please select an employee', 'error');
        return;
    }
    
    form.querySelectorAll('button, select, textarea').forEach(el => el.disabled = true);
    form.querySelector('button').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Assigning...';
    
    fetch(`/admin/demo-requests/${requestId}/assign/`, {
        method: 'POST',
        body: formData,
        headers: { 
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('✓ Employee assigned successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage('✗ ' + (data.error || 'Failed to assign'), 'error');
            form.querySelectorAll('button, select, textarea').forEach(el => el.disabled = false);
            form.querySelector('button').innerHTML = '<i class="fas fa-user-plus me-1"></i>Assign';
        }
    })
    .catch(error => {
        console.error('Assignment error:', error);
        showMessage('✗ Error: ' + error.message, 'error');
        form.querySelectorAll('button, select, textarea').forEach(el => el.disabled = false);
        form.querySelector('button').innerHTML = '<i class="fas fa-user-plus me-1"></i>Assign';
    });
}

function handleReassign(requestId) {
    const form = document.getElementById('reassignDemoForm');
    const formData = new FormData(form);
    const employeeId = document.getElementById('employeeSelect').value;
    
    if (!employeeId) {
        showMessage('Please select an employee', 'error');
        return;
    }
    
    form.querySelectorAll('button, select, textarea').forEach(el => el.disabled = true);
    form.querySelector('button[type="button"]').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Reassigning...';
    
    fetch(`/admin/demo-requests/${requestId}/assign/`, {
        method: 'POST',
        body: formData,
        headers: { 
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('✓ Employee reassigned successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage('✗ ' + (data.error || 'Failed to reassign'), 'error');
            form.querySelectorAll('button, select, textarea').forEach(el => el.disabled = false);
            form.querySelector('button[type="button"]').innerHTML = '<i class="fas fa-user-plus me-1"></i>Reassign';
        }
    })
    .catch(error => {
        console.error('Reassignment error:', error);
        showMessage('✗ Error: ' + error.message, 'error');
        form.querySelectorAll('button, select, textarea').forEach(el => el.disabled = false);
        form.querySelector('button[type="button"]').innerHTML = '<i class="fas fa-user-plus me-1"></i>Reassign';
    });
}

function confirmUnassign(requestId) {
    if (confirm('Are you sure you want to unassign this demo request?')) {
        const button = document.querySelector('.employee-actions button.btn-danger');
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Unassigning...';
        
        fetch(`/admin/demo-requests/${requestId}/unassign/`, {
            method: 'POST',
            headers: { 
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('✓ Employee unassigned successfully!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showMessage('✗ ' + (data.error || 'Failed to unassign'), 'error');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-user-minus me-1"></i>Unassign';
            }
        })
        .catch(error => {
            console.error('Unassign error:', error);
            showMessage('✗ Error: ' + error.message, 'error');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-user-minus me-1"></i>Unassign';
        });
    }
}

// ✅ FIXED: Show reschedule modal with Sunday validation
function showRescheduleModal(requestId) {
    const dateInput = document.getElementById('rescheduleDate');
    
    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;
    dateInput.value = today;
    
    dateInput.addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        
        if (selectedDate.getDay() === 0) {
            showMessage('Sundays are not available for demos. Please select another date.', 'warning');
            this.value = '';
            document.getElementById('rescheduleTimeSlot').innerHTML = '<option value="">Select date first</option>';
            document.getElementById('rescheduleTimeSlot').disabled = true;
            return;
        }
        
        loadTimeSlots(this.value);
    });
    
    loadTimeSlots(today);
    rescheduleModal.show();
}

// ✅ FIXED: Load time slots with validation
function loadTimeSlots(date) {
    const loadingDiv = document.getElementById('loadingTimeSlots');
    const timeSlotSelect = document.getElementById('rescheduleTimeSlot');
    
    loadingDiv.style.display = 'block';
    timeSlotSelect.disabled = true;
    timeSlotSelect.innerHTML = '<option value="">-- Loading... --</option>';
    
    fetch(`/api/demo-requests/available-slots/?date=${date}`)
        .then(r => r.json())
        .then(data => {
            loadingDiv.style.display = 'none';
            
            if (!data.success) {
                timeSlotSelect.innerHTML = `<option value="">Error: ${data.error || 'Failed to load slots'}</option>`;
                showMessage(data.error || 'Failed to load time slots', 'error');
                return;
            }
            
            if (data.slots && data.slots.length > 0) {
                timeSlotSelect.innerHTML = '<option value="">-- Select Time Slot --</option>';
                
                data.slots.forEach(slot => {
                    const option = document.createElement('option');
                    option.value = slot.id;
                    option.textContent = slot.display_time;
                    
                    if (slot.status === 'available') {
                        option.textContent += ' ✓';
                    } else if (slot.status === 'full') {
                        option.textContent += ' ✗ Full';
                        option.disabled = true;
                    }
                    
                    timeSlotSelect.appendChild(option);
                });
                
                timeSlotSelect.disabled = false;
            } else {
                timeSlotSelect.innerHTML = '<option value="">No available time slots</option>';
                showMessage('No available time slots for this date', 'warning');
            }
        })
        .catch(error => {
            loadingDiv.style.display = 'none';
            timeSlotSelect.innerHTML = '<option value="">Error loading slots</option>';
            showMessage('Error loading time slots: ' + error.message, 'error');
            console.error('Load slots error:', error);
        });
}

// ✅ FIXED: Handle reschedule with success message
function handleReschedule(requestId) {
    const form = document.getElementById('rescheduleForm');
    const formData = new FormData(form);
    
    if (!formData.get('reschedule_date') || !formData.get('reschedule_time_slot')) {
        showMessage('Please select both date and time slot', 'error');
        return;
    }
    
    if (!formData.get('reschedule_reason')?.trim()) {
        showMessage('Please provide a reason for rescheduling', 'error');
        return;
    }
    
    const buttons = form.parentElement.nextElementSibling.querySelectorAll('button');
    buttons.forEach(btn => btn.disabled = true);
    buttons[1].innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Rescheduling...';
    
    fetch(`/admin/demo-requests/${requestId}/reschedule/`, {
        method: 'POST',
        body: formData,
        headers: { 
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            rescheduleModal.hide();
            showMessage('✓ Demo request rescheduled successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage('✗ ' + (data.error || 'Failed to reschedule'), 'error');
            buttons.forEach(btn => btn.disabled = false);
            buttons[1].innerHTML = '<i class="fas fa-calendar-check me-1"></i>Reschedule';
        }
    })
    .catch(error => {
        console.error('Reschedule error:', error);
        showMessage('✗ Error: ' + error.message, 'error');
        buttons.forEach(btn => btn.disabled = false);
        buttons[1].innerHTML = '<i class="fas fa-calendar-check me-1"></i>Reschedule';
    });
}

function showCancelModal(requestId) {
    cancelModal.show();
}

// ✅ FIXED: Handle cancel with success message
function handleCancel(requestId) {
    const form = document.getElementById('cancelForm');
    const formData = new FormData(form);
    
    if (!formData.get('cancel_reason')) {
        showMessage('Please select a cancellation reason', 'error');
        return;
    }
    
    const buttons = form.parentElement.nextElementSibling.querySelectorAll('button');
    buttons.forEach(btn => btn.disabled = true);
    buttons[1].innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Cancelling...';
    
    fetch(`/admin/demo-requests/${requestId}/confirm/`, {
        method: 'POST',
        body: JSON.stringify({
            action: 'cancel',
            cancel_reason: formData.get('cancel_reason'),
            cancel_details: formData.get('cancel_details'),
            notify_customer: formData.get('notify_cancel') === 'on'
        }),
        headers: { 
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            cancelModal.hide();
            showMessage('✓ Demo request cancelled successfully', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage('✗ ' + (data.error || 'Failed to cancel'), 'error');
            buttons.forEach(btn => btn.disabled = false);
            buttons[1].innerHTML = '<i class="fas fa-times-circle me-1"></i>Cancel Request';
        }
    })
    .catch(error => {
        console.error('Cancel error:', error);
        showMessage('✗ Error: ' + error.message, 'error');
        buttons.forEach(btn => btn.disabled = false);
        buttons[1].innerHTML = '<i class="fas fa-times-circle me-1"></i>Cancel Request';
    });
}

// ✅ FIXED: Confirm demo with success message
function confirmDemoRequest(requestId) {
    if (!confirm('Are you sure you want to confirm this demo request?')) {
        return;
    }
    
    const button = document.querySelector('.btn-success');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Confirming...';
    
    const dateIso = "{{ demo_request.requested_date|date:'Y-m-d' }}";
    const timeSlotId = "{{ demo_request.requested_time_slot.id }}";
    
    fetch(`/admin/demo-requests/${requestId}/confirm/`, {
        method: 'POST',
        body: JSON.stringify({
            action: 'confirm',
            confirmed_date: dateIso,
            confirmed_time_slot_id: timeSlotId
        }),
        headers: { 
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('✓ Demo request confirmed successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage('✗ ' + (data.error || 'Failed to confirm'), 'error');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check-circle me-1"></i>Confirm Demo';
        }
    })
    .catch(error => {
        console.error('Confirm error:', error);
        showMessage('✗ Error: ' + error.message, 'error');
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-check-circle me-1"></i>Confirm Demo';
    });
}

// ✅ FIXED: Mark completed with success message
function markCompleted(requestId) {
    if (!confirm('Are you sure you want to mark this demo as completed?')) {
        return;
    }
    
    const button = document.querySelector('.btn-info');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
    
    fetch(`/admin/demo-requests/${requestId}/mark-complete/`, {
        method: 'POST',
        headers: { 
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('✓ Demo marked as completed!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage('✗ ' + (data.error || 'Failed to mark as completed'), 'error');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-flag-checkered me-1"></i>Mark as Completed';
        }
    })
    .catch(error => {
        console.error('Complete error:', error);
        showMessage('✗ Error: ' + error.message, 'error');
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-flag-checkered me-1"></i>Mark as Completed';
    });
}

// ✅ FIXED: Save admin notes with success message
function saveAdminNotes(requestId) {
    const notes = document.getElementById('adminNotes').value;
    const button = document.querySelector('#adminNotesForm button');
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
    
    fetch(`/admin/demo-requests/${requestId}/update-notes/`, {
        method: 'POST',
        body: JSON.stringify({ admin_notes: notes }),
        headers: { 
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('✓ Admin notes saved successfully', 'success');
        } else {
            showMessage('✗ Failed to save notes', 'error');
        }
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-save me-1"></i>Save Notes';
    })
    .catch(error => {
        console.error('Save notes error:', error);
        showMessage('✗ Error: ' + error.message, 'error');
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-save me-1"></i>Save Notes';
    });
}

function confirmDelete(requestId) {
    if (confirm('Are you sure you want to delete this request permanently? This action cannot be undone.')) {
        const button = document.querySelector('.btn-outline-danger');
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Deleting...';
        
        fetch(`/admin/demo-requests/${requestId}/delete/`, {
            method: 'POST',
            headers: { 
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('✓ Demo request deleted successfully', 'success');
                setTimeout(() => {
                    window.location.href = "{% url 'core:admin_demo_requests' %}";
                }, 1500);
            } else {
                showMessage('✗ ' + (data.error || 'Failed to delete'), 'error');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-trash me-1"></i>Delete Request';
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            showMessage('✗ Error: ' + error.message, 'error');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-trash me-1"></i>Delete Request';
        });
    }
}

function reactivateRequest(requestId) {
    if (confirm('Are you sure you want to reactivate this cancelled request?')) {
        const button = document.querySelector('.btn-success');
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Reactivating...';
        
        fetch(`/admin/demo-requests/${requestId}/reactivate/`, {
            method: 'POST',
            headers: { 
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('✓ Demo request reactivated successfully!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showMessage('✗ ' + (data.error || 'Failed to reactivate'), 'error');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-redo me-1"></i>Reactivate Request';
            }
        })
        .catch(error => {
            console.error('Reactivate error:', error);
            showMessage('✗ Error: ' + error.message, 'error');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-redo me-1"></i>Reactivate Request';
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const employeeSelect = document.getElementById('employeeSelect');
    if (employeeSelect) {
        employeeSelect.addEventListener('change', function() {
            if (this.value) {
                checkEmployeeAvailability(this.value);
            } else {
                const statusDiv = document.getElementById('availabilityStatus');
                if (statusDiv) statusDiv.style.display = 'none';
            }
        });
    }

    const assignmentSection = document.getElementById('assignmentSection');
    if (assignmentSection) {
        assignmentSection.style.display = 'block !important';
        assignmentSection.style.visibility = 'visible !important';
        assignmentSection.style.opacity = '1 !important';
        
        assignmentSection.classList.add('always-visible');
    }
});
</script>

<style>
#assignmentSection, 
#assignmentSection.info-card,
#assignmentSection .info-card-header,
#assignmentSection .info-card-body {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.always-visible {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}
</style>
{% endblock %}