{% extends 'admin/base.html' %}
{% load permission_tags %}

{% block admin_title %}Demo Request #{{ demo_request.id }}{% endblock %}
{% block page_title %}Demo Request #{{ demo_request.id }}{% endblock %}

{% block breadcrumb %}
<div class="admin-breadcrumb">
    <div class="d-flex justify-content-between align-items-center">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="{% url 'core:admin_dashboard' %}">
                        <i class="fas fa-home me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'core:admin_demo_requests' %}">Demo Requests</a>
                </li>
                <li class="breadcrumb-item active">Request #{{ demo_request.id }}</li>
            </ol>
        </nav>
        <div class="d-flex align-items-center gap-2">
            <a href="{% url 'core:admin_demo_requests' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i>Back to List
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_extra_css %}
<style>
    .demo-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
    }
    
    .demo-header h1 {
        font-size: var(--font-2xl);
        font-weight: 600;
        margin-bottom: 0.25rem;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .demo-header .text-secondary {
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .info-card {
        background: white;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        margin-bottom: 1.25rem;
        overflow: hidden;
    }
    
    .info-card-header {
        background-color: #f9fafb;
        padding: 0.875rem 1rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
    }
    
    .info-card-header i, 
    .info-card-header svg {
        margin-right: 0.5rem;
        color: #0d6efd;
        font-size: var(--font-md);
    }
    
    .info-card-header h5,
    .card-title {
        font-size: var(--font-lg);
        font-weight: 600;
        margin-bottom: 0;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .info-card-body {
        padding: 1.25rem;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: 200px 1fr;
        row-gap: 1rem;
    }
    
    .info-label {
        font-weight: 600;
        color: #374151;
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .info-value {
        color: #1f2937;
        font-size: var(--font-sm);
        font-weight: 400;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .info-value a {
        color: #0d6efd;
        text-decoration: none;
        font-size: var(--font-sm);
    }
    
    .info-value a:hover {
        text-decoration: underline;
    }
    
    .badge {
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: var(--font-xs);
        font-weight: 600;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .badge.bg-warning { background-color: #f59e0b !important; }
    .badge.bg-success { background-color: #10b981 !important; }
    .badge.bg-info { background-color: #0ea5e9 !important; }
    .badge.bg-danger { background-color: #ef4444 !important; }
    .badge.bg-secondary { background-color: #6b7280 !important; }
    
    .status-badge-lg {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }

    .status-timeline {
        position: relative;
        margin-top: 1.5rem;
    }
    
    .timeline-item {
        display: flex;
        margin-bottom: 1.25rem;
    }
    
    .timeline-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #0ea5e9;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        position: relative;
        z-index: 2;
        font-size: var(--font-sm);
    }
    
    .timeline-icon.bg-warning { background-color: #f59e0b; }
    .timeline-icon.bg-success { background-color: #10b981; }
    .timeline-icon.bg-danger { background-color: #ef4444; }
    
    .timeline-content {
        flex-grow: 1;
    }
    
    .timeline-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .timeline-date {
        font-size: var(--font-xs);
        color: #6b7280;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .timeline-line {
        position: absolute;
        left: 16px;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: #e5e7eb;
        z-index: 1;
    }

    .form-label {
        font-size: var(--font-sm);
        font-weight: 500;
        margin-bottom: 0.375rem;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .form-control, .form-select {
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #087fc2;
        box-shadow: 0 0 0 3px rgba(8, 127, 194, 0.1);
    }
    
    .form-check-label {
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    textarea.form-control {
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }

    .btn {
        font-size: var(--font-sm);
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: var(--font-xs);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }

    .card {
        border-radius: 8px;
    }
    
    .card-body h3 {
        font-size: var(--font-4xl);
        font-weight: 700;
        margin-bottom: 0.25rem;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .card-body .small {
        font-size: var(--font-xs);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .card.bg-light {
        padding: 0.75rem;
    }

    .modal-title {
        font-size: var(--font-lg);
        font-weight: 600;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    
    .modal-body {
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
        padding: 1.25rem;
    }
    
    .modal-header {
        padding: 1rem 1.25rem;
    }
    
    .modal-footer {
        padding: 0.875rem 1.25rem;
    }

    .alert {
        font-size: var(--font-sm);
        padding: 0.75rem;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }

    .text-muted,
    .text-secondary {
        font-size: var(--font-sm);
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }

    h6 {
        font-size: var(--font-md);
        font-weight: 600;
        font-family: Verdana, Geneva, Tahoma, sans-serif;
    }

    /* Conflict Warning Styles */
    .conflict-warning .alert-danger {
        background-color: #fee2e2;
        border: 1px solid #ef4444;
        border-left: 4px solid #dc2626;
    }

    .conflict-item {
        padding: 0.5rem;
        background: white;
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
        border-left: 3px solid #dc2626;
    }

    .conflict-item:last-child {
        margin-bottom: 0;
    }

    /* Time Slot Dropdown */
    .time-slot-select option.slot-available {
        background-color: #d1fae5;
        color: #065f46;
    }

    .time-slot-select option.slot-partial {
        background-color: #fef3c7;
        color: #92400e;
    }

    .time-slot-select option.slot-full {
        background-color: #fee2e2;
        color: #991b1b;
    }

    .time-slot-select option:disabled {
        background-color: #f3f4f6;
        color: #9ca3af;
    }

    /* Make date inputs fully clickable */
    input[type="date"] {
        cursor: pointer !important;
        position: relative;
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: auto;
        height: auto;
        color: transparent;
        background: transparent;
        cursor: pointer;
    }

    @media (max-width: 768px) {
        .info-grid {
            grid-template-columns: 1fr;
            row-gap: 0.75rem;
        }
        
        .info-label {
            margin-bottom: 0.25rem;
        }
        
        .demo-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .demo-header h1 {
            font-size: var(--font-xl);
        }
        
        .status-badge-lg {
            padding: 0.375rem 0.75rem;
            font-size: var(--font-xs);
        }
        
        .info-card-body {
            padding: 1rem;
        }
        
        .info-card-header {
            padding: 0.75rem 1rem;
        }
        
        .timeline-item {
            margin-bottom: 1rem;
        }
        
        .card-body h3 {
            font-size: var(--font-3xl);
        }
    }
</style>
{% endblock %}

{% block admin_content %}

{# SUCCESS/ERROR MESSAGES #}
{% if messages %}
<div class="container-fluid mb-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Demo Request Header -->
<div class="demo-header">
    <div>
        <h1 class="h3 mb-1">Demo Request #{{ demo_request.id }}</h1>
        <p class="text-secondary mb-0">
            <i class="far fa-calendar-alt me-1"></i>Submitted {{ demo_request.created_at|date:"M d, Y" }} at {{ demo_request.created_at|date:"h:i A" }}
        </p>
    </div>
    <div>
        {% if demo_request.status == 'pending' %}
        <span class="status-badge-lg bg-warning text-white">
            <i class="fas fa-clock me-1"></i>Pending
        </span>
        {% elif demo_request.status == 'confirmed' %}
        <span class="status-badge-lg bg-success text-white">
            <i class="fas fa-check-circle me-1"></i>Confirmed
        </span>
        {% elif demo_request.status == 'completed' %}
        <span class="status-badge-lg bg-info text-white">
            <i class="fas fa-flag-checkered me-1"></i>Completed
        </span>
        {% elif demo_request.status == 'cancelled' %}
        <span class="status-badge-lg bg-danger text-white">
            <i class="fas fa-times-circle me-1"></i>Cancelled
        </span>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Customer Information -->
        <div class="info-card">
            <div class="info-card-header">
                <i class="fas fa-user"></i>
                <h5 class="card-title mb-0">Customer Information</h5>
            </div>
            <div class="info-card-body">
                <div class="info-grid">
                    <div class="info-label">Full Name:</div>
                    <div class="info-value">
                        <a href="{% url 'core:admin_customer_detail' demo_request.user.id %}">{{ demo_request.user.get_full_name }}</a>
                    </div>
                    
                    <div class="info-label">Email:</div>
                    <div class="info-value">
                        <a href="mailto:{{ demo_request.user.email }}">{{ demo_request.user.email }}</a>
                    </div>
                    
                    <div class="info-label">Phone:</div>
                    <div class="info-value">
                        {% if demo_request.user.mobile %}
                            <a href="tel:{{ demo_request.user.mobile }}">+91 {{ demo_request.user.mobile }}</a>
                        {% else %}
                            <span class="text-muted">Not provided</span>
                        {% endif %}
                    </div>
                    
                    <div class="info-label">Company:</div>
                    <div class="info-value">
                        {% if demo_request.user.organization %}
                            {{ demo_request.user.organization }}
                        {% else %}
                            <span class="text-muted">Not provided</span>
                        {% endif %}
                    </div>
                    
                    <div class="info-label">Business Category:</div>
                    <div class="info-value">
                        {% if demo_request.business_category %}
                            {{ demo_request.business_category.name }}
                            {% if demo_request.business_subcategory %}
                                <span class="text-secondary">
                                    <i class="fas fa-angle-right mx-1"></i>{{ demo_request.business_subcategory.name }}
                                </span>
                            {% endif %}
                        {% elif demo_request.user.business_category %}
                            {{ demo_request.user.business_category.name }}
                            {% if demo_request.user.business_subcategory %}
                                <span class="text-secondary">
                                    <i class="fas fa-angle-right mx-1"></i>{{ demo_request.user.business_subcategory.name }}
                                </span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Not specified</span>
                        {% endif %}
                    </div>
                    
                    <div class="info-label">Account Status:</div>
                    <div class="info-value">
                        {% if demo_request.user.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-danger">Inactive</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Demo Information -->
        <div class="info-card">
            <div class="info-card-header">
                <i class="fas fa-desktop"></i>
                <h5 class="card-title mb-0">Demo Information</h5>
            </div>
            <div class="info-card-body">
                <div class="info-grid">
                    <div class="info-label">Demo Title:</div>
                    <div class="info-value">
                        <a href="{% url 'core:admin_demo_detail' demo_request.demo.id %}">{{ demo_request.demo.title }}</a>
                        {% if demo_request.demo.is_featured %}
                            <span class="badge bg-info ms-2">Featured</span>
                        {% endif %}
                    </div>
                    
                    <div class="info-label">Demo Type:</div>
                    <div class="info-value">
                        {{ demo_request.demo.get_demo_type_display }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Schedule Information -->
        <div class="info-card">
            <div class="info-card-header">
                <i class="far fa-calendar-alt"></i>
                <h5 class="card-title mb-0">Schedule</h5>
            </div>
            <div class="info-card-body">
                <div class="info-grid">
                    <div class="info-label">Requested Date:</div>
                    <div class="info-value">
                        <i class="far fa-calendar text-primary me-1"></i>{{ demo_request.requested_date|date:"l, F d, Y" }}
                    </div>
                    
                    <div class="info-label">Time Slot:</div>
                    <div class="info-value">
                        <i class="far fa-clock text-primary me-1"></i>
                        {% if demo_request.requested_time_slot %}
                            {{ demo_request.requested_time_slot.start_time|time:"g:i A" }} - {{ demo_request.requested_time_slot.end_time|time:"g:i A" }}
                        {% else %}
                            <span class="text-muted">Not specified</span>
                        {% endif %}
                    </div>
                    
                    {% if demo_request.assigned_to %}
                    <div class="info-label">Assigned To:</div>
                    <div class="info-value">
                        <i class="fas fa-user-check text-success me-1"></i>
                        {{ demo_request.assigned_to.get_full_name }}
                        {% if demo_request.assigned_at %}
                            <span class="text-muted small">
                                (Assigned {{ demo_request.assigned_at|date:"M d, Y" }})
                            </span>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if demo_request.status == 'confirmed' and demo_request.confirmed_date %}
                    <div class="info-label">Confirmed Date:</div>
                    <div class="info-value">
                        <i class="fas fa-calendar-check text-success me-1"></i>{{ demo_request.confirmed_date|date:"l, F d, Y" }}
                        {% if demo_request.confirmed_date != demo_request.requested_date %}
                            <span class="badge bg-info">Rescheduled</span>
                        {% endif %}
                    </div>
                    
                    <div class="info-label">Confirmed Time:</div>
                    <div class="info-value">
                        <i class="fas fa-check-circle text-success me-1"></i>
                        {% if demo_request.confirmed_time_slot %}
                            {{ demo_request.confirmed_time_slot.start_time|time:"g:i A" }} - {{ demo_request.confirmed_time_slot.end_time|time:"g:i A" }}
                        {% elif demo_request.requested_time_slot %}
                            {{ demo_request.requested_time_slot.start_time|time:"g:i A" }} - {{ demo_request.requested_time_slot.end_time|time:"g:i A" }}
                        {% else %}
                            <span class="text-muted">Not specified</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="info-label">Customer Notes:</div>
                    <div class="info-value">
                        {% if demo_request.notes %}
                            {{ demo_request.notes }}
                        {% else %}
                            <span class="text-muted">No notes provided</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Notes -->
        <div class="info-card">
            <div class="info-card-header">
                <i class="fas fa-sticky-note"></i>
                <h5 class="card-title mb-0">Admin Notes</h5>
            </div>
            <div class="info-card-body">
                <form id="adminNotesForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <textarea class="form-control" rows="4" id="adminNotes" name="admin_notes">{{ demo_request.admin_notes }}</textarea>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-primary" onclick="saveAdminNotes({{ demo_request.id }})">
                            <i class="fas fa-save me-1"></i>Save Notes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="info-card">
            <div class="info-card-header">
                <i class="fas fa-bolt"></i>
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="info-card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'core:admin_demo_requests' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to List
                    </a>
                    
                    {% if demo_request.status == 'pending' %}
                        {% if user|has_permission:'approve_demo_request' %}
                        <button type="button" class="btn btn-success" onclick="openConfirmModal({{ demo_request.id }})">
                            <i class="fas fa-check-circle me-1"></i>Confirm Demo
                        </button>
                        {% endif %}
                        
                        {% if user|has_permission:'reject_demo_request' %}
                        <button type="button" class="btn btn-danger" onclick="showCancelModal({{ demo_request.id }})">
                            <i class="fas fa-times-circle me-1"></i>Cancel Request
                        </button>
                        {% endif %}
                    {% elif demo_request.status == 'confirmed' %}
                        <button type="button" class="btn btn-info" onclick="markCompleted({{ demo_request.id }})">
                            <i class="fas fa-flag-checkered me-1"></i>Mark as Completed
                        </button>
                        
                        <button type="button" class="btn btn-warning" onclick="showRescheduleModal({{ demo_request.id }})">
                            <i class="fas fa-calendar-alt me-1"></i>Reschedule
                        </button>
                        
                        {% if user|has_permission:'reject_demo_request' %}
                        <button type="button" class="btn btn-danger" onclick="showCancelModal({{ demo_request.id }})">
                            <i class="fas fa-times-circle me-1"></i>Cancel Request
                        </button>
                        {% endif %}
                    {% elif demo_request.status == 'cancelled' %}
                        {% if user|has_permission:'approve_demo_request' %}
                        <button type="button" class="btn btn-success" onclick="reactivateRequest({{ demo_request.id }})">
                            <i class="fas fa-redo me-1"></i>Reactivate Request
                        </button>
                        {% endif %}
                    {% endif %}
                    
                    {% if user|has_permission:'reject_demo_request' %}
                    <button type="button" class="btn btn-outline-danger" onclick="confirmDelete({{ demo_request.id }})">
                        <i class="fas fa-trash me-1"></i>Delete Request
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Activity Timeline -->
        <div class="info-card">
            <div class="info-card-header">
                <i class="fas fa-history"></i>
                <h5 class="card-title mb-0">Activity Timeline</h5>
            </div>
            <div class="info-card-body">
                <div class="status-timeline">
                    <div class="timeline-line"></div>
                    
                    <div class="timeline-item">
                        <div class="timeline-icon bg-info">
                            <i class="fas fa-plus"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">Request Submitted</div>
                            <div class="timeline-date">{{ demo_request.created_at|date:"M d, Y h:i A" }}</div>
                        </div>
                    </div>
                    
                    {% if demo_request.assigned_to %}
                    <div class="timeline-item">
                        <div class="timeline-icon bg-primary">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">
                                Assigned to {{ demo_request.assigned_to.get_full_name }}
                            </div>
                            <div class="timeline-date">
                                {{ demo_request.assigned_at|date:"M d, Y h:i A" }}
                                {% if demo_request.assigned_by %}
                                by {{ demo_request.assigned_by.get_full_name }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if demo_request.status == 'confirmed' %}
                    <div class="timeline-item">
                        <div class="timeline-icon bg-success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">Request Confirmed</div>
                            <div class="timeline-date">{{ demo_request.updated_at|date:"M d, Y h:i A" }}</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if demo_request.status == 'completed' %}
                    <div class="timeline-item">
                        <div class="timeline-icon bg-info">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">Demo Completed</div>
                            <div class="timeline-date">{{ demo_request.updated_at|date:"M d, Y h:i A" }}</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if demo_request.status == 'cancelled' %}
                    <div class="timeline-item">
                        <div class="timeline-icon bg-danger">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">Request Cancelled</div>
                            <div class="timeline-date">{{ demo_request.updated_at|date:"M d, Y h:i A" }}</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirm & Assign Modal -->
<div class="modal fade" id="confirmAssignModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 600px;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-2">
                <h6 class="modal-title mb-0">
                    <i class="fas fa-check-circle me-2"></i>Confirm Demo & Assign Employee
                </h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-3">
                <!-- Customer & Demo Info -->
                <div class="info-box mb-3 p-2 bg-light rounded">
                    <div class="row g-2 small">
                        <div class="col-6">
                            <i class="fas fa-user text-primary me-1"></i>
                            <strong>{{ demo_request.user.get_full_name }}</strong>
                        </div>
                        <div class="col-6">
                            <i class="fas fa-desktop text-primary me-1"></i>
                            <strong>{{ demo_request.demo.title }}</strong>
                        </div>
                    </div>
                </div>

                <!-- Date Selection -->
                <div class="mb-3">
                    <label class="form-label small mb-1" for="confirmDate">
                        <i class="far fa-calendar me-1"></i>Select Date
                    </label>
                    <input type="date" id="confirmDate" class="form-control form-control-sm" 
                           value="{{ demo_request.requested_date|date:'Y-m-d' }}" required
                           style="cursor: pointer;">
                    <small class="text-muted">Current: {{ demo_request.requested_date|date:"D, M d, Y" }}</small>
                </div>

                <!-- Time Slot Selection -->
                <div class="mb-3">
                    <label class="form-label small mb-1">
                        <i class="far fa-clock me-1"></i>Select Time Slot
                    </label>
                    <select id="confirmTimeSlot" class="form-select form-select-sm time-slot-select" required>
                        <option value="">Loading slots...</option>
                    </select>
                    <small class="text-muted">Current: {{ demo_request.requested_time_slot.start_time|time:"g:i A" }} - {{ demo_request.requested_time_slot.end_time|time:"g:i A" }}</small>
                    
                    <div id="slotDetailsCard" class="mt-2" style="display: none;">
                        <div class="card">
                            <div class="card-body p-2">
                                <h6 class="card-title mb-2 small">
                                    <i class="fas fa-info-circle text-primary"></i>
                                    Slot Details: <span id="slotDetailsTime"></span>
                                </h6>
                                <div id="slotDetailsContent" class="small"></div>
                                
                                <div id="conflictWarning" class="conflict-warning mt-2" style="display: none;">
                                    <div class="alert alert-danger py-2 px-2 mb-0">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                                            <div class="flex-grow-1">
                                                <strong class="d-block mb-1">‚ö†Ô∏è Scheduling Conflicts</strong>
                                                <div id="conflictDetails" class="small"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Employee Selection -->
                <div class="mb-3">
                    <label class="form-label small mb-1">
                        <i class="fas fa-user-tie me-1"></i>Assign Employee
                        <span class="badge bg-info ms-1" id="employeeCountBadge">Select slot first</span>
                    </label>
                    <select id="confirmEmployee" class="form-select form-select-sm">
                        <option value="">First select date & time</option>
                    </select>
                    
                    <div class="d-flex gap-2 mt-2 flex-wrap small">
                        <span><span class="badge bg-success">‚óè</span> Available</span>
                        <span><span class="badge bg-warning">‚óè</span> Busy</span>
                        <span><span class="badge bg-danger">‚óè</span> Conflict</span>
                    </div>
                </div>

                <div id="selectedEmployeeInfo" class="alert alert-success py-2 mb-3" style="display: none;">
                    <small>
                        <i class="fas fa-check-circle me-1"></i>
                        <strong>Selected:</strong> <span id="selectedEmployeeName"></span>
                    </small>
                </div>

                <div id="employeeLoadingState" class="text-center py-2" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary"></div>
                    <small class="text-muted ms-2">Loading employees...</small>
                </div>

                <!-- Admin Notes -->
                <div class="mb-0">
                    <label class="form-label small mb-1">
                        <i class="far fa-sticky-note me-1"></i>Admin Notes <span class="text-muted">(Optional)</span>
                    </label>
                    <textarea id="confirmAdminNotes" class="form-control form-control-sm" rows="2" 
                              placeholder="Add any notes..."></textarea>
                </div>
            </div>
            
            <div class="modal-footer bg-light py-2">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" id="proceedWithoutAssignBtn" class="btn btn-sm btn-warning" 
                        style="display: none;" onclick="confirmWithoutAssignment()">
                    <i class="fas fa-forward me-1"></i>Without Employee
                </button>
                <button type="button" id="confirmAssignBtn" class="btn btn-sm btn-success" onclick="confirmWithAssignment()">
                    <i class="fas fa-check-circle me-1"></i>Confirm & Assign
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ UPDATED: Reschedule Modal - EXACTLY LIKE CONFIRM -->
<div class="modal fade" id="rescheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 600px;">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white py-2">
                <h6 class="modal-title mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>Reschedule Demo
                </h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-3">
                <!-- Customer & Demo Info -->
                <div class="info-box mb-3 p-2 bg-light rounded">
                    <div class="row g-2 small">
                        <div class="col-6">
                            <i class="fas fa-user text-warning me-1"></i>
                            <strong>{{ demo_request.user.get_full_name }}</strong>
                        </div>
                        <div class="col-6">
                            <i class="fas fa-desktop text-warning me-1"></i>
                            <strong>{{ demo_request.demo.title }}</strong>
                        </div>
                    </div>
                </div>

                <!-- Current Schedule Info -->
                <div class="alert alert-info py-2 px-2 mb-3">
                    <small>
                        <strong>Current Schedule:</strong><br>
                        üìÖ {{ demo_request.requested_date|date:"D, M d, Y" }}<br>
                        ‚è∞ {{ demo_request.requested_time_slot.start_time|time:"g:i A" }} - {{ demo_request.requested_time_slot.end_time|time:"g:i A" }}
                        {% if demo_request.assigned_to %}
                        <br>üë§ {{ demo_request.assigned_to.get_full_name }}
                        {% endif %}
                    </small>
                </div>

                <!-- Date Selection -->
                <div class="mb-3">
                    <label class="form-label small mb-1" for="rescheduleDate">
                        <i class="far fa-calendar me-1"></i>New Date
                    </label>
                    <input type="date" id="rescheduleDate" class="form-control form-control-sm" 
                           value="{{ demo_request.requested_date|date:'Y-m-d' }}" required
                           style="cursor: pointer;">
                </div>

                <!-- Time Slot Selection -->
                <div class="mb-3">
                    <label class="form-label small mb-1">
                        <i class="far fa-clock me-1"></i>New Time Slot
                    </label>
                    <select id="rescheduleTimeSlot" class="form-select form-select-sm time-slot-select" required>
                        <option value="">First select date</option>
                    </select>
                    
                    <div id="rescheduleSlotDetails" class="mt-2" style="display: none;">
                        <div class="card">
                            <div class="card-body p-2">
                                <h6 class="card-title mb-2 small">
                                    <i class="fas fa-info-circle text-warning"></i>
                                    Slot Details
                                </h6>
                                <div id="rescheduleSlotContent" class="small"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ Employee Selection (SAME AS CONFIRM) -->
                <div class="mb-3">
                    <label class="form-label small mb-1">
                        <i class="fas fa-user-tie me-1"></i>Assign Employee
                        {% if demo_request.assigned_to %}
                        <span class="badge bg-info ms-1">Current: {{ demo_request.assigned_to.first_name }}</span>
                        {% else %}
                        <span class="badge bg-secondary ms-1">Not Assigned</span>
                        {% endif %}
                    </label>
                    <select id="rescheduleEmployee" class="form-select form-select-sm">
                        <option value="">First select time slot</option>
                    </select>
                    
                    <div class="d-flex gap-2 mt-2 flex-wrap small">
                        <span><span class="badge bg-success">‚óè</span> Available</span>
                        <span><span class="badge bg-warning">‚óè</span> Busy</span>
                        <span><span class="badge bg-danger">‚óè</span> Conflict</span>
                    </div>
                </div>

                <div id="rescheduleEmployeeInfo" class="alert alert-success py-2 mb-3" style="display: none;">
                    <small>
                        <i class="fas fa-check-circle me-1"></i>
                        <strong>Selected:</strong> <span id="rescheduleEmployeeName"></span>
                    </small>
                </div>

                <div id="rescheduleEmployeeLoading" class="text-center py-2" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-warning"></div>
                    <small class="text-muted ms-2">Loading employees...</small>
                </div>

                <!-- Reason -->
                <div class="mb-0">
                    <label class="form-label small mb-1">
                        <i class="fas fa-comment-alt me-1"></i>Reason for Rescheduling
                    </label>
                    <textarea id="rescheduleReason" class="form-control form-control-sm" rows="2" 
                              placeholder="Provide a reason" required></textarea>
                </div>
            </div>
            
            <div class="modal-footer bg-light py-2">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-sm btn-warning" onclick="handleReschedule({{ demo_request.id }})">
                    <i class="fas fa-calendar-check me-1"></i>Reschedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white py-2">
                <h6 class="modal-title mb-0">
                    <i class="fas fa-times-circle me-2"></i>Cancel Demo Request
                </h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <form id="cancelForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="cancelReason" class="form-label small mb-1">Cancellation Reason</label>
                        <select id="cancelReason" name="cancel_reason" class="form-select form-select-sm" required>
                            <option value="">-- Select Reason --</option>
                            <option value="customer_request">Customer Request</option>
                            <option value="scheduling_conflict">Scheduling Conflict</option>
                            <option value="no_longer_needed">No Longer Needed</option>
                            <option value="duplicate">Duplicate Request</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="cancelDetails" class="form-label small mb-1">Additional Details</label>
                        <textarea id="cancelDetails" name="cancel_details" class="form-control form-control-sm" rows="3" 
                                  placeholder="Provide additional details"></textarea>
                    </div>
                    
                    <div class="mb-0">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notifyCancelCheck" name="notify_cancel" checked>
                            <label class="form-check-label small" for="notifyCancelCheck">
                                Send cancellation notice to customer
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light py-2">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Go Back</button>
                <button type="button" class="btn btn-sm btn-danger" onclick="handleCancel({{ demo_request.id }})">
                    <i class="fas fa-times-circle me-1"></i>Cancel Request
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_extra_js %}
<script>
// ============================================================================
// DETAIL PAGE SCRIPT - WITH RESCHEDULE LIKE CONFIRM
// ============================================================================

const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// Modal instances
let confirmAssignModal;
let rescheduleModal;
let cancelModal;

// Variables for modals
if (typeof window.demoModalVars === 'undefined') {
    window.demoModalVars = {
        confirmAssignModal: null,
        rescheduleModal: null,
        currentRequestId: null,
        currentRequestData: null,
        selectedEmployeeId: null,
        availableEmployees: [],
        availableSlots: [],
        csrfToken: csrfToken
    };
}

const vars = window.demoModalVars;

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function showMessage(message, type = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Find container - try multiple selectors
    let container = document.querySelector('.container-fluid');
    if (!container) container = document.querySelector('main');
    if (!container) container = document.querySelector('.admin-content');
    if (!container) container = document.body;
    
    // Safely insert at top
    if (container && container.firstChild) {
        container.insertBefore(alertDiv, container.firstChild);
    } else if (container) {
        container.appendChild(alertDiv);
    }
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv && alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// ============================================================================
// OPEN CONFIRM MODAL
// ============================================================================

function openConfirmModal(requestId) {
    console.log('üîµ Opening confirm modal for request:', requestId);

    if (!vars.confirmAssignModal) {
        console.error('‚ùå Modal not initialized');
        showMessage('Modal not initialized', 'error');
        return;
    }

    vars.currentRequestId = requestId;
    vars.selectedEmployeeId = null;

    vars.currentRequestData = {
        id: requestId,
        demo: '{{ demo_request.demo.title }}',
        customer: '{{ demo_request.user.get_full_name }}',
        date: '{{ demo_request.requested_date|date:"D, M d, Y" }}',
        time: '{{ demo_request.requested_time_slot.start_time|time:"g:i A" }} - {{ demo_request.requested_time_slot.end_time|time:"g:i A" }}',
        dateIso: '{{ demo_request.requested_date|date:"Y-m-d" }}',
        timeSlotId: '{{ demo_request.requested_time_slot.id }}'
    };

    const confirmDate = document.getElementById('confirmDate');
    const confirmAdminNotes = document.getElementById('confirmAdminNotes');
    const confirmEmployee = document.getElementById('confirmEmployee');
    const selectedEmployeeInfo = document.getElementById('selectedEmployeeInfo');
    const slotDetailsCard = document.getElementById('slotDetailsCard');
    const conflictWarning = document.getElementById('conflictWarning');

    if (confirmDate) confirmDate.value = vars.currentRequestData.dateIso;
    if (confirmAdminNotes) confirmAdminNotes.value = '';
    if (confirmEmployee) confirmEmployee.innerHTML = '<option value="">First select time slot</option>';
    if (selectedEmployeeInfo) selectedEmployeeInfo.style.display = 'none';
    if (slotDetailsCard) slotDetailsCard.style.display = 'none';
    if (conflictWarning) conflictWarning.style.display = 'none';

    vars.confirmAssignModal.show();
    loadTimeSlotsForDate(vars.currentRequestData.dateIso, 'confirm');
}

// ============================================================================
// ‚úÖ OPEN RESCHEDULE MODAL - EXACTLY LIKE CONFIRM
// ============================================================================

function showRescheduleModal(requestId) {
    console.log('üîµ Opening reschedule modal for request:', requestId);

    if (!vars.rescheduleModal) {
        console.error('‚ùå Reschedule modal not initialized');
        showMessage('Modal not initialized', 'error');
        return;
    }

    vars.currentRequestId = requestId;
    vars.selectedEmployeeId = '{{ demo_request.assigned_to.id|default:"" }}'; // ‚úÖ Pre-select current employee

    // ‚úÖ Reset form
    const rescheduleDate = document.getElementById('rescheduleDate');
    const rescheduleTimeSlot = document.getElementById('rescheduleTimeSlot');
    const rescheduleEmployee = document.getElementById('rescheduleEmployee');
    const rescheduleReason = document.getElementById('rescheduleReason');
    const rescheduleEmployeeInfo = document.getElementById('rescheduleEmployeeInfo');
    const rescheduleSlotDetails = document.getElementById('rescheduleSlotDetails');

    if (rescheduleDate) {
        rescheduleDate.value = '{{ demo_request.requested_date|date:"Y-m-d" }}';
        
        // ‚úÖ Load slots when date changes
        rescheduleDate.addEventListener('change', function() {
            const selectedDate = new Date(this.value);
            
            if (selectedDate.getDay() === 0) {
                showMessage('Sundays are not available for demos. Please select another date.', 'warning');
                this.value = '';
                rescheduleTimeSlot.innerHTML = '<option value="">Select date first</option>';
                return;
            }
            
            loadTimeSlotsForDate(this.value, 'reschedule');
        });
    }

    if (rescheduleTimeSlot) {
        rescheduleTimeSlot.innerHTML = '<option value="">Loading...</option>';
        
        // ‚úÖ Load employees when slot changes
        rescheduleTimeSlot.addEventListener('change', function() {
            const selectedDate = rescheduleDate?.value;
            const selectedSlotId = this.value;
            
            if (selectedDate && selectedSlotId) {
                loadAvailableEmployees(selectedDate, selectedSlotId, 'reschedule');
                
                // Show slot details
                const slot = vars.availableSlots.find(s => s.id == selectedSlotId);
                if (slot) displaySlotDetails(slot, 'reschedule');
            }
        });
    }

    if (rescheduleEmployee) rescheduleEmployee.innerHTML = '<option value="">First select time slot</option>';
    if (rescheduleReason) rescheduleReason.value = '';
    if (rescheduleEmployeeInfo) rescheduleEmployeeInfo.style.display = 'none';
    if (rescheduleSlotDetails) rescheduleSlotDetails.style.display = 'none';

    // ‚úÖ Load initial slots
    loadTimeSlotsForDate('{{ demo_request.requested_date|date:"Y-m-d" }}', 'reschedule');
    
    vars.rescheduleModal.show();
}

// ============================================================================
// LOAD TIME SLOTS (SHARED FUNCTION)
// ============================================================================

function loadTimeSlotsForDate(dateIso, modalType = 'confirm') {
    console.log(`üîç Loading slots for ${modalType}:`, dateIso);
    
    const timeSlotSelect = document.getElementById(modalType === 'confirm' ? 'confirmTimeSlot' : 'rescheduleTimeSlot');
    const employeeSelect = document.getElementById(modalType === 'confirm' ? 'confirmEmployee' : 'rescheduleEmployee');
    
    if (timeSlotSelect) timeSlotSelect.innerHTML = '<option value="">Loading...</option>';
    if (employeeSelect) employeeSelect.innerHTML = '<option value="">First select time slot</option>';
    
    fetch(`/admin/demo-requests/ajax-check-slots/?date=${dateIso}`)
        .then(response => response.json())
        .then(data => {
            console.log(`‚úÖ Slots loaded for ${modalType}:`, data);
            
            if (!data.success || !data.slots || data.slots.length === 0) {
                if (timeSlotSelect) timeSlotSelect.innerHTML = '<option value="">No slots available</option>';
                return;
            }
            
            vars.availableSlots = data.slots;
            
            let optionsHTML = '<option value="">-- Select Time Slot --</option>';
            
            data.slots.forEach(slot => {
                let statusIcon = '';
                let statusClass = '';
                let disabled = '';
                let assignedText = '';
                
                const assignedEmployees = slot.booking_details || [];
                
                if (assignedEmployees.length > 0) {
                    const employeeNames = assignedEmployees
                        .map(b => b.assigned_employee_name || 'Unassigned')
                        .filter(name => name !== 'Not assigned' && name !== 'Unassigned')
                        .join(', ');
                    
                    assignedText = employeeNames ? ` ‚Üí ${employeeNames}` : ' ‚Üí -';
                } else {
                    assignedText = ' ‚Üí -';
                }
                
                const assignedCount = assignedEmployees.filter(
                    b => b.assigned_employee_name && b.assigned_employee_name !== 'Not assigned' && b.assigned_employee_name !== 'Unassigned'
                ).length;
                
                const realAvailableSpots = slot.total_capacity - assignedCount;
                
                if (slot.is_past || slot.is_starting_soon) {
                    statusIcon = '‚è∞';
                    statusClass = 'slot-unavailable';
                    disabled = 'disabled';
                } else if (realAvailableSpots === 0) {
                    statusIcon = 'üî¥';
                    statusClass = 'slot-full';
                    disabled = 'disabled';
                } else if (assignedCount > 0 && realAvailableSpots > 0) {
                    statusIcon = 'üü°';
                    statusClass = 'slot-partial';
                } else {
                    statusIcon = 'üü¢';
                    statusClass = 'slot-available';
                }
                
                // ‚úÖ Pre-select current slot in reschedule
                const isCurrentSlot = (modalType === 'reschedule' && slot.id == '{{ demo_request.requested_time_slot.id }}');
                const selected = isCurrentSlot ? 'selected' : '';
                
                optionsHTML += `
                    <option value="${slot.id}" ${disabled} ${selected} class="${statusClass}">
                        ${statusIcon} ${slot.start_time} - ${slot.end_time} (${realAvailableSpots} free)${assignedText}
                    </option>
                `;
            });
            
            if (timeSlotSelect) {
                timeSlotSelect.innerHTML = optionsHTML;
                
                // ‚úÖ Auto-load employees if slot is pre-selected (reschedule case)
                if (modalType === 'reschedule' && timeSlotSelect.value) {
                    const slot = vars.availableSlots.find(s => s.id == timeSlotSelect.value);
                    if (slot) displaySlotDetails(slot, 'reschedule');
                    loadAvailableEmployees(dateIso, timeSlotSelect.value, 'reschedule');
                }
            }
        })
        .catch(error => {
            console.error(`‚ùå Error loading slots for ${modalType}:`, error);
            if (timeSlotSelect) timeSlotSelect.innerHTML = '<option value="">Error loading slots</option>';
            showMessage('Failed to load time slots', 'error');
        });
}

// ============================================================================
// DISPLAY SLOT DETAILS (SHARED)
// ============================================================================

function displaySlotDetails(slot, modalType = 'confirm') {
    const detailsCard = document.getElementById(modalType === 'confirm' ? 'slotDetailsCard' : 'rescheduleSlotDetails');
    const detailsTime = document.getElementById(modalType === 'confirm' ? 'slotDetailsTime' : null);
    const detailsContent = document.getElementById(modalType === 'confirm' ? 'slotDetailsContent' : 'rescheduleSlotContent');
    
    if (!detailsCard || !detailsContent) return;
    
    if (detailsTime) detailsTime.textContent = `${slot.start_time} - ${slot.end_time}`;
    
    const assignedEmployees = slot.booking_details || [];
    const assignedCount = assignedEmployees.filter(
        b => b.assigned_employee_name && 
        b.assigned_employee_name !== 'Not assigned' && 
        b.assigned_employee_name !== 'Unassigned'
    ).length;
    
    let contentHTML = `
        <div class="mb-2">
            <strong>Capacity:</strong> 
            ${assignedCount} assigned / ${slot.total_capacity} total
            <span class="badge ${assignedCount < slot.total_capacity ? 'bg-success' : 'bg-danger'} ms-1">
                ${slot.total_capacity - assignedCount} free
            </span>
        </div>
    `;
    
    if (assignedEmployees.length > 0) {
        contentHTML += '<div class="mb-2"><strong>Current Bookings:</strong></div>';
        
        assignedEmployees.forEach(booking => {
            contentHTML += `
                <div class="small text-muted">
                    ‚Ä¢ ${booking.customer_name} - ${booking.demo_title}
                    ${booking.assigned_employee_name && booking.assigned_employee_name !== 'Not assigned' 
                        ? `(${booking.assigned_employee_name})` 
                        : '(Unassigned)'}
                </div>
            `;
        });
    } else {
        contentHTML += '<div class="text-muted small"><i class="fas fa-minus-circle me-1"></i>No employees assigned yet</div>';
    }
    
    detailsContent.innerHTML = contentHTML;
    detailsCard.style.display = 'block';
}

// ============================================================================
// LOAD AVAILABLE EMPLOYEES (SHARED)
// ============================================================================

function loadAvailableEmployees(dateIso, timeSlotId, modalType = 'confirm') {
    const employeeSelect = document.getElementById(modalType === 'confirm' ? 'confirmEmployee' : 'rescheduleEmployee');
    const loadingState = document.getElementById(modalType === 'confirm' ? 'employeeLoadingState' : 'rescheduleEmployeeLoading');
    const selectedEmployeeInfo = document.getElementById(modalType === 'confirm' ? 'selectedEmployeeInfo' : 'rescheduleEmployeeInfo');
    const employeeCountBadge = document.getElementById('employeeCountBadge');
    
    if (loadingState) loadingState.style.display = 'block';
    if (employeeSelect) employeeSelect.innerHTML = '<option value="">Loading...</option>';
    if (selectedEmployeeInfo) selectedEmployeeInfo.style.display = 'none';
    
    fetch(`/api/demo-requests/available-employees/?date=${dateIso}&time_slot_id=${timeSlotId}`)
        .then(response => response.json())
        .then(data => {
            if (loadingState) loadingState.style.display = 'none';
            
            if (!data.success || !data.employees || data.employees.length === 0) {
                if (employeeSelect) employeeSelect.innerHTML = '<option value="">No employees available</option>';
                if (employeeCountBadge) employeeCountBadge.textContent = '0 available';
                return;
            }
            
            vars.availableEmployees = data.employees;
            const availableCount = data.employees.filter(e => e.available).length;
            if (employeeCountBadge) employeeCountBadge.textContent = `${availableCount} available`;
            
            let optionsHTML = '<option value="">-- Select Employee --</option>';
            
            data.employees.forEach(emp => {
                let icon = '';
                let statusText = '';
                let className = '';
                let disabled = '';
                
                switch(emp.status) {
                    case 'CONFLICT':
                        icon = 'üî¥';
                        statusText = ` (Booked)`;
                        className = 'conflict';
                        disabled = 'disabled';
                        break;
                    case 'BUSY_OTHER_SLOTS':
                        icon = 'üü°';
                        statusText = ` (${emp.current_demos} demos, free)`;
                        className = 'busy';
                        break;
                    default:
                        icon = 'üü¢';
                        statusText = ' (Available)';
                        className = 'available';
                        break;
                }
                
                // ‚úÖ Pre-select current employee in reschedule
                const isCurrentEmployee = (modalType === 'reschedule' && emp.id == '{{ demo_request.assigned_to.id|default:"" }}');
                const selected = isCurrentEmployee ? 'selected' : '';
                
                optionsHTML += `
                    <option value="${emp.id}" class="${className}" ${disabled} ${selected} data-name="${emp.name}">
                        ${icon} ${emp.name}${statusText}
                    </option>
                `;
            });
            
            if (employeeSelect) {
                employeeSelect.innerHTML = optionsHTML;
                
                // ‚úÖ Show selected employee info if pre-selected
                if (modalType === 'reschedule' && employeeSelect.value) {
                    const selectedOption = employeeSelect.options[employeeSelect.selectedIndex];
                    const employeeName = selectedOption.getAttribute('data-name');
                    const employeeNameSpan = document.getElementById('rescheduleEmployeeName');
                    if (employeeNameSpan) employeeNameSpan.textContent = employeeName;
                    if (selectedEmployeeInfo) selectedEmployeeInfo.style.display = 'block';
                    vars.selectedEmployeeId = employeeSelect.value;
                }
                
                employeeSelect.onchange = function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const selectedEmployeeInfo = document.getElementById(modalType === 'confirm' ? 'selectedEmployeeInfo' : 'rescheduleEmployeeInfo');
                    const selectedEmployeeName = document.getElementById(modalType === 'confirm' ? 'selectedEmployeeName' : 'rescheduleEmployeeName');
                    
                    if (this.value) {
                        vars.selectedEmployeeId = this.value;
                        const employeeName = selectedOption.getAttribute('data-name');
                        if (selectedEmployeeName) selectedEmployeeName.textContent = employeeName;
                        if (selectedEmployeeInfo) selectedEmployeeInfo.style.display = 'block';
                    } else {
                        vars.selectedEmployeeId = null;
                        if (selectedEmployeeInfo) selectedEmployeeInfo.style.display = 'none';
                    }
                };
            }
        })
        .catch(error => {
            console.error(`‚ùå Error loading employees for ${modalType}:`, error);
            if (loadingState) loadingState.style.display = 'none';
            if (employeeSelect) employeeSelect.innerHTML = '<option value="">Error loading</option>';
            showMessage('Failed to load employees', 'error');
        });
}

// ============================================================================
// CONFIRM WITH ASSIGNMENT
// ============================================================================

function confirmWithAssignment() {
    const selectedDate = document.getElementById('confirmDate')?.value;
    const selectedTimeSlotId = document.getElementById('confirmTimeSlot')?.value;
    const adminNotes = document.getElementById('confirmAdminNotes')?.value?.trim();
    
    if (!selectedDate || !selectedTimeSlotId) {
        showMessage('Please select date and time slot', 'warning');
        return;
    }
    
    const btn = document.getElementById('confirmAssignBtn');
    if (!btn) return;
    
    const originalBtnHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

    fetch(`/admin/demo-requests/${vars.currentRequestId}/confirm/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': vars.csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: 'confirm',
            confirmed_date: selectedDate,
            confirmed_time_slot_id: selectedTimeSlotId,
            admin_notes: adminNotes
        })
    })
    .then(response => response.json())
    .then(confirmResult => {
        if (!confirmResult.success) {
            if (confirmResult.conflict_details && confirmResult.conflict_details.length > 0) {
                let detailedMessage = `‚ö†Ô∏è TIME SLOT CONFLICT\n\n`;
                detailedMessage += `Date: ${confirmResult.date}\n`;
                detailedMessage += `Time: ${confirmResult.time}\n\n`;
                detailedMessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                detailedMessage += `Already Scheduled:\n\n`;
                
                confirmResult.conflict_details.forEach((conflict, index) => {
                    detailedMessage += `${index + 1}. ${conflict.demo_title}\n`;
                    detailedMessage += `   Customer: ${conflict.customer_name}\n`;
                    detailedMessage += `   Email: ${conflict.customer_email}\n`;
                    if (conflict.employee_name && conflict.employee_name !== 'Unassigned') {
                        detailedMessage += `   Assigned to: ${conflict.employee_name}\n`;
                    }
                    detailedMessage += `\n`;
                });
                
                detailedMessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                detailedMessage += `\nPlease select a different time slot or date.`;
                
                alert(detailedMessage);
                console.error('‚ö†Ô∏è Conflict Details:', confirmResult.conflict_details);
            } else {
                alert(confirmResult.error || 'Failed to confirm request');
            }
            
            throw new Error(confirmResult.error || 'Failed');
        }

        if (vars.selectedEmployeeId) {
            const formData = new FormData();
            formData.append('employee_id', vars.selectedEmployeeId);
            formData.append('send_notification', 'on');
            if (adminNotes) formData.append('assignment_notes', adminNotes);

            return fetch(`/admin/demo-requests/${vars.currentRequestId}/assign/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': vars.csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            });
        } else {
            return Promise.resolve({ json: () => Promise.resolve({ success: true }) });
        }
    })
    .then(response => response.json ? response.json() : response)
    .then(assignResult => {
        if (assignResult.success === false) {
            if (assignResult.conflict) {
                let conflictMsg = `‚ùå EMPLOYEE SCHEDULING CONFLICT\n\n`;
                conflictMsg += `Employee: Cannot assign this employee\n\n`;
                conflictMsg += `Already Scheduled:\n`;
                conflictMsg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                conflictMsg += `Demo: ${assignResult.conflict.demo_title}\n`;
                conflictMsg += `Customer: ${assignResult.conflict.customer_name}\n`;
                conflictMsg += `Date: ${assignResult.conflict.date}\n`;
                conflictMsg += `Time: ${assignResult.conflict.time}\n`;
                conflictMsg += `Status: ${assignResult.conflict.status}\n`;
                conflictMsg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
                conflictMsg += `Please select a different employee or time slot.`;
                
                alert(conflictMsg);
                console.error('‚ö†Ô∏è Employee Conflict:', assignResult.conflict);
            } else {
                alert(assignResult.error || 'Failed to assign employee');
            }
            
            throw new Error(assignResult.error || 'Failed');
        }
        
        showMessage('‚úì Demo confirmed successfully!', 'success');
        if (vars.confirmAssignModal) vars.confirmAssignModal.hide();
        setTimeout(() => window.location.reload(), 1500);
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        btn.disabled = false;
        btn.innerHTML = originalBtnHtml;
    });
}

function confirmWithoutAssignment() {
    const selectedDate = document.getElementById('confirmDate')?.value;
    const selectedTimeSlotId = document.getElementById('confirmTimeSlot')?.value;
    const adminNotes = document.getElementById('confirmAdminNotes')?.value?.trim();
    
    if (!selectedDate || !selectedTimeSlotId) {
        showMessage('Please select date and time', 'warning');
        return;
    }

    if (!confirm('Confirm without employee?')) return;

    const btn = document.getElementById('proceedWithoutAssignBtn');
    if (!btn) return;
    
    const originalBtnHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Confirming...';

    fetch(`/admin/demo-requests/${vars.currentRequestId}/confirm/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': vars.csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: 'confirm',
            confirmed_date: selectedDate,
            confirmed_time_slot_id: selectedTimeSlotId,
            admin_notes: adminNotes || 'Confirmed without assignment'
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showMessage('‚úì Confirmed! Reloading...', 'success');
            if (vars.confirmAssignModal) vars.confirmAssignModal.hide();
            setTimeout(() => window.location.reload(), 1500);
        } else {
            throw new Error(result.error || 'Failed');
        }
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        showMessage('‚úó Error: ' + error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = originalBtnHtml;
    });
}

// ============================================================================
// ‚úÖ HANDLE RESCHEDULE - UPDATED TO INCLUDE EMPLOYEE
// ============================================================================

function handleReschedule(requestId) {
    const rescheduleDate = document.getElementById('rescheduleDate')?.value;
    const rescheduleTimeSlot = document.getElementById('rescheduleTimeSlot')?.value;
    const rescheduleEmployee = document.getElementById('rescheduleEmployee')?.value;
    const rescheduleReason = document.getElementById('rescheduleReason')?.value?.trim();
    
    if (!rescheduleDate || !rescheduleTimeSlot) {
        showMessage('Please select date and time slot', 'warning');
        return;
    }
    
    if (!rescheduleReason) {
        showMessage('Please provide a reason for rescheduling', 'warning');
        return;
    }
    
    const btn = document.querySelector('#rescheduleModal .btn-warning');
    if (!btn) return;
    
    const originalBtnHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Rescheduling...';
    
    // ‚úÖ Step 1: Reschedule (update date/time)
    fetch(`/admin/demo-requests/${requestId}/confirm/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: 'reschedule',
            new_date: rescheduleDate,
            new_time_slot_id: rescheduleTimeSlot,
            reason: rescheduleReason
        })
    })
    .then(response => response.json())
    .then(rescheduleResult => {
        if (!rescheduleResult.success) {
            throw new Error(rescheduleResult.error || 'Failed to reschedule');
        }
        
        // ‚úÖ Step 2: Assign employee if selected and different from current
        if (rescheduleEmployee && rescheduleEmployee !== '{{ demo_request.assigned_to.id|default:"" }}') {
            const formData = new FormData();
            formData.append('employee_id', rescheduleEmployee);
            formData.append('send_notification', 'on');
            formData.append('assignment_notes', `Assigned during reschedule: ${rescheduleReason}`);

            return fetch(`/admin/demo-requests/${requestId}/assign/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            });
        } else {
            return Promise.resolve({ json: () => Promise.resolve({ success: true }) });
        }
    })
    .then(response => response.json ? response.json() : response)
    .then(assignResult => {
        if (assignResult.success === false) {
            throw new Error(assignResult.error || 'Failed to assign employee');
        }
        
        showMessage('‚úì Demo rescheduled successfully!', 'success');
        if (vars.rescheduleModal) vars.rescheduleModal.hide();
        setTimeout(() => window.location.reload(), 1500);
    })
    .catch(error => {
        console.error('‚ùå Reschedule error:', error);
        showMessage('‚úó Error: ' + error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = originalBtnHtml;
    });
}

// ============================================================================
// OTHER ACTION FUNCTIONS
// ============================================================================

function showCancelModal(requestId) {
    cancelModal.show();
}

function handleCancel(requestId) {
    const form = document.getElementById('cancelForm');
    const formData = new FormData(form);
    
    if (!formData.get('cancel_reason')) {
        showMessage('Please select a cancellation reason', 'error');
        return;
    }
    
    const buttons = form.parentElement.nextElementSibling.querySelectorAll('button');
    buttons.forEach(btn => btn.disabled = true);
    buttons[1].innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Cancelling...';
    
    fetch(`/admin/demo-requests/${requestId}/confirm/`, {
        method: 'POST',
        body: JSON.stringify({
            action: 'cancel',
            cancel_reason: formData.get('cancel_reason'),
            cancel_details: formData.get('cancel_details'),
            notify_customer: formData.get('notify_cancel') === 'on'
        }),
        headers: { 
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            cancelModal.hide();
            showMessage('‚úì Demo request cancelled successfully', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage('‚úó ' + (data.error || 'Failed to cancel'), 'error');
            buttons.forEach(btn => btn.disabled = false);
            buttons[1].innerHTML = '<i class="fas fa-times-circle me-1"></i>Cancel Request';
        }
    })
    .catch(error => {
        console.error('Cancel error:', error);
        showMessage('‚úó Error: ' + error.message, 'error');
        buttons.forEach(btn => btn.disabled = false);
        buttons[1].innerHTML = '<i class="fas fa-times-circle me-1"></i>Cancel Request';
    });
}

function markCompleted(requestId) {
    if (!confirm('Mark this demo as completed?')) return;
    
    const button = document.querySelector('.btn-info');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
    
    fetch(`/admin/demo-requests/${requestId}/confirm/`, {
        method: 'POST',
        body: JSON.stringify({ action: 'complete' }),
        headers: { 
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('‚úì Demo marked as completed!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage('‚úó ' + (data.error || 'Failed'), 'error');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-flag-checkered me-1"></i>Mark as Completed';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('‚úó Error: ' + error.message, 'error');
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-flag-checkered me-1"></i>Mark as Completed';
    });
}

function saveAdminNotes(requestId) {
    const notes = document.getElementById('adminNotes').value;
    const button = document.querySelector('#adminNotesForm button');
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
    
    fetch(`/admin/demo-requests/${requestId}/update-notes/`, {
        method: 'POST',
        body: JSON.stringify({ admin_notes: notes }),
        headers: { 
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('‚úì Admin notes saved', 'success');
        } else {
            showMessage('‚úó Failed to save notes', 'error');
        }
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-save me-1"></i>Save Notes';
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('‚úó Error: ' + error.message, 'error');
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-save me-1"></i>Save Notes';
    });
}

function confirmDelete(requestId) {
    if (confirm('Delete this request permanently? This cannot be undone.')) {
        const button = document.querySelector('.btn-outline-danger');
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Deleting...';
        
        fetch(`/admin/demo-requests/${requestId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('‚úì Demo request deleted', 'success');
                setTimeout(() => {
                    window.location.href = "{% url 'core:admin_demo_requests' %}";
                }, 1500);
            } else {
                showMessage('‚úó ' + (data.error || 'Failed to delete'), 'error');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-trash me-1"></i>Delete Request';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('‚úó Error: ' + error.message, 'error');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-trash me-1"></i>Delete Request';
        });
    }
}

function reactivateRequest(requestId) {
    if (confirm('Reactivate this cancelled request?')) {
        const button = document.querySelector('.btn-success');
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Reactivating...';
        
        fetch(`/admin/demo-requests/${requestId}/reactivate/`, {
            method: 'POST',
            headers: { 
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('‚úì Demo request reactivated!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showMessage('‚úó ' + (data.error || 'Failed to reactivate'), 'error');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-redo me-1"></i>Reactivate Request';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('‚úó Error: ' + error.message, 'error');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-redo me-1"></i>Reactivate Request';
        });
    }
}

// ============================================================================
// INITIALIZE ON PAGE LOAD
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üîµ Initializing detail page...');
    
    if (typeof bootstrap === 'undefined') {
        console.error('‚ùå Bootstrap not loaded');
        return;
    }
    
    const confirmModalElement = document.getElementById('confirmAssignModal');
    if (confirmModalElement && !vars.confirmAssignModal) {
        vars.confirmAssignModal = new bootstrap.Modal(confirmModalElement, {
            backdrop: 'static',
            keyboard: false
        });
        console.log('‚úÖ Confirm modal initialized');
    }
    
    const rescheduleModalElement = document.getElementById('rescheduleModal');
    if (rescheduleModalElement && !vars.rescheduleModal) {
        vars.rescheduleModal = new bootstrap.Modal(rescheduleModalElement, {
            backdrop: 'static',
            keyboard: false
        });
        console.log('‚úÖ Reschedule modal initialized');
    }
    
    cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));
    
    // Event listeners for confirm modal
    const dateInput = document.getElementById('confirmDate');
    if (dateInput) {
        dateInput.addEventListener('change', function() {
            const selectedDate = this.value;
            if (selectedDate) {
                const slotDetailsCard = document.getElementById('slotDetailsCard');
                const conflictWarning = document.getElementById('conflictWarning');
                if (slotDetailsCard) slotDetailsCard.style.display = 'none';
                if (conflictWarning) conflictWarning.style.display = 'none';
                loadTimeSlotsForDate(selectedDate, 'confirm');
            }
        });
    }
    
    const timeSlotSelect = document.getElementById('confirmTimeSlot');
    if (timeSlotSelect) {
        timeSlotSelect.addEventListener('change', function() {
            const selectedDate = document.getElementById('confirmDate')?.value;
            const selectedSlotId = this.value;
            
            if (selectedDate && selectedSlotId) {
                const slot = vars.availableSlots.find(s => s.id == selectedSlotId);
                if (slot) displaySlotDetails(slot, 'confirm');
                loadAvailableEmployees(selectedDate, selectedSlotId, 'confirm');
            } else {
                const slotDetailsCard = document.getElementById('slotDetailsCard');
                const conflictWarning = document.getElementById('conflictWarning');
                if (slotDetailsCard) slotDetailsCard.style.display = 'none';
                if (conflictWarning) conflictWarning.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}